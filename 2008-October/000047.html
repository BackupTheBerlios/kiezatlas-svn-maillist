<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Kiezatlas-svn] r58 - in trunk: docs pages	src/de/kiezatlas/deepamehta
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/kiezatlas-svn/2008-October/index.html" >
   <LINK REL="made" HREF="mailto:kiezatlas-svn%40lists.berlios.de?Subject=Re%3A%20%5BKiezatlas-svn%5D%20r58%20-%20in%20trunk%3A%20docs%20pages%0A%09src/de/kiezatlas/deepamehta&In-Reply-To=%3C200810300254.m9U2sT41016535%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="000048.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Kiezatlas-svn] r58 - in trunk: docs pages	src/de/kiezatlas/deepamehta</H1>
    <B>maltito at mail.berlios.de</B> 
    <A HREF="mailto:kiezatlas-svn%40lists.berlios.de?Subject=Re%3A%20%5BKiezatlas-svn%5D%20r58%20-%20in%20trunk%3A%20docs%20pages%0A%09src/de/kiezatlas/deepamehta&In-Reply-To=%3C200810300254.m9U2sT41016535%40sheep.berlios.de%3E"
       TITLE="[Kiezatlas-svn] r58 - in trunk: docs pages	src/de/kiezatlas/deepamehta">maltito at mail.berlios.de
       </A><BR>
    <I>Thu Oct 30 03:54:29 CET 2008</I>
    <P><UL>
        
        <LI>Next message: <A HREF="000048.html">[Kiezatlas-svn] r59 - in trunk: images pages	src/de/kiezatlas/deepamehta
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#47">[ date ]</a>
              <a href="thread.html#47">[ thread ]</a>
              <a href="subject.html#47">[ subject ]</a>
              <a href="author.html#47">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: maltito
Date: 2008-10-30 03:54:23 +0100 (Thu, 30 Oct 2008)
New Revision: 58

Added:
   trunk/pages/Print.jsp
Modified:
   trunk/docs/session.txt
   trunk/pages/CityMap.jsp
   trunk/pages/GeoObjectInfo.jsp
   trunk/pages/KiezAtlas.jsp
   trunk/pages/List.jsp
   trunk/pages/kiezatlas.css
   trunk/src/de/kiezatlas/deepamehta/EditServlet.java
   trunk/src/de/kiezatlas/deepamehta/KiezAtlas.java
   trunk/src/de/kiezatlas/deepamehta/ListServlet.java
Log:
1) ListenFunktion erweitert um
	 a)Sortierung b) Filterung
2) Rundmail verfassen
3) Steuerdatei erstellen (Non Final)
4) Browser Encoding Latin One

Extras:
1) Multiple File Uploads with Forms supported (Docs and Images)
2) Fixed Usability Issue: Hotspot Marker

Depends on upcoming DeepaMehta revision 
with Extended HTML Generator, TopicBeanFields and Info-Generator

Modified: trunk/docs/session.txt
===================================================================
--- trunk/docs/session.txt	2008-09-16 13:14:47 UTC (rev 57)
+++ trunk/docs/session.txt	2008-10-30 02:54:23 UTC (rev 58)
@@ -138,11 +138,16 @@
 ----
 
 cityMap				selected city map (BaseTopic)
-topics				IDs of geo objects to list (Vector of String)
+topics				Vector of TopicBeans
 geo					geo object to highlight (BaseTopic)
 notifications		error notifications (Vector of Notification)
+sortField			Topic Bean Field Name, der zur Sortierung heanrgezogen wird (String) bzw. &quot;null&quot;, wenn unsortiert
+filterField			Topic Bean Field Name, der zur Filterung heanrgezogen wird (String) bzw. &quot;null&quot;, wenn ungefiltert
+filterText			query string (String). Nur verwendet, wenn filterField != null
+emailList			Liste von Email-Adressen (Vector of String)
 
 
+
 GeoObjectAdminForm
 ------------------
 

Modified: trunk/pages/CityMap.jsp
===================================================================
--- trunk/pages/CityMap.jsp	2008-09-16 13:14:47 UTC (rev 57)
+++ trunk/pages/CityMap.jsp	2008-10-30 02:54:23 UTC (rev 58)
@@ -92,7 +92,7 @@
 				out.println(&quot;&lt;/a&gt;&quot;);
 			}
 		}
-		// --- geoObjects ---
+		// --- marker first ---
 		e = hotspots.elements();
 		while (e.hasMoreElements()) {
 			Vector presentables = (Vector) e.nextElement();
@@ -101,13 +101,24 @@
 			while (e2.hasMoreElements()) {
 				PresentableTopic inst = (PresentableTopic) e2.nextElement();
 				Point p = inst.getGeometry();
-				// marker
 				// marker and hotspot can't overlap exactly, cause of the new icons don't fit in the old convention of 20x20px chel
 				if (selectedInst != null &amp;&amp; selectedInst.geoID.equals(inst.getID())) {
 					out.println(&quot;&lt;img src=\&quot;../images/marker.gif\&quot; style=\&quot;position:absolute; top:&quot; +
-						(p.y - 18) + &quot;px; left:&quot; + (p.x - 18) + &quot;px;\&quot;&gt;&quot;);
+						(p.y - 20) + &quot;px; left:&quot; + (p.x - 20) + &quot;px;\&quot;&gt;&quot;);
+					break;
 				}
-				// hotspot
+			}
+		}
+		
+		// --- geoObjects ---
+		e = hotspots.elements();
+		while (e.hasMoreElements()) {
+			Vector presentables = (Vector) e.nextElement();
+			Enumeration e2 = presentables.elements();
+			String icon = (String) e2.nextElement();
+			while (e2.hasMoreElements()) {
+				PresentableTopic inst = (PresentableTopic) e2.nextElement();
+				Point p = inst.getGeometry();
 				out.println(&quot;&lt;a href=\&quot;javascript:top.frames.right.location.href='controller?action=&quot; +
 					KiezAtlas.ACTION_SHOW_GEO_INFO + &quot;&amp;id=&quot; + inst.getID() + &quot;'\&quot;&gt;&quot; +
 					&quot;&lt;img src=\&quot;&quot; + icon + &quot;\&quot; style=\&quot;position:absolute; top:&quot; + (p.y - 7) + &quot;px; left:&quot; +

Modified: trunk/pages/GeoObjectInfo.jsp
===================================================================
--- trunk/pages/GeoObjectInfo.jsp	2008-09-16 13:14:47 UTC (rev 57)
+++ trunk/pages/GeoObjectInfo.jsp	2008-10-30 02:54:23 UTC (rev 58)
@@ -15,6 +15,12 @@
 	topicBean.removeFieldsContaining(&quot;Web Alias&quot;);
 	topicBean.removeFieldsContaining(&quot;Locked Geometry&quot;);
 	topicBean.removeFieldsContaining(&quot;Description&quot;);
+	topicBean.removeFieldsContaining(&quot;Birthday&quot;);
+	topicBean.removeFieldsContaining(&quot;Gender&quot;);
+	topicBean.removeField(&quot;Person / Mobile Number&quot;);
+	topicBean.removeField(&quot;Person / Fax Number&quot;);
+	topicBean.removeField(&quot;Person / Phone Number&quot;);
+	topicBean.removeField(&quot;Person / Webpage&quot;);
 	topicBean.removeField(&quot;Forum / Aktivierung&quot;);
 	// --- image ---
 	String imageFile = topicBean.getValue(&quot;Image / File&quot;);

Modified: trunk/pages/KiezAtlas.jsp
===================================================================
--- trunk/pages/KiezAtlas.jsp	2008-09-16 13:14:47 UTC (rev 57)
+++ trunk/pages/KiezAtlas.jsp	2008-10-30 02:54:23 UTC (rev 58)
@@ -9,6 +9,8 @@
 &lt;%@ page import=&quot;de.kiezatlas.deepamehta.Cluster&quot; %&gt;
 
 &lt;%@ page import=&quot;de.deepamehta.BaseTopic&quot; %&gt;
+&lt;%@ page import=&quot;de.deepamehta.service.TopicBean&quot; %&gt;
+&lt;%@ page import=&quot;de.deepamehta.service.TopicBeanField&quot; %&gt;
 &lt;%@ page import=&quot;de.deepamehta.BaseAssociation&quot; %&gt;
 &lt;%@ page import=&quot;de.deepamehta.DeepaMehtaException&quot; %&gt;
 &lt;%@ page import=&quot;de.deepamehta.PresentableTopic&quot; %&gt;
@@ -38,7 +40,9 @@
 			title = title + &quot; - Listenzugang&quot;;
 			break;
 		}
-		out.println(&quot;&lt;html&gt;\r&lt;head&gt;\r&lt;title&gt;&quot; + title + &quot;&lt;/title&gt;&quot;);
+		out.println(&quot;&lt;html&gt;&quot; +
+			&quot;&lt;meta http-equiv=\&quot;content-type\&quot; content=\&quot;text/html; charset=iso-8859-1\&quot;&gt;&quot; +
+			&quot;\r&lt;head&gt;\r&lt;title&gt;&quot; + title + &quot;&lt;/title&gt;&quot;);
 		out.println(&quot;&lt;link href=\&quot;../pages/kiezatlas.css\&quot; rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot;&gt;&quot;);
 		out.println(&quot;&lt;/head&gt;&quot;);
 		out.println(&quot;&lt;body&gt;&quot;);
@@ -59,7 +63,9 @@
 		String stylesheet = (String) session.getAttribute(&quot;stylesheet&quot;);
 		String siteLogo = (String) session.getAttribute(&quot;siteLogo&quot;);
 		String homepageURL = (String) session.getAttribute(&quot;homepageURL&quot;);
-		out.println(&quot;&lt;html&gt;\r&lt;head&gt;\r&lt;title&gt;Kiezatlas&lt;/title&gt;\r&quot; +
+		out.println(&quot;&lt;html&gt;&quot; +
+			&quot;&lt;meta http-equiv=\&quot;content-type\&quot; content=\&quot;text/html; charset=iso-8859-1\&quot;&gt;&quot; +
+			&quot;\r&lt;head&gt;\r&lt;title&gt;Kiezatlas&lt;/title&gt;\r&quot; +
 			&quot;&lt;style type=\&quot;text/css\&quot;&gt;\r&quot; + stylesheet + &quot;\r&lt;/style&gt;\r&quot; +
 			&quot;&lt;/head&gt;\r&quot; +
 			&quot;&lt;body&quot; + (refreshMap ? &quot; onLoad=\&quot;top.frames.left.location.href='controller?action=initFrame&amp;frame=&quot; +
@@ -183,7 +189,47 @@
 			return html.toString();
 		}
 	}
-
+	
+	String mailListLink(Vector mailboxes) {
+		Enumeration e = mailboxes.elements();
+		StringBuffer html = new StringBuffer();
+		html.append(&quot;&lt;a href=\&quot;mailto:&quot;);
+		//
+		while(e.hasMoreElements()) {
+			String mail = (String) e.nextElement();
+			if(mail != null &amp;&amp; !mail.equals(&quot;&quot;)) {
+			    html.append(mail);
+			}
+			if (e.hasMoreElements()) {
+			    html.append(&quot;,&quot;);
+			}
+		}
+		html.append(&quot;\&quot; class=\&quot;small\&quot;&gt; Rundmail erstellen&lt;/a&gt;&quot;);
+		//
+		return html.toString();
+	}
+	
+	// --
+	
+	String fieldOptions(TopicBean bean, String[] hiddenProps, String[] hiddenPropsContaining, String checked) {
+		StringBuffer html = new StringBuffer();
+		for (int j = 0; j &lt; hiddenProps.length; j++) {
+		    bean.removeField(hiddenProps[j].toString());
+		}
+		for (int k = 0; k &lt; hiddenPropsContaining.length; k++) {
+		    bean.removeFieldsContaining(hiddenPropsContaining[k].toString());
+		}
+		for (int i = 0; i &lt; bean.fields.size(); i++) {
+		    TopicBeanField field = (TopicBeanField) bean.fields.get(i);
+		    html.append(&quot;&lt;option value=\&quot;&quot;+ field.name +&quot;\&quot;&quot;);
+		    if (field.name.equals(checked)) {
+			html.append(&quot; selected=\&quot;selected\&quot;&quot;);
+		    }
+		    html.append(&quot;&gt;&quot; + field.label + &quot;&lt;/option&gt; \n &quot;);
+		}
+		return html.toString();
+	}
+	
 	// ---
 
 	boolean isSet(String str) {

Modified: trunk/pages/List.jsp
===================================================================
--- trunk/pages/List.jsp	2008-09-16 13:14:47 UTC (rev 57)
+++ trunk/pages/List.jsp	2008-10-30 02:54:23 UTC (rev 58)
@@ -3,26 +3,76 @@
 &lt;% begin(KiezAtlas.SERVLET_LIST, session, out); %&gt;
 &lt;%!
 	static String[] hiddenProps = {
-		KiezAtlas.PROPERTY_DESCRIPTION,
-		KiezAtlas.PROPERTY_ICON,
-		&quot;Width&quot;, &quot;Height&quot;};
+		&quot;Image&quot;, &quot;Image / Height&quot;, &quot;Image / Width&quot;, 
+		&quot;Image / File&quot;,  &quot;Image / Name&quot;, &quot;Width&quot;, &quot;Height&quot;,
+		&quot;Address / Name&quot;, &quot;Address / City&quot;, &quot;Person / Birthday&quot;};
+	static String[] hiddenPropsContaining= {&quot;YADE&quot;, &quot;Owner&quot;, &quot;Locked Geometry&quot;, KiezAtlas.PROPERTY_DESCRIPTION, KiezAtlas.PROPERTY_ICON, &quot;Person / Address&quot; };
 %&gt;
 &lt;%
+
 	HTMLGenerator html = (HTMLGenerator) session.getAttribute(&quot;html&quot;);
 	BaseTopic cityMap = (BaseTopic) session.getAttribute(&quot;cityMap&quot;);
 	Vector topics = (Vector) session.getAttribute(&quot;topics&quot;);
 	BaseTopic geo = (BaseTopic) session.getAttribute(&quot;geo&quot;);
 	Vector notifications = (Vector) session.getAttribute(&quot;notifications&quot;);
+	String filterField = (String) session.getAttribute(&quot;filterField&quot;);
+	String filterText = (String) session.getAttribute(&quot;filterText&quot;);
+	String sortField = (String) session.getAttribute(&quot;sortField&quot;);
+	Vector mailboxes = (Vector) session.getAttribute(&quot;emailList&quot;);
+	TopicBean bean = null;
+	if (topics.size() &gt; 0) {
+	    // get table headers, just if topics are provided
+	    bean = (TopicBean) topics.get(0);
+	}
 	//
+	String disabledFormString;
+	String selectedFilterField;
+	if(filterField != null) {
+	    disabledFormString = &quot;&quot;;
+	    selectedFilterField = filterField;
+	} else {
+	    disabledFormString = &quot; disabled&quot;;
+	    selectedFilterField = &quot;&quot;;
+	}
 	out.println(&quot;&lt;p&gt;&lt;span class=\&quot;heading\&quot;&gt;&quot; + cityMap.getName() + &quot;&lt;/span&gt;&quot; +
 		&quot;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&quot; +
 		html.link(&quot;Alle Stadtpl&auml;ne anzeigen&quot;, KiezAtlas.ACTION_GO_HOME) + &quot;&lt;/p&gt;&quot;);
 	out.println(&quot;&lt;p&gt;&quot; + topics.size() + &quot; Objekte&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&quot; +
-		html.link(&quot;Neues Objekt eingeben&quot;, KiezAtlas.ACTION_SHOW_EMPTY_GEO_FORM) + &quot;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;&quot;);	
+		html.link(&quot;Neues Objekt eingeben&quot;, KiezAtlas.ACTION_SHOW_EMPTY_GEO_FORM));
+	if (bean != null) {
+	    out.println(&quot;&lt;form id=\&quot;filterForm\&quot; method=\&quot;GET\&quot; action=\&quot;controller\&quot; &gt;\n&lt;select name=\&quot;filterField\&quot;&gt;&quot; + 
+			fieldOptions(bean, hiddenProps, hiddenPropsContaining, filterField) + &quot;&lt;/select&gt;\n&quot;);
+	    // -- had to encode the action into form data cause of '?'
+	    out.println(&quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;action\&quot; value=\&quot;&quot;+KiezAtlas.ACTION_FILTER+&quot;\&quot;&gt;\n&quot;);
+	    if (filterText != null) {
+		out.println(&quot;&lt;input type=\&quot;text\&quot; name=\&quot;filterText\&quot; value=\&quot;&quot;+filterText+&quot;\&quot;&gt;\n&quot;);
+	    } else {
+		out.println(&quot;&lt;input type=\&quot;text\&quot; name=\&quot;filterText\&quot;&gt;\n&quot;);
+	    }
+	    out.println(&quot;&lt;input type=\&quot;submit\&quot; value=\&quot;Filtern\&quot;&gt;\n&quot;);
+	    out.println(&quot;&lt;/form&gt;\n&quot;);
+	}
+	out.println(&quot;&lt;form method=\&quot;GET\&quot; action=\&quot;controller\&quot; &gt;&quot;);
+	out.println(&quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;action\&quot; value=\&quot;&quot;+KiezAtlas.ACTION_CLEAR_FILTER+&quot;\&quot;&gt;\n&quot;);
+	out.println(&quot;&lt;input type=\&quot;submit\&quot; value=\&quot;Filter aufheben\&quot;&quot; + disabledFormString + &quot;&gt;\n&quot;);
+	out.println(&quot;&lt;/form&gt;\n&quot;);
+	out.println(&quot;&lt;br&gt;&lt;/p&gt;&quot;);
 	out.println(html.notification(notifications) + (notifications.size() &gt; 0 ? &quot;&lt;br&gt;&lt;br&gt;&quot; : &quot;&quot;));
 	// --- list of institutions ---
 	String selectedID = geo != null ? geo.getID() : null;
-	out.println(html.list(topics, selectedID, hiddenProps, true, KiezAtlas.ACTION_SHOW_GEO_FORM, true));
-														// hideSel=true, doZebraStriping=true
+	if (sortField == null) {
+	    out.println(html.listTopicBeans(topics, selectedID, hiddenProps, hiddenPropsContaining, true, KiezAtlas.ACTION_SHOW_GEO_FORM, KiezAtlas.ACTION_SORT_BY, true, null));
+	} else {
+	    System.out.println(&quot;&gt;&gt;&gt; highlight Column: &quot; + sortField);
+	    out.println(html.listTopicBeans(topics, selectedID, hiddenProps, hiddenPropsContaining, true, KiezAtlas.ACTION_SHOW_GEO_FORM, KiezAtlas.ACTION_SORT_BY, true, sortField));
+	}
+	//
+	out.println(&quot;&lt;p&gt;&quot;);
+	// check mailboxes
+	if (mailboxes != null &amp;&amp; mailboxes.size() &gt; 0) {
+	    out.println(mailListLink(mailboxes));
+	}
+	out.println(&quot;&lt;a href=\&quot;?action=createFormLetter\&quot; class=\&quot;small\&quot;&gt;Erstelle Serienbrief&lt;/a&gt;&quot;);
+	out.println(&quot;&lt;/p&gt;&quot;);
 %&gt;
 &lt;% end(out); %&gt;

Added: trunk/pages/Print.jsp
===================================================================
--- trunk/pages/Print.jsp	2008-09-16 13:14:47 UTC (rev 57)
+++ trunk/pages/Print.jsp	2008-10-30 02:54:23 UTC (rev 58)
@@ -0,0 +1,14 @@
+&lt;%-- 
+    Document   : Print
+    Created on : 21.10.2008, 19:19:36
+    Author     : monty
+--%&gt;
+&lt;%@ include file=&quot;KiezAtlas.jsp&quot; %&gt;
+
+&lt;%@page contentType=&quot;text/html&quot; pageEncoding=&quot;iso-8859-1&quot;%&gt;
+&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;
+   &quot;<A HREF="http://www.w3.org/TR/html4/loose.dtd">http://www.w3.org/TR/html4/loose.dtd</A>&quot;&gt;
+
+&lt;%  String text = (String) session.getAttribute(&quot;formLetter&quot;);
+    out.println(text);
+%&gt;

Modified: trunk/pages/kiezatlas.css
===================================================================
--- trunk/pages/kiezatlas.css	2008-09-16 13:14:47 UTC (rev 57)
+++ trunk/pages/kiezatlas.css	2008-10-30 02:54:23 UTC (rev 58)
@@ -69,6 +69,13 @@
 	background-color: #FFFFFF;
 }
 
+/* DeepaMehta list generator: higlight the table header (used for sortBy in listTopicBeans)*/
+.list-highlightcolumnheader {
+        background-color: #E0E0FF;
+        font-size: 10px;
+	color: #666666;
+}
+
 /* DeepaMehta info generator: outmost container for label/content pairs */
 .info-container {
 }

Modified: trunk/src/de/kiezatlas/deepamehta/EditServlet.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/EditServlet.java	2008-09-16 13:14:47 UTC (rev 57)
+++ trunk/src/de/kiezatlas/deepamehta/EditServlet.java	2008-10-30 02:54:23 UTC (rev 58)
@@ -75,7 +75,7 @@
 			// Note: the timestamp is updated through geo object's propertiesChanged() hook
 			updateTopic(geo.getType(), params, session, directives);
 			// --- store image ---
-			writeImage(params.getUploads(), geo.getImage(), PROPERTY_FILE, as);
+			writeFiles(params.getUploads(), geo.getImage(), as);
 			//
 			return PAGE_GEO_HOME;
 			//
@@ -146,15 +146,22 @@
 	 * @see		#performAction
 	 * @see		ListServlet#performAction
 	 */
-	static String writeImage(Vector fileItems, BaseTopic topic, String propName, ApplicationService as) {
-		try {
-			System.out.println(&quot;&gt;&gt;&gt; EditServlet.writeImage(): &quot; + fileItems.size() + &quot; files uploaded&quot;);
-			if (fileItems.size() &gt; 0) {
-				String path = &quot;/home/jrichter/deepamehta/install/client/images/&quot;;	// ### hardcoded
-				// ### String path = &quot;/Users/jri/Projects/DeepaMehta/trunk/install/client/images/&quot;;
-				FileItem item = (FileItem) fileItems.firstElement();
+	static Vector writeFiles(Vector fileItems, BaseTopic topic, ApplicationService as) {
+		Vector fileNames = new Vector();
+		for (int i = 0; i &lt; fileItems.size(); i++) {
+			try {
+				System.out.println(&quot;&gt;&gt;&gt; EditServlet.writeImage(): &quot; + fileItems.size() + &quot; files uploaded, writing fileItem: &quot; + i);
+				FileItem item = (FileItem) fileItems.get(i);
+				String propName = getFileChooserFieldName(item);
+				String fileext = getFileExtension(item.getName());	// ### explorer includes entire path
 				String filename = getFilename(item.getName());	// ### explorer includes entire path
-				System.out.println(&quot;  &gt; filename=\&quot;&quot; + filename + &quot;\&quot;&quot;);
+				System.out.println(&quot;  &gt; filename=\&quot;&quot; + filename + &quot;\&quot; extension=\&quot;&quot; + fileext + &quot;\&quot;&quot;);
+				// String path = &quot;/home/jrichter/deepamehta/install/client/document/&quot;;	// ### hardcoded
+				String path = &quot;/home/monty/source/deepaMehta/install/client/documents/&quot;;
+				if (fileext.equals(&quot;png&quot;) || fileext.equals(&quot;jpg&quot;) || fileext.equals(&quot;gif&quot;)) {
+					// String path = &quot;/home/jrichter/deepamehta/install/client/images/&quot;;	// ### hardcoded
+					path = &quot;/home/monty/source/deepaMehta/install/client/images/&quot;;
+				}
 				File fileToWrite = new File(path + filename);
 				// find new filename if already exists
 				int copyCount = 0;
@@ -174,20 +181,33 @@
 					if (newFilename != null) {
 						as.setTopicProperty(topic, propName, newFilename);
 					}
-					return newFilename;
+					fileNames.add(newFilename);
+				} else {
+					fileNames.add(filename);
 				}
+			} catch (Exception e) {
+				System.out.println(&quot;*** EditServlet.writeImage(): &quot; + e);
 			}
-		} catch (Exception e) {
-			System.out.println(&quot;*** EditServlet.writeImage(): &quot; + e);
 		}
-		return null;
+		return fileNames;
 	}
+	
+	static String getFileChooserFieldName(FileItem item) {
+		String fieldName = item.getFieldName();
+		int pos = fieldName.lastIndexOf(&quot;:&quot;);
+		return pos != -1 ? fieldName.substring(pos + 1) : fieldName; 
+	}
 
 	// ###
 	static String getFilename(String path) {
 		int pos = path.lastIndexOf('\\');
 		return pos != -1 ? path.substring(pos + 1) : path;
 	}
+	
+	static String getFileExtension(String path) {
+		int pos = path.lastIndexOf('.');
+		return pos != -1 ? path.substring(pos + 1) : &quot;&quot;;
+	}
 
 
 

Modified: trunk/src/de/kiezatlas/deepamehta/KiezAtlas.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/KiezAtlas.java	2008-09-16 13:14:47 UTC (rev 57)
+++ trunk/src/de/kiezatlas/deepamehta/KiezAtlas.java	2008-10-30 02:54:23 UTC (rev 58)
@@ -229,6 +229,12 @@
 	public static final String ACTION_SHOW_INSTITUTIONS = &quot;showInstitutions&quot;;
 	public static final String ACTION_SHOW_EMPTY_GEO_FORM = &quot;showEmptyGeoObjectForm&quot;;
 	public static final String ACTION_CREATE_GEO = &quot;createGeo&quot;;
+	public static final String ACTION_SORT_BY =&quot;sort&quot;;
+	public static final String ACTION_FILTER =&quot;filter&quot;;
+	public static final String ACTION_CLEAR_FILTER =&quot;clearFilter&quot;;
+	public static final String ACTION_CREATE_FORM_LETTER =&quot;createFormLetter&quot;;
+	
+	
 
 
 

Modified: trunk/src/de/kiezatlas/deepamehta/ListServlet.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/ListServlet.java	2008-09-16 13:14:47 UTC (rev 57)
+++ trunk/src/de/kiezatlas/deepamehta/ListServlet.java	2008-10-30 02:54:23 UTC (rev 58)
@@ -6,16 +6,21 @@
 import de.deepamehta.BaseTopic;
 import de.deepamehta.service.CorporateDirectives;
 import de.deepamehta.service.Session;
+import de.deepamehta.service.TopicBean;
+import de.deepamehta.service.TopicBeanField;
 import de.deepamehta.service.web.DeepaMehtaServlet;
-import de.deepamehta.service.web.Notification;
 import de.deepamehta.service.web.RequestParameter;
-import de.deepamehta.util.DeepaMehtaUtils;
-//
+import java.io.File;
+import java.io.FileWriter;
+import java.io.IOException;
+import java.util.Collections;
+import java.util.Comparator;
 import javax.servlet.ServletException;
 //
 import java.util.Enumeration;
 import java.util.Hashtable;
 import java.util.Vector;
+import org.apache.commons.fileupload.FileItem;
 
 
 
@@ -28,7 +33,7 @@
  * <A HREF="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">jri at deepamehta.de</A>
  */
 public class ListServlet extends DeepaMehtaServlet implements KiezAtlas {
-
+	
 	protected String performAction(String action, RequestParameter params, Session session, CorporateDirectives directives)
 																									throws ServletException {
 		if (action == null) {
@@ -47,6 +52,9 @@
 			String instTypeID = ((CityMapTopic) as.getLiveTopic(cityMap)).getInstitutionType().getID();
 			setCityMap(cityMap, session);
 			setInstTypeID(instTypeID, session);
+			// -- initialize filter and search attributes with &quot;null&quot;
+			session.setAttribute(&quot;sortField&quot;, null);
+			session.setAttribute(&quot;filterField&quot;, null);
 			return PAGE_LIST;
 		} else if (action.equals(ACTION_SHOW_GEO_FORM)) {
 			String geoObjectID = params.getValue(&quot;id&quot;);
@@ -62,8 +70,12 @@
 			// --- update geo object ---
 			// Note: the timestamp is updated through geo object's propertiesChanged() hook
 			updateTopic(geo.getType(), params, session, directives, cityMap.getID(), VIEWMODE_USE);
-			// --- store image ---
-			EditServlet.writeImage(params.getUploads(), geo.getImage(), PROPERTY_FILE, as);
+			// --- store image / files---
+			for (int a = 0; a &lt; params.getUploads().size(); a++) {
+				FileItem f = (FileItem) params.getUploads().get(a);
+				System.out.println(&quot;***ListServlet. uploaded files are &quot; + EditServlet.getFilename(f.getName()));
+			}
+			EditServlet.writeFiles(params.getUploads(), geo.getImage(), as);
 			//
 			return PAGE_LIST;
 		} else if (action.equals(ACTION_SHOW_EMPTY_GEO_FORM)) {
@@ -86,11 +98,48 @@
 			setGeoObject(cm.getTopic(geoObjectID, 1), session);
 			GeoObjectTopic geo = getGeoObject(session);
 			// --- store image ---
-			EditServlet.writeImage(params.getUploads(), geo.getImage(), PROPERTY_FILE, as);
+			EditServlet.writeFiles(params.getUploads(), geo.getImage(), as);
 			//
 			return PAGE_LIST;
 		} else if (action.equals(ACTION_GO_HOME)) {
 			return PAGE_LIST_HOME;
+		} else if (action.equals(ACTION_SORT_BY)) {
+			Vector topicBeans = getListedTopics(session);
+			String sortBy = params.getParameter(&quot;sortField&quot;);
+			sortBeans(topicBeans, sortBy);
+			session.setAttribute(&quot;topics&quot;, topicBeans);
+			session.setAttribute(&quot;sortField&quot;, sortBy);
+			return PAGE_LIST;
+		} else if (action.equals(ACTION_FILTER)) {
+			Vector topicBeans = getListedTopics(session);
+			String filterField = params.getParameter(&quot;filterField&quot;);
+			if (filterField != null) {
+				String filterText = params.getValue(&quot;filterText&quot;);
+				Vector newBeans = filterBeansByField(topicBeans, filterField, filterText);
+				session.setAttribute(&quot;topics&quot;, newBeans);
+				session.setAttribute(&quot;filterField&quot;, filterField);
+				session.setAttribute(&quot;filterText&quot;, filterText);
+				// Maybe redundant
+				return PAGE_LIST;
+			}
+			// Maybe redundant
+			session.setAttribute(&quot;topics&quot;, topicBeans);
+			return PAGE_LIST;
+		} else if (action.equals(ACTION_CLEAR_FILTER)) {
+			// -- reset filter and search attributes to &quot;null&quot;
+			session.setAttribute(&quot;filterField&quot;, null);
+			session.setAttribute(&quot;filterText&quot;, null);
+			System.out.println(&quot;&gt;&gt;&gt; cleared Sort and Filter&quot;);
+			return PAGE_LIST;
+		} else if (action.equals(ACTION_CREATE_FORM_LETTER)) {
+			System.out.println(&quot;&gt;&gt;&gt; created Form Letter&quot;);
+			String letter = createFormLetter(getListedTopics(session));
+			if(letter.equals(&quot;&quot;)) {
+				return PAGE_LIST;
+			}
+			session.setAttribute(&quot;formLetter&quot;, letter);
+			writeLetter(letter, &quot;testLetter.txt&quot;);
+			return &quot;Print&quot;;
 		}
 		//
 		return super.performAction(action, params, session, directives);
@@ -102,25 +151,264 @@
 			Hashtable cityMaps = getCityMaps(workspaces);
 			session.setAttribute(&quot;workspaces&quot;, workspaces);
 			session.setAttribute(&quot;cityMaps&quot;, cityMaps);
+			session.setAttribute(&quot;emailList&quot;, null);
 		} else if (page.equals(PAGE_LIST)) {
-			// geo objects
-			String cityMapID = getCityMap(session).getID();
-			String instTypeID = getInstTypeID(session);
-			Vector insts = cm.getTopicIDs(instTypeID, cityMapID, true);		// sortByTopicName=true
-			session.setAttribute(&quot;topics&quot;, insts);
-			// notifications
-			session.setAttribute(&quot;notifications&quot;, directives.getNotifications());
+			String sortBy = getSortByField(session);
+			// refresh geo objects in list from cm, if no filter active
+			if (session.getAttribute(&quot;filterField&quot;) == null) {
+				String cityMapID = getCityMap(session).getID();
+				String instTypeID = getInstTypeID(session);
+				Vector insts = cm.getTopicIDs(instTypeID, cityMapID, true);		// sortByTopicName=true
+				Vector topicBeans = new Vector();
+				for (int i = 0; i &lt; insts.size(); i++) {
+					TopicBean topic = as.createTopicBean(insts.get(i).toString(), 1);
+					topicBeans.add(topic);
+				}
+				// recover sorting
+				if (sortBy != null) {
+					sortBeans(topicBeans, sortBy);
+					// ### System.out.println(&quot;&gt;&gt;&gt;&gt; topics are fresh from server and sorted by: &quot; + session.getAttribute(&quot;sortField&quot;) );
+				} else {
+					// ### System.out.println(&quot;&gt;&gt;&gt;&gt; topics are fresh from server, by default sort&quot;);
+				}
+				session.setAttribute(&quot;topics&quot;, topicBeans);
+				// notifications
+				session.setAttribute(&quot;notifications&quot;, directives.getNotifications());
+			} else {
+				// ### System.out.println(&quot;&gt;&gt;&gt;&gt; sorting / filtering active: &quot; + params.getParameter(&quot;sortField&quot;) );
+				session.setAttribute(&quot;notifications&quot;, directives.getNotifications());
+			}
+			Vector beans = getListedTopics(session);
+			Vector mailAdresses = getMailAdresses(beans);
+			session.setAttribute(&quot;emailList&quot;, mailAdresses);
+			// ### System.out.println(&quot;&gt;&gt;&gt;&gt; emailList created with : &quot; + mailAdresses.size() + &quot; Eintr&#228;ge&quot;);
+			
 		}
 	}
 
+	
 
-
 	// **********************
 	// *** Custom Methods ***
 	// **********************
-
-
-
+	
+	
+	
+	private void sortBeans(Vector topicBeans, String sortBy) {
+		// ### System.out.println(&quot;&gt;&gt;&gt; sorting for german strings supported&quot;);
+		Collections.sort(topicBeans, new MyStringComparator( sortBy ));
+	}
+	
+	private Vector filterBeansByField(Vector topicBeans, String filterField, String filterText) {
+		Vector filteredBeans = new Vector();
+		//
+		String prop;
+		BaseTopic topicProp;
+		TopicBean topicBean;
+		TopicBeanField beanField;
+		for (int i = 0; i &lt; topicBeans.size(); i++) {
+			topicBean = (TopicBean) topicBeans.get(i);
+			beanField = (TopicBeanField) topicBean.getField(filterField);
+			if (beanField.type == TopicBeanField.TYPE_MULTI) {
+				for (int j = 0; j &lt; beanField.values.size(); j++) {
+					topicProp = (BaseTopic) beanField.values.get(j);
+					if (topicProp.getName().toLowerCase().indexOf(filterText.toLowerCase()) != -1) {
+						filteredBeans.add(topicBean);
+					}
+					break;
+				}
+			} else {
+				prop = (String) beanField.value;
+				if (prop.toLowerCase().indexOf(filterText.toLowerCase()) != -1) {
+					// ### System.out.println(&quot;single field: found &quot; + filterText + &quot;, in &quot; + prop);
+					filteredBeans.add(topicBean);
+				}
+			}
+		}
+		//
+		return filteredBeans;
+	}
+	/**
+	 * Collects Email Addresses for all given beans by searching for TopicBeanFields {@link TopicBeanField} 
+	 * which are inherited by each bean as PROPERTY_EMAIL_ADDRESS as Email Topic (has to be named PROPERTY_EMAIL_ADDRESS) 
+	 * and a TopicBeanField with the name &quot;Person / Email Address&quot; (Email of Person which is assigned to an Institution)
+	 * @param topics
+	 * @return a list of Strings which are all email adresses
+	 */
+	private Vector getMailAdresses(Vector topics) {
+		Vector mailAdresses = new Vector();
+		//
+		Enumeration e = topics.elements();
+		while (e.hasMoreElements()) {
+			TopicBean bean = (TopicBean) e.nextElement();
+			TopicBeanField mailProp = bean.getField(PROPERTY_EMAIL_ADDRESS);
+			// direct related Email Topic
+			if (mailProp != null) {
+				// ### Value can be not null and just empty &quot;&quot; () have to verify this in the form processor
+				if (mailProp.value != null &amp;&amp; !mailProp.value.equals(&quot;&quot;)) {
+					// Type Single
+					// ### System.out.println(&quot;type single mail property is: &quot; + mailProp.value); 
+				} else if(mailProp.values != null &amp;&amp; mailProp.values.size() &gt; 0){
+					// Type Multi
+					BaseTopic mailTopic = (BaseTopic) mailProp.values.get(0);
+					if (!mailTopic.getName().equals(&quot;&quot;)) {
+						mailAdresses.add(mailTopic.getName());
+						// ### System.out.println(&quot;type multi direct mail topic is: &quot; + mailTopic.getName());
+					}
+				}
+			}
+			// indirect related Email Topic via Person
+			if (mailProp != null) {
+				TopicBeanField mailField = bean.getField(&quot;Person / Email Address&quot;);
+				if (mailField != null &amp;&amp; mailField.type == TopicBeanField.TYPE_MULTI){
+					// ### System.out.println(&quot;indirect mailProp Field is: &quot; + mailField.name);
+					if (mailField.values.size() &gt; 0 ){
+						BaseTopic propTopic = (BaseTopic) mailField.values.get(0);
+						String mail = as.getTopicProperty(propTopic, PROPERTY_EMAIL_ADDRESS);
+						if (mail != null &amp;&amp; mail.indexOf(&quot;@&quot;) != -1) {
+							mailAdresses.add(mail);
+							// ### System.out.println(&quot;**** found indirect related email adress, added to \&quot;recipient list\&quot;: &quot; +
+							// mail + &quot;, fieldName is: &quot; + mailField.name);	
+						}
+						
+					}
+				}
+			}
+		}
+		//
+		return mailAdresses;
+	}
+	
+	private String createFormLetter(Vector topics) {
+		String letter = new String();
+		String personName = &quot;&quot;;
+		String test = &quot;&quot;;
+		//
+		if (topics == null) {
+			System.out.println(&quot;**** createFormLetter(): somebody gave me an empty topics list&quot;);
+			return &quot;&quot;;
+		}
+		Enumeration e = topics.elements();
+		while (e.hasMoreElements()) {
+			TopicBean bean = (TopicBean) e.nextElement();
+			// get related Address
+			String address = getAddress(bean);
+			if (address != null) {
+				test += bean.name;
+				test += createTab();
+				personName = getRelatedPersonName(bean);
+				if (personName != null &amp;&amp; !personName.equals(&quot;&quot;)) {
+					test += (&quot;z.Hd. &quot;);
+					test += personName;
+					test += createTab(); 
+					test += address;
+					test += &quot;\n&quot;;
+					letter += test;
+					System.out.println(&quot;Adresseintrag mit Person: &quot; + test);
+					test = &quot;&quot;;
+				} else {
+					test += address;
+					test += &quot;\n&quot;;
+					letter += test;
+					System.out.println(&quot;Adresseintrag: &quot; + test);
+					test = &quot;&quot;;
+				}
+			}
+		}
+		return letter;
+	}
+	
+	private void writeLetter(String letter, String fileName) {
+		File toFile = new File(&quot;/tmp/&quot; + fileName);
+		try {
+			FileWriter fw = new FileWriter(toFile, true);
+			fw.write(letter);
+			fw.close(); 
+			System.out.println(&quot;&gt;&gt;&gt; writeLetter(): written file successfully from: &quot; + toFile.getAbsolutePath());
+		} catch (IOException ex){
+			System.out.println(&quot;***: Error with writing File:&quot;);
+		}
+	}
+	
+	private String createTab() {
+		return &quot;\t&quot;;
+	}
+	
+	/**
+	 * First checks for Related Topic Name, if no relatedPerson looks for Related Info Person
+	 * 
+	 * @param bean
+	 * @return
+	 */
+	private String getRelatedPersonName(TopicBean bean) {
+		String relatedPerson = new String();
+		String firstName = bean.getValue(&quot;Person / First Name&quot;);
+		String lastName = bean.getValue(&quot;Person / Name&quot;);
+		Vector fullName = bean.getValues(&quot;Person&quot;);
+		// Check both types of related Person Topics
+		if (lastName != null &amp;&amp; !lastName.equals(&quot;&quot;)) {
+			// Person: Related Info | Related Deeply Info has at least a name
+			// String gender = bean.getValue(&quot;Person / Gender&quot;);
+			//relatedPerson =	!gender.equals(&quot;Female&quot;) ? &quot;Herr &quot; : &quot;Frau &quot;;
+			if (firstName != null &amp;&amp; !firstName.equals(&quot;&quot;)) {
+				relatedPerson += firstName + &quot; &quot; + lastName;
+			} else {
+				relatedPerson += lastName;
+			}
+			System.out.println(&quot;***getRelatedPerson(): There is a LastName, so: &quot; + relatedPerson);
+			return relatedPerson;
+		} else if (fullName != null &amp;&amp; fullName.size() &gt; 0) {
+			// Person: Related Topic Name has at least some attributes
+			BaseTopic person = (BaseTopic) fullName.get(0);
+			lastName = as.getTopicProperty(person, PROPERTY_NAME);
+			if (lastName.equals(&quot;&quot;)) {
+				// Found no name, so no 'ansprechpartner'
+				return relatedPerson;
+			} else {
+				// found a name via Related Topic Name
+				firstName = as.getTopicProperty(person, PROPERTY_FIRST_NAME);
+				if (!firstName.equals(&quot;&quot;)) {
+					relatedPerson += firstName;
+				}
+				relatedPerson += lastName;
+				System.out.println(&quot;***getRelatedPerson(): RelatedTopicName &quot; + relatedPerson);
+				return relatedPerson;
+				/* Commented out since Gender Prefix is prefilled in a lot of data fields
+				String gender = as.getTopicProperty(person, PROPERTY_GENDER);
+				if (!gender.equals(&quot;&quot;)) {
+					relatedPerson = !gender.equals(&quot;Female&quot;) ? &quot;Herr &quot; : &quot;Frau &quot;;
+				}*/
+			}
+		}		
+		return relatedPerson;
+	}
+	
+	public String getAddress(TopicBean bean) {
+		String address = &quot;&quot;;
+		// get Street &amp; Postal Code
+		String street = bean.getValue(&quot;Address / Street&quot;);
+		String postalCode = bean.getValue(&quot;Address / Postal Code&quot;);
+		if ( street != null &amp;&amp; postalCode != null ) {
+				address = street + createTab() + postalCode + createTab();
+				//System.out.println(&quot;**** found related address: &quot; + address.toString());	
+		} else {
+			return null;
+		}
+		// get City
+		String oldCityProp = bean.getValue(&quot;Stadt&quot;);
+		if (oldCityProp != null) {// != null &amp;&amp; oldCityProp.type == TopicBeanField.TYPE_SINGLE) {
+			address += oldCityProp;
+			System.out.println(&quot;*** found old \&quot;Stadt\&quot; Property. so City is: &quot; + address.toString());
+		} else {
+			String cityField = bean.getValue(&quot;Address / City&quot;);
+			if (cityField != null) { // != null &amp;&amp; cityField.type == TopicBeanField.TYPE_MULTI){
+				address += cityField;
+				System.out.println(&quot;**** found related city: &quot; + address.toString());	
+			}
+		}
+		return address;
+	}
+	
 	private Vector getWorkspaces(String userID) {
 		Vector workspaces = new Vector();
 		//
@@ -204,7 +492,17 @@
 		session.setAttribute(&quot;geo&quot;, geo);
 		System.out.println(&quot;&gt; \&quot;geo\&quot; stored in session: &quot; + geo);
 	}
+	
+	private void setSortField(String field, Session session) {
+		session.setAttribute(&quot;sortField&quot;, field);
+		System.out.println(&quot;&gt; \&quot;sortField\&quot; stored in session: &quot; + field);
+	}
 
+	private void setListedTopics(Vector beans, Session session) {
+		session.setAttribute(&quot;topics&quot;, beans);
+		System.out.println(&quot;&gt; \&quot;topics\&quot; stored in session: &quot; + beans.size());
+	}
+
 	// ---
 
 	private CityMapTopic getCityMap(Session session) {
@@ -218,4 +516,64 @@
 	private GeoObjectTopic getGeoObject(Session session) {
 		return (GeoObjectTopic) as.getLiveTopic((BaseTopic) session.getAttribute(&quot;geo&quot;));
 	}
+	
+	private String getSortByField(Session session) {
+		return (String) session.getAttribute(&quot;sortField&quot;);
+	}
+	
+	private Vector getListedTopics(Session session) {
+		return (Vector) session.getAttribute(&quot;topics&quot;);
+	}
+
+
+
+	// ********************************
+	// *** Inner Comparison Classes ***
+	// ********************************
+
+
+
+	private class MyStringComparator implements Comparator {
+		
+		private String sortBy;
+		
+		public MyStringComparator(String sortBy) {
+			this.sortBy = sortBy;
+		}
+		
+		public int compare( Object o1, Object o2 ) {
+			TopicBean beanOne = (TopicBean) o1;
+			TopicBean beanTwo = (TopicBean) o2;
+			//
+			String valOne = beanOne.getValue(sortBy);
+			String valTwo = beanTwo.getValue(sortBy);
+			//
+			// int i = prepairForCompare( valOne ).compareTo( prepairForCompare( valTwo ) );
+			int k = ((String)valOne).compareTo( (String)valTwo );
+			/*
+			if ( i != 0) {
+				System.out.println(&quot;&gt;&gt;&gt;&gt;i &quot;+ i +&quot; o1: &quot; + o1.toString() +&quot;, o2: &quot;+ o2.toString());
+			}
+			if ( i == 0 ) {
+				System.out.println(&quot;&gt;&gt;&gt;&gt;k &quot;+ k +&quot; o1: &quot; + o1.toString() +&quot;, o2: &quot;+ o2.toString());
+			}
+			*/
+			return k; // ( 0 != i ) ? i : k;
+		}
+
+		/**
+		 * Maybe not useful
+		 * 
+		 * @param o
+		 * @return
+		 */
+		private String prepairForCompare( Object o ) {
+			return ((String)o).toLowerCase().replace( '&#228;', 'a' )
+										.replace( '&#246;', 'o' )
+										.replace( '&#252;', 'u' )
+										.replace( '&#223;', 's' );
+		}
+
+	}
+	
 }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="000048.html">[Kiezatlas-svn] r59 - in trunk: images pages	src/de/kiezatlas/deepamehta
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#47">[ date ]</a>
              <a href="thread.html#47">[ thread ]</a>
              <a href="subject.html#47">[ subject ]</a>
              <a href="author.html#47">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">More information about the Kiezatlas-svn
mailing list</a><br>
</body></html>
