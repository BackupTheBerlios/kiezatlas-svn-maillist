<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Kiezatlas-svn] r17 - in trunk: pages src/de/kiezatlas/deepamehta	src/de/kiezatlas/deepamehta/topics
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/kiezatlas-svn/2007-October/index.html" >
   <LINK REL="made" HREF="mailto:kiezatlas-svn%40lists.berlios.de?Subject=Re%3A%20%5BKiezatlas-svn%5D%20r17%20-%20in%20trunk%3A%20pages%20src/de/kiezatlas/deepamehta%0A%09src/de/kiezatlas/deepamehta/topics&In-Reply-To=%3C200710151113.l9FBDVDs032121%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000008.html">
   <LINK REL="Next"  HREF="000010.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Kiezatlas-svn] r17 - in trunk: pages src/de/kiezatlas/deepamehta	src/de/kiezatlas/deepamehta/topics</H1>
    <B>maltito at mail.berlios.de</B> 
    <A HREF="mailto:kiezatlas-svn%40lists.berlios.de?Subject=Re%3A%20%5BKiezatlas-svn%5D%20r17%20-%20in%20trunk%3A%20pages%20src/de/kiezatlas/deepamehta%0A%09src/de/kiezatlas/deepamehta/topics&In-Reply-To=%3C200710151113.l9FBDVDs032121%40sheep.berlios.de%3E"
       TITLE="[Kiezatlas-svn] r17 - in trunk: pages src/de/kiezatlas/deepamehta	src/de/kiezatlas/deepamehta/topics">maltito at mail.berlios.de
       </A><BR>
    <I>Mon Oct 15 13:13:31 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000008.html">[Kiezatlas-svn] r16 - in trunk/src/de/kiezatlas/deepamehta: . topics
</A></li>
        <LI>Next message: <A HREF="000010.html">[Kiezatlas-svn] r18 - trunk/db/patches
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9">[ date ]</a>
              <a href="thread.html#9">[ thread ]</a>
              <a href="subject.html#9">[ subject ]</a>
              <a href="author.html#9">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: maltito
Date: 2007-10-15 13:12:54 +0200 (Mon, 15 Oct 2007)
New Revision: 17

Added:
   trunk/pages/GeoObjectForm.jsp
   trunk/pages/GeoObjectForum.jsp
   trunk/pages/GeoObjectHome.jsp
   trunk/pages/GeoObjectInfo.jsp
   trunk/pages/GeoObjectList.jsp
   trunk/pages/GeoObjectLogin.jsp
   trunk/src/de/kiezatlas/deepamehta/GeoObject.java
   trunk/src/de/kiezatlas/deepamehta/topics/GeoObjectTopic.java
Removed:
   trunk/pages/InstitutionForm.jsp
   trunk/pages/InstitutionForum.jsp
   trunk/pages/InstitutionHome.jsp
   trunk/pages/InstitutionInfo.jsp
   trunk/pages/InstitutionList.jsp
   trunk/pages/InstitutionLogin.jsp
   trunk/src/de/kiezatlas/deepamehta/Institution.java
   trunk/src/de/kiezatlas/deepamehta/topics/InstitutionTopic.java
Modified:
   trunk/pages/CityMap.jsp
   trunk/pages/CommentForm.jsp
   trunk/pages/ForumAdministration.jsp
   trunk/pages/KiezAtlas.jsp
   trunk/src/de/kiezatlas/deepamehta/BrowseServlet.java
   trunk/src/de/kiezatlas/deepamehta/EditServlet.java
   trunk/src/de/kiezatlas/deepamehta/KiezAtlas.java
   trunk/src/de/kiezatlas/deepamehta/topics/CityMapTopic.java
   trunk/src/de/kiezatlas/deepamehta/topics/FileImportTopic.java
Log:
refactored from Institution to GeoObject, added sql-patch for new data model 1.5

Modified: trunk/pages/CityMap.jsp
===================================================================
--- trunk/pages/CityMap.jsp	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/pages/CityMap.jsp	2007-10-15 11:12:54 UTC (rev 17)
@@ -14,7 +14,7 @@
 		Vector hotspots = (Vector) session.getAttribute(&quot;hotspots&quot;);
 		Vector shapeTypes = (Vector) session.getAttribute(&quot;shapeTypes&quot;);
 		Vector shapes = (Vector) session.getAttribute(&quot;shapes&quot;);
-		Institution selectedInst = (Institution) session.getAttribute(&quot;selectedInst&quot;);
+		GeoObject selectedInst = (GeoObject) session.getAttribute(&quot;selectedGeo&quot;);
 	%&gt;
 	&lt;img src=&quot;&lt;%= mapImage %&gt;&quot; style=&quot;position:absolute; top:0px; left:0px;&quot;&gt;
 	&lt;%
@@ -42,13 +42,13 @@
 				PresentableTopic inst = (PresentableTopic) e2.nextElement();
 				Point p = inst.getGeometry();
 				// marker
-				if (selectedInst != null &amp;&amp; selectedInst.id.equals(inst.getID())) {
+				if (selectedInst != null &amp;&amp; selectedInst.geoID.equals(inst.getID())) {
 					out.println(&quot;&lt;img src=\&quot;../images/marker.gif\&quot; style=\&quot;position:absolute; top:&quot; +
 						(p.y - 20) + &quot;px; left:&quot; + (p.x - 20) + &quot;px;\&quot;&gt;&quot;);
 				}
 				// hotspot
 				out.println(&quot;&lt;a href=\&quot;javascript:top.frames.right.location.href='controller?action=&quot; +
-					KiezAtlas.ACTION_SHOW_INSTITUTION_INFO + &quot;&amp;id=&quot; + inst.getID() + &quot;'\&quot;&gt;&quot; +
+					KiezAtlas.ACTION_SHOW_GEO_INFO + &quot;&amp;id=&quot; + inst.getID() + &quot;'\&quot;&gt;&quot; +
 					&quot;&lt;img src=\&quot;&quot; + icon + &quot;\&quot; style=\&quot;position:absolute; top:&quot; + (p.y - 10) + &quot;px; left:&quot; +
 					(p.x - 10) + &quot;px;\&quot; alt=\&quot;&quot; + inst.getName() + &quot;\&quot; title=\&quot;&quot; + inst.getName() + &quot;\&quot; border=\&quot;0\&quot;&gt;&lt;/a&gt;&quot;);
 			}

Modified: trunk/pages/CommentForm.jsp
===================================================================
--- trunk/pages/CommentForm.jsp	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/pages/CommentForm.jsp	2007-10-15 11:12:54 UTC (rev 17)
@@ -3,8 +3,8 @@
 &lt;% begin(session, out, false); %&gt;
 &lt;%
 	HTMLGenerator html = (HTMLGenerator) session.getAttribute(&quot;html&quot;);
-	Institution inst = (Institution) session.getAttribute(&quot;selectedInst&quot;);
-	Vector comments = (Vector) session.getAttribute(&quot;instComments&quot;);
+	GeoObject inst = (GeoObject) session.getAttribute(&quot;selectedGeo&quot;);
+	Vector comments = (Vector) session.getAttribute(&quot;geoComments&quot;);
 %&gt;
 	&lt;br&gt;&lt;br&gt;
 	&lt;p&gt;&lt;b&gt;&lt;%= inst.name %&gt; -- Forum&lt;/b&gt;&lt;/p&gt;
@@ -38,5 +38,5 @@
 		}
 	%&gt;
 	&lt;br&gt;
-	&lt;p&gt;&lt;%= html.link(&quot;Zur&uuml;ck zu &quot; + inst.name, KiezAtlas.ACTION_SHOW_INSTITUTION_INFO, &quot;id=&quot; + inst.id) %&gt;&lt;/p&gt;
+	&lt;p&gt;&lt;%= html.link(&quot;Zur&uuml;ck zu &quot; + inst.name, KiezAtlas.ACTION_SHOW_GEO_INFO, &quot;id=&quot; + inst.geoID) %&gt;&lt;/p&gt;
 &lt;% end(out); %&gt;

Modified: trunk/pages/ForumAdministration.jsp
===================================================================
--- trunk/pages/ForumAdministration.jsp	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/pages/ForumAdministration.jsp	2007-10-15 11:12:54 UTC (rev 17)
@@ -3,7 +3,7 @@
 &lt;% begin(session, out); %&gt;
 &lt;%
 	HTMLGenerator html = (HTMLGenerator) session.getAttribute(&quot;html&quot;);
-	BaseTopic inst = (BaseTopic) session.getAttribute(&quot;inst&quot;);
+	BaseTopic inst = (BaseTopic) session.getAttribute(&quot;geo&quot;);
 	String activition = (String) session.getAttribute(&quot;activition&quot;);
 	Vector comments = (Vector) session.getAttribute(&quot;comments&quot;);
 %&gt;

Added: trunk/pages/GeoObjectForm.jsp
===================================================================
--- trunk/pages/GeoObjectForm.jsp	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/pages/GeoObjectForm.jsp	2007-10-15 11:12:54 UTC (rev 17)
@@ -0,0 +1,23 @@
+&lt;%@ include file=&quot;KiezAtlas.jsp&quot; %&gt;
+
+&lt;% begin(session, out); %&gt;
+&lt;%!
+	static String[] hiddenProps = {
+		&quot;Name&quot;,
+		KiezAtlas.PROPERTY_DESCRIPTION,
+		KiezAtlas.PROPERTY_ICON,
+		KiezAtlas.PROPERTY_ADMINISTRATION_INFO,
+		&quot;City&quot;, &quot;Title&quot;, &quot;Content&quot;,
+		&quot;Width&quot;, &quot;Height&quot;};
+%&gt;
+&lt;%
+	HTMLGenerator html = (HTMLGenerator) session.getAttribute(&quot;html&quot;);
+	BaseTopic geo = (BaseTopic) session.getAttribute(&quot;geo&quot;);
+	//
+	// institution form
+	out.println(&quot;&lt;H2&gt;&quot; + geo.getName() + &quot;&lt;/H2&gt;&quot;);
+	out.println(&quot;&lt;H3&gt;&Auml;nderungsformular&lt;/H3&gt;&quot;);
+	out.println(html.form(geo.getType(), KiezAtlas.ACTION_UPDATE_GEO,
+						  geo.getID(), hiddenProps, true));
+%&gt;
+&lt;% end(out); %&gt;

Added: trunk/pages/GeoObjectForum.jsp
===================================================================
--- trunk/pages/GeoObjectForum.jsp	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/pages/GeoObjectForum.jsp	2007-10-15 11:12:54 UTC (rev 17)
@@ -0,0 +1,22 @@
+&lt;%@ include file=&quot;KiezAtlas.jsp&quot; %&gt;
+
+&lt;% begin(session, out, false); %&gt;
+&lt;%
+	HTMLGenerator html = (HTMLGenerator) session.getAttribute(&quot;html&quot;);
+	GeoObject geo = (GeoObject) session.getAttribute(&quot;selectedGeo&quot;);
+	Vector comments = (Vector) session.getAttribute(&quot;geoComments&quot;);
+%&gt;
+	&lt;br&gt;&lt;br&gt;
+	&lt;p&gt;&lt;b&gt;&lt;%= geo.name %&gt; -- Forum&lt;/b&gt;&lt;/p&gt;
+	&lt;p class=&quot;small&quot;&gt;Das Forum enth&auml;lt &lt;%= comments.size() %&gt; Kommentare&lt;/p&gt;
+	&lt;p&gt;&lt;%= html.link(&quot;Kommentar schreiben&quot;, KiezAtlas.ACTION_SHOW_COMMENT_FORM) %&gt;&lt;/p&gt;
+	&lt;%
+		Enumeration e = comments.elements();
+		while (e.hasMoreElements()) {
+			Comment comment = (Comment) e.nextElement();
+			comment(comment, out);
+		}
+	%&gt;
+	&lt;br&gt;
+	&lt;p&gt;&lt;%= html.link(&quot;Zur&uuml;ck zu &quot; + geo.name, KiezAtlas.ACTION_SHOW_GEO_INFO, &quot;id=&quot; + geo.geoID) %&gt;&lt;/p&gt;
+&lt;% end(out); %&gt;

Added: trunk/pages/GeoObjectHome.jsp
===================================================================
--- trunk/pages/GeoObjectHome.jsp	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/pages/GeoObjectHome.jsp	2007-10-15 11:12:54 UTC (rev 17)
@@ -0,0 +1,28 @@
+&lt;%@ include file=&quot;KiezAtlas.jsp&quot; %&gt;
+
+&lt;% begin(session, out); %&gt;
+&lt;%!
+	static String[] hiddenProps = {
+		KiezAtlas.PROPERTY_ICON,
+		KiezAtlas.PROPERTY_YADE_X,
+		KiezAtlas.PROPERTY_YADE_Y,
+		&quot;Width&quot;, &quot;Height&quot;};
+%&gt;
+&lt;%
+	HTMLGenerator html = (HTMLGenerator) session.getAttribute(&quot;html&quot;);
+	BaseTopic geo = (BaseTopic) session.getAttribute(&quot;geo&quot;);
+	String imagefile = (String) session.getAttribute(&quot;imagefile&quot;);
+	//
+	// institution info
+	out.println(&quot;&lt;H2&gt;&quot; + geo.getName() + &quot;&lt;/H2&gt;&quot;);
+	if (imagefile != null) {
+		out.println(&quot;&lt;img src=\&quot;&quot; + imagefile + &quot;\&quot;&gt;&lt;p&gt;&quot;);
+	}
+	out.println(html.info(geo.getID(), hiddenProps, true));
+	//
+	// link to form page
+	out.println(&quot;&lt;p&gt;\r&quot; + html.link(&quot;Zum &Auml;nderungsformular&quot;, KiezAtlas.ACTION_SHOW_GEO_FORM) + &quot;&lt;/p&gt;&quot;);
+	// link to forum administration page
+	out.println(&quot;&lt;p&gt;\r&lt;hr&gt;\r&quot; + html.link(&quot;Zur Forum Administration&quot;, KiezAtlas.ACTION_SHOW_FORUM_ADMINISTRATION) + &quot;&lt;/p&gt;&quot;);
+%&gt;
+&lt;% end(out); %&gt;

Added: trunk/pages/GeoObjectInfo.jsp
===================================================================
--- trunk/pages/GeoObjectInfo.jsp	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/pages/GeoObjectInfo.jsp	2007-10-15 11:12:54 UTC (rev 17)
@@ -0,0 +1,35 @@
+&lt;%@ include file=&quot;KiezAtlas.jsp&quot; %&gt;
+
+&lt;% begin(session, out, true); %&gt;
+&lt;%!
+	// don&#180;t know what to do with these lines, dropped unknown lines :)
+	static String[] hiddenProps = {
+		&quot;Name&quot;,
+		KiezAtlas.PROPERTY_PASSWORD,
+		KiezAtlas.PROPERTY_YADE_X,
+		KiezAtlas.PROPERTY_YADE_Y,
+		&quot;Width&quot;, &quot;Height&quot;};
+%&gt;
+&lt;%
+	HTMLGenerator html = (HTMLGenerator) session.getAttribute(&quot;html&quot;);
+	GeoObject geo = (GeoObject) session.getAttribute(&quot;selectedGeo&quot;);
+	SearchCriteria[] criterias = (SearchCriteria[]) session.getAttribute(&quot;criterias&quot;);
+	String forumActivition = (String) session.getAttribute(&quot;forumActivition&quot;);
+	Integer commentCount = (Integer) session.getAttribute(&quot;commentCount&quot;);
+
+	out.println(html.info(geo.geoID, hiddenProps, true));
+	
+	//out.println(geo.adminInfo);
+	//
+	if (forumActivition.equals(KiezAtlas.SWITCH_ON)) {
+		// link to forum page
+		out.println(&quot;&lt;p&gt;\r&lt;hr&gt;\rDas &quot; + html.link(&quot;Forum&quot;, KiezAtlas.ACTION_SHOW_GEO_FORUM) +
+			&quot; enth&auml;lt &quot;+ commentCount + &quot; Kommentare&lt;/p&gt;&quot;);
+	}
+	//
+	// link to form page
+	// out.println(&quot;&lt;p&gt;\r&quot; + html.link(&quot;Zum &Auml;nderungsformular&quot;, KiezAtlas.ACTION_SHOW_GEO_FORM) + &quot;&lt;/p&gt;&quot;);
+    // link to forum administration page
+	 out.println(&quot;&lt;p&gt;\r&lt;hr&gt;\r&quot; + html.link(&quot;Zum Forum &quot;, KiezAtlas.ACTION_SHOW_GEO_FORUM) + &quot;&lt;/p&gt;&quot;);
+%&gt;
+&lt;% end(out); %&gt;

Added: trunk/pages/GeoObjectList.jsp
===================================================================
--- trunk/pages/GeoObjectList.jsp	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/pages/GeoObjectList.jsp	2007-10-15 11:12:54 UTC (rev 17)
@@ -0,0 +1,46 @@
+&lt;%@ include file=&quot;KiezAtlas.jsp&quot; %&gt;
+
+&lt;% begin(session, out, true); %&gt;
+&lt;%
+	HTMLGenerator html = (HTMLGenerator) session.getAttribute(&quot;html&quot;);
+	Vector insts = (Vector) session.getAttribute(&quot;institutions&quot;);
+	Hashtable cats = (Hashtable) session.getAttribute(&quot;categories&quot;);
+	//Hashtable addresses = (Hashtable) session.getAttribute(&quot;addresses&quot;);
+	String searchMode = (String) session.getAttribute(&quot;searchMode&quot;);
+	String searchValue = (String) session.getAttribute(&quot;searchValue&quot;);
+	// --- heading ---
+	out.println(&quot;&lt;p&gt;&quot;);
+	if (searchMode.equals(KiezAtlas.SEARCHMODE_BY_NAME)) {
+		out.println(&quot;Suchergebnis &quot;);
+	}
+	out.println(&quot;&lt;b&gt;&quot; + searchValue + &quot;&lt;/b&gt;&lt;div class=\&quot;small\&quot;&gt;&quot; + insts.size() + &quot; Objekte&lt;/div&gt;&quot;);
+	out.println(&quot;&lt;p&gt;&quot;);
+	// --- list of institutions ---
+	out.println(&quot;&lt;table cellpadding=\&quot;4\&quot; cellspacing=\&quot;0\&quot;&gt;&quot;);
+	Enumeration e = insts.elements();
+	while (e.hasMoreElements()) {
+		BaseTopic inst = (BaseTopic) e.nextElement();
+		out.println(&quot;&lt;tr valign=\&quot;top\&quot;&gt;&quot;);
+		out.println(&quot;&lt;td align=\&quot;right\&quot;&gt;&quot;);
+		//topicImages((Vector) cats.get(inst.getID()), html, out);
+		out.println(&quot;&lt;/td&gt;&quot;);
+		out.println(&quot;&lt;td&gt;&quot;);
+		out.println(&quot;&lt;a href=\&quot;controller?action=&quot; + KiezAtlas.ACTION_SHOW_GEO_INFO + &quot;&amp;id=&quot; + inst.getID() +
+			&quot;\&quot;&gt;&quot; + inst.getName() + &quot;&lt;/a&gt;&quot;);
+		// address
+		//Hashtable address = (Hashtable) addresses.get(inst.getID());
+		//if (address != null) {
+		//	String street = (String) address.get(KiezAtlas.PROPERTY_STREET);
+	    //	String postcode = (String) address.get(KiezAtlas.PROPERTY_POSTAL_CODE);
+		//	String city = (String) address.get(KiezAtlas.PROPERTY_CITY);
+		//	if (street != null || postcode != null || city != null) {
+		//		out.println(&quot;&lt;br&gt;&lt;small&gt;&quot; + street + &quot;&nbsp;&nbsp;&nbsp;&quot; + postcode + &quot; &quot; + city + &quot;&lt;/small&gt;&quot;);
+		//	}
+		//}
+		out.println(&quot;&lt;/td&gt;&quot;);
+		out.println(&quot;&lt;/tr&gt;&quot;);
+	}
+	out.println(&quot;&lt;/table&gt;&quot;);
+	
+%&gt;
+&lt;% end(out); %&gt;

Added: trunk/pages/GeoObjectLogin.jsp
===================================================================
--- trunk/pages/GeoObjectLogin.jsp	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/pages/GeoObjectLogin.jsp	2007-10-15 11:12:54 UTC (rev 17)
@@ -0,0 +1,24 @@
+&lt;%@ include file=&quot;KiezAtlas.jsp&quot; %&gt;
+
+&lt;% begin(session, out); %&gt;
+&lt;%
+	HTMLGenerator html = (HTMLGenerator) session.getAttribute(&quot;html&quot;);
+	BaseTopic geo = (BaseTopic) session.getAttribute(&quot;geo&quot;);
+%&gt;
+&lt;h2&gt;&lt;%= geo.getName() %&gt;&lt;/h2&gt;
+&lt;form method=&quot;post&quot;&gt;
+	&lt;table&gt;
+		&lt;tr&gt;
+			&lt;td&gt;&lt;small&gt;Passwort&lt;/small&gt;&lt;/td&gt;
+			&lt;td&gt;&lt;input TYPE=&quot;Password&quot; NAME=&quot;Password&quot;&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td&gt;&lt;/td&gt;
+			&lt;td&gt;
+				&lt;input TYPE=&quot;Submit&quot; VALUE=&quot;Login&quot;&gt;
+				&lt;input TYPE=&quot;Hidden&quot; NAME=&quot;action&quot; VALUE=&quot;&lt;%= KiezAtlas.ACTION_TRY_LOGIN %&gt;&quot;&gt;
+			&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;
+&lt;/form&gt;
+&lt;% end(out); %&gt;

Deleted: trunk/pages/InstitutionForm.jsp
===================================================================
--- trunk/pages/InstitutionForm.jsp	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/pages/InstitutionForm.jsp	2007-10-15 11:12:54 UTC (rev 17)
@@ -1,27 +0,0 @@
-&lt;%@ include file=&quot;KiezAtlas.jsp&quot; %&gt;
-
-&lt;% begin(session, out); %&gt;
-&lt;%!
-	static String[] hiddenProps = {
-		&quot;Name&quot;,
-		KiezAtlas.PROPERTY_DESCRIPTION,
-		KiezAtlas.PROPERTY_ICON,
-		KiezAtlas.PROPERTY_WEB_ALIAS,
-		KiezAtlas.PROPERTY_BIRTHDAY,
-		KiezAtlas.PROPERTY_YADE_X,
-		KiezAtlas.PROPERTY_YADE_Y,
-		KiezAtlas.PROPERTY_ADMINISTRATION_INFO,
-		&quot;City&quot;, &quot;Title&quot;, &quot;Content&quot;,
-		&quot;Width&quot;, &quot;Height&quot;};
-%&gt;
-&lt;%
-	HTMLGenerator html = (HTMLGenerator) session.getAttribute(&quot;html&quot;);
-	BaseTopic inst = (BaseTopic) session.getAttribute(&quot;inst&quot;);
-	//
-	// institution form
-	out.println(&quot;&lt;H2&gt;&quot; + inst.getName() + &quot;&lt;/H2&gt;&quot;);
-	out.println(&quot;&lt;H3&gt;&Auml;nderungsformular&lt;/H3&gt;&quot;);
-	out.println(html.form(inst.getType(), KiezAtlas.ACTION_UPDATE_INSTITUTION,
-						  inst.getID(), hiddenProps, true));
-%&gt;
-&lt;% end(out); %&gt;

Deleted: trunk/pages/InstitutionForum.jsp
===================================================================
--- trunk/pages/InstitutionForum.jsp	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/pages/InstitutionForum.jsp	2007-10-15 11:12:54 UTC (rev 17)
@@ -1,22 +0,0 @@
-&lt;%@ include file=&quot;KiezAtlas.jsp&quot; %&gt;
-
-&lt;% begin(session, out, false); %&gt;
-&lt;%
-	HTMLGenerator html = (HTMLGenerator) session.getAttribute(&quot;html&quot;);
-	Institution inst = (Institution) session.getAttribute(&quot;selectedInst&quot;);
-	Vector comments = (Vector) session.getAttribute(&quot;instComments&quot;);
-%&gt;
-	&lt;br&gt;&lt;br&gt;
-	&lt;p&gt;&lt;b&gt;&lt;%= inst.name %&gt; -- Forum&lt;/b&gt;&lt;/p&gt;
-	&lt;p class=&quot;small&quot;&gt;Das Forum enth&auml;lt &lt;%= comments.size() %&gt; Kommentare&lt;/p&gt;
-	&lt;p&gt;&lt;%= html.link(&quot;Kommentar schreiben&quot;, KiezAtlas.ACTION_SHOW_COMMENT_FORM) %&gt;&lt;/p&gt;
-	&lt;%
-		Enumeration e = comments.elements();
-		while (e.hasMoreElements()) {
-			Comment comment = (Comment) e.nextElement();
-			comment(comment, out);
-		}
-	%&gt;
-	&lt;br&gt;
-	&lt;p&gt;&lt;%= html.link(&quot;Zur&uuml;ck zu &quot; + inst.name, KiezAtlas.ACTION_SHOW_INSTITUTION_INFO, &quot;id=&quot; + inst.id) %&gt;&lt;/p&gt;
-&lt;% end(out); %&gt;

Deleted: trunk/pages/InstitutionHome.jsp
===================================================================
--- trunk/pages/InstitutionHome.jsp	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/pages/InstitutionHome.jsp	2007-10-15 11:12:54 UTC (rev 17)
@@ -1,33 +0,0 @@
-&lt;%@ include file=&quot;KiezAtlas.jsp&quot; %&gt;
-
-&lt;% begin(session, out); %&gt;
-&lt;%!
-	static String[] hiddenProps = {
-		&quot;Name&quot;,
-		KiezAtlas.PROPERTY_DESCRIPTION,
-		KiezAtlas.PROPERTY_ICON,
-		KiezAtlas.PROPERTY_WEB_ALIAS,
-		KiezAtlas.PROPERTY_YADE_X,
-		KiezAtlas.PROPERTY_YADE_Y,
-		KiezAtlas.PROPERTY_ADMINISTRATION_INFO,
-		&quot;City&quot;, &quot;Title&quot;, &quot;Content&quot;,
-		&quot;Width&quot;, &quot;Height&quot;};
-%&gt;
-&lt;%
-	HTMLGenerator html = (HTMLGenerator) session.getAttribute(&quot;html&quot;);
-	BaseTopic inst = (BaseTopic) session.getAttribute(&quot;inst&quot;);
-	String imagefile = (String) session.getAttribute(&quot;imagefile&quot;);
-	//
-	// institution info
-	out.println(&quot;&lt;H2&gt;&quot; + inst.getName() + &quot;&lt;/H2&gt;&quot;);
-	if (imagefile != null) {
-		out.println(&quot;&lt;img src=\&quot;&quot; + imagefile + &quot;\&quot;&gt;&lt;p&gt;&quot;);
-	}
-	out.println(html.info(inst.getID(), hiddenProps, true));
-	//
-	// link to form page
-	out.println(&quot;&lt;p&gt;\r&quot; + html.link(&quot;Zum &Auml;nderungsformular&quot;, KiezAtlas.ACTION_SHOW_INSTITUTION_FORM) + &quot;&lt;/p&gt;&quot;);
-	// link to forum administration page
-	out.println(&quot;&lt;p&gt;\r&lt;hr&gt;\r&quot; + html.link(&quot;Zur Forum Administration&quot;, KiezAtlas.ACTION_SHOW_FORUM_ADMINISTRATION) + &quot;&lt;/p&gt;&quot;);
-%&gt;
-&lt;% end(out); %&gt;

Deleted: trunk/pages/InstitutionInfo.jsp
===================================================================
--- trunk/pages/InstitutionInfo.jsp	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/pages/InstitutionInfo.jsp	2007-10-15 11:12:54 UTC (rev 17)
@@ -1,50 +0,0 @@
-&lt;%@ include file=&quot;KiezAtlas.jsp&quot; %&gt;
-
-&lt;% begin(session, out, true); %&gt;
-&lt;%
-	HTMLGenerator html = (HTMLGenerator) session.getAttribute(&quot;html&quot;);
-	Institution inst = (Institution) session.getAttribute(&quot;selectedInst&quot;);
-	SearchCriteria[] criterias = (SearchCriteria[]) session.getAttribute(&quot;criterias&quot;);
-	String forumActivition = (String) session.getAttribute(&quot;forumActivition&quot;);
-	Integer commentCount = (Integer) session.getAttribute(&quot;commentCount&quot;);
-	//
-	out.println(inst.imageURL != null ? &quot;&lt;p&gt;&lt;img src=\&quot;&quot; + inst.imageURL + &quot;\&quot;&gt;&lt;br&gt;&quot; : &quot;&lt;br&gt;&lt;br&gt;&quot;);
-	out.println(&quot;&lt;b&gt;&quot; + inst.name + &quot;&lt;/b&gt;&lt;br&gt;&quot;);
-	if (isSet(inst.street)) {
-		out.println(mapLink(inst.street, inst.postalCode, inst.city) + &quot;&lt;br&gt;&quot;);
-	}
-	out.println(inst.postalCode + &quot; &quot; + inst.city + &quot;&lt;p&gt;&quot;);
-	//
-	out.println(&quot;&lt;span class=\&quot;small\&quot;&gt;&Ouml;ffnungszeiten:&lt;/span&gt; &quot; + inst.open + &quot;&lt;p&gt;&quot;);
-	//
-	out.println(&quot;&lt;span class=\&quot;small\&quot;&gt;Tel:&lt;/span&gt; &quot; + inst.phone + &quot;&lt;br&gt;&quot;);
-	out.println(&quot;&lt;span class=\&quot;small\&quot;&gt;Fax:&lt;/span&gt; &quot; + inst.fax + &quot;&lt;br&gt;&quot;);
-	out.println(&quot;&lt;span class=\&quot;small\&quot;&gt;Ansprechpartner/in:&lt;/span&gt; &quot; + inst.person + &quot;&lt;br&gt;&quot;);
-	out.println(&quot;&lt;span class=\&quot;small\&quot;&gt;Email:&lt;/span&gt; &quot; +
-		&quot;&lt;a href=\&quot;mailto:&quot; + inst.email + &quot;\&quot;&gt;&quot; + inst.email + &quot;&lt;/a&gt;&lt;br&gt;&quot;);
-	out.println(&quot;&lt;span class=\&quot;small\&quot;&gt;Website:&lt;/span&gt; &quot; +
-		&quot;&lt;a href=\&quot;&quot; + inst.webpageURL + &quot;\&quot; target=\&quot;_bank\&quot;&gt;&quot; + inst.webpageURL + &quot;&lt;/a&gt;&quot;);
-	//
-	for (int i = 0; i &lt; criterias.length; i++) {
-		String critName = criterias[i].criteria.getPluralName();
-		out.println(&quot;&lt;p&gt;&lt;div class=\&quot;small\&quot;&gt;&quot; + critName + &quot;:&lt;/div&gt;&quot;);
-		topicList(inst.categories[i], KiezAtlas.ACTION_SEARCH_BY_CATEGORY + &quot;&amp;critNr=&quot; + i, html, out);
-	}
-	//
-	out.println(&quot;&lt;p&gt;&lt;span class=\&quot;small\&quot;&gt;Tr&auml;ger:&lt;/span&gt; &quot; + inst.traeger +
-		(isSet(inst.traegerArt) ? &quot; (&quot; + inst.traegerArt + &quot;)&quot; : &quot;&quot;));
-	//
-	out.println(&quot;&lt;p&gt;&lt;div class=\&quot;small\&quot;&gt;Weitere Infos:&lt;/div&gt;&quot;);
-	out.println(inst.misc);
-	if (isSet(inst.misc) &amp;&amp; isSet(inst.adminInfo)) {
-		out.println(&quot;&lt;p&gt;&quot;);
-	}
-	out.println(inst.adminInfo);
-	//
-	if (forumActivition.equals(KiezAtlas.SWITCH_ON)) {
-		// link to forum page
-		out.println(&quot;&lt;p&gt;\r&lt;hr&gt;\rDas &quot; + html.link(&quot;Forum&quot;, KiezAtlas.ACTION_SHOW_INSTITUTION_FORUM) +
-			&quot; enth&auml;lt &quot;+ commentCount + &quot; Kommentare&lt;/p&gt;&quot;);
-	}
-%&gt;
-&lt;% end(out); %&gt;

Deleted: trunk/pages/InstitutionList.jsp
===================================================================
--- trunk/pages/InstitutionList.jsp	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/pages/InstitutionList.jsp	2007-10-15 11:12:54 UTC (rev 17)
@@ -1,46 +0,0 @@
-&lt;%@ include file=&quot;KiezAtlas.jsp&quot; %&gt;
-
-&lt;% begin(session, out, true); %&gt;
-&lt;%
-	HTMLGenerator html = (HTMLGenerator) session.getAttribute(&quot;html&quot;);
-	Vector insts = (Vector) session.getAttribute(&quot;institutions&quot;);
-	Hashtable cats = (Hashtable) session.getAttribute(&quot;categories&quot;);
-	Hashtable addresses = (Hashtable) session.getAttribute(&quot;addresses&quot;);
-	String searchMode = (String) session.getAttribute(&quot;searchMode&quot;);
-	String searchValue = (String) session.getAttribute(&quot;searchValue&quot;);
-	// --- heading ---
-	out.println(&quot;&lt;p&gt;&quot;);
-	if (searchMode.equals(KiezAtlas.SEARCHMODE_BY_NAME)) {
-		out.println(&quot;Suchergebnis &quot;);
-	}
-	out.println(&quot;&lt;b&gt;&quot; + searchValue + &quot;&lt;/b&gt;&lt;div class=\&quot;small\&quot;&gt;&quot; + insts.size() + &quot; Einrichtungen&lt;/div&gt;&quot;);
-	out.println(&quot;&lt;p&gt;&quot;);
-	// --- list of institutions ---
-	out.println(&quot;&lt;table cellpadding=\&quot;4\&quot; cellspacing=\&quot;0\&quot;&gt;&quot;);
-	Enumeration e = insts.elements();
-	while (e.hasMoreElements()) {
-		BaseTopic inst = (BaseTopic) e.nextElement();
-		out.println(&quot;&lt;tr valign=\&quot;top\&quot;&gt;&quot;);
-		out.println(&quot;&lt;td align=\&quot;right\&quot;&gt;&quot;);
-		topicImages((Vector) cats.get(inst.getID()), html, out);
-		out.println(&quot;&lt;/td&gt;&quot;);
-		out.println(&quot;&lt;td&gt;&quot;);
-		out.println(&quot;&lt;a href=\&quot;controller?action=&quot; + KiezAtlas.ACTION_SHOW_INSTITUTION_INFO + &quot;&amp;id=&quot; + inst.getID() +
-			&quot;\&quot;&gt;&quot; + inst.getName() + &quot;&lt;/a&gt;&quot;);
-		// address
-		Hashtable address = (Hashtable) addresses.get(inst.getID());
-		if (address != null) {
-			String street = (String) address.get(KiezAtlas.PROPERTY_STREET);
-			String postcode = (String) address.get(KiezAtlas.PROPERTY_POSTAL_CODE);
-			String city = (String) address.get(KiezAtlas.PROPERTY_CITY);
-			if (street != null || postcode != null || city != null) {
-				out.println(&quot;&lt;br&gt;&lt;small&gt;&quot; + street + &quot;&nbsp;&nbsp;&nbsp;&quot; + postcode + &quot; &quot; + city + &quot;&lt;/small&gt;&quot;);
-			}
-		}
-		out.println(&quot;&lt;/td&gt;&quot;);
-		out.println(&quot;&lt;/tr&gt;&quot;);
-	}
-	out.println(&quot;&lt;/table&gt;&quot;);
-	
-%&gt;
-&lt;% end(out); %&gt;

Deleted: trunk/pages/InstitutionLogin.jsp
===================================================================
--- trunk/pages/InstitutionLogin.jsp	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/pages/InstitutionLogin.jsp	2007-10-15 11:12:54 UTC (rev 17)
@@ -1,24 +0,0 @@
-&lt;%@ include file=&quot;KiezAtlas.jsp&quot; %&gt;
-
-&lt;% begin(session, out); %&gt;
-&lt;%
-	HTMLGenerator html = (HTMLGenerator) session.getAttribute(&quot;html&quot;);
-	BaseTopic inst = (BaseTopic) session.getAttribute(&quot;inst&quot;);
-%&gt;
-&lt;h2&gt;&lt;%= inst.getName() %&gt;&lt;/h2&gt;
-&lt;form method=&quot;post&quot;&gt;
-	&lt;table&gt;
-		&lt;tr&gt;
-			&lt;td&gt;&lt;small&gt;Passwort&lt;/small&gt;&lt;/td&gt;
-			&lt;td&gt;&lt;input TYPE=&quot;Password&quot; NAME=&quot;Password&quot;&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-		&lt;tr&gt;
-			&lt;td&gt;&lt;/td&gt;
-			&lt;td&gt;
-				&lt;input TYPE=&quot;Submit&quot; VALUE=&quot;Login&quot;&gt;
-				&lt;input TYPE=&quot;Hidden&quot; NAME=&quot;action&quot; VALUE=&quot;&lt;%= KiezAtlas.ACTION_TRY_LOGIN %&gt;&quot;&gt;
-			&lt;/td&gt;
-		&lt;/tr&gt;
-	&lt;/table&gt;
-&lt;/form&gt;
-&lt;% end(out); %&gt;

Modified: trunk/pages/KiezAtlas.jsp
===================================================================
--- trunk/pages/KiezAtlas.jsp	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/pages/KiezAtlas.jsp	2007-10-15 11:12:54 UTC (rev 17)
@@ -1,5 +1,5 @@
 &lt;%@ page import=&quot;de.kiezatlas.deepamehta.KiezAtlas&quot; %&gt;
-&lt;%@ page import=&quot;de.kiezatlas.deepamehta.Institution&quot; %&gt;
+&lt;%@ page import=&quot;de.kiezatlas.deepamehta.GeoObject&quot; %&gt;
 &lt;%@ page import=&quot;de.kiezatlas.deepamehta.SearchCriteria&quot; %&gt;
 &lt;%@ page import=&quot;de.kiezatlas.deepamehta.ShapeType&quot; %&gt;
 &lt;%@ page import=&quot;de.kiezatlas.deepamehta.Shape&quot; %&gt;

Modified: trunk/src/de/kiezatlas/deepamehta/BrowseServlet.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/BrowseServlet.java	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/src/de/kiezatlas/deepamehta/BrowseServlet.java	2007-10-15 11:12:54 UTC (rev 17)
@@ -1,8 +1,17 @@
 package de.kiezatlas.deepamehta;
 
-import de.kiezatlas.deepamehta.topics.CityMapTopic;
-import de.kiezatlas.deepamehta.topics.InstitutionTopic;
-//
+import java.awt.Dimension;
+import java.awt.Image;
+import java.awt.Point;
+import java.awt.Toolkit;
+import java.net.URL;
+import java.util.Enumeration;
+import java.util.Hashtable;
+import java.util.Vector;
+
+import javax.servlet.ServletException;
+import javax.swing.ImageIcon;
+
 import de.deepamehta.BaseTopic;
 import de.deepamehta.DeepaMehtaException;
 import de.deepamehta.PresentableTopic;
@@ -10,30 +19,21 @@
 import de.deepamehta.service.web.DeepaMehtaServlet;
 import de.deepamehta.service.web.RequestParameter;
 import de.deepamehta.service.web.WebSession;
+import de.deepamehta.topics.EmailTopic;
 import de.deepamehta.topics.TypeTopic;
-import de.deepamehta.topics.EmailTopic;
 import de.deepamehta.util.DeepaMehtaUtils;
-//
-import javax.servlet.ServletException;
-import javax.servlet.http.HttpServletRequest;
-import javax.swing.ImageIcon;
-//
-import java.awt.Image;
-import java.awt.Point;
-import java.awt.Dimension;
-import java.awt.Toolkit;
-import java.net.URL;
-import java.util.*;
+import de.kiezatlas.deepamehta.topics.CityMapTopic;
+import de.kiezatlas.deepamehta.topics.GeoObjectTopic;
 
 
 
 /**
- * Kiez-Atlas 1.4.1&lt;br&gt;
+ * Kiez-Atlas 1.5&lt;br&gt;
  * Requires DeepaMehta 2.0b7-post1
  * &lt;p&gt;
- * Last change: 9.10.2007&lt;br&gt;
- * J&ouml;rg Richter&lt;br&gt;
- * <A HREF="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">jri at freenet.de</A>
+ * Last change: 15.10.2007&lt;br&gt;
+ * Malte Rei&szlig;ig&lt;br&gt;
+ * <A HREF="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">mre at deepamehta.de</A>
  */
 public class BrowseServlet extends DeepaMehtaServlet implements KiezAtlas {
 
@@ -80,7 +80,7 @@
 					// otherwise list all institutions
 					setSearchMode(SEARCHMODE_BY_NAME, session);
 					setSearchValue(&quot;&quot;, session);	// searching for &quot;&quot; retrieves all institutions
-					return PAGE_INSTITUTION_LIST;
+					return PAGE_GEO_LIST;
 				}
 			} else {
 				throw new DeepaMehtaException(&quot;unexpected frame \&quot;&quot; + frame + &quot;\&quot;&quot;);
@@ -89,7 +89,7 @@
 		} else if (action.equals(ACTION_SEARCH)) {
 			setSearchMode(SEARCHMODE_BY_NAME, session);
 			setSearchValue(params.getValue(&quot;search&quot;), session);
-			return PAGE_INSTITUTION_LIST;
+			return PAGE_GEO_LIST;
 		// show
 		} else if (action.equals(ACTION_SHOW_CATEGORIES)) {
 			String critNr = params.getValue(&quot;critNr&quot;);
@@ -114,22 +114,23 @@
 			// ### setSearchMode(SEARCHMODE_BY_CATEGORY, session);		// needed for &quot;cross-links&quot;
 			Vector selCats = getSelectedCats(session);
 			switchOn(selCats, catID);
-			return PAGE_INSTITUTION_LIST;
+			return PAGE_GEO_LIST;
 		// info
-		} else if (action.equals(ACTION_SHOW_INSTITUTION_INFO)) {
-			String instID = params.getValue(&quot;id&quot;);
-			setSelectedInst(instID, session);
-			//
-			InstitutionTopic inst = (InstitutionTopic) as.getLiveTopic(instID, 1);
-			boolean isForumActivated = inst.isForumActivated();
-			session.setAttribute(&quot;forumActivition&quot;, isForumActivated ? SWITCH_ON : SWITCH_OFF);
-			if (isForumActivated) {
-				session.setAttribute(&quot;commentCount&quot;, new Integer(inst.getComments().size()));
-			}
-			return PAGE_INSTITUTION_INFO;
-		// show forum
-		} else if (action.equals(ACTION_SHOW_INSTITUTION_FORUM)) {
-			return PAGE_INSTITUTION_FORUM;
+		} else if (action.equals(ACTION_SHOW_GEO_INFO)) {
+				String geoID = params.getValue(&quot;id&quot;);
+				System.out.println(&quot;@params: &quot; + params.getValue(&quot;id&quot;));
+				setSelectedGeo(geoID, session);
+				//
+				GeoObjectTopic geo = (GeoObjectTopic) as.getLiveTopic(geoID, 1);
+				boolean isForumActivated = geo.isForumActivated();
+				session.setAttribute(&quot;forumActivition&quot;, isForumActivated ? SWITCH_ON : SWITCH_OFF);
+				if (isForumActivated) {
+					session.setAttribute(&quot;commentCount&quot;, new Integer(geo.getComments().size()));
+				}
+				return PAGE_GEO_INFO;
+		// TODO show forum if wanted
+		} else if (action.equals(ACTION_SHOW_GEO_FORUM)) {
+			return PAGE_GEO_FORUM;
 		// show comment form
 		} else if (action.equals(ACTION_SHOW_COMMENT_FORM)) {
 			// Note: &quot;instComments&quot; are still in the session
@@ -141,20 +142,23 @@
 			as.setTopicProperty(commentID, 1, PROPERTY_COMMENT_DATE, DeepaMehtaUtils.getDate());
 			as.setTopicProperty(commentID, 1, PROPERTY_COMMENT_TIME, DeepaMehtaUtils.getTime());
 			// associate comment with forum
-			InstitutionTopic inst = getSelectedInst(session);
-			String forumID = inst.getForum().getID();
+			GeoObjectTopic geo = getSelectedGeo(session);
+			String forumID = geo.getForum().getID();
 			String assocID = as.getNewAssociationID();
 			cm.createAssociation(assocID, 1, SEMANTIC_FORUM_COMMENTS, 1, forumID, 1, commentID, 1);
 			// send notification email
-			sendNotificationEmail(inst.getID(), commentID);
+			// sendNotificationEmail(inst.getID(), commentID);
 			//
-			return PAGE_INSTITUTION_FORUM;
+			return PAGE_GEO_FORUM;
 		// shape display
 		} else if (action.equals(ACTION_TOGGLE_SHAPE_DISPLAY)) {
 			String shapeTypeID = params.getValue(&quot;typeID&quot;);
 			toggleShapeDisplay(shapeTypeID, session);
 			updateShapes(session);
 			return PAGE_CITY_MAP;
+		} else if (action.equals(ACTION_SHOW_GEO_FORM)) {
+			//should this  be possible from the browseServlet, if so the action has to redirect to edit/GeoLogin or am i wrong? 
+			return PAGE_GEO_FORM;
 		} else {
 			return super.performAction(action, params, session);
 		}
@@ -169,8 +173,8 @@
 			// hotspots
 			setCategoryHotspots(session);
 			// clear marker
-			setSelectedInst(null, session);
-		} else if (page.equals(PAGE_INSTITUTION_LIST)) {
+			setSelectedGeo(null, session);
+		} else if (page.equals(PAGE_GEO_LIST)) {
 			// institutions
 			String mapID = getCityMap(session).getID();
 			String instTypeID = getInstitutionType(session).getID();
@@ -193,28 +197,28 @@
 			for (int i = 0; i &lt; insts.size(); i++) {
 				BaseTopic t = (BaseTopic) insts.elementAt(i);
 				try {
-					InstitutionTopic inst = (InstitutionTopic) as.getLiveTopic(t);
+					GeoObjectTopic inst = (GeoObjectTopic) as.getLiveTopic(t);
 					// categories
 					String critTypeID = getCriteria(0, session).criteria.getID();
 					categories.put(inst.getID(), inst.getCategories(critTypeID));
 					// address
-					BaseTopic address = inst.getAddress();
-					if (address != null) {
-						Hashtable addressProps = as.getTopicProperties(address);
-						addressProps.put(PROPERTY_CITY, inst.getCity());
-						addresses.put(inst.getID(), addressProps);
-					}
+//					BaseTopic address = inst.getAddress();
+//					if (address != null) {
+//						Hashtable addressProps = as.getTopicProperties(address);
+//						addressProps.put(PROPERTY_CITY, inst.getCity());
+//						addresses.put(inst.getID(), addressProps);
+//					}
 				} catch (ClassCastException e) {
 					System.out.println(&quot;*** BrowseServlet.preparePage(): &quot; + t + &quot;: &quot; + e);
-					// ### happens if institution type is not up to date
+					// ### happens if geo object type is not up to date
 				}
 			}
 			session.setAttribute(&quot;categories&quot;, categories);
-			session.setAttribute(&quot;addresses&quot;, addresses);
+//			session.setAttribute(&quot;addresses&quot;, addresses);
 			// clear marker
-			setSelectedInst(null, session);
-		} else if (page.equals(PAGE_INSTITUTION_FORUM)) {
-			session.setAttribute(&quot;instComments&quot;, getSelectedInst(session).getCommentBeans());
+			setSelectedGeo(null, session);
+		} else if (page.equals(PAGE_GEO_FORUM)) {
+			session.setAttribute(&quot;geoComments&quot;, getSelectedGeo(session).getCommentBeans());
 		}
 	}
 
@@ -242,49 +246,49 @@
 
 	// ---
 
-	private void sendNotificationEmail(String instID, String commentID) {
-		try {
-			InstitutionTopic inst = (InstitutionTopic) as.getLiveTopic(instID, 1);
-			// &quot;from&quot;
-			String from = as.getEmailAddress(&quot;t-rootuser&quot;);		// ###
-			if (from == null || from.equals(&quot;&quot;)) {
-				throw new DeepaMehtaException(&quot;email address of root user is unknown&quot;);
-			}
-			// &quot;to&quot;
-			BaseTopic email = inst.getEmail();
-			if (email == null || email.getName().equals(&quot;&quot;)) {
-				throw new DeepaMehtaException(&quot;email address of \&quot;&quot; + inst.getName() + &quot;\&quot; is unknown&quot;);
-			}
-			String to = email.getName();
-			// &quot;subject&quot;
-			String subject = &quot;Kiezatlas: neuer Forumsbeitrag f&#195;&#188;r \&quot;&quot; + inst.getName() + &quot;\&quot;&quot;;
-			// &quot;body&quot;
-			Hashtable comment = cm.getTopicData(commentID, 1);
-			String body = &quot;Dies ist eine automatische Benachrichtigung von www.kiezatlas.de\r\r&quot; +
-				&quot;Im Forum der Einrichtung \&quot;&quot; + inst.getName() + &quot;\&quot; wurde ein neuer Kommentar eingetragen:\r\r&quot; +
-				&quot;------------------------------\r&quot; +
-				comment.get(PROPERTY_TEXT) + &quot;\r\r&quot; +
-				&quot;Autor: &quot; + comment.get(PROPERTY_COMMENT_AUTHOR) + &quot;\r&quot; +
-				&quot;Email: &quot; + comment.get(PROPERTY_EMAIL_ADDRESS) + &quot;\r&quot; +
-				&quot;Datum: &quot; + comment.get(PROPERTY_COMMENT_DATE) + &quot;\r&quot; +
-				&quot;Uhrzeit: &quot; + comment.get(PROPERTY_COMMENT_TIME) + &quot;\r&quot; +
-				&quot;------------------------------\r\r&quot; +
-				&quot;Im Falle des Mi&#195;&#159;brauchs: In der \&quot;Forum Administration\&quot; ihres pers&#195;&#182;nlichen Kiezatlas-Zugangs haben &quot; +
-				&quot;Sie die M&#195;&#182;glichkeit, einzelne Kommentare zu l&#195;&#182;schen, bzw. das Forum ganz zu deaktivieren.\r&quot; +
-				&quot;www.kiezatlas.de:8080/edit/&quot; + inst.getWebAlias() + &quot;\r\r&quot; +
-				&quot;Mit freundlichen Gr&#195;&#188;&#195;&#159;en\r&quot; +
-				&quot;ihr Kiezatlas-Team&quot;;
-			//
-			System.out.println(&quot;&gt;&gt;&gt; send notification email&quot;);
-			System.out.println(&quot;  &gt; SMTP server: \&quot;&quot; + as.getSMTPServer() + &quot;\&quot;&quot;);	// as.getSMTPServer() throws DME
-			System.out.println(&quot;  &gt; from: \&quot;&quot; + from + &quot;\&quot;&quot;);
-			System.out.println(&quot;  &gt; to: \&quot;&quot; + to + &quot;\&quot;&quot;);
-			// send email
-			EmailTopic.sendMail(as.getSMTPServer(), from, to, subject, body);		// EmailTopic.sendMail() throws DME
-		} catch (Exception e) {
-			System.out.println(&quot;*** notification email not send (&quot; + e + &quot;)&quot;);
-		}
-	}
+//	private void sendNotificationEmail(String instID, String commentID) {
+//		try {
+//			GeoObjectTopic inst = (GeoObjectTopic) as.getLiveTopic(instID, 1);
+//			// &quot;from&quot;
+//			String from = as.getEmailAddress(&quot;t-rootuser&quot;);		// ###
+//			if (from == null || from.equals(&quot;&quot;)) {
+//				throw new DeepaMehtaException(&quot;email address of root user is unknown&quot;);
+//			}
+//			// &quot;to&quot;
+//			BaseTopic email = inst.getEmail();
+//			if (email == null || email.getName().equals(&quot;&quot;)) {
+//				throw new DeepaMehtaException(&quot;email address of \&quot;&quot; + inst.getName() + &quot;\&quot; is unknown&quot;);
+//			}
+//			String to = email.getName();
+//			// &quot;subject&quot;
+//			String subject = &quot;Kiezatlas: neuer Forumsbeitrag f&#195;&#188;r \&quot;&quot; + inst.getName() + &quot;\&quot;&quot;;
+//			// &quot;body&quot;
+//			Hashtable comment = cm.getTopicData(commentID, 1);
+//			String body = &quot;Dies ist eine automatische Benachrichtigung von www.kiezatlas.de\r\r&quot; +
+//				&quot;Im Forum der Einrichtung \&quot;&quot; + inst.getName() + &quot;\&quot; wurde ein neuer Kommentar eingetragen:\r\r&quot; +
+//				&quot;------------------------------\r&quot; +
+//				comment.get(PROPERTY_TEXT) + &quot;\r\r&quot; +
+//				&quot;Autor: &quot; + comment.get(PROPERTY_COMMENT_AUTHOR) + &quot;\r&quot; +
+//				&quot;Email: &quot; + comment.get(PROPERTY_EMAIL_ADDRESS) + &quot;\r&quot; +
+//				&quot;Datum: &quot; + comment.get(PROPERTY_COMMENT_DATE) + &quot;\r&quot; +
+//				&quot;Uhrzeit: &quot; + comment.get(PROPERTY_COMMENT_TIME) + &quot;\r&quot; +
+//				&quot;------------------------------\r\r&quot; +
+//				&quot;Im Falle des Mi&#195;&#159;brauchs: In der \&quot;Forum Administration\&quot; ihres pers&#195;&#182;nlichen Kiezatlas-Zugangs haben &quot; +
+//				&quot;Sie die M&#195;&#182;glichkeit, einzelne Kommentare zu l&#195;&#182;schen, bzw. das Forum ganz zu deaktivieren.\r&quot; +
+//				&quot;www.kiezatlas.de:8080/edit/&quot; + inst.getWebAlias() + &quot;\r\r&quot; +
+//				&quot;Mit freundlichen Gr&#195;&#188;&#195;&#159;en\r&quot; +
+//				&quot;ihr Kiezatlas-Team&quot;;
+//			//
+//			System.out.println(&quot;&gt;&gt;&gt; send notification email&quot;);
+//			System.out.println(&quot;  &gt; SMTP server: \&quot;&quot; + as.getSMTPServer() + &quot;\&quot;&quot;);	// as.getSMTPServer() throws DME
+//			System.out.println(&quot;  &gt; from: \&quot;&quot; + from + &quot;\&quot;&quot;);
+//			System.out.println(&quot;  &gt; to: \&quot;&quot; + to + &quot;\&quot;&quot;);
+//			// send email
+//			EmailTopic.sendMail(as.getSMTPServer(), from, to, subject, body);		// EmailTopic.sendMail() throws DME
+//		} catch (Exception e) {
+//			System.out.println(&quot;*** notification email not send (&quot; + e + &quot;)&quot;);
+//		}
+//	}
 
 
 
@@ -340,10 +344,10 @@
 		session.setAttribute(&quot;shapeTypes&quot;, shapeTypes);
 	}
 
-	private void setSelectedInst(String instID, Session session) {
-		Institution institution = instID != null ? new Institution(instID, getCriterias(session), as) : null;
-		session.setAttribute(&quot;selectedInst&quot;, institution);
-		System.out.println(&quot;&gt; \&quot;selectedInst\&quot; stored in session: &quot; + institution);
+	private void setSelectedGeo(String geoID, Session session) {
+		GeoObject geo = geoID != null ? new GeoObject(geoID, getCriterias(session), as) : null;
+		session.setAttribute(&quot;selectedGeo&quot;, geo);
+		System.out.println(&quot;&gt; \&quot;selectedGeoObject\&quot; stored in session: &quot; + geo);
 	}
 
 	// ---
@@ -480,8 +484,8 @@
 
 	// ---
 
-	private InstitutionTopic getSelectedInst(Session session) {
-		return (InstitutionTopic) as.getLiveTopic(((Institution) session.getAttribute(&quot;selectedInst&quot;)).id, 1);
+	private GeoObjectTopic getSelectedGeo(Session session) {
+		return (GeoObjectTopic) as.getLiveTopic(((GeoObject) session.getAttribute(&quot;selectedGeo&quot;)).geoID, 1);
 	}
 
 	private Vector getSelectedCats(Session session) {

Modified: trunk/src/de/kiezatlas/deepamehta/EditServlet.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/EditServlet.java	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/src/de/kiezatlas/deepamehta/EditServlet.java	2007-10-15 11:12:54 UTC (rev 17)
@@ -1,6 +1,6 @@
 package de.kiezatlas.deepamehta;
 
-import de.kiezatlas.deepamehta.topics.InstitutionTopic;
+import de.kiezatlas.deepamehta.topics.GeoObjectTopic;
 //
 import de.deepamehta.BaseTopic;
 import de.deepamehta.DeepaMehtaException;
@@ -17,9 +17,8 @@
 import org.apache.commons.fileupload.FileItem;
 
 
-
 /**
- * Kiez-Atlas 1.4.1.&lt;br&gt;
+ * Kiez-Atlas 1.4.1.&lt;br&gt;Institution
  * Requires DeepaMehta 2.0b7-post1.
  * &lt;p&gt;
  * Last functional change: 17.3.2007&lt;br&gt;
@@ -38,8 +37,8 @@
 				}
 				//
 				String alias = pathInfo.substring(1);
-				setInstitution(InstitutionTopic.lookupInstitution(alias, as), session);
-				return PAGE_INSTITUTION_LOGIN;
+				setInstitution(GeoObjectTopic.lookupInstitution(alias, as), session);
+				return PAGE_GEO_LOGIN;
 			} catch (DeepaMehtaException e) {
 				System.out.println(&quot;*** EditServlet.performAction(): &quot; + e);
 				session.setAttribute(&quot;error&quot;, e.getMessage());
@@ -47,7 +46,7 @@
 			}
 		}
 		// session timeout?
-		if (getInstitution(session) == null) {	// ### doesn't return null but throws exception!
+		if (getGeoObject(session) == null) {	// ### doesn't return null but throws exception!
 			System.out.println(&quot;*** Session Expired ***&quot;);
 			session.setAttribute(&quot;error&quot;, &quot;Timeout: Kiez-Atlas wurde mehr als &quot; +
 				((WebSession) session).session.getMaxInactiveInterval() / 60 + &quot; Minuten nicht benutzt&quot;);
@@ -56,26 +55,26 @@
 		//
 		if (action.equals(ACTION_TRY_LOGIN)) {
 			String password = params.getValue(PROPERTY_PASSWORD);
-			String instPw = as.getTopicProperty(getInstitution(session), PROPERTY_PASSWORD);
-			return password.equals(instPw) ? PAGE_INSTITUTION_HOME : PAGE_INSTITUTION_LOGIN;
+			String geoPw = as.getTopicProperty(getGeoObject(session), PROPERTY_PASSWORD);
+			return password.equals(geoPw) ? PAGE_GEO_HOME : PAGE_GEO_LOGIN;
 			//
-		} else if (action.equals(ACTION_SHOW_INSTITUTION_FORM)) {
-			return PAGE_INSTITUTION_FORM;
+		} else if (action.equals(ACTION_SHOW_GEO_FORM)) {
+			return PAGE_GEO_FORM;
 			//
-		} else if (action.equals(ACTION_UPDATE_INSTITUTION)) {
-			InstitutionTopic inst = getInstitution(session);
-			updateTopic(inst.getType(), params, session);
+		} else if (action.equals(ACTION_UPDATE_GEO)) {
+			GeoObjectTopic geo = getGeoObject(session);
+			updateTopic(geo.getType(), params, session);
 			String newFilename = writeImage(params.getUploads());
 			if (newFilename != null) {
-				as.setTopicProperty(inst.getImage(), PROPERTY_FILE, newFilename);
+				as.setTopicProperty(geo.getImage(), PROPERTY_FILE, newFilename);
 			}
-			return PAGE_INSTITUTION_HOME;
+			return PAGE_GEO_HOME;
 			//
 		} else if (action.equals(ACTION_SHOW_FORUM_ADMINISTRATION)) {
 			return PAGE_FORUM_ADMINISTRATION;
 			//
 		} else if (action.equals(ACTION_ACTIVATE_FORUM)) {
-			InstitutionTopic inst = getInstitution(session);
+			GeoObjectTopic inst = getGeoObject(session);
 			// create forum topic if not yet exist
 			BaseTopic forum = inst.getForum();
 			String forumID;
@@ -93,7 +92,7 @@
 			//
 		} else if (action.equals(ACTION_DEACTIVATE_FORUM)) {
 			// deactivate forum
-			BaseTopic forum = getInstitution(session).getForum();
+			BaseTopic forum = getGeoObject(session).getForum();
 			cm.setTopicData(forum.getID(), 1, PROPERTY_FORUM_ACTIVITION, SWITCH_OFF);
 			return PAGE_FORUM_ADMINISTRATION;
 			//
@@ -103,7 +102,7 @@
 			return PAGE_FORUM_ADMINISTRATION;
 			//
 		} else if (action.equals(ACTION_GO_HOME)) {
-			return PAGE_INSTITUTION_HOME;
+			return PAGE_GEO_HOME;
 			//
 		} else {
 			return super.performAction(action, params, session);
@@ -111,14 +110,14 @@
 	}
 
 	protected void preparePage(String page, RequestParameter params, Session session) {
-		if (page.equals(PAGE_INSTITUTION_HOME)) {
+		if (page.equals(PAGE_GEO_HOME)) {
 			updateImagefile(session);
 		} else if (page.equals(PAGE_FORUM_ADMINISTRATION)) {
-			InstitutionTopic inst = getInstitution(session);
-			boolean isForumActivated = inst.isForumActivated();
+			GeoObjectTopic geo = getGeoObject(session);
+			boolean isForumActivated = geo.isForumActivated();
 			session.setAttribute(&quot;activition&quot;, isForumActivated ? SWITCH_ON : SWITCH_OFF);
 			if (isForumActivated) {
-				session.setAttribute(&quot;comments&quot;, inst.getCommentBeans());
+				session.setAttribute(&quot;comments&quot;, geo.getCommentBeans());
 			}
 		}
 	}
@@ -129,12 +128,15 @@
 	// *** Utilities ***
 	// *****************
 
+	// not sure when this method is triggered
+	// uses not configurable file path to write image/s to disk  
 
-
 	private String writeImage(Vector fileItems) {
 		try {
 			System.out.println(&quot;&gt;&gt;&gt; EditServlet.writeImage(): &quot; + fileItems.size() + &quot; files uploaded&quot;);
 			if (fileItems.size() &gt; 0) {
+				
+				//CAUTION
 				String path = &quot;/home/jrichter/deepamehta/install/client/images/&quot;;	// ###
 				// ### String path = &quot;/Users/jri/Projects/DeepaMehta/trunk/install/client/images/&quot;;
 				FileItem item = (FileItem) fileItems.firstElement();
@@ -179,13 +181,13 @@
 
 
 
-	private void setInstitution(BaseTopic inst, Session session) {
-		session.setAttribute(&quot;inst&quot;, inst);
-		System.out.println(&quot;&gt; \&quot;inst\&quot; stored in session: &quot; + inst);
+	private void setInstitution(BaseTopic geo, Session session) {
+		session.setAttribute(&quot;geo&quot;, geo);
+		System.out.println(&quot;&gt; \&quot;geo\&quot; stored in session: &quot; + geo);
 	}
 
-	private InstitutionTopic getInstitution(Session session) {
-		return (InstitutionTopic) as.getLiveTopic((BaseTopic) session.getAttribute(&quot;inst&quot;));
+	private GeoObjectTopic getGeoObject(Session session) {
+		return (GeoObjectTopic) as.getLiveTopic((BaseTopic) session.getAttribute(&quot;geo&quot;));
 	}
 
 	// ---
@@ -193,7 +195,7 @@
 	// ### compare to class Institution
 	private void updateImagefile(Session session) {
 		String imageURL = null;
-		BaseTopic image = getInstitution(session).getImage();
+		BaseTopic image = getGeoObject(session).getImage();
 		if (image != null) {
 			String imagefile = as.getTopicProperty(image, PROPERTY_FILE);
 			if (imagefile.length() &gt; 0) {

Added: trunk/src/de/kiezatlas/deepamehta/GeoObject.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/GeoObject.java	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/src/de/kiezatlas/deepamehta/GeoObject.java	2007-10-15 11:12:54 UTC (rev 17)
@@ -0,0 +1,33 @@
+package de.kiezatlas.deepamehta;
+import java.io.Serializable;
+import java.util.Vector;
+
+import de.deepamehta.service.ApplicationService;
+import de.kiezatlas.deepamehta.topics.GeoObjectTopic;
+import de.kiezatlas.deepamehta.KiezAtlas;
+
+
+public class GeoObject implements KiezAtlas, Serializable{
+	/**
+	 *  Value Object/ Bean
+	 *  used as Container for the data Transport between Servlet and JSP 
+	 */
+	private static final long serialVersionUID = 1L;
+	public String geoID, name, webAlias;
+	public String yadeX, yadeY;
+	public Vector categories;
+	
+	GeoObject(String newID, SearchCriteria[] criterias, ApplicationService as) {
+		GeoObjectTopic geo = (GeoObjectTopic) as.getLiveTopic(newID, 1);
+		this.geoID = geo.getID();
+		this.name = geo.getName();
+		this.webAlias = as.getTopicProperty(geo, PROPERTY_WEB_ALIAS);
+		this.yadeX = as.getTopicProperty(geo, PROPERTY_YADE_X);
+		this.yadeY = as.getTopicProperty(geo, PROPERTY_YADE_Y);
+		this.categories = geo.getCategories(KiezAtlas.TOPICTYPE_KIEZ_GEO);
+	}
+	
+	public String toString() {
+		return &quot;\&quot;&quot; + name + &quot;\&quot;&quot;;
+	}
+}

Deleted: trunk/src/de/kiezatlas/deepamehta/Institution.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/Institution.java	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/src/de/kiezatlas/deepamehta/Institution.java	2007-10-15 11:12:54 UTC (rev 17)
@@ -1,107 +0,0 @@
-package de.kiezatlas.deepamehta;
-
-import de.kiezatlas.deepamehta.topics.InstitutionTopic;
-//
-import de.deepamehta.BaseTopic;
-import de.deepamehta.service.ApplicationService;
-import de.deepamehta.util.DeepaMehtaUtils;
-//
-import java.io.Serializable;
-import java.util.*;
-
-
-
-/**
- * A bean-like data container for passing data from the front-controler (servlet)
- * to the presentation layer (JSP engine).
- * &lt;p&gt;
- * Kiez-Atlas 1.4.1&lt;br&gt;
- * Requires DeepaMehta 2.0b7-post1
- * &lt;p&gt;
- * Last change: 9.10.2007&lt;br&gt;
- * J&ouml;rg Richter&lt;br&gt;
- * <A HREF="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">jri at freenet.de</A>
- */
-public class Institution implements KiezAtlas, Serializable {
-
-	public String id, name, webAlias;
-	public String street, postalCode, city;
-	public String webpageURL, person, phone, fax, email;
-	public String traeger, traegerArt;
-	public String open, misc, adminInfo;
-	public String imageURL;
-	public String yadeX, yadeY;
-	public Vector[] categories;
-
-	/**
-	 * @param	criterias	may be null
-	 *
-	 * @see		BrowseServlet#setSelectedInst
-	 */
-	Institution(String instID, SearchCriteria[] criterias, ApplicationService as) {
-		InstitutionTopic inst = (InstitutionTopic) as.getLiveTopic(instID, 1);
-		id = inst.getID();
-		name = inst.getName();
-		webAlias = as.getTopicProperty(inst, PROPERTY_WEB_ALIAS);
-		// address
-		BaseTopic address = inst.getAddress();
-		if (address != null) {
-			street = as.getTopicProperty(address, PROPERTY_STREET);
-			postalCode = as.getTopicProperty(address, PROPERTY_POSTAL_CODE);
-		} else {
-			street = &quot;&quot;;
-			postalCode = &quot;&quot;;
-		}
-		city = as.getTopicProperty(inst, PROPERTY_CITY);
-		// contact
-		BaseTopic w = inst.getWebpage();
-		BaseTopic p = inst.getPerson();
-		BaseTopic ph = inst.getPhone();
-		BaseTopic f = inst.getFax();
-		BaseTopic e = inst.getEmail();
-		webpageURL = w != null ? w.getName() : &quot;&quot;;
-		person = p != null ? p.getName() : &quot;&quot;;
-		phone = ph != null ? ph.getName() : &quot;&quot;;
-		fax = f != null ? f.getName() : &quot;&quot;;
-		email = e != null ? e.getName() : &quot;&quot;;
-		// traeger
-		BaseTopic t = inst.getTraeger();
-		if (t != null) {
-			traeger = t.getName();
-			traegerArt = as.getTopicProperty(t, PROPERTY_AGENCY_KIND);
-		} else {
-			traeger = &quot;&quot;;
-			traegerArt = &quot;&quot;;
-		}
-		//
-		open = as.getTopicProperty(inst, PROPERTY_OEFFNUNGSZEITEN);
-		misc = as.getTopicProperty(inst, PROPERTY_SONSTIGES);
-		adminInfo = as.getTopicProperty(inst, PROPERTY_ADMINISTRATION_INFO);
-		open = DeepaMehtaUtils.replaceLF(open);				// needed for &quot;Multiline Input Field&quot;
-		misc = DeepaMehtaUtils.replaceLF(misc);				// needed for &quot;Multiline Input Field&quot;		
-		adminInfo = DeepaMehtaUtils.replaceLF(adminInfo);	// needed for &quot;Multiline Input Field&quot;		
-		// image
-		BaseTopic image = inst.getImage();
-		if (image != null) {
-			String imagefile = as.getTopicProperty(image, PROPERTY_FILE);
-			if (imagefile.length() &gt; 0) {
-				imageURL = as.getCorporateWebBaseURL() + FILESERVER_IMAGES_PATH + imagefile;
-			}
-		}
-		// yade
-		yadeX = as.getTopicProperty(inst, PROPERTY_YADE_X);
-		yadeY = as.getTopicProperty(inst, PROPERTY_YADE_Y);
-		// categories
-		if (criterias != null) {
-			categories = new Vector[criterias.length];
-			for (int i = 0; i &lt; criterias.length; i++) {
-				String critTypeID = criterias[i].criteria.getID();
-				categories[i] = inst.getCategories(critTypeID);
-			}
-		}
-	}
-
-	public String toString() {
-		return &quot;\&quot;&quot; + name + &quot;\&quot;&quot;;
-	}
-}

Modified: trunk/src/de/kiezatlas/deepamehta/KiezAtlas.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/KiezAtlas.java	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/src/de/kiezatlas/deepamehta/KiezAtlas.java	2007-10-15 11:12:54 UTC (rev 17)
@@ -50,8 +50,8 @@
 
 
 	static final String TOPICTYPE_CITYMAP = &quot;tt-ka-stadtplan&quot;;
-	static final String TOPICTYPE_KIEZ_INSTITUTION = &quot;tt-ka-einrichtung&quot;;
-	static final String TOPICTYPE_KIEZ_INSTITUTION_SEARCH = &quot;tt-ka-einrichtungsuche&quot;;
+	static final String TOPICTYPE_KIEZ_GEO = &quot;tt-ka-geoobject&quot;;
+	static final String TOPICTYPE_KIEZ_GEO_SEARCH = &quot;tt-ka-geoobject-search&quot;;
 	static final String TOPICTYPE_AGENCY = &quot;tt-ka-traeger&quot;;
 	static final String TOPICTYPE_CRITERIA = &quot;tt-ka-kriterium&quot;;
 	static final String TOPICTYPE_YADE_POINT = &quot;tt-ka-yadepoint&quot;;
@@ -174,18 +174,20 @@
 	// browse servlet
 	public static final String ACTION_INIT_FRAME = &quot;initFrame&quot;;
 	public static final String ACTION_SHOW_CATEGORIES = &quot;showCategories&quot;;
-	public static final String ACTION_SHOW_INSTITUTION_INFO = &quot;showInstInfo&quot;;
-	public static final String ACTION_SEARCH = &quot;search&quot;;
+	//public static final String ACTION_SHOW_INSTITUTION_INFO = &quot;showInstInfo&quot;;
+	public static final String ACTION_SHOW_GEO_INFO = &quot;showGeoObjectInfo&quot;;
+	public static final String ACTION_SEARCH = &quot;search&quot;;		
 	public static final String ACTION_SEARCH_BY_CATEGORY = &quot;searchByCategory&quot;;
 	public static final String ACTION_SELECT_CATEGORY = &quot;selectCategory&quot;;
-	public static final String ACTION_SHOW_INSTITUTION_FORUM = &quot;showInstForum&quot;;
+	public static final String ACTION_SHOW_GEO_FORUM = &quot;showGeoObjectForum&quot;;
 	public static final String ACTION_SHOW_COMMENT_FORM = &quot;showCommentForm&quot;;
 	public static final String ACTION_CREATE_COMMENT = &quot;createComment&quot;;
 	public static final String ACTION_TOGGLE_SHAPE_DISPLAY = &quot;toggleShapeDisplay&quot;;
 	// edit servlet
 	public static final String ACTION_TRY_LOGIN = &quot;tryLogin&quot;;		// also used for list servlet
-	public static final String ACTION_SHOW_INSTITUTION_FORM = &quot;showInstForm&quot;;
-	public static final String ACTION_UPDATE_INSTITUTION = &quot;updateInst&quot;;
+	//public static final String ACTION_SHOW_INSTITUTION_FORM = &quot;showInstForm&quot;;
+	public static final String ACTION_SHOW_GEO_FORM = &quot;showGeoObjectForm&quot;;
+	public static final String ACTION_UPDATE_GEO = &quot;updateGeo&quot;;
 	public static final String ACTION_SHOW_FORUM_ADMINISTRATION = &quot;showForumAdmin&quot;;
 	public static final String ACTION_ACTIVATE_FORUM = &quot;activateForum&quot;;
 	public static final String ACTION_DEACTIVATE_FORUM = &quot;deactivateForum&quot;;
@@ -228,14 +230,15 @@
     static final String PAGE_FRAMESET = &quot;frameset&quot;;
     static final String PAGE_CITY_MAP = &quot;CityMap&quot;;
     static final String PAGE_CATEGORY_LIST = &quot;CategoryList&quot;;
-    static final String PAGE_INSTITUTION_LIST = &quot;InstitutionList&quot;;
-    static final String PAGE_INSTITUTION_INFO = &quot;InstitutionInfo&quot;;
-    static final String PAGE_INSTITUTION_FORUM = &quot;InstitutionForum&quot;;
+    static final String PAGE_GEO_LIST = &quot;GeoObjectList&quot;;
+    //static final String PAGE_INSTITUTION_INFO = &quot;InstitutionInfo&quot;;
+    static final String PAGE_GEO_INFO = &quot;GeoObjectInfo&quot;;
+    static final String PAGE_GEO_FORUM = &quot;GeoObjectForum&quot;;
     static final String PAGE_COMMENT_FORM = &quot;CommentForm&quot;;
     // edit
-    static final String PAGE_INSTITUTION_LOGIN = &quot;InstitutionLogin&quot;;
-    static final String PAGE_INSTITUTION_HOME = &quot;InstitutionHome&quot;;
-    static final String PAGE_INSTITUTION_FORM = &quot;InstitutionForm&quot;;
+    static final String PAGE_GEO_LOGIN = &quot;GeoObjectLogin&quot;;
+    static final String PAGE_GEO_HOME = &quot;GeoObjectHome&quot;;
+    static final String PAGE_GEO_FORM = &quot;GeoObjectForm&quot;;
     static final String PAGE_FORUM_ADMINISTRATION = &quot;ForumAdministration&quot;;
     // list
     static final String PAGE_LIST_LOGIN = &quot;ListLogin&quot;;

Modified: trunk/src/de/kiezatlas/deepamehta/topics/CityMapTopic.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/topics/CityMapTopic.java	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/src/de/kiezatlas/deepamehta/topics/CityMapTopic.java	2007-10-15 11:12:54 UTC (rev 17)
@@ -156,9 +156,9 @@
 	public PresentableTopic getPresentableTopic(BaseTopic topic, String nearTopicID) {
 		PresentableTopic pt = super.getPresentableTopic(topic, nearTopicID);
 		//
-		if (as.isInstanceOf(topic, TOPICTYPE_KIEZ_INSTITUTION)) {
+		if (as.isInstanceOf(topic, TOPICTYPE_KIEZ_GEO)) {
 			try {
-				InstitutionTopic inst = (InstitutionTopic) as.getLiveTopic(topic);
+				GeoObjectTopic inst = (GeoObjectTopic) as.getLiveTopic(topic);
 				// determine new geometry
 				Point p = inst.getPoint(getID());	// throws DME
 				// set new geometry
@@ -192,7 +192,7 @@
 		BaseTopic workspace = as.getTopicmapOwner(getID());
 		System.out.println(&quot;&gt;&gt;&gt; map belongs to workspace &quot; + workspace);
 		// institution type
-		Vector typeIDs = as.type(TOPICTYPE_KIEZ_INSTITUTION, 1).getSubtypeIDs();
+		Vector typeIDs = as.type(TOPICTYPE_KIEZ_GEO, 1).getSubtypeIDs();
 		Vector instTypes = cm.getRelatedTopics(workspace.getID(), SEMANTIC_WORKSPACE_TYPES, TOPICTYPE_TOPICTYPE, 2, typeIDs, true);
 		// error check
 		if (instTypes.size() == 0) {
@@ -237,8 +237,8 @@
 	 * @return	2-element array of YADE-reference topics, or &lt;code&gt;null&lt;/code&gt; if there are no YADE-reference topics
 	 *			inside this city map (YADE is &quot;off&quot;).
 	 *
-	 * @see		InstitutionTopic#getPoint
-	 * @see		InstitutionTopic#getYadePoint
+	 * @see		GeeObjecTopic#getPoint
+	 * @see		GeoObjectTopic#getYadePoint
 	 */
 	public PresentableTopic[] getYADEReferencePoints() throws DeepaMehtaException {
 		Vector yp = cm.getViewTopics(getID(), 1, TOPICTYPE_YADE_POINT);
@@ -260,12 +260,12 @@
 	 * @see		#executeCommand
 	 */
 	private void repositionAllInstitutions(CorporateDirectives directives) {
-		Vector typeIDs = as.type(TOPICTYPE_KIEZ_INSTITUTION, 1).getSubtypeIDs();
+		Vector typeIDs = as.type(TOPICTYPE_KIEZ_GEO, 1).getSubtypeIDs();
 		Vector insts = cm.getViewTopics(getID(), 1, typeIDs);	// ### BaseTopics would be sufficient, but there is no such cm call
 		Enumeration e = insts.elements();
 		while (e.hasMoreElements()) {
 			try {
-				InstitutionTopic inst = (InstitutionTopic) as.getLiveTopic((PresentableTopic) e.nextElement());
+				GeoObjectTopic inst = (GeoObjectTopic) as.getLiveTopic((PresentableTopic) e.nextElement());
 				// calculate screen coordinate
 				Point p = inst.getPoint(getID());	// throws DME
 				// Note: if YADE is &quot;off&quot; p is null

Modified: trunk/src/de/kiezatlas/deepamehta/topics/FileImportTopic.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/topics/FileImportTopic.java	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/src/de/kiezatlas/deepamehta/topics/FileImportTopic.java	2007-10-15 11:12:54 UTC (rev 17)
@@ -152,7 +152,7 @@
 					System.out.println(&quot;&gt;&gt;&gt; Name: &quot; + instName);
 					//
 					String instID = cm.getNewTopicID();
-					LiveTopic inst = as.createLiveTopic(instID, TOPICTYPE_KIEZ_INSTITUTION, instName, session);
+					LiveTopic inst = as.createLiveTopic(instID, TOPICTYPE_KIEZ_GEO, instName, session);
 					as.setTopicProperty(inst, PROPERTY_NAME, instName);
 					as.createViewTopic(TOPICMAP_ID, 1, null, instID, 1, p.x, p.y, false);	// ### version=1
 					//

Added: trunk/src/de/kiezatlas/deepamehta/topics/GeoObjectTopic.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/topics/GeoObjectTopic.java	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/src/de/kiezatlas/deepamehta/topics/GeoObjectTopic.java	2007-10-15 11:12:54 UTC (rev 17)
@@ -0,0 +1,314 @@
+package de.kiezatlas.deepamehta.topics;
+
+import java.awt.Point;
+import java.awt.geom.Point2D;
+import java.util.Enumeration;
+import java.util.Hashtable;
+import java.util.StringTokenizer;
+import java.util.Vector;
+
+import de.deepamehta.AmbiguousSemanticException;
+import de.deepamehta.BaseTopic;
+import de.deepamehta.DeepaMehtaException;
+import de.deepamehta.PresentableTopic;
+import de.deepamehta.service.ApplicationService;
+import de.deepamehta.service.CorporateCommands;
+import de.deepamehta.service.CorporateDirectives;
+import de.deepamehta.service.Session;
+import de.deepamehta.topics.LiveTopic;
+import de.deepamehta.topics.TopicTypeTopic;
+import de.kiezatlas.deepamehta.Comment;
+import de.kiezatlas.deepamehta.KiezAtlas;
+
+/**
+ * 
+ * Kiez-Atlas 1.5&lt;br&gt;
+ * Requires DeepaMehta 2.0b8-pre2
+ * &lt;p&gt;
+ * Last change: 10.10.2007&lt;br&gt;
+ * Malte Rei&#195;&#159;ig&lt;br&gt;
+ * <A HREF="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">mre at deepamehta.de</A>
+ * 
+ */
+public class GeoObjectTopic extends LiveTopic implements KiezAtlas{
+
+	/**
+	 * 
+	 */
+	static final String DEFAULT_PASSWORD = &quot;geheim&quot;;
+	
+	// ------------------
+	// --- Constructor ---
+	// ------------------
+	
+	public GeoObjectTopic(BaseTopic topic, ApplicationService as) {
+		super(topic, as);
+		// TODO Auto-generated constructor stub
+	}
+	
+	// **********************
+	// *** Defining Hooks ***
+	// **********************
+
+
+
+	// ------------------
+	// --- Life Cycle ---
+	// ------------------
+
+
+
+	public CorporateDirectives evoke(Session session, String topicmapID, String viewmode) {
+		setTopicData(PROPERTY_LOCKED_GEOMETRY, SWITCH_ON);
+		setTopicData(PROPERTY_PASSWORD, DEFAULT_PASSWORD);
+		return super.evoke(session, topicmapID, viewmode);
+	}
+
+
+
+	// --------------------------
+	// --- Providing Commands ---
+	// --------------------------
+
+
+
+	public CorporateCommands contextCommands(String topicmapID, String viewmode,
+								Session session, CorporateDirectives directives) {
+		CorporateCommands commands = new CorporateCommands(as);
+		int editorContext = as.editorContext(topicmapID);
+		//
+		commands.addNavigationCommands(this, editorContext, session);
+		commands.addSeparator();
+		// --- &quot;Lock&quot;/&quot;Unlock&quot; ---
+		boolean isLocked = getProperty(PROPERTY_LOCKED_GEOMETRY).equals(SWITCH_ON);
+		int lockState = !isLocked ? COMMAND_STATE_DEFAULT : COMMAND_STATE_DISABLED;
+		int unlockState = isLocked ? COMMAND_STATE_DEFAULT : COMMAND_STATE_DISABLED;
+		//
+		commands.addCommand(ITEM_LOCK_GEOMETRY, CMD_LOCK_GEOMETRY, lockState);
+		commands.addCommand(ITEM_UNLOCK_GEOMETRY, CMD_UNLOCK_GEOMETRY, unlockState);
+		// --- standard topic commands ---
+		commands.addStandardCommands(this, editorContext, viewmode, session, directives);
+		//
+		return commands;
+	}
+
+
+
+	// --------------------------
+	// --- Executing Commands ---
+	// --------------------------
+
+
+
+	public CorporateDirectives executeCommand(String command, Session session, String topicmapID, String viewmode) {
+		CorporateDirectives directives = new CorporateDirectives();
+		StringTokenizer st = new StringTokenizer(command, COMMAND_SEPARATOR);
+		String cmd = st.nextToken();
+		if (cmd.equals(CMD_LOCK_GEOMETRY) || cmd.equals(CMD_UNLOCK_GEOMETRY)) {
+			String value = cmd.equals(CMD_LOCK_GEOMETRY) ? SWITCH_ON : SWITCH_OFF;
+			directives.add(as.setTopicProperty(getID(), getVersion(), PROPERTY_LOCKED_GEOMETRY, value,
+				topicmapID, viewmode, session));
+		} else {
+			return super.executeCommand(command, session, topicmapID, viewmode);
+		}
+		return directives;
+	}
+		
+
+
+	// ------------------------------------------
+	// --- Reacting upon dedicated situations ---
+	// ------------------------------------------
+
+
+
+	public CorporateDirectives moved(String topicmapID, int topicmapVersion, int x, int y, Session session) {
+		CorporateDirectives directives = super.moved(topicmapID, topicmapVersion, x, y, session);
+		// abort if we are not inside a city map, but inside a plain topic map
+		if (!(as.getLiveTopic(topicmapID, 1) instanceof CityMapTopic)) {
+			return directives;
+		}
+		//
+		Point2D.Float yadePoint = getYadePoint(x, y, topicmapID);
+		// set properties
+		if (yadePoint != null) {	// Note: yadePoint is null if YADE is &quot;off&quot;
+			Hashtable props = new Hashtable();
+			props.put(PROPERTY_YADE_X, Float.toString(yadePoint.x));
+			props.put(PROPERTY_YADE_Y, Float.toString(yadePoint.y));
+			directives.add(DIRECTIVE_SHOW_TOPIC_PROPERTIES, getID(), props, new Integer(1));
+		}
+		//
+		return directives;
+	}
+	
+	// ---
+	
+	public Vector getCategories(String critTypeID) {
+		return as.getRelatedTopics(getID(), ASSOCTYPE_ASSOCIATION, critTypeID, 2);
+	}
+	
+	public BaseTopic getImage() {
+		try {
+			return as.getRelatedTopic(getID(), ASSOCTYPE_ASSOCIATION, TOPICTYPE_IMAGE, 2, true);		// emptyAllowed=true
+		} catch (AmbiguousSemanticException e) {
+			System.out.println(&quot;*** GeoObjectTopic.getImage(): &quot; + e);
+			return e.getDefaultTopic();
+		}
+	}
+	
+	public Vector getComments() {
+		BaseTopic forum = getForum();
+		if (forum == null) {
+			throw new DeepaMehtaException(&quot;Institution &quot; + getID() + &quot; has no forum topic&quot;);
+		}
+		String[] sortProps = {PROPERTY_COMMENT_DATE, PROPERTY_COMMENT_TIME};
+		return cm.getRelatedTopics(forum.getID(), SEMANTIC_FORUM_COMMENTS, TOPICTYPE_COMMENT, 2, sortProps, true);	// descending=true
+	}
+	
+	public boolean isForumActivated() {
+		BaseTopic forum = getForum();
+		if (forum == null) {
+			return false;
+		}
+		return as.getTopicProperty(forum, PROPERTY_FORUM_ACTIVITION).equals(SWITCH_ON);
+	}
+	
+	public BaseTopic getForum() {
+		try {
+			return as.getRelatedTopic(getID(), SEMANTIC_INSTITUTION_FORUM, TOPICTYPE_FORUM, 2, true);		// emptyAllowed=true
+		} catch (AmbiguousSemanticException e) {
+			System.out.println(&quot;*** GeoObjectTopic.getForum(): &quot; + e);
+			return e.getDefaultTopic();
+		}
+	}
+	
+	
+	// ------------------------
+	// --- Topic Type Hooks ---
+	// ------------------------
+
+
+
+	/**
+	 * @return  the ID of the search type
+	 *
+	 * @see     TopicTypeTopic#createSearchType
+	 */
+	public static String getSearchTypeID() {
+		return TOPICTYPE_KIEZ_GEO_SEARCH;
+	}
+	
+	
+	// **********************
+	// *** Custom Methods ***
+	// **********************
+
+	public static BaseTopic lookupInstitution(String alias, ApplicationService as) throws DeepaMehtaException {
+		Vector typeIDs = as.type(TOPICTYPE_KIEZ_GEO, 1).getSubtypeIDs();
+		Hashtable props = new Hashtable();
+		props.put(PROPERTY_WEB_ALIAS, alias);
+		Vector institutions = as.cm.getTopics(typeIDs, props, true);		// caseSensitiv=true
+		// error check
+		if (institutions.size() == 0) {
+			throw new DeepaMehtaException(&quot;Fehler in URL: Einrichtung \&quot;&quot; + alias + &quot;\&quot; ist nicht bekannt&quot;);
+		}
+		if (institutions.size() &gt; 1) {
+			throw new DeepaMehtaException(&quot;Mehrdeutigkeit: es gibt &quot; + institutions.size() + &quot; \&quot;&quot; + alias + &quot;\&quot; Einrichtungen&quot;);
+		}
+		//
+		BaseTopic inst = (BaseTopic) institutions.firstElement();
+		return inst;
+	}
+	
+	public Vector getCommentBeans() {
+		Vector commentBeans = new Vector();
+		//
+		Enumeration e = getComments().elements();
+		while (e.hasMoreElements()) {
+			BaseTopic comment = (BaseTopic) e.nextElement();
+			commentBeans.addElement(new Comment(comment.getID(), as));
+		}
+		//
+		return commentBeans;
+	}
+	
+	/**
+	 * Converts the YADE-coordinate of this institution into a screen coordinate.
+	 *
+	 * @return	the screen coordinate, or &lt;code&gt;null&lt;/code&gt; if YADE is &quot;off&quot;.
+	 *
+	 * @see		#propertiesChanged
+	 * @see		CityMapTopic#getPresentableTopic
+	 * @see		CityMapTopic#repositionAllInstitutions
+	 */
+	Point getPoint(String topicmapID) throws DeepaMehtaException {
+		// ### copied
+		CityMapTopic citymap = (CityMapTopic) as.getLiveTopic(topicmapID, 1);
+		int x1, y1, x2, y2;
+		float yadeX1, yadeY1, yadeX2, yadeY2;
+		try {
+			PresentableTopic[] yp = citymap.getYADEReferencePoints();	// throws DME
+			if (yp == null) {
+				// YADE is &quot;off&quot;
+				return null;
+			}
+			x1 = yp[0].getGeometry().x;
+			y1 = yp[0].getGeometry().y;
+			x2 = yp[1].getGeometry().x;
+			y2 = yp[1].getGeometry().y;
+			yadeX1 = Float.parseFloat(as.getTopicProperty(yp[0], PROPERTY_YADE_X));
+			yadeY1 = Float.parseFloat(as.getTopicProperty(yp[0], PROPERTY_YADE_Y));
+			yadeX2 = Float.parseFloat(as.getTopicProperty(yp[1], PROPERTY_YADE_X));
+			yadeY2 = Float.parseFloat(as.getTopicProperty(yp[1], PROPERTY_YADE_Y));
+		} catch (NumberFormatException e) {
+			throw new DeepaMehtaException(&quot;Administrator-Fehler: ein YADE Referenzpunkt von &quot; +
+				&quot;Stadtplan \&quot;&quot; + citymap.getName() + &quot;\&quot; hat ung&#195;&#188;ltigen Wert (&quot; + e.getMessage() + &quot;)&quot;);
+		}
+		// yade -&gt; pixel
+		try {
+			float yadeX = Float.parseFloat(getProperty(PROPERTY_YADE_X));
+			float yadeY = Float.parseFloat(getProperty(PROPERTY_YADE_Y));
+			int x = (int) (x1 + (x2 - x1) * (yadeX - yadeX1) / (yadeX2 - yadeX1));
+			int y = (int) (y2 + (y1 - y2) * (yadeY - yadeY2) / (yadeY1 - yadeY2));
+			return new Point(x, y);
+		} catch (NumberFormatException e) {
+			throw new DeepaMehtaException(&quot;YADE Koordinate von Einrichtung \&quot;&quot; + getName() + &quot;\&quot; ist ung&#195;&#188;ltig (&quot; + e.getMessage() + &quot;)&quot;);
+		}
+	}
+
+	/**
+	 * Converts the specified screen coordinate into a YADE-coordinate.
+	 *
+	 * @return	the YADE-coordinate, or &lt;code&gt;null&lt;/code&gt; if YADE is &quot;off&quot;.
+	 *
+	 * @see		#moved
+	 * @see		CityMapTopic#updateYADECoordinates
+	 */
+	Point2D.Float getYadePoint(int x, int y, String topicmapID) throws DeepaMehtaException {
+		// ### copied
+		CityMapTopic citymap = (CityMapTopic) as.getLiveTopic(topicmapID, 1);
+		try {
+			PresentableTopic[] yp = citymap.getYADEReferencePoints();	// throws DME
+			if (yp == null) {
+				return null;
+			}
+			int x1 = yp[0].getGeometry().x;
+			int y1 = yp[0].getGeometry().y;
+			int x2 = yp[1].getGeometry().x;
+			int y2 = yp[1].getGeometry().y;
+			float yadeX1 = Float.parseFloat(as.getTopicProperty(yp[0], PROPERTY_YADE_X));
+			float yadeY1 = Float.parseFloat(as.getTopicProperty(yp[0], PROPERTY_YADE_Y));
+			float yadeX2 = Float.parseFloat(as.getTopicProperty(yp[1], PROPERTY_YADE_X));
+			float yadeY2 = Float.parseFloat(as.getTopicProperty(yp[1], PROPERTY_YADE_Y));
+			// pixel -&gt; yade
+			float yadeX = yadeX1 + (yadeX2 - yadeX1) * (x - x1) / (x2 - x1);
+			float yadeY = yadeY2 + (yadeY1 - yadeY2) * (y2 - y) / (y2 - y1);
+			return new Point2D.Float(yadeX, yadeY);
+		} catch (NumberFormatException e) {
+			throw new DeepaMehtaException(&quot;Administrator-Fehler: ein YADE Referenzpunkt von &quot; +
+				&quot;Stadtplan \&quot;&quot; + citymap.getName() + &quot;\&quot; hat ung&#195;&#188;ltigen Wert (&quot; + e.getMessage() + &quot;)&quot;);
+		}
+	}
+
+
+}

Deleted: trunk/src/de/kiezatlas/deepamehta/topics/InstitutionTopic.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/topics/InstitutionTopic.java	2007-10-09 07:45:16 UTC (rev 16)
+++ trunk/src/de/kiezatlas/deepamehta/topics/InstitutionTopic.java	2007-10-15 11:12:54 UTC (rev 17)
@@ -1,517 +0,0 @@
-package de.kiezatlas.deepamehta.topics;
-
-import de.kiezatlas.deepamehta.KiezAtlas;
-import de.kiezatlas.deepamehta.Comment;
-//
-import de.deepamehta.BaseTopic;
-import de.deepamehta.DeepaMehtaException;
-import de.deepamehta.PresentableTopic;
-import de.deepamehta.PresentableAssociation;
-import de.deepamehta.PropertyDefinition;
-import de.deepamehta.AmbiguousSemanticException;
-import de.deepamehta.service.ApplicationService;
-import de.deepamehta.service.CorporateDirectives;
-import de.deepamehta.service.CorporateCommands;
-import de.deepamehta.service.Session;
-import de.deepamehta.topics.LiveTopic;
-import de.deepamehta.topics.TypeTopic;
-//
-import java.awt.Point;
-import java.awt.geom.Point2D;
-import java.util.*;
-
-
-
-/**
- * Kiez-Atlas 1.4.1&lt;br&gt;
- * Requires DeepaMehta 2.0b8-pre2
- * &lt;p&gt;
- * Last change: 11.9.2007&lt;br&gt;
- * J&ouml;rg Richter&lt;br&gt;
- * <A HREF="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">jri at freenet.de</A>
- */
-public class InstitutionTopic extends LiveTopic implements KiezAtlas {
-
-
-
-	// *****************
-	// *** Constants ***
-	// *****************
-
-
-
-    static final String DEFAULT_PASSWORD = &quot;geheim&quot;;
-
-
-
-	// *******************
-	// *** Constructor ***
-	// *******************
-
-
-
-	public InstitutionTopic(BaseTopic topic, ApplicationService as) {
-		super(topic, as);
-	}
-
-
-
-	// **********************
-	// *** Defining Hooks ***
-	// **********************
-
-
-
-	// ------------------
-	// --- Life Cycle ---
-	// ------------------
-
-
-
-	public CorporateDirectives evoke(Session session, String topicmapID, String viewmode) {
-		setTopicData(PROPERTY_LOCKED_GEOMETRY, SWITCH_ON);
-		setTopicData(PROPERTY_PASSWORD, DEFAULT_PASSWORD);
-		return super.evoke(session, topicmapID, viewmode);
-	}
-
-
-
-	// --------------------------
-	// --- Providing Commands ---
-	// --------------------------
-
-
-
-	public CorporateCommands contextCommands(String topicmapID, String viewmode,
-								Session session, CorporateDirectives directives) {
-		CorporateCommands commands = new CorporateCommands(as);
-		int editorContext = as.editorContext(topicmapID);
-		//
-		commands.addNavigationCommands(this, editorContext, session);
-		commands.addSeparator();
-		// --- &quot;Lock&quot;/&quot;Unlock&quot; ---
-		boolean isLocked = getProperty(PROPERTY_LOCKED_GEOMETRY).equals(SWITCH_ON);
-		int lockState = !isLocked ? COMMAND_STATE_DEFAULT : COMMAND_STATE_DISABLED;
-		int unlockState = isLocked ? COMMAND_STATE_DEFAULT : COMMAND_STATE_DISABLED;
-		//
-		commands.addCommand(ITEM_LOCK_GEOMETRY, CMD_LOCK_GEOMETRY, lockState);
-		commands.addCommand(ITEM_UNLOCK_GEOMETRY, CMD_UNLOCK_GEOMETRY, unlockState);
-		// --- standard topic commands ---
-		commands.addStandardCommands(this, editorContext, viewmode, session, directives);
-		//
-		return commands;
-	}
-
-
-
-	// --------------------------
-	// --- Executing Commands ---
-	// --------------------------
-
-
-
-	public CorporateDirectives executeCommand(String command, Session session, String topicmapID, String viewmode) {
-		CorporateDirectives directives = new CorporateDirectives();
-		StringTokenizer st = new StringTokenizer(command, COMMAND_SEPARATOR);
-		String cmd = st.nextToken();
-		if (cmd.equals(CMD_LOCK_GEOMETRY) || cmd.equals(CMD_UNLOCK_GEOMETRY)) {
-			String value = cmd.equals(CMD_LOCK_GEOMETRY) ? SWITCH_ON : SWITCH_OFF;
-			directives.add(as.setTopicProperty(getID(), getVersion(), PROPERTY_LOCKED_GEOMETRY, value,
-				topicmapID, viewmode, session));
-		} else {
-			return super.executeCommand(command, session, topicmapID, viewmode);
-		}
-		return directives;
-	}
-		
-
-
-	// ------------------------------------------
-	// --- Reacting upon dedicated situations ---
-	// ------------------------------------------
-
-
-
-	public CorporateDirectives moved(String topicmapID, int topicmapVersion, int x, int y, Session session) {
-		CorporateDirectives directives = super.moved(topicmapID, topicmapVersion, x, y, session);
-		// abort if we are not inside a city map, but inside a plain topic map
-		if (!(as.getLiveTopic(topicmapID, 1) instanceof CityMapTopic)) {
-			return directives;
-		}
-		//
-		Point2D.Float yadePoint = getYadePoint(x, y, topicmapID);
-		// set properties
-		if (yadePoint != null) {	// Note: yadePoint is null if YADE is &quot;off&quot;
-			Hashtable props = new Hashtable();
-			props.put(PROPERTY_YADE_X, Float.toString(yadePoint.x));
-			props.put(PROPERTY_YADE_Y, Float.toString(yadePoint.y));
-			directives.add(DIRECTIVE_SHOW_TOPIC_PROPERTIES, getID(), props, new Integer(1));
-		}
-		//
-		return directives;
-	}
-
-
-
-	// ---------------------------
-	// --- Handling Properties ---
-	// ---------------------------
-
-
-
-	public boolean propertiesChangeAllowed(Hashtable oldProps, Hashtable newProps, CorporateDirectives directives) {
-		String alias = (String) newProps.get(PROPERTY_WEB_ALIAS);
-		if (alias != null) {
-			// ### compare to lookupInstitution()
-			Vector typeIDs = as.type(TOPICTYPE_KIEZ_INSTITUTION, 1).getSubtypeIDs();
-			Hashtable props = new Hashtable();
-			props.put(PROPERTY_WEB_ALIAS, alias);
-			Vector insts = cm.getTopics(typeIDs, props, true);	// caseSensitive=true
-			//
-			if (insts.size() &gt; 0) {
-				BaseTopic inst = (BaseTopic) insts.firstElement();
-				String errText = &quot;Web Alias \&quot;&quot; + alias + &quot;\&quot; ist bereits an Einrichtung \&quot;&quot; +
-					inst.getName() + &quot;\&quot; vergeben -- Bitte anderen Web Alias verwenden&quot;;
-				directives.add(DIRECTIVE_SHOW_MESSAGE, errText, new Integer(NOTIFICATION_WARNING));
-				System.out.println(&quot;*** InstitutionTopic.propertiesChangeAllowed(): &quot; + errText);
-				return false;
-			}
-		}
-		return super.propertiesChangeAllowed(oldProps, newProps, directives);
-	}
-
-	public CorporateDirectives propertiesChanged(Hashtable newProps, Hashtable oldProps,
-											String topicmapID, String viewmode, Session session) {
-		CorporateDirectives directives = super.propertiesChanged(newProps, oldProps, topicmapID, viewmode, session);
-		// --- &quot;YADE&quot; ---
-		if (newProps.get(PROPERTY_YADE_X) != null || newProps.get(PROPERTY_YADE_Y) != null) {
-			// determine new geometry
-			Point p = getPoint(topicmapID);	// throws DME
-			// set new geometry
-			if (p != null) {	// Note: p is null if YADE is &quot;off&quot;
-				directives.add(DIRECTIVE_SET_TOPIC_GEOMETRY, getID(), p, topicmapID);
-			}
-		}
-		//
-		return directives;
-	}
-
-	public static Vector hiddenProperties(TypeTopic type) {
-		Vector props = new Vector();
-		props.addElement(PROPERTY_DESCRIPTION);
-		return props;
-	}
-
-	public static Vector hiddenProperties(TypeTopic type, String relTopicTypeID) {
-		Vector props = null;
-		if (relTopicTypeID.equals(TOPICTYPE_EMAIL_ADDRESS)) {
-			props = new Vector();
-			props.addElement(PROPERTY_MAILBOX_URL);
-		} else if (relTopicTypeID.equals(TOPICTYPE_IMAGE)) {
-			props = new Vector();
-			props.addElement(PROPERTY_NAME);
-		}
-		return props;
-	}
-
-	public static void propertyLabel(PropertyDefinition propDef, ApplicationService as, Session session) {
-		String propName = propDef.getPropertyName();
-		if (propName.equals(PROPERTY_SONSTIGES)) {
-			propDef.setPropertyLabel(&quot;Weitere Infos&quot;);
-		}
-	}
-
-	public static String propertyLabel(PropertyDefinition propDef, String relTopicTypeID, ApplicationService as) {
-		String propName = propDef.getPropertyName();
-		if (relTopicTypeID.equals(TOPICTYPE_ADDRESS)) {
-			if (propName.equals(PROPERTY_STREET)) {
-				return &quot;Stra&szlig;e&quot;;
-			} else if (propName.equals(PROPERTY_POSTAL_CODE)) {
-				return &quot;Postleitzahl&quot;;
-			}
-		} else if (relTopicTypeID.equals(TOPICTYPE_WEBPAGE)) {
-			if (propName.equals(PROPERTY_URL)) {
-				return &quot;Website (URL)&quot;;
-			}
-		} else if (relTopicTypeID.equals(TOPICTYPE_AGENCY)) {
-			if (propName.equals(PROPERTY_NAME)) {
-				return &quot;Tr&auml;ger&quot;;
-			} else if (propName.equals(PROPERTY_AGENCY_KIND)) {
-				return &quot;Art des Tr&auml;gers&quot;;
-			}
-		} else if (relTopicTypeID.equals(TOPICTYPE_PERSON)) {
-			if (propName.equals(PROPERTY_FIRST_NAME)) {
-				return &quot;Ansprechpartner/in (Vorname)&quot;;
-			} else if (propName.equals(PROPERTY_NAME)) {
-				return &quot;Ansprechpartner/in (Nachname)&quot;;
-			} else if (propName.equals(PROPERTY_GENDER)) {
-				return &quot;Ansprechpartner/in&quot;;
-			}
-		} else if (relTopicTypeID.equals(TOPICTYPE_PHONE_NUMBER)) {
-			if (propName.equals(PROPERTY_NAME)) {
-				return &quot;Telefon&quot;;
-			}
-		} else if (relTopicTypeID.equals(TOPICTYPE_FAX_NUMBER)) {
-			if (propName.equals(PROPERTY_NAME)) {
-				return &quot;Fax&quot;;
-			}
-		} else if (relTopicTypeID.equals(TOPICTYPE_EMAIL_ADDRESS)) {
-			if (propName.equals(PROPERTY_EMAIL_ADDRESS)) {
-				return &quot;E-mail&quot;;
-			}
-		}
-		return LiveTopic.propertyLabel(propDef, relTopicTypeID, as);
-	}
-
-
-
-	// ------------------------
-	// --- Topic Type Hooks ---
-	// ------------------------
-
-
-
-	/**
-	 * @return  the ID of the search type
-	 *
-	 * @see     TopicTypeTopic#createSearchType
-	 */
-	public static String getSearchTypeID() {
-		return TOPICTYPE_KIEZ_INSTITUTION_SEARCH;
-	}
-
-
-
-	// **********************
-	// *** Custom Methods ***
-	// **********************
-
-
-
-	public static BaseTopic lookupInstitution(String alias, ApplicationService as) throws DeepaMehtaException {
-		Vector typeIDs = as.type(TOPICTYPE_KIEZ_INSTITUTION, 1).getSubtypeIDs();
-		Hashtable props = new Hashtable();
-		props.put(PROPERTY_WEB_ALIAS, alias);
-		Vector institutions = as.cm.getTopics(typeIDs, props, true);		// caseSensitiv=true
-		// error check
-		if (institutions.size() == 0) {
-			throw new DeepaMehtaException(&quot;Fehler in URL: Einrichtung \&quot;&quot; + alias + &quot;\&quot; ist nicht bekannt&quot;);
-		}
-		if (institutions.size() &gt; 1) {
-			throw new DeepaMehtaException(&quot;Mehrdeutigkeit: es gibt &quot; + institutions.size() + &quot; \&quot;&quot; + alias + &quot;\&quot; Einrichtungen&quot;);
-		}
-		//
-		BaseTopic inst = (BaseTopic) institutions.firstElement();
-		return inst;
-	}
-
-	// ---
-
-	public BaseTopic getAddress() {
-		try {
-			return as.getRelatedTopic(getID(), ASSOCTYPE_ASSOCIATION, TOPICTYPE_ADDRESS, 2, true);		// emptyAllowed=true
-		} catch (AmbiguousSemanticException e) {
-			System.out.println(&quot;*** InstitutionTopic.getAddress(): &quot; + e);
-			return e.getDefaultTopic();
-		}
-	}
-
-	public String getCity() {
-		return getProperty(PROPERTY_CITY);
-	}
-
-	public BaseTopic getWebpage() {
-		try {
-			return as.getRelatedTopic(getID(), ASSOCTYPE_ASSOCIATION, TOPICTYPE_WEBPAGE, 2, true);		// emptyAllowed=true
-		} catch (AmbiguousSemanticException e) {
-			System.out.println(&quot;*** InstitutionTopic.getWebpage(): &quot; + e);
-			return e.getDefaultTopic();
-		}
-	}
-
-	public BaseTopic getPerson() {
-		try {
-			return as.getRelatedTopic(getID(), ASSOCTYPE_ASSOCIATION, TOPICTYPE_PERSON, 2, true);		// emptyAllowed=true
-		} catch (AmbiguousSemanticException e) {
-			System.out.println(&quot;*** InstitutionTopic.getPerson(): &quot; + e);
-			return e.getDefaultTopic();
-		}
-	}
-
-	public BaseTopic getPhone() {
-		try {
-			return as.getRelatedTopic(getID(), ASSOCTYPE_ASSOCIATION, TOPICTYPE_PHONE_NUMBER, 2, true);		// emptyAllowed=true
-		} catch (AmbiguousSemanticException e) {
-			System.out.println(&quot;*** InstitutionTopic.getPhone(): &quot; + e);
-			return e.getDefaultTopic();
-		}
-	}
-
-	public BaseTopic getFax() {
-		try {
-			return as.getRelatedTopic(getID(), ASSOCTYPE_ASSOCIATION, TOPICTYPE_FAX_NUMBER, 2, true);		// emptyAllowed=true
-		} catch (AmbiguousSemanticException e) {
-			System.out.println(&quot;*** InstitutionTopic.getFax(): &quot; + e);
-			return e.getDefaultTopic();
-		}
-	}
-
-	public BaseTopic getEmail() {
-		try {
-			return as.getRelatedTopic(getID(), ASSOCTYPE_ASSOCIATION, TOPICTYPE_EMAIL_ADDRESS, 2, true);		// emptyAllowed=true
-		} catch (AmbiguousSemanticException e) {
-			System.out.println(&quot;*** InstitutionTopic.getEmail(): &quot; + e);
-			return e.getDefaultTopic();
-		}
-	}
-
-	public BaseTopic getTraeger() {
-		try {
-			return as.getRelatedTopic(getID(), ASSOCTYPE_ASSOCIATION, TOPICTYPE_AGENCY, 2, true);		// emptyAllowed=true
-		} catch (AmbiguousSemanticException e) {
-			System.out.println(&quot;*** InstitutionTopic.getTraeger(): &quot; + e);
-			return e.getDefaultTopic();
-		}
-	}
-
-	public String getWebAlias() {
-		return getProperty(PROPERTY_WEB_ALIAS);
-	}
-
-	// ---
-
-	public Vector getCategories(String critTypeID) {
-		return as.getRelatedTopics(getID(), ASSOCTYPE_ASSOCIATION, critTypeID, 2);
-	}
-
-	// ---
-
-	public BaseTopic getImage() {
-		try {
-			return as.getRelatedTopic(getID(), ASSOCTYPE_ASSOCIATION, TOPICTYPE_IMAGE, 2, true);		// emptyAllowed=true
-		} catch (AmbiguousSemanticException e) {
-			System.out.println(&quot;*** InstitutionTopic.getImage(): &quot; + e);
-			return e.getDefaultTopic();
-		}
-	}
-
-	// ---
-
-	/**
-	 * Converts the YADE-coordinate of this institution into a screen coordinate.
-	 *
-	 * @return	the screen coordinate, or &lt;code&gt;null&lt;/code&gt; if YADE is &quot;off&quot;.
-	 *
-	 * @see		#propertiesChanged
-	 * @see		CityMapTopic#getPresentableTopic
-	 * @see		CityMapTopic#repositionAllInstitutions
-	 */
-	Point getPoint(String topicmapID) throws DeepaMehtaException {
-		// ### copied
-		CityMapTopic citymap = (CityMapTopic) as.getLiveTopic(topicmapID, 1);
-		int x1, y1, x2, y2;
-		float yadeX1, yadeY1, yadeX2, yadeY2;
-		try {
-			PresentableTopic[] yp = citymap.getYADEReferencePoints();	// throws DME
-			if (yp == null) {
-				// YADE is &quot;off&quot;
-				return null;
-			}
-			x1 = yp[0].getGeometry().x;
-			y1 = yp[0].getGeometry().y;
-			x2 = yp[1].getGeometry().x;
-			y2 = yp[1].getGeometry().y;
-			yadeX1 = Float.parseFloat(as.getTopicProperty(yp[0], PROPERTY_YADE_X));
-			yadeY1 = Float.parseFloat(as.getTopicProperty(yp[0], PROPERTY_YADE_Y));
-			yadeX2 = Float.parseFloat(as.getTopicProperty(yp[1], PROPERTY_YADE_X));
-			yadeY2 = Float.parseFloat(as.getTopicProperty(yp[1], PROPERTY_YADE_Y));
-		} catch (NumberFormatException e) {
-			throw new DeepaMehtaException(&quot;Administrator-Fehler: ein YADE Referenzpunkt von &quot; +
-				&quot;Stadtplan \&quot;&quot; + citymap.getName() + &quot;\&quot; hat ung&#195;&#188;ltigen Wert (&quot; + e.getMessage() + &quot;)&quot;);
-		}
-		// yade -&gt; pixel
-		try {
-			float yadeX = Float.parseFloat(getProperty(PROPERTY_YADE_X));
-			float yadeY = Float.parseFloat(getProperty(PROPERTY_YADE_Y));
-			int x = (int) (x1 + (x2 - x1) * (yadeX - yadeX1) / (yadeX2 - yadeX1));
-			int y = (int) (y2 + (y1 - y2) * (yadeY - yadeY2) / (yadeY1 - yadeY2));
-			return new Point(x, y);
-		} catch (NumberFormatException e) {
-			throw new DeepaMehtaException(&quot;YADE Koordinate von Einrichtung \&quot;&quot; + getName() + &quot;\&quot; ist ung&#195;&#188;ltig (&quot; + e.getMessage() + &quot;)&quot;);
-		}
-	}
-
-	/**
-	 * Converts the specified screen coordinate into a YADE-coordinate.
-	 *
-	 * @return	the YADE-coordinate, or &lt;code&gt;null&lt;/code&gt; if YADE is &quot;off&quot;.
-	 *
-	 * @see		#moved
-	 * @see		CityMapTopic#updateYADECoordinates
-	 */
-	Point2D.Float getYadePoint(int x, int y, String topicmapID) throws DeepaMehtaException {
-		// ### copied
-		CityMapTopic citymap = (CityMapTopic) as.getLiveTopic(topicmapID, 1);
-		try {
-			PresentableTopic[] yp = citymap.getYADEReferencePoints();	// throws DME
-			if (yp == null) {
-				return null;
-			}
-			int x1 = yp[0].getGeometry().x;
-			int y1 = yp[0].getGeometry().y;
-			int x2 = yp[1].getGeometry().x;
-			int y2 = yp[1].getGeometry().y;
-			float yadeX1 = Float.parseFloat(as.getTopicProperty(yp[0], PROPERTY_YADE_X));
-			float yadeY1 = Float.parseFloat(as.getTopicProperty(yp[0], PROPERTY_YADE_Y));
-			float yadeX2 = Float.parseFloat(as.getTopicProperty(yp[1], PROPERTY_YADE_X));
-			float yadeY2 = Float.parseFloat(as.getTopicProperty(yp[1], PROPERTY_YADE_Y));
-			// pixel -&gt; yade
-			float yadeX = yadeX1 + (yadeX2 - yadeX1) * (x - x1) / (x2 - x1);
-			float yadeY = yadeY2 + (yadeY1 - yadeY2) * (y2 - y) / (y2 - y1);
-			return new Point2D.Float(yadeX, yadeY);
-		} catch (NumberFormatException e) {
-			throw new DeepaMehtaException(&quot;Administrator-Fehler: ein YADE Referenzpunkt von &quot; +
-				&quot;Stadtplan \&quot;&quot; + citymap.getName() + &quot;\&quot; hat ung&#195;&#188;ltigen Wert (&quot; + e.getMessage() + &quot;)&quot;);
-		}
-	}
-
-	// ---
-
-	public boolean isForumActivated() {
-		BaseTopic forum = getForum();
-		if (forum == null) {
-			return false;
-		}
-		return as.getTopicProperty(forum, PROPERTY_FORUM_ACTIVITION).equals(SWITCH_ON);
-	}
-
-	public Vector getComments() {
-		BaseTopic forum = getForum();
-		if (forum == null) {
-			throw new DeepaMehtaException(&quot;Institution &quot; + getID() + &quot; has no forum topic&quot;);
-		}
-		String[] sortProps = {PROPERTY_COMMENT_DATE, PROPERTY_COMMENT_TIME};
-		return cm.getRelatedTopics(forum.getID(), SEMANTIC_FORUM_COMMENTS, TOPICTYPE_COMMENT, 2, sortProps, true);	// descending=true
-	}
-
-	public BaseTopic getForum() {
-		try {
-			return as.getRelatedTopic(getID(), SEMANTIC_INSTITUTION_FORUM, TOPICTYPE_FORUM, 2, true);		// emptyAllowed=true
-		} catch (AmbiguousSemanticException e) {
-			System.out.println(&quot;*** InstitutionTopic.getForum(): &quot; + e);
-			return e.getDefaultTopic();
-		}
-	}
-
-	public Vector getCommentBeans() {
-		Vector commentBeans = new Vector();
-		//
-		Enumeration e = getComments().elements();
-		while (e.hasMoreElements()) {
-			BaseTopic comment = (BaseTopic) e.nextElement();
-			commentBeans.addElement(new Comment(comment.getID(), as));
-		}
-		//
-		return commentBeans;
-	}
-}


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000008.html">[Kiezatlas-svn] r16 - in trunk/src/de/kiezatlas/deepamehta: . topics
</A></li>
	<LI>Next message: <A HREF="000010.html">[Kiezatlas-svn] r18 - trunk/db/patches
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9">[ date ]</a>
              <a href="thread.html#9">[ thread ]</a>
              <a href="subject.html#9">[ subject ]</a>
              <a href="author.html#9">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">More information about the Kiezatlas-svn
mailing list</a><br>
</body></html>
