<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Kiezatlas-svn] r95 - in trunk: pages/be.de	src/de/kiezatlas/deepamehta
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/kiezatlas-svn/2010-August/index.html" >
   <LINK REL="made" HREF="mailto:kiezatlas-svn%40lists.berlios.de?Subject=Re%3A%20%5BKiezatlas-svn%5D%20r95%20-%20in%20trunk%3A%20pages/be.de%0A%09src/de/kiezatlas/deepamehta&In-Reply-To=%3C20100823223134.D8E28480B83%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000082.html">
   <LINK REL="Next"  HREF="000084.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Kiezatlas-svn] r95 - in trunk: pages/be.de	src/de/kiezatlas/deepamehta</H1>
    <B>maltito at mail.berlios.de</B> 
    <A HREF="mailto:kiezatlas-svn%40lists.berlios.de?Subject=Re%3A%20%5BKiezatlas-svn%5D%20r95%20-%20in%20trunk%3A%20pages/be.de%0A%09src/de/kiezatlas/deepamehta&In-Reply-To=%3C20100823223134.D8E28480B83%40sheep.berlios.de%3E"
       TITLE="[Kiezatlas-svn] r95 - in trunk: pages/be.de	src/de/kiezatlas/deepamehta">maltito at mail.berlios.de
       </A><BR>
    <I>Tue Aug 24 00:31:34 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="000082.html">[Kiezatlas-svn] r94 - in trunk/pages/be.de: . proxies
</A></li>
        <LI>Next message: <A HREF="000084.html">[Kiezatlas-svn] r96 - trunk/pages/be.de
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#83">[ date ]</a>
              <a href="thread.html#83">[ thread ]</a>
              <a href="subject.html#83">[ subject ]</a>
              <a href="author.html#83">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: maltito
Date: 2010-08-24 00:31:34 +0200 (Tue, 24 Aug 2010)
New Revision: 95

Modified:
   trunk/pages/be.de/bmap.php
   trunk/pages/be.de/kiezatlas.js
   trunk/src/de/kiezatlas/deepamehta/ImportWorker.java
   trunk/src/de/kiezatlas/deepamehta/ImportWorkerEvent.java
   trunk/src/de/kiezatlas/deepamehta/KiezServlet.java
Log:
Minor Changes to RPC Service
* simplified the searchGeoObjects call which now just searches geoObjects by name
* removed some printouts and unused methods

Changes to the AJAX  Citymap Client to be able to make use of the same codebase at the Kiezatlas Labs and some minor improvements
* marked some code fragments with todo's ### mostly for user exception handling


Modified: trunk/pages/be.de/bmap.php
===================================================================
--- trunk/pages/be.de/bmap.php	2010-08-20 10:30:08 UTC (rev 94)
+++ trunk/pages/be.de/bmap.php	2010-08-23 22:31:34 UTC (rev 95)
@@ -55,7 +55,7 @@
     &lt;!-- &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;land.css&quot;&gt;--&gt;
     &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;landmaps.css&quot;&gt;
     &lt;script type=&quot;text/javascript&quot; src=&quot;kiezatlas.js&quot;&gt;&lt;/script&gt;
-    &lt;script type=&quot;text/javascript&quot; src=&quot;OpenLayers.2.9.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;OpenLayers.js&quot;&gt;&lt;/script&gt;
     &lt;script type=&quot;text/javascript&quot; src=&quot;jquery-1.3.2.js&quot;&gt;&lt;/script&gt;
     &lt;script type=&quot;text/javascript&quot; src=&quot;<A HREF="http://maps.google.com/maps?file=api&amp;v=2&amp;oe=utf-8&amp;key=ABQIAAAADev2ctFkze28KEcta5b4WBSQDgFJvORzMhuwLQZ9zEDMQLdVUhTWXHB2vS0W0TdlEbDiH_qzhBEZ5A">http://maps.google.com/maps?file=api&amp;v=2&amp;oe=utf-8&amp;key=ABQIAAAADev2ctFkze28KEcta5b4WBSQDgFJvORzMhuwLQZ9zEDMQLdVUhTWXHB2vS0W0TdlEbDiH_qzhBEZ5A</A>&quot;&gt;&lt;/script&gt;
     &lt;script type=&quot;text/javascript&quot;&gt;
@@ -83,7 +83,6 @@
     	var helpVisible = false;
 	    // var slimWidth = false;
 	    // var totalWidth = 1000; // 953
-	    var headerGap = 63;
 	    var map = &quot;&quot;;
 	    var bounds = &quot;&quot;;
 	    var markerLayer = &quot;&quot;;
@@ -175,10 +174,12 @@
 	    &lt;div id=&quot;focusAlternatives&quot;&gt;&lt;/div&gt;
       &lt;div id=&quot;mapControl&quot;&gt;
         &lt;a href=&quot;javascript:showAllMarker();&quot; id=&quot;toggleMarkerHref&quot;&gt;
-          &lt;img border=&quot;0&quot; src=&quot;img/FreiwilligenAgentur.png&quot; title=&quot;Alle Markierer einblenden&quot; width=&quot;15&quot; height=&quot;15&quot;&gt;&lt;/a&gt;
+          &lt;img border=&quot;0&quot; src=&quot;img/FreiwilligenAgentur.png&quot; title=&quot;Alle Markierer einblenden&quot; width=&quot;15&quot; height=&quot;15&quot;&gt;
+        &lt;/a&gt;
 			    &lt;!-- &lt;a href=&quot;javascript:removeAllMarker();&quot; style=&quot;text-decoration: none;&quot;&gt;&gt; Alle ausblenden&lt;/a&gt; &lt;br/&gt;--&gt;
 			  &lt;a href=&quot;javascript:updateVisibleBounds(null, true);&quot; id=&quot;resetMarkerHref&quot;&gt;
-			    &lt;img border=&quot;0&quot; src=&quot;img/Stop.png&quot; title=&quot;zur&#252;cksetzen der Kartenansicht und Informationsebenen&quot; width=&quot;15&quot; height=&quot;15&quot;&gt;&lt;/a&gt;&nbsp;
+			    &lt;img border=&quot;0&quot; src=&quot;img/Stop.png&quot; title=&quot;zur&#252;cksetzen der Kartenansicht und Informationsebenen&quot; width=&quot;15&quot; height=&quot;15&quot;&gt;
+        &lt;/a&gt;&nbsp;
 		    &lt;a href=&quot;javascript:toggleMapControl();&quot; id=&quot;mapFunctions&quot;&gt;Kartenfunktionalit&auml;t&lt;/a&gt;
 		    &lt;div id=&quot;mapSwitcher&quot; style=&quot;position: absolute; visibility: hidden;&quot;&gt;&lt;/div&gt;
       &lt;/div&gt;

Modified: trunk/pages/be.de/kiezatlas.js
===================================================================
--- trunk/pages/be.de/kiezatlas.js	2010-08-20 10:30:08 UTC (rev 94)
+++ trunk/pages/be.de/kiezatlas.js	2010-08-23 22:31:34 UTC (rev 95)
@@ -30,9 +30,10 @@
   var alternative_items = [];
   var lastStreetName = &quot;&quot;;
   var debugUI = false;
-  // var debug = false;
   // deployment settings
   var onBerlinDe = true;
+  var headerGap = 0;
+  if (onBerlinDe) headerGap = 63
   var kiezKey = &quot;ABQIAAAAyg-5-YjVJ1InfpWX9gsTuxRa7xhKv6UmZ1sBua05bF3F2fwOehRUiEzUjBmCh76NaeOoCu841j1qnQ&quot;;
   var berlinKey = &quot;ABQIAAAADev2ctFkze28KEcta5b4WBSQDgFJvORzMhuwLQZ9zEDMQLdVUhTWXHB2vS0W0TdlEbDiH_qzhBEZ5A&quot;;
   var propFooterMessage = &quot;&quot;;
@@ -52,18 +53,19 @@
       maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34)
     };
     map = new OpenLayers.Map('map', options);
-    var mapnik = new OpenLayers.Layer.TMS(&quot;OpenStreetMap&quot;, &quot;<A HREF="http://tile.openstreetmap.org/">http://tile.openstreetmap.org/</A>&quot;, { type: 'png', 
+    var mapnik = new OpenLayers.Layer.TMS(&quot;OpenStreetMap&quot;, &quot;<A HREF="http://tile.openstreetmap.org/">http://tile.openstreetmap.org/</A>&quot;, {type: 'png', 
       getURL: osm_getTileURL, displayOutsideMaxExtent: true, 
       attribution: '&lt;a href=&quot;<A HREF="http://www.openstreetmap.org/">http://www.openstreetmap.org/</A>&quot;&gt;OpenStreetMap&lt;/a&gt;', 
-      numZoomLevels: 25 }
+      numZoomLevels: 25}
     );
     map.events.register(&quot;movestart&quot;, map, function (evnt) {
       // log(&quot;baseLayerBounds&quot;+map.getBoundFromBaseLayer());
       if (map.getExtent()!= null) log(&quot;evt: &quot; + map.getExtent().getCenterLonLat());
     });
-    var googleBaseLayer = new OpenLayers.Layer.Google(&quot;Google Maps&quot;, { sphericalMercator:true, numZoomLevels: 25} );
+    var googleBaseLayer = new OpenLayers.Layer.Google(&quot;Google Maps&quot;, {sphericalMercator:true, numZoomLevels: 25} );
     // districtLayer.setVisibility(true);
-    map.addLayers([googleBaseLayer, mapnik]); // , markerLayer
+    if (onBerlinDe) map.addLayers([googleBaseLayer, mapnik]); // , markerLayer
+    else map.addLayers([mapnik, googleBaseLayer]);
     // MapControl Setup
     nav = new OpenLayers.Control.NavigationHistory();
     // parent control must be added to the map
@@ -99,11 +101,12 @@
     startHeight = parseInt(startHeight.substr(0, startHeight.length-2));
     // topHeight = topHeight - startHeight;
     //
-    if (onBerlinDe) fullW = fullW - 1;
-    var mapW = fullW - sideW - 6; // border
-    var mapH = fullH - topHeight - startHeight - 1; // current headerHeight
-    jQuery(&quot;#bobody&quot;).css(&quot;width&quot;, fullW + 1);
-  	jQuery(&quot;#bohead&quot;).css(&quot;width&quot;, fullW + 1);
+    if (onBerlinDe) fullW = fullW - 1; // 
+    var mapW = fullW - sideW - 7; // border
+    // if (onBerlinDe) mapW = fullW - sideW - 7; // border
+    var mapH = fullH - topHeight - startHeight - 1; // current labs headerHeight
+    if (onBerlinDe) jQuery(&quot;#bobody&quot;).css(&quot;width&quot;, fullW + 1);
+  	if (onBerlinDe) jQuery(&quot;#bohead&quot;).css(&quot;width&quot;, fullW + 1);
     jQuery(&quot;#kiezatlas&quot;).css(&quot;width&quot;, fullW);
 	  jQuery(&quot;#kiezatlas&quot;).css(&quot;visibility&quot;, &quot;visible&quot;); // make the whole appframe visible
     //jQuery(&quot;#kiezatlas&quot;).css(&quot;height&quot;, fullH - startHeight);
@@ -115,11 +118,14 @@
     jQuery(&quot;#mapControl&quot;).css(&quot;left&quot;, mapW - 185);
     jQuery(&quot;#mapControl&quot;).css(&quot;top&quot;, startHeight + 3);
     // jQuery(&quot;#mapSwitcher&quot;).css(&quot;left&quot;, 525);
-    jQuery(&quot;#focusInput&quot;).css(&quot;left&quot;, 225);
-    jQuery(&quot;#focusAlternatives&quot;).css(&quot;left&quot;, 295);
+    if (onBerlinDe) jQuery(&quot;#focusInput&quot;).css(&quot;left&quot;, 225);
+    else jQuery(&quot;#focusInput&quot;).css(&quot;left&quot;, 345);
+    if (onBerlinDe) jQuery(&quot;#focusAlternatives&quot;).css(&quot;left&quot;, 295);
+    else jQuery(&quot;#focusAlternatives&quot;).css(&quot;left&quot;, 420);
     //jQuery(&quot;#focusAlternatives&quot;).css(&quot;top&quot;, 205);
     jQuery(&quot;#searchInput&quot;).css(&quot;left&quot;, fullW - sideW + 10);
-    jQuery(&quot;#headerButtons&quot;).css(&quot;left&quot;, fullW - 20);
+    if (onBerlinDe) jQuery(&quot;#headerButtons&quot;).css(&quot;left&quot;, fullW - 20);
+    else jQuery(&quot;#headerButtons&quot;).css(&quot;left&quot;, fullW - 30);
     // sidebarControl is 5px fat
     jQuery(&quot;#sideBarControl&quot;).css(&quot;left&quot;, mapW);
     jQuery(&quot;#sideBarControl&quot;).css(&quot;height&quot;, mapH);
@@ -129,7 +135,8 @@
     jQuery(&quot;#sideBar&quot;).css(&quot;left&quot;, mapW + 5);
     // fine adjustment per browser from the top
 	  jQuery(&quot;#map&quot;).css(&quot;top&quot;, topHeight + startHeight + 1);
-    jQuery(&quot;#sideBar&quot;).css(&quot;top&quot;, topHeight + startHeight + 1);
+    if (onBerlinDe) jQuery(&quot;#sideBar&quot;).css(&quot;top&quot;, topHeight + startHeight + 1);
+    else jQuery(&quot;#sideBar&quot;).css(&quot;top&quot;, topHeight + startHeight + 1);
     jQuery(&quot;#sideBarControl&quot;).css(&quot;top&quot;, topHeight + startHeight + 1);
     // set width and perform a jquery show('fast')
     setSideBarWidth(sideW);
@@ -149,7 +156,7 @@
     var sideBarHeight = mapH - critHeight - footerHeight;
     jQuery(&quot;#sideBarCategories&quot;).css(&quot;height&quot;, sideBarHeight);
     var fWidth = sideW - 6;
-    var fOrientation = mapW - 5;
+    var fOrientation = mapW - 3;
     // jQuery(&quot;#sideBarCategories&quot;).css(&quot;width&quot;, );
     // jQuery(&quot;#sideBar&quot;).css(&quot;right&quot;, sideW);
     jQuery(&quot;#kafooter&quot;).css(&quot;width&quot;, fWidth - 15);
@@ -174,6 +181,7 @@
       jQuery(&quot;#kafooter&quot;).css(&quot;background&quot;, &quot;transparent&quot;);
       jQuery(&quot;#kafooter&quot;).css(&quot;bottom&quot;, 15);
       jQuery(&quot;#resizeButton&quot;).attr(&quot;src&quot;, &quot;img/go-first.png&quot;);
+      if (!onBerlinDe) jQuery(&quot;#resizeButton&quot;).attr(&quot;width&quot;, 25);
       jQuery(&quot;#resizeButton&quot;).attr(&quot;title&quot;, &quot;Seitenleiste einblenden&quot;);
       sideBarToggle = false;
     } else {
@@ -188,6 +196,7 @@
       jQuery(&quot;#kafooter&quot;).css(&quot;bottom&quot;, 2);
       // jQuery(&quot;#headerButtons&quot;).html(imgTag);
       jQuery(&quot;#resizeButton&quot;).attr(&quot;src&quot;, &quot;img/go-last.png&quot;);
+      if (!onBerlinDe) jQuery(&quot;#resizeButton&quot;).attr(&quot;width&quot;, 25);
       jQuery(&quot;#resizeButton&quot;).attr(&quot;title&quot;, &quot;Seitenleiste ausblenden&quot;);
   	  // jQuery(&quot;#kafooter&quot;).css(&quot;width&quot;, );
       handleResize(breitSeite);
@@ -223,8 +232,9 @@
 	      }
 	      resultHandler.append('&lt;b&gt;'+topic.name+'&lt;/b&gt;&lt;br/&gt;');
 	      // resultHandler.append('&lt;table width=&quot;100%&quot; cellpadding=&quot;2&quot; cellspacing=&quot;0&quot; id=&quot;sideBarCategoriesTable&quot;&gt;&lt;/table&gt;');
-	      resultHandler.append(''+getTopicPostalCode(topic) + ' Berlin &lt;br/&gt;');
-	      resultHandler.append(''+getTopicAddress(topic)+'&lt;p/&gt;');
+	      if (onBerlinDe) resultHandler.append(''+getTopicPostalCode(topic) + ' Berlin &lt;br/&gt;');
+        else resultHandler.append(''+getTopicPostalCode(topic) + ' ' + getTopicCity(topic) + '&lt;br/&gt;');
+        resultHandler.append(''+getTopicAddress(topic)+'&lt;p/&gt;');
 	      // resultHandler.append(&quot;Loaded Topic&quot; + topic.name);
 	      topic = stripFieldsContaining(topic, &quot;LAT&quot;);
 	      topic = stripFieldsContaining(topic, &quot;LONG&quot;);
@@ -361,8 +371,9 @@
       dataType: 'json',
       success: function(obj){
         var workspace = obj.result;
-        if (debug) log('loading infos '+ workspace.logo+ '&lt;&lt; logo, ' + workspace.imprint + 
-          '&lt;&lt;imprint, ' + workspace.homepage + '&lt;&lt;homagepe');
+        if (debug) {
+          log('loading infos '+ workspace.logo+ '&lt;&lt; logo, ' + workspace.imprint + '&lt;&lt;imprint, ' + workspace.homepage + '&lt;&lt;homagepe');
+        }
         workspaceInfos = workspace;
       },
       error: function(x, s, e){ 
@@ -408,23 +419,29 @@
     * ###: localized to DE and BERLIN throug &amp;q=... Berlin&quot;
     */
   function focusRequest() {
-    var streetFocus = jQuery(&quot;#streetNameField&quot;).val() + '%20Berlin'; //lo
     if (debug) log('focusRqeust for ' + streetFocus);
+    var streetFocus = jQuery(&quot;#streetNameField&quot;).val();
+    if (onBerlinDe) streetFocus = jQuery(&quot;#streetNameField&quot;).val() + '%20Berlin'; //lo
     var swBerlin = &quot;6881778.529613,1467590.9428711&quot;;
     var nwBerlin = &quot;6920608.5399765,1518650.8777585&quot;;
     var viewPortBias = &quot;&amp;bounds=&quot;+swBerlin+&quot;|&quot;+nwBerlin;
     var url = HIDDEN_SERVICE_URL + 'geoProxy.php?q=' + urlencode(streetFocus) + viewPortBias + '&amp;output=json&amp;oe=utf8'
-      + '&amp;sensotr=false&amp;key=' + gKey + '=de';
+      + '&amp;sensotr=false&amp;key=';
+    if (onBerlinDe) url +=  berlinKey; else url += kiezKey;
+    if (onBerlinDe) url += '=de';
     // var viewPortURL = &quot;1338106.6169795,6831635.8390675|1614197.1630961,6955769.5729803&quot;;
     jQuery.ajax({
       type: &quot;GET&quot;,
       url: url,
       dataType: 'json',
       success: function(obj) {
-        alternative_items = null;
+        // alternative_items = null;
         autocomplete_item = 0;
         alternative_items = obj.Placemark;
-	      if (alternative_items.length &gt; 1) {
+        if (alternative_items.length == 1) {
+          select_current_item();
+  	      focus_current_item();
+        } else if (alternative_items.length &gt; 1) {
   	      show_alternatives_list(jQuery(&quot;#focusAlternatives&quot;));
   	      // select_alternative_item(autocomplete_item);
   	      select_current_item();
@@ -435,7 +452,7 @@
           map.setCenter(toLonLat.transform(map.displayProjection, map.projection), 15);
 	      }
       },
-      error: function(x, s, e){ log('.. wrong street ?! (' + x.statusText+')'); }
+      error: function(x, s, e){log('.. wrong street ?! (' + x.statusText+')');}
     });
     if (!checkIfAllCategoriesSelected()) showAllMarker();
   }
@@ -474,11 +491,11 @@
           if (autocomplete_item &lt; 0 || autocomplete_item &gt; alternative_items.length) {
             jQuery(&quot;#autoLocateInputField&quot;).attr(&quot;action&quot;, &quot;javascript:focusRequest()&quot;);
             // jQuery(&quot;#focusInput&quot;).attr(&quot;disabled&quot;, &quot;enabled&quot;);
-            log(&quot;REQUEST&quot; + event.keyCode);
+            if (debug) log(&quot;REQUEST&quot; + event.keyCode);
           } else {
             jQuery(&quot;#autoLocateInputField&quot;).attr(&quot;action&quot;, &quot;javascript:focus_current_item()&quot;);
             // jQuery(&quot;#focusInput&quot;).attr(&quot;disabled&quot;, &quot;disabled&quot;);
-            log(&quot;FOCUS&quot; + event.keyCode);
+            if (debug) log(&quot;FOCUS&quot; + event.keyCode);
           }
           if (event.keyCode == 38) { // UP
             select_previous_item();
@@ -493,7 +510,7 @@
             alternative_items = null;
           } else if (event.keyCode == 13) { // ENTER
             jQuery(&quot;#focusInput&quot;).submit();
-            log(&quot;ENTER submitting  but resetting ? &quot; + autocomplete_item);
+            if (debug) log(&quot;ENTER submitting  but resetting ? &quot; + autocomplete_item);
           }
         } else {
           jQuery(&quot;#autoLocateInputField&quot;).attr(&quot;action&quot;, &quot;javascript:focusRequest()&quot;);
@@ -506,12 +523,16 @@
       jQuery(&quot;#resultItem_&quot; + autocomplete_item).css(&quot;background-color&quot;, &quot;#999999&quot;);
       // autocomplete_item = atPos;
   }
-  
+
+  /** changed on 23.Agusta --- ### to test with berlin.de */
   function focus_current_item(itemNumber)  {
-      var item = alternative_items[autocomplete_item];
-      if (itemNumber != null) {
-        item = alternative_items[itemNumber];
-        select_next_item(itemNumber);
+      var item;
+      if (alternative_items != null) {
+        item = alternative_items[autocomplete_item]; // autoselection
+        if (itemNumber != null) {
+          item = alternative_items[itemNumber];
+          select_next_item(itemNumber);
+        }
       }
       // check if inputField.action with jQuery (line 293) was later changed 
       // than inputField.keyUp is received (line 314)
@@ -553,8 +574,8 @@
       'id=&quot;sideBarCategoriesTable&quot;&gt;&lt;/table&gt;');
     for (var i=0; i &lt; resultObjects.length; i++) {
       var resultBaseTopic = resultObjects[i];
-      if (resultBaseTopic.lat == 0.0 || resultBaseTopic.long == 0.0) {
-       if (debug) log('..initResultList - skipping ' + resultBaseTopic.name );
+      if (resultBaseTopic.lat == 0.0 || resultBaseTopic.lon == 0.0) {
+        if (debug) log('..initResultList - skipping ' + resultBaseTopic.name );
       } else {
         jQuery(&quot;#sideBarCategoriesTable&quot;).append('&lt;tr id=&quot;topicRow-'+resultBaseTopic.id+'&quot; width=&quot;100%&quot; '
           + ' class=&quot;topicRowDeselected&quot;&gt;&lt;td width=&quot;20px&quot; valign=&quot;center&quot; align=&quot;center&quot;&gt;&lt;b&gt;'+(i+1)+'. &lt;/b&gt;&lt;/td&gt;'
@@ -577,9 +598,15 @@
     var critLinkList = '&lt;table width=&quot;95%&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;&lt;tbody&gt;';
       critLinkList += '&lt;tr valign=&quot;top&quot;&gt;'; // TODO: onclick
       critLinkList += '&lt;td rowspan=&quot;'+workspaceCriterias.result.length+1+'&quot; align=&quot;left&quot;&gt;';
-      critLinkList += '&lt;a id=&quot;sideBarLogoLink&quot; href=&quot;<A HREF="http://www.berlin.de/buergeraktiv/">http://www.berlin.de/buergeraktiv/</A>&quot;&gt;'
+      if (workspaceInfos != null) {
+        critLinkList += '&lt;a id=&quot;sideBarLogoLink&quot; href=&quot;<A HREF="http://www.berlin.de/buergeraktiv/">http://www.berlin.de/buergeraktiv/</A>&quot;&gt;'
+        + ' &lt;img id=&quot;sideBarLogo&quot; src=&quot;'+IMAGES_URL + workspaceInfos.logo +'&quot; alt=&quot;Das ' + workspaceInfos.name + '-Logo&quot; '
+        + ' border=&quot;0&quot; text=&quot;Das B&#252;rgeraktiv Logo&quot;&gt;&lt;/a&gt;&lt;/td&gt;';
+      } else {
+        critLinkList += '&lt;a id=&quot;sideBarLogoLink&quot; href=&quot;<A HREF="http://www.berlin.de/buergeraktiv/">http://www.berlin.de/buergeraktiv/</A>&quot;&gt;'
         + ' &lt;img id=&quot;sideBarLogo&quot; src=&quot;img/buergeraktiv-logo.gif&quot; alt=&quot;Das B&#252;rgeraktiv Logo&quot; '
         + ' border=&quot;0&quot; text=&quot;Das B&#252;rgeraktiv Logo&quot;&gt;&lt;/a&gt;&lt;/td&gt;';
+      }
       critLinkList += '&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;';
       critLinkList += '&lt;/tr&gt;';
     for (var i = 0; i &lt; workspaceCriterias.result.length; i++) {  
@@ -591,7 +618,7 @@
       }
       critLinkList += '&lt;td onclick=&quot;javascript:updateCategoryList(' + i + ');&quot; align=&quot;right&quot; class=&quot;critLinkNormal&quot;&gt;'
         + critName + '&lt;/td&gt;';
-      if (crtCritIndex == i) { critLinkList += '&lt;td align=&quot;left&quot;&gt;&#8226;&lt;/td&gt;&lt;/tr&gt;'; } else { critLinkList += '&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;'; }
+      if (crtCritIndex == i) {critLinkList += '&lt;td align=&quot;left&quot;&gt;&#8226;&lt;/td&gt;&lt;/tr&gt;';} else {critLinkList += '&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;';}
       // in any case, when switchin the criteria updateSidebar --
       // radio.setAttribute('onclick', 'javascript:updateCategoryList(&quot;' + i + '&quot;)'); 
     }
@@ -629,7 +656,7 @@
     // calculateNewBounds if its a &quot;District&quot; criteria
     if (catName == &quot;Berlin&quot;) { // ### fixed hack
       updateVisibleBounds(null, false);
-    } else {
+    } else if (onBerlinDe) {
       for (i = 0; i &lt; districtNames.length; i++) {
         if (districtNames[i].catName == catName) {
           var districtBounds = getBoundsOfCurrentVisibleFeatures(); // out features inside
@@ -654,42 +681,51 @@
     // Auslesen der Legendenelemente.
     // sideBarCategories.html('&lt;table width=&quot;95%&quot;&gt;');
     // var contentWidth = jQuery(&quot;#sideBar&quot;).css(&quot;width&quot;).substr(0,jQuery(&quot;#sideBar&quot;).css(&quot;width&quot;).length-2);
-    for (var i = 0; i &lt; workspaceCriterias.result[criteria].categories.length; i++) {
-      // Schleife &#252;ber alle Kategorien eines Kriteriums
-      var catIcon = [workspaceCriterias.result['' + criteria + ''].categories[i].catIcon];
-      var catName = [workspaceCriterias.result['' + criteria + ''].categories[i].catName];
-      var catId = new String([workspaceCriterias.result['' + criteria + ''].categories[i].catId]);
-      var catCSS = &quot;catRowDeselected&quot;;
-      /*if (isCategoryVisible(catId)) {
-        if (debug) log(&quot;..updateCategeryList.isVisibleCat - reSelect in GUI! &quot;);
-        catCSS = &quot;catRowSelected&quot;;
-      }*/
-      //
-      jQuery(&quot;#sideBarCategoriesTable&quot;).append('&lt;tr id=&quot;catRow-'+catId+'&quot; width=&quot;100%&quot; class=&quot;'+catCSS+'&quot;&gt;' 
-        + ' &lt;td width=&quot;25px&quot; valign=&quot;center&quot; align=&quot;center&quot;&gt;&lt;a href=&quot;&quot; id=&quot;toggleHref-'+catId+'&quot;&gt;' 
-          + '&lt;img src=&quot;'+ICONS_URL+''+catIcon+'&quot; border=&quot;0&quot; id=&quot;catIconRow-'+catId+'&quot; alt=&quot;'+catName+'-Icon&quot; '
-          + 'text=&quot;Klicken zum Ein- und Ausblenden&quot;&gt;&lt;/a&gt;&lt;/td&gt;' 
-        + '&lt;td valign=&quot;center&quot;&gt;&lt;a href=&quot;&quot; id=&quot;catHref-'+catId+'&quot;&gt;'+catName+'&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;');
-      // javaScript sucks up when &quot;t-12312321&quot; is a stringId and NAN !
-      // mozilla alows onclick on a tableRow while webkit and others do neither allow onmouseclick nor onclick
-      jQuery(&quot;#toggleHref-&quot;+catId).attr('href', 'javascript:toggleMarkerGroups(&quot;' + catId + '&quot;);');
-      // jQuery(&quot;#catIconRow-&quot;+catId).attr('onclick', 'javascript:toggleMarkerGroups(&quot;' + catId + '&quot;)');
-      jQuery(&quot;#catHref-&quot;+catId).attr('href', 'javascript:showCatInSideBar(&quot;' + catId + '&quot;, &quot;'+catName+'&quot;);');
-      // jQuery(&quot;#catRow-&quot;+catId).attr('onmouseover', 'hoverCatButton(&quot;' + catId + '&quot;)');
-      // jQuery(&quot;#catRow-&quot;+catId).attr('onmouseout', 'outCatButton(&quot;' + catId + '&quot;)');
+    if (workspaceCriterias.result.length &lt;= 0) {
+      // ### ToDo: Exception Handling
+      alert(&quot;Sorry for that inconvenience. Probably an error occured while loading the criterias.&quot;);
+    } else {
+      for (var i = 0; i &lt; workspaceCriterias.result[criteria].categories.length; i++) {
+        // Schleife &#252;ber alle Kategorien eines Kriteriums
+        var catIcon = [workspaceCriterias.result['' + criteria + ''].categories[i].catIcon];
+        var catName = [workspaceCriterias.result['' + criteria + ''].categories[i].catName];
+        var catId = new String([workspaceCriterias.result['' + criteria + ''].categories[i].catId]);
+        var catCSS = &quot;catRowDeselected&quot;;
+        /*if (isCategoryVisible(catId)) {
+          if (debug) log(&quot;..updateCategeryList.isVisibleCat - reSelect in GUI! &quot;);
+          catCSS = &quot;catRowSelected&quot;;
+        }*/
+        //
+        jQuery(&quot;#sideBarCategoriesTable&quot;).append('&lt;tr id=&quot;catRow-'+catId+'&quot; width=&quot;100%&quot; class=&quot;'+catCSS+'&quot;&gt;'
+          + ' &lt;td width=&quot;25px&quot; valign=&quot;center&quot; align=&quot;center&quot;&gt;&lt;a href=&quot;&quot; id=&quot;toggleHref-'+catId+'&quot;&gt;'
+            + '&lt;img src=&quot;'+ICONS_URL+''+catIcon+'&quot; border=&quot;0&quot; id=&quot;catIconRow-'+catId+'&quot; alt=&quot;'+catName+'-Icon&quot; '
+            + 'text=&quot;Klicken zum Ein- und Ausblenden&quot;&gt;&lt;/a&gt;&lt;/td&gt;'
+          + '&lt;td valign=&quot;center&quot;&gt;&lt;a href=&quot;&quot; id=&quot;catHref-'+catId+'&quot;&gt;'+catName+'&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;');
+        // javaScript sucks up when &quot;t-12312321&quot; is a stringId and NAN !
+        // mozilla alows onclick on a tableRow while webkit and others do neither allow onmouseclick nor onclick
+        jQuery(&quot;#toggleHref-&quot;+catId).attr('href', 'javascript:toggleMarkerGroups(&quot;' + catId + '&quot;);');
+        // jQuery(&quot;#catIconRow-&quot;+catId).attr('onclick', 'javascript:toggleMarkerGroups(&quot;' + catId + '&quot;)');
+        jQuery(&quot;#catHref-&quot;+catId).attr('href', 'javascript:showCatInSideBar(&quot;' + catId + '&quot;, &quot;'+catName+'&quot;);');
+        // jQuery(&quot;#catRow-&quot;+catId).attr('onmouseover', 'hoverCatButton(&quot;' + catId + '&quot;)');
+        // jQuery(&quot;#catRow-&quot;+catId).attr('onmouseout', 'outCatButton(&quot;' + catId + '&quot;)');
+      }
     }
   }
   
   /** sets imprint, homepage and logo link associated with the current workspaceInfos*/
   function setWorkspaceInfos() {
-    var footer = '&lt;span id=&quot;footerImprint&quot;&gt;&lt;a href=&quot;'+workspaceInfos.imprint+'&quot;&gt;Impressum / Haftungshinweise&lt;/a&gt;&lt;/span&gt;';
-    footer += '&lt;span id=&quot;footerPoweredBy&quot;&gt;'+footerMessage+'&lt;/span&gt;';
-    jQuery(&quot;#kafooter&quot;).html(footer);
-    jQuery(&quot;#sideBarLogo&quot;).attr('src', ''+IMAGES_URL+workspaceInfos.logo+'');
-    jQuery(&quot;#sideBarLogo&quot;).attr('title', ''+workspaceInfos.name+'');
-    jQuery(&quot;#sideBarLogo&quot;).attr('alt', ''+workspaceInfos.name+' Logo');
-    jQuery(&quot;#sideBarLogoLink&quot;).attr('href', workspaceInfos.homepage);
-    log(&quot;set sideBar to: &quot; + jQuery(&quot;#sideBarLogo&quot;).attr('src') + &quot; and logo is: &quot; + jQuery(&quot;#sideBarLogo&quot;).attr('title'));
+    if (workspaceInfos == null) { // ### Improve Exception Handling
+      alert(&quot;Sorry. The workspace you tried to access is not properly configured by the administrator.&quot;);
+    } else {
+      var footer = '&lt;span id=&quot;footerImprint&quot;&gt;&lt;a href=&quot;'+workspaceInfos.imprint+'&quot;&gt;Impressum / Haftungshinweise&lt;/a&gt;&lt;/span&gt;';
+      footer += '&lt;span id=&quot;footerPoweredBy&quot;&gt;'+footerMessage+'&lt;/span&gt;';
+      jQuery(&quot;#kafooter&quot;).html(footer);
+      jQuery(&quot;#sideBarLogo&quot;).attr('src', ''+IMAGES_URL+workspaceInfos.logo+'');
+        jQuery(&quot;#sideBarLogo&quot;).attr('title', ''+workspaceInfos.name+'');
+      jQuery(&quot;#sideBarLogo&quot;).attr('alt', ''+workspaceInfos.name+' Logo');
+      jQuery(&quot;#sideBarLogoLink&quot;).attr('href', workspaceInfos.homepage);
+      log(&quot;set sideBar to: &quot; + jQuery(&quot;#sideBarLogo&quot;).attr('src') + &quot; and logo is: &quot; + jQuery(&quot;#sideBarLogo&quot;).attr('title'));
+    }
   }
   
   /** put numerous marker in the layer and draw them
@@ -1057,9 +1093,9 @@
     var defaultStyle = OpenLayers.Util.applyDefaults( dStyle, OpenLayers.Feature.Vector.style[&quot;default&quot;]);
     var dStyleMap = new OpenLayers.StyleMap({
       &quot;default&quot;: defaultStyle, 
-      &quot;select&quot;: { strokeColor:&quot;#B60033&quot;, strokeWidth: 2, fill: 0,
+      &quot;select&quot;: {strokeColor:&quot;#B60033&quot;, strokeWidth: 2, fill: 0,
         label : &quot;${name}&quot;, fontSize: &quot;12px&quot;, fontStyle: &quot;bold&quot;,
-        fontFamily: &quot;Arial,Helvetica,sans-serif&quot;, fontColor: &quot;#B60033&quot; }
+        fontFamily: &quot;Arial,Helvetica,sans-serif&quot;, fontColor: &quot;#B60033&quot;}
     });
     var districtLayer = new OpenLayers.Layer.Vector(&quot;Bezirksgrenzen&quot;, {
       styleMap: dStyleMap,
@@ -1078,7 +1114,7 @@
     districtLayer.setVisibility(debug);
     map.addLayer(districtLayer);
     log('districtLayer loaded with overall: ' + districtLayer.features.length + ' polygons');
-    var districtSelect = new OpenLayers.Control.SelectFeature(districtLayer, { highlightOnly: true });
+    var districtSelect = new OpenLayers.Control.SelectFeature(districtLayer, {highlightOnly: true});
     //selecting kml based Features in the new layer disabled for now
     /** districtLayer.onSelect = function (feature) {
       // &quot;featureselected&quot;: function(evt) { log(&quot;districtLayer clicked &quot; + evt); },
@@ -1174,7 +1210,7 @@
               jQuery(&quot;#memu&quot;).html(htmlString);
               jQuery(&quot;#memu&quot;).css(&quot;visibility&quot;, &quot;visible&quot;);
               jQuery(&quot;#memu&quot;).css(&quot;left&quot;, centerPoint.x);
-              jQuery(&quot;#memu&quot;).css(&quot;top&quot;, centerPoint.y + headerGap + 27);
+              jQuery(&quot;#memu&quot;).css(&quot;top&quot;, centerPoint.y + headerGap + 27); // ### headergap seems unneccessary
             }
           } else {
             // log(&quot;normalFeature just highlight&quot;);
@@ -1305,7 +1341,7 @@
         if (debug) log(&quot;*** mischeck: &quot;+ poi.lonlat + &quot;!=&quot; + allMarkers[i].lonlat);
       }
     }
-    if (cluster.length &gt;= 1) { cluster.push(poi); } else { log(&quot;nothing found equal: &quot; + poi.lonlat.lon +&quot;==&quot;+ poi.lonlat.lat); }
+    if (cluster.length &gt;= 1) {cluster.push(poi);} else {log(&quot;nothing found equal: &quot; + poi.lonlat.lon +&quot;==&quot;+ poi.lonlat.lat);}
     // after one match we`re a cluster
     return cluster;
   }
@@ -1348,7 +1384,7 @@
         // log(&quot;clusterCheck found a featured position.. &quot;);
       }
     }
-    log(&quot;&gt; topicId is not in any cluster yet&quot;);
+    if (debug) log(&quot;&gt; topicId is not in any cluster yet&quot;);
     return false;
   }
   
@@ -1494,7 +1530,7 @@
     for (var i = 0; i &lt; gMarkers.length; i++) {
       // map.addOverlay(gMarkers[i]);
       var marker = gMarkers[i];
-      if (marker.lonlat == latLng) { return marker; }
+      if (marker.lonlat == latLng) {return marker;}
     }
     return null;
   }
@@ -1539,13 +1575,13 @@
       // jQuery(this).addClass(&quot;activeField&quot;).removeClass(&quot;idle&quot;);
       // set activeField
       // jQuery(this).width(150);
-      jQuery(this).animate({ width: 145 }, 500);
+      jQuery(this).animate({width: 145}, 500);
     });
     jQuery(&quot;#focusInput&quot;).blur(function() {
       // jQuery(this).removeClass(&quot;activeField&quot;).addClass(&quot;idle&quot;);
       // jQuery(this).width(75);
       // set idleField
-      jQuery(this).animate({ width: 115 }, 500);
+      jQuery(this).animate({width: 115}, 500);
     });
   }
 
@@ -1635,8 +1671,8 @@
     for (var it=0; it &lt; topic.properties.length; it++) {
       // resultHandler.append('&lt;tr&gt;&lt;td&gt;'+topic.properties[i].label+'&lt;/td&gt;&lt;td&gt;'+topic.properties[i].value+'&lt;/td&gt;&lt;/tr&gt;');
       if (topic.properties[it].name.indexOf(fieldName) == -1) {
-      // log('fieldStrippin: ' + it);
-      newProps.push(topic.properties[it]);
+        // log('fieldStrippin: ' + it);
+        newProps.push(topic.properties[it]);
       } else {
       // flog('stripping Field ' + topic.properties[it].name);
       }
@@ -1655,6 +1691,7 @@
       return topic.properties[i].value;
       }
     }
+    return &quot;&quot;;
   }
   
   function getImageSource(topic) {
@@ -1663,6 +1700,7 @@
         return topic.properties[i].value;
       }
     }
+    return &quot;&quot;;
   }
 
   function getTopicPostalCode(topic) {
@@ -1671,8 +1709,22 @@
         return topic.properties[i].value; // + ' Berlin&lt;br/&gt;';
       }
     }
+    return &quot;&quot;;
   }
-  
+
+  function getTopicCity(topic) {
+    for (var at=0; at &lt; topic.properties.length; at++) {
+      // resultHandler.append('&lt;tr&gt;&lt;td&gt;'+topic.properties[i].label+'&lt;/td&gt;&lt;td&gt;'+topic.properties[i].value+'&lt;/td&gt;&lt;/tr&gt;');
+      if (topic.properties[at].name == &quot;Address / City&quot;) {
+        return topic.properties[at].value; // + ' Berlin&lt;br/&gt;';
+      } else if (topic.properties[at].name == &quot;Stadt&quot;) {
+        return topic.properties[at].value;
+      }
+    }
+    return &quot;&quot;;
+  }
+
+
   // 
   // --- High Level CiyMap Functions 
   // 
@@ -1686,7 +1738,7 @@
       var skip = false;
       if (lat == 0.0 || lng == 0.0) {
         skip = true;
-      };
+      }
       if (!skip) {
         var point = new OpenLayers.LonLat(parseFloat(lng), parseFloat(lat));
         bounds.extend(point);
@@ -1723,7 +1775,7 @@
         var skip = false;
         if (point.lat == 0.0 || point.lon == 0.0) {
           skip = true;
-        };
+        }
         if (!skip) {
           counter++;
           // var point = new OpenLayers.LonLat(parseFloat(lng), parseFloat(lat));
@@ -1779,17 +1831,20 @@
     if (markerGroupIds.length == workspaceCriterias.result[crtCritIndex].categories.length) return true; else return false;
   }
   
-  /** produces a very clear markerGroupIds situation*/
+  /** produces a very clear markerGroupIds state */
   function deSelectAllCategories() {
     markerGroupIds = [];
-    //for (var i = 0; i &lt; workspaceCriterias.result.length; i++) {
-    for (var j = 0; j &lt; workspaceCriterias.result[crtCritIndex].categories.length; j++) {
-      var catId = workspaceCriterias.result[crtCritIndex].categories[j].catId;
-      // remove catId from groups
-      jQuery(&quot;#catRow-&quot;+catId).attr(&quot;class&quot;, &quot;catRowDeselected&quot;);  
+    if (workspaceCriterias.result.length &lt;= 0) {
+      // ### ToDo: Exception Handling
+      alert(&quot;Sorry for that inconvenience. Probably an error occured while loading the criterias.&quot;);
+    } else {
+      for (var j = 0; j &lt; workspaceCriterias.result[crtCritIndex].categories.length; j++) {
+        var catId = workspaceCriterias.result[crtCritIndex].categories[j].catId;
+        // remove catId from groups
+        jQuery(&quot;#catRow-&quot;+catId).attr(&quot;class&quot;, &quot;catRowDeselected&quot;);
+      }
     }
-    //}
-    log(&quot;deSelected All markerGroups to: &quot; + markerGroupIds);
+    if(debug) log(&quot;deSelected All markerGroups to: &quot; + markerGroupIds);
   }
   
   /** show all topics as Features in myNewLayer and select all Categories in Sidebar */
@@ -1808,7 +1863,7 @@
   /** TODO: nearly redundant code to removeAllMarker  */
   function reSetMarkers() {
     log(&quot;resetting all Markers thus Categories&quot;);
-    removeAllMarker();
+    removeAllMarker(); // and popups
     deSelectAllCategories();
   }
 
@@ -1828,7 +1883,6 @@
       featureToToggle.renderIntent = &quot;delete&quot;;
     }
     myNewLayer.redraw();
-    deSelectAllCategories();
     removeAllPopUps();
   }
 
@@ -1837,7 +1891,7 @@
   // --- Little Helpers
   //
   
-    function selectAndShowInMap(originId) {
+  function selectAndShowInMap(originId) {
     var feature = checkFeatureByOriginId(originId);
     if (feature == null) {
       // project could not be assoiciated with a correct address, though is not published
@@ -1858,7 +1912,7 @@
       // 
       showTopicInMap(feature.data.topicId);
     }
-    }
+  }
   
   /** mapTile Function, not exactly clear what it does */
   function osm_getTileURL(bounds) {
@@ -1926,6 +1980,7 @@
     } else if (val.indexOf(&quot;@&quot;) != -1) {
       return '&lt;a href=&quot;mailto:'+val+'&quot;&gt;'+val+'&lt;/a&gt;';
     }
+    return val;
   }
   
   function render_text(text) {
@@ -1933,8 +1988,10 @@
   }
   
   function makeWebpageLink(url, label) {
-    return urlMarkup = '&lt;a href=&quot;'+url+'&quot; target=&quot;_blank&quot;&gt;Link zur T&auml;tigkeitsbeschreibung' 
+    if (onBerlinDe) urlMarkup = '&lt;a href=&quot;'+url+'&quot; target=&quot;_blank&quot;&gt;Link zur T&auml;tigkeitsbeschreibung'
       + '&lt;img src=&quot;/.img/ml/link_extern.gif&quot; class=&quot;c7&quot; alt=&quot;(externer Link)&quot; border=&quot;0&quot; height=&quot;11&quot; width=&quot;12&quot;&gt;&lt;/a&gt;';
+    else urlMarkup = '&lt;a href=&quot;'+url+'&quot; target=&quot;_blank&quot;&gt;'+label+'&lt;/a&gt;';
+    return urlMarkup
   }
   
   function removeAllPopUps() {
@@ -1963,4 +2020,4 @@
       // setWorkspaceInfos();
       helpVisible = false;
     }
-  }  
+  }
\ No newline at end of file

Modified: trunk/src/de/kiezatlas/deepamehta/ImportWorker.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/ImportWorker.java	2010-08-20 10:30:08 UTC (rev 94)
+++ trunk/src/de/kiezatlas/deepamehta/ImportWorker.java	2010-08-23 22:31:34 UTC (rev 95)
@@ -650,10 +650,10 @@
         String subject = &quot;Ehrenamtsatlas: \&quot;&quot; + unusableProjects.size() + &quot;\&quot; fehlerhafte Addresseintr&#228;ge in der Ehrenamtsdatenbank&quot;;
         StringBuffer entries = new StringBuffer();
         entries.append(&quot;------------------------------\r&quot;);
-          for (int i = 0; i &lt; unusableProjects.size(); i++) {
+        for (int i = 0; i &lt; unusableProjects.size(); i++) {
             GeoObjectTopic entry = (GeoObjectTopic) unusableProjects.get(i);
             entries.append(&quot;Projekt: &quot;+ entry.getName()+ &quot; Adresseintrag: &quot; + entry.getAddress() + &quot;\r&quot;);
-          }
+        }
         entries.append(&quot;------------------------------\r&quot;);
         // &quot;body&quot;
         String body = &quot;Dies ist eine automatische Benachrichtigung erstellt von www.kiezatlas.de\r\r&quot; +

Modified: trunk/src/de/kiezatlas/deepamehta/ImportWorkerEvent.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/ImportWorkerEvent.java	2010-08-20 10:30:08 UTC (rev 94)
+++ trunk/src/de/kiezatlas/deepamehta/ImportWorkerEvent.java	2010-08-23 22:31:34 UTC (rev 95)
@@ -575,36 +575,7 @@
         return result;
     }
 
-    private Vector getGeoObjectInformation(String workspaceId) {
-        BaseTopic geoType = getWorkspaceGeoType(workspaceId);
-        if (geoType == null) {
-            System.out.println(&quot;&gt;&gt; Workspace (&quot;+workspaceId+&quot;) is not configured properly&quot;);
-            return new Vector();
-        }
-        return cm.getTopics(geoType.getID());
-    }
 
-	private Vector getWorkspaces(String userID, Session session) {
-		Vector workspaces = new Vector();
-		//
-        session.setAttribute(&quot;membership&quot;, &quot;&quot;);
-        Vector ws = as.getRelatedTopics(userID, SEMANTIC_MEMBERSHIP, TOPICTYPE_WORKSPACE, 2);
-        Enumeration e = ws.elements();
-        if (!e.hasMoreElements()) {
-            Vector aws = as.getRelatedTopics(userID, SEMANTIC_AFFILIATED_MEMBERSHIP, TOPICTYPE_WORKSPACE, 2);
-            session.setAttribute(&quot;membership&quot;, &quot;Affiliated&quot;);
-            e = aws.elements();
-        }
-		while (e.hasMoreElements()) {
-			BaseTopic w = (BaseTopic) e.nextElement();
-			//if (isKiezatlasWorkspace(w.getID())) {
-			workspaces.addElement(w);
-			//}
-		}
-		//
-		return workspaces;
-	}
-
     /**
      * returns null if no topictype whihc is assigned to the given workspace,
      * is a subtype of &quot;GeoObjectTopic&quot;
@@ -612,35 +583,6 @@
      * @param workspaceId
      * @return
      */
-    private BaseTopic getWorkspaceSubType(String workspaceId, String superTypeId) {
-        //
-        TypeTopic geotype = as.type(superTypeId, 1);
-        Vector subtypes = geotype.getSubtypeIDs();
-        Vector workspacetypes = as.getRelatedTopics(workspaceId, ASSOCTYPE_USES, 2);
-        int i;
-        for (i = 0; i &lt; workspacetypes.size(); i++) {
-            BaseTopic topic = (BaseTopic) workspacetypes.get(i);
-            int a;
-            for (a = 0; a &lt; subtypes.size(); a++) {
-                // System.out.println(&quot; counter: &quot; + a);
-                String derivedOne = (String) subtypes.get(a);
-                // System.out.println(&quot;    &quot; + derivedOne.getID() + &quot;:&quot; + derivedOne.getName());
-                if (derivedOne.equals(topic.getID())) {
-                    // System.out.println(&quot; found geoType &quot; + topic.getID() + &quot;:&quot; + topic.getName());
-                    return topic;
-                }
-            }
-        }
-        return null;
-    }
-
-    /**
-     * returns null if no topictype whihc is assigned to the given workspace,
-     * is a subtype of &quot;GeoObjectTopic&quot;
-     *
-     * @param workspaceId
-     * @return
-     */
     private BaseTopic getWorkspaceGeoType(String workspaceId) {
         //
         TypeTopic geotype = as.type(TOPICTYPE_KIEZ_GEO, 1);
@@ -663,36 +605,4 @@
         return null;
     }
 
-
-    /**
-     * simply retrieves the BaseTopics assigned to a workspace which are used
-     * for navigation in web-frontends
-     *
-     * @param workspaceId
-     * @return
-     */
-    private Vector getKiezCriteriaTypes(String workspaceId)
-    {
-        Vector criterias = new Vector();
-        TypeTopic critType = as.type(TOPICTYPE_CRITERIA, 1);
-        Vector subtypes = critType.getSubtypeIDs();
-        Vector workspacetypes = as.getRelatedTopics(workspaceId, &quot;at-uses&quot;, 2);
-        for(int i = 0; i &lt; workspacetypes.size(); i++)
-        {
-            BaseTopic topic = (BaseTopic)workspacetypes.get(i);
-            for(int a = 0; a &lt; subtypes.size(); a++)
-            {
-                String derivedOne = (String)subtypes.get(a);
-                if(derivedOne.equals(topic.getID()))
-                {
-                    //System.out.println(&quot;&gt;&gt;&gt; use criteria (&quot; + derivedOne + &quot;) &quot; + topic.getName());
-                    criterias.add(topic);
-                }
-            }
-
-        }
-
-        return criterias;
-    }
-
 }
\ No newline at end of file

Modified: trunk/src/de/kiezatlas/deepamehta/KiezServlet.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/KiezServlet.java	2010-08-20 10:30:08 UTC (rev 94)
+++ trunk/src/de/kiezatlas/deepamehta/KiezServlet.java	2010-08-23 22:31:34 UTC (rev 95)
@@ -97,6 +97,7 @@
         String criteriaList = createCritCatSystemList(workspaceId.substring(2, workspaceId.length()-2), mapId.substring(2, mapId.length()-2));
         result.append(criteriaList);
         result.append(&quot;, \&quot;error\&quot;: &quot; + messages + &quot;}&quot;);
+        System.out.println(&quot;[DEBUG] .. &quot; + result.toString() + &quot; \n &quot;);
         return result.toString();
     }
 
@@ -128,7 +129,6 @@
      * @return
      */
     private String searchTopics(String params, CorporateDirectives directives) {
-        System.out.println(&quot;&gt;&gt;&gt;&gt; searchGeoObjects(&quot; + params +&quot;)&quot;);
         StringBuffer result = new StringBuffer(&quot;{\&quot;result\&quot;: &quot;);
         StringBuffer messages = null;
         String parameters[] = params.split(&quot;,&quot;);
@@ -145,13 +145,13 @@
         Hashtable props = new Hashtable();
         props.put(PROPERTY_NAME, query);
         // String typeID, Hashtable propertyFilter, String topicmapID
-        Vector results = cm.getTopics(geoType.getID(), props, topicmapId, false); // getTopic(query, props, topicmapId, directives);
         // getTopics: String typeID, String nameFilter, Hashtable propertyFilter, String relatedTopicID
-        // getRelated: String topicID, String assocType, String relTopicType, int relTopicPos
-        Vector topicsToQuery = cm.getViewTopics(topicmapId, 1);
+        Vector results = cm.getTopics(geoType.getID(), props, topicmapId, false);
+        /*Vector topicsToQuery = cm.getViewTopics(topicmapId, 1);
         Vector streetResults = new Vector();
         for (int i = 0; i &lt; topicsToQuery.size(); i++) {
             BaseTopic topic = (BaseTopic) topicsToQuery.get(i);
+            // if (topic.getName().indexOf(query) != -1) results.add(topic); // by name
             Vector addresses = cm.getRelatedTopics(topic.getID(), ASSOCTYPE_ASSOCIATION, TOPICTYPE_ADDRESS, 2);
             for (int j = 0; j &lt; addresses.size(); j++) {
                 BaseTopic addressTopic = (BaseTopic) addresses.get(j);
@@ -161,9 +161,9 @@
                     // System.out.println(&quot;&gt;&gt;&gt;&gt; streetFound + &quot; + streetName+ &quot; for &quot; + topic.getName());
                 }
             }
-        }
-        results.addAll(streetResults);
-        System.out.println(&quot;&gt;&gt;&gt;&gt; found &quot; + results.size() + &quot; named and &quot;+streetResults.size()+ &quot; streetnames like &quot; + query);
+        }*/
+        // results.addAll(streetResults);
+        System.out.println(&quot;&gt;&gt;&gt;&gt; found &quot; + results.size() + &quot; by name&quot;);// +&quot; named and &quot;+streetResults.size()+ &quot; streetnames like &quot; + query);
         //
         result.append(&quot;[&quot;);
         for (int i=0; i &lt; results.size(); i++) {
@@ -189,7 +189,6 @@
      */
     private String getGeoMapTopics(String params, Session session, CorporateDirectives directives)
     {
-        System.out.println(&quot;&gt;&gt;&gt;&gt; getGeoMapTopics(&quot; + params + &quot;)&quot;);
         String parameters[] = params.split(&quot;,&quot;);
         String mapId = parameters[0];
         String workspaceId = parameters[1];
@@ -229,7 +228,6 @@
 
     private String createWorkspaceInfos(String workspaceId)
     {
-        // System.out.println(&quot;&gt;&gt;&gt; createWorkspaceInfos(&quot; + workspaceId+&quot;) ...&quot;);
         StringBuffer object = new StringBuffer();
         String workspaceName = as.getTopicProperty(workspaceId, 1, PROPERTY_NAME);
         String logoURL = &quot;&quot;;
@@ -356,14 +354,12 @@
     {
         StringBuffer catList = new StringBuffer(&quot;[&quot;);
         BaseTopic topic = cm.getTopic(topicId, 1);
-        for(int i = 0; i &lt; criterias.size(); i++)
-        {
+        for(int i = 0; i &lt; criterias.size(); i++) {
             BaseTopic criteria = (BaseTopic) criterias.get(i);
             // which topics are related and are of type criteria
             Vector categories = as.getRelatedTopics(topic.getID(), &quot;at-association&quot;, criteria.getID(), 2);
             int andex;
-            if(categories.size() == 0)
-            {
+            if(categories.size() == 0) {
                 catList.append(&quot;{\&quot;critId\&quot;: \&quot;&quot; + criteria.getID() + &quot;\&quot;, &quot;);
                 catList.append(&quot;\&quot;categories\&quot;: []&quot;);
                 andex = criterias.indexOf(criteria);
@@ -376,8 +372,7 @@
             }
             catList.append(&quot;{\&quot;critId\&quot;: \&quot;&quot; + criteria.getID() + &quot;\&quot;, &quot;);
             catList.append(&quot;\&quot;categories\&quot;: [&quot;);
-            for(int c = 0; c &lt; categories.size(); c++)
-            {
+            for(int c = 0; c &lt; categories.size(); c++) {
                 BaseTopic cat = (BaseTopic)categories.get(c);
                 int index = categories.indexOf(cat);
                 // awkyard
@@ -541,22 +536,10 @@
         text = text.trim();
         // JSON conformity
         text = removeControlChars(text);
-        // text = text.replaceAll(&quot;\r&quot;, &quot;\\\\n&quot;);
-        // text = text.replaceAll(&quot;\n&quot;, &quot;\\\\n&quot;);
-        // text = text.replaceAll(&quot;\&quot;&quot;, &quot;\\\\\&quot;&quot;);
         //
         return text;
     }
 
-    private String convertHTMLForJSON(String html)
-    {
-        html = html.replaceAll(&quot;\&quot;&quot;, &quot;\\\\\&quot;&quot;);
-        // html = html.replaceAll(&quot;\r&quot;, &quot;\\\\n&quot;);
-        // html = html.replaceAll(&quot;\n&quot;, &quot;\\\\n&quot;);
-        // html = html.replaceAll(&quot;\t&quot;, &quot;\\\\t&quot;);
-        return html;
-    }
-
     private String toUnicode(String text)
     {
         StringBuffer buffer = new StringBuffer();


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000082.html">[Kiezatlas-svn] r94 - in trunk/pages/be.de: . proxies
</A></li>
	<LI>Next message: <A HREF="000084.html">[Kiezatlas-svn] r96 - trunk/pages/be.de
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#83">[ date ]</a>
              <a href="thread.html#83">[ thread ]</a>
              <a href="subject.html#83">[ subject ]</a>
              <a href="author.html#83">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">More information about the Kiezatlas-svn
mailing list</a><br>
</body></html>
