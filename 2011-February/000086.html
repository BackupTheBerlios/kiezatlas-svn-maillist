<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Kiezatlas-svn] r99 - in trunk: . WEB-INF WEB-INF/lib	config/default db/patches pages pages/be.de	pages/be.de/proxies src/de/kiezatlas/deepamehta	src/de/kiezatlas/deepamehta/topics src/de/swers/kiezatlas/tools
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/kiezatlas-svn/2011-February/index.html" >
   <LINK REL="made" HREF="mailto:kiezatlas-svn%40lists.berlios.de?Subject=Re%3A%20%5BKiezatlas-svn%5D%20r99%20-%20in%20trunk%3A%20.%20WEB-INF%20WEB-INF/lib%0A%09config/default%20db/patches%20pages%20pages/be.de%0A%09pages/be.de/proxies%20src/de/kiezatlas/deepamehta%0A%09src/de/kiezatlas/deepamehta/topics%20src/de/swers/kiezatlas/tools&In-Reply-To=%3C20110209112616.C33F348138D%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Kiezatlas-svn] r99 - in trunk: . WEB-INF WEB-INF/lib	config/default db/patches pages pages/be.de	pages/be.de/proxies src/de/kiezatlas/deepamehta	src/de/kiezatlas/deepamehta/topics src/de/swers/kiezatlas/tools</H1>
    <B>maltito at mail.berlios.de</B> 
    <A HREF="mailto:kiezatlas-svn%40lists.berlios.de?Subject=Re%3A%20%5BKiezatlas-svn%5D%20r99%20-%20in%20trunk%3A%20.%20WEB-INF%20WEB-INF/lib%0A%09config/default%20db/patches%20pages%20pages/be.de%0A%09pages/be.de/proxies%20src/de/kiezatlas/deepamehta%0A%09src/de/kiezatlas/deepamehta/topics%20src/de/swers/kiezatlas/tools&In-Reply-To=%3C20110209112616.C33F348138D%40sheep.berlios.de%3E"
       TITLE="[Kiezatlas-svn] r99 - in trunk: . WEB-INF WEB-INF/lib	config/default db/patches pages pages/be.de	pages/be.de/proxies src/de/kiezatlas/deepamehta	src/de/kiezatlas/deepamehta/topics src/de/swers/kiezatlas/tools">maltito at mail.berlios.de
       </A><BR>
    <I>Wed Feb  9 12:26:16 CET 2011</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#86">[ date ]</a>
              <a href="thread.html#86">[ thread ]</a>
              <a href="subject.html#86">[ subject ]</a>
              <a href="author.html#86">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: maltito
Date: 2011-02-09 12:26:16 +0100 (Wed, 09 Feb 2011)
New Revision: 99

Added:
   trunk/WEB-INF/
   trunk/WEB-INF/lib/
   trunk/WEB-INF/lib/LICENSE.txt
   trunk/WEB-INF/lib/NOTICE.txt
   trunk/WEB-INF/lib/README.txt
   trunk/WEB-INF/lib/log4j-1.2.14.jar
   trunk/WEB-INF/lib/quartz-1.8.4.jar
   trunk/WEB-INF/lib/slf4j-api-1.6.0.jar
   trunk/WEB-INF/lib/slf4j-log4j12-1.6.0.jar
   trunk/conf/
   trunk/db/patches/ka-1.6.8.sql
   trunk/src/de/kiezatlas/deepamehta/SlimerServlet.java
   trunk/src/de/kiezatlas/deepamehta/TimedEngagementImporter.java
   trunk/src/de/kiezatlas/deepamehta/TimedEventImporter.java
   trunk/src/de/kiezatlas/deepamehta/TimerJobParameterHolder.java
Modified:
   trunk/config/default/web.xml
   trunk/db/patches/ka-1.6.7.sql
   trunk/pages/be.de/AlternativeAtlas.jsp
   trunk/pages/be.de/BerlinAtlas.jsp
   trunk/pages/be.de/CustomLayerSwitcher.js
   trunk/pages/be.de/app.html
   trunk/pages/be.de/bmap.php
   trunk/pages/be.de/kiezatlas.js
   trunk/pages/be.de/landmaps.css
   trunk/pages/be.de/maps.css
   trunk/pages/be.de/proxies/getGeoObjectInfo.php
   trunk/pages/be.de/proxies/getMapTopics.php
   trunk/pages/be.de/proxies/getWorkspaceCriterias.php
   trunk/pages/be.de/proxies/getWorkspaceInfos.php
   trunk/pages/be.de/proxies/searchGeoObjects.php
   trunk/pages/util.js
   trunk/src/de/kiezatlas/deepamehta/AtlasServlet.java
   trunk/src/de/kiezatlas/deepamehta/ImportServlet.java
   trunk/src/de/kiezatlas/deepamehta/ImportWorker.java
   trunk/src/de/kiezatlas/deepamehta/ImportWorkerEvent.java
   trunk/src/de/kiezatlas/deepamehta/KiezAtlas.java
   trunk/src/de/kiezatlas/deepamehta/topics/CityMapTopic.java
   trunk/src/de/kiezatlas/deepamehta/topics/GPSConverterTopic.java
   trunk/src/de/swers/kiezatlas/tools/UploadDataServlet.java
Log:
stalled commit towards Kiezatlas 1.6.8: Extended AJAX CityMap Client, Improving Importer Processes, Performance and Usability:

- CityMap's are now served as one big &quot;mega website&quot; via their webalias through the introduction of two new Java Servlets /atlas/* (for berlin.de) and /map/* (for kiezatlas.de)
- A new PATCH (-1.6.8.sql) is introduced to add an Importer Config-Topic which mainly keeps Report-Recipient and Icon-Configuration for imported categories
- A new (-1.6.7.sql) PATCH for a new CityMap' Password Property which now allews us to protect access to a CityMap on Application Level (at /browse/*.. /map/*.. /atlas/*.. )
- Introduced the Quartz-Framework as a dependency to handle the scheduling of jobs more nicely
- A couple of minor improvements (fahrinfo-berlin) and some code cleanup in the JS CityMap' Client (kiezatlas.js)

NOTE: PHP / HTML FIles to be removed when the transition to the new app is foreseeable/ completed

Added: trunk/WEB-INF/lib/LICENSE.txt
===================================================================
--- trunk/WEB-INF/lib/LICENSE.txt	                        (rev 0)
+++ trunk/WEB-INF/lib/LICENSE.txt	2011-02-09 11:26:16 UTC (rev 99)
@@ -0,0 +1,202 @@
+
+                                 Apache License
+                           Version 2.0, January 2004
+                        <A HREF="http://www.apache.org/licenses/">http://www.apache.org/licenses/</A>
+
+   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION
+
+   1. Definitions.
+
+      &quot;License&quot; shall mean the terms and conditions for use, reproduction,
+      and distribution as defined by Sections 1 through 9 of this document.
+
+      &quot;Licensor&quot; shall mean the copyright owner or entity authorized by
+      the copyright owner that is granting the License.
+
+      &quot;Legal Entity&quot; shall mean the union of the acting entity and all
+      other entities that control, are controlled by, or are under common
+      control with that entity. For the purposes of this definition,
+      &quot;control&quot; means (i) the power, direct or indirect, to cause the
+      direction or management of such entity, whether by contract or
+      otherwise, or (ii) ownership of fifty percent (50%) or more of the
+      outstanding shares, or (iii) beneficial ownership of such entity.
+
+      &quot;You&quot; (or &quot;Your&quot;) shall mean an individual or Legal Entity
+      exercising permissions granted by this License.
+
+      &quot;Source&quot; form shall mean the preferred form for making modifications,
+      including but not limited to software source code, documentation
+      source, and configuration files.
+
+      &quot;Object&quot; form shall mean any form resulting from mechanical
+      transformation or translation of a Source form, including but
+      not limited to compiled object code, generated documentation,
+      and conversions to other media types.
+
+      &quot;Work&quot; shall mean the work of authorship, whether in Source or
+      Object form, made available under the License, as indicated by a
+      copyright notice that is included in or attached to the work
+      (an example is provided in the Appendix below).
+
+      &quot;Derivative Works&quot; shall mean any work, whether in Source or Object
+      form, that is based on (or derived from) the Work and for which the
+      editorial revisions, annotations, elaborations, or other modifications
+      represent, as a whole, an original work of authorship. For the purposes
+      of this License, Derivative Works shall not include works that remain
+      separable from, or merely link (or bind by name) to the interfaces of,
+      the Work and Derivative Works thereof.
+
+      &quot;Contribution&quot; shall mean any work of authorship, including
+      the original version of the Work and any modifications or additions
+      to that Work or Derivative Works thereof, that is intentionally
+      submitted to Licensor for inclusion in the Work by the copyright owner
+      or by an individual or Legal Entity authorized to submit on behalf of
+      the copyright owner. For the purposes of this definition, &quot;submitted&quot;
+      means any form of electronic, verbal, or written communication sent
+      to the Licensor or its representatives, including but not limited to
+      communication on electronic mailing lists, source code control systems,
+      and issue tracking systems that are managed by, or on behalf of, the
+      Licensor for the purpose of discussing and improving the Work, but
+      excluding communication that is conspicuously marked or otherwise
+      designated in writing by the copyright owner as &quot;Not a Contribution.&quot;
+
+      &quot;Contributor&quot; shall mean Licensor and any individual or Legal Entity
+      on behalf of whom a Contribution has been received by Licensor and
+      subsequently incorporated within the Work.
+
+   2. Grant of Copyright License. Subject to the terms and conditions of
+      this License, each Contributor hereby grants to You a perpetual,
+      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
+      copyright license to reproduce, prepare Derivative Works of,
+      publicly display, publicly perform, sublicense, and distribute the
+      Work and such Derivative Works in Source or Object form.
+
+   3. Grant of Patent License. Subject to the terms and conditions of
+      this License, each Contributor hereby grants to You a perpetual,
+      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
+      (except as stated in this section) patent license to make, have made,
+      use, offer to sell, sell, import, and otherwise transfer the Work,
+      where such license applies only to those patent claims licensable
+      by such Contributor that are necessarily infringed by their
+      Contribution(s) alone or by combination of their Contribution(s)
+      with the Work to which such Contribution(s) was submitted. If You
+      institute patent litigation against any entity (including a
+      cross-claim or counterclaim in a lawsuit) alleging that the Work
+      or a Contribution incorporated within the Work constitutes direct
+      or contributory patent infringement, then any patent licenses
+      granted to You under this License for that Work shall terminate
+      as of the date such litigation is filed.
+
+   4. Redistribution. You may reproduce and distribute copies of the
+      Work or Derivative Works thereof in any medium, with or without
+      modifications, and in Source or Object form, provided that You
+      meet the following conditions:
+
+      (a) You must give any other recipients of the Work or
+          Derivative Works a copy of this License; and
+
+      (b) You must cause any modified files to carry prominent notices
+          stating that You changed the files; and
+
+      (c) You must retain, in the Source form of any Derivative Works
+          that You distribute, all copyright, patent, trademark, and
+          attribution notices from the Source form of the Work,
+          excluding those notices that do not pertain to any part of
+          the Derivative Works; and
+
+      (d) If the Work includes a &quot;NOTICE&quot; text file as part of its
+          distribution, then any Derivative Works that You distribute must
+          include a readable copy of the attribution notices contained
+          within such NOTICE file, excluding those notices that do not
+          pertain to any part of the Derivative Works, in at least one
+          of the following places: within a NOTICE text file distributed
+          as part of the Derivative Works; within the Source form or
+          documentation, if provided along with the Derivative Works; or,
+          within a display generated by the Derivative Works, if and
+          wherever such third-party notices normally appear. The contents
+          of the NOTICE file are for informational purposes only and
+          do not modify the License. You may add Your own attribution
+          notices within Derivative Works that You distribute, alongside
+          or as an addendum to the NOTICE text from the Work, provided
+          that such additional attribution notices cannot be construed
+          as modifying the License.
+
+      You may add Your own copyright statement to Your modifications and
+      may provide additional or different license terms and conditions
+      for use, reproduction, or distribution of Your modifications, or
+      for any such Derivative Works as a whole, provided Your use,
+      reproduction, and distribution of the Work otherwise complies with
+      the conditions stated in this License.
+
+   5. Submission of Contributions. Unless You explicitly state otherwise,
+      any Contribution intentionally submitted for inclusion in the Work
+      by You to the Licensor shall be under the terms and conditions of
+      this License, without any additional terms or conditions.
+      Notwithstanding the above, nothing herein shall supersede or modify
+      the terms of any separate license agreement you may have executed
+      with Licensor regarding such Contributions.
+
+   6. Trademarks. This License does not grant permission to use the trade
+      names, trademarks, service marks, or product names of the Licensor,
+      except as required for reasonable and customary use in describing the
+      origin of the Work and reproducing the content of the NOTICE file.
+
+   7. Disclaimer of Warranty. Unless required by applicable law or
+      agreed to in writing, Licensor provides the Work (and each
+      Contributor provides its Contributions) on an &quot;AS IS&quot; BASIS,
+      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
+      implied, including, without limitation, any warranties or conditions
+      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
+      PARTICULAR PURPOSE. You are solely responsible for determining the
+      appropriateness of using or redistributing the Work and assume any
+      risks associated with Your exercise of permissions under this License.
+
+   8. Limitation of Liability. In no event and under no legal theory,
+      whether in tort (including negligence), contract, or otherwise,
+      unless required by applicable law (such as deliberate and grossly
+      negligent acts) or agreed to in writing, shall any Contributor be
+      liable to You for damages, including any direct, indirect, special,
+      incidental, or consequential damages of any character arising as a
+      result of this License or out of the use or inability to use the
+      Work (including but not limited to damages for loss of goodwill,
+      work stoppage, computer failure or malfunction, or any and all
+      other commercial damages or losses), even if such Contributor
+      has been advised of the possibility of such damages.
+
+   9. Accepting Warranty or Additional Liability. While redistributing
+      the Work or Derivative Works thereof, You may choose to offer,
+      and charge a fee for, acceptance of support, warranty, indemnity,
+      or other liability obligations and/or rights consistent with this
+      License. However, in accepting such obligations, You may act only
+      on Your own behalf and on Your sole responsibility, not on behalf
+      of any other Contributor, and only if You agree to indemnify,
+      defend, and hold each Contributor harmless for any liability
+      incurred by, or claims asserted against, such Contributor by reason
+      of your accepting any such warranty or additional liability.
+
+   END OF TERMS AND CONDITIONS
+
+   APPENDIX: How to apply the Apache License to your work.
+
+      To apply the Apache License to your work, attach the following
+      boilerplate notice, with the fields enclosed by brackets &quot;[]&quot;
+      replaced with your own identifying information. (Don't include
+      the brackets!)  The text should be enclosed in the appropriate
+      comment syntax for the file format. We also recommend that a
+      file or class name and description of purpose be included on the
+      same &quot;printed page&quot; as the copyright notice for easier
+      identification within third-party archives.
+
+   Copyright [yyyy] [name of copyright owner]
+
+   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
+   you may not use this file except in compliance with the License.
+   You may obtain a copy of the License at
+
+       <A HREF="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</A>
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.

Added: trunk/WEB-INF/lib/NOTICE.txt
===================================================================
--- trunk/WEB-INF/lib/NOTICE.txt	                        (rev 0)
+++ trunk/WEB-INF/lib/NOTICE.txt	2011-02-09 11:26:16 UTC (rev 99)
@@ -0,0 +1,2 @@
+Quartz Scheduler
+Copyright 2001-2009 Terracotta, Inc.

Added: trunk/WEB-INF/lib/README.txt
===================================================================
--- trunk/WEB-INF/lib/README.txt	                        (rev 0)
+++ trunk/WEB-INF/lib/README.txt	2011-02-09 11:26:16 UTC (rev 99)
@@ -0,0 +1,211 @@
+
+==============================================================================
+This file is intended to help you get started with the Quartz project.
+
+For more information see <A HREF="http://www.quartz-scheduler.org">http://www.quartz-scheduler.org</A>
+==============================================================================
+
+
+What is Quartz?
+==============================================================================
+
+Quartz is an open source project aimed at creating a free-for-use Job 
+Scheduler, with enterprise features.
+
+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
+use this file except in compliance with the License. You may obtain a copy
+of the License at
+
+    <A HREF="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</A>
+
+Additionally, a copy of the license and its accompanying notice file is
+included with the distribution.
+
+
+What is in this package?
+==============================================================================
+
+quartz-all-&lt;ver&gt;.jar        all-in-one Quartz library.  Includes the core
+                            Quartz components plus all optional packages.  If
+                            you use this library, no other quartz-*.jars are
+                            necessary.
+
+quartz-&lt;ver&gt;.jar            core Quartz library.
+
+quartz-jboss-&lt;ver&gt;.jar      optional JBoss specific Quartz extensions such as
+                            the Quartz startup MBean, QuartzService.
+
+quartz-oracle-&lt;ver&gt;.jar     optional Oracle specific Quartz extensions such as
+                            the OracleDelegate.
+
+quartz-terracotta-&lt;ver&gt;.jar optional Terracotta specific Quartz extension to 
+                            enable the Terracotta Job Store for Terracotta 
+                            based clustering (Located in the Terracotta Kit 
+                            <A HREF="http://www.terracotta.org/dl/oss-download-catalog">http://www.terracotta.org/dl/oss-download-catalog</A>)
+
+quartz-weblogic-&lt;ver&gt;.jar   optional WebLogic specific Quartz extensions such
+                            as the WebLogicDelegate.
+
+README.txt                  this file.
+
+LICENSE.txt                 a document declaring the license under which
+                            Quartz can be used and distributed.
+
+docs/dbTables               sql scripts for creating Quartz database tables in
+                            a variety of different databases.
+
+quartz                      source code for the main quartz module, including
+                            the following packages:
+
+    org.quartz              the main package of the Quartz project,
+                            containing the 'public' (client-side) API for
+                            the scheduler
+
+    org.quartz.core         a package containing the 'private' (server-side)
+                            components of Quartz.
+
+    org.quartz.simpl        a package contain simple implementations of
+                            Quartz support modules (JobStores, ThreadPools,
+                            Loggers, etc.) that have no dependencies on
+                            external (third-party) products.
+
+    org.quartz.impl         a package containing implementations of Quartz
+                            support modules (JobStores, ThreadPools,
+                            Loggers, etc.) that may have dependencies on
+                            external (third-party) products - but may be
+                            more robust.
+
+    org.quartz.utils        a package containing some utility/helper
+                            components used through-out the main Quartz
+                            components.
+
+quartz-jboss                source code for the quartz-jboss module
+
+quartz-oracle               source code for the quartz-oracle module
+
+quartz-weblogic             source code for the quartz-weblogic module
+
+quartz-all                  module to compile the quartz-all jar
+
+examples                    a directory containing some code samples on the
+                            usage of Quartz.  The first example you should
+                            look at is 'example1.bat' or 'example1.sh' -
+                            depending if you're a win-dos or unix person.
+                            This example uses the code found in the
+                            SchedTest.java class, which is also in the
+                            examples directory.
+
+lib                         a directory which should contain all of the
+                            third-party libraries that are needed in order
+                            to use all of the features of Quartz. (Some are
+                            not automatically there, but you need to get
+                            them and put them there if you use the features 
+                            they depend on -- see below).
+
+
+
+Where should I start if I am new to Quartz?
+==============================================================================
+
+There is an FAQ, tutorial and configuration reference that can be found on the 
+main Quartz website at <A HREF="http://quartz-scheduler.org/docs/index.html">http://quartz-scheduler.org/docs/index.html</A>
+
+Most of the Java source files are fairly well documented with JavaDOC -
+consider this your &quot;reference manual&quot;.  
+
+Start by looking at org.quartz.Scheduler, org.quartz.Job,
+org.quartz.JobDetail and org.quartz.Trigger.
+
+Examine and run the examples found in the &quot;examples&quot; directory.
+
+If you're interested in the &quot;behind the scenes&quot; (server-side) code,
+you'll want to look at org.quartz.core.QuartzSchedulerThread, which
+will make you interested in org.quartz.spi.JobStore.java,
+org.quartz.spi.ThreadPool.java and org.quartz.core.JobRunShell.
+
+
+What should I do if I encounter a problem?
+==============================================================================
+
+Help is available via the Quartz Users forum:
+
+  <A HREF="http://forums.terracotta.org/forums/forums/show/17.page">http://forums.terracotta.org/forums/forums/show/17.page</A>
+
+Please report bugs / issues to JIRA at:
+
+  <A HREF="https://jira.terracotta.org/jira/browse/QTZ">https://jira.terracotta.org/jira/browse/QTZ</A>
+
+
+How do I build Quartz?
+==============================================================================
+
+Quartz is built using the Maven project management tool.  If you don't 
+already have Maven installed, download it from the Apache website 
+(<A HREF="http://maven.apache.org">http://maven.apache.org</A>) and follow the installation instructions.  You can 
+confirm the version of Maven you have installed by typing: mvn --version
+
+To build, simply execute &quot;mvn install&quot; from the top level Quartz project 
+directory. This command will build the Quartz JAR files and install them 
+into your local repository.  Along the way it will also execute all of the 
+Quartz unit and integration tests.  You can disable tests by 
+passing -Dmaven.test.skip=true on the mvn command-line.
+
+By default, only the main &quot;quartz&quot; module and the &quot;quartz-jboss&quot; module 
+JARs are built.  The quartz-oracle and quartz-weblogic depend on 
+proprietary Oracle and Weblogic JARs that are not available in any public 
+Maven repositories, and therefore these modules have been excluded from 
+the default build.  To build these modules you will need to obtain the 
+following JAR files and install them into your local Maven repository:
+
+    com.oracle:ojdbc5:jar:11.2.0
+    com.bea.core:datasource:jar:1.6.0
+
+Once you have these artifacts installed into your local repository you can
+enable the quartz-oracle and quartz-weblogic modules by activating the Maven
+profiles &quot;oracle&quot; and &quot;weblogic&quot; with the -P mvn command-line option. 
+For example:
+
+    mvn -Pweblogic install
+
+Note that the quartz-weblogic module depends on the quartz-oracle 
+module, and therefore the weblogic Maven profile implies the oracle 
+profile.
+
+To create the downloadable distribution, invoke the package phase and the
+assembly:assembly plugin goal with prepare-distribution profile enabled, 
+i.e.:
+
+    mvn -Pprepare-distribution package assembly:assembly
+
+To include the quartz-oracle and quartz-weblogic artifacts in the 
+distribution, make sure to enable the respective profiles when assembling 
+the package, i.e.:
+
+    mvn -Pprepare-distribution -Poracle,weblogic,all package assembly:assembly
+
+
+How can I get started with the Terracotta Job Store?
+==============================================================================
+
+The Terracotta Job Store provides an easy way to implement a highly 
+available, highly scalable, and durable way to schedule jobs across 
+multiple nodes. As with other Terracotta solutions, Quartz clustering 
+can be achieved via a Terracotta Express installation as well as via a 
+Terracotta Custom Installation. To use the Terracotta Job Store in a 
+Custom Installation - i.e. in conjunction with other Terracotta DSO uses 
+(such as shared objects/shared roots/TIMs/clustered web sessions) please 
+consult the online documentation.
+
+For an Express installation, simply include the quartz-&lt;ver&gt; and 
+quartz-terracotta-&lt;ver&gt; jars in your application classpath, and then 
+configure your app to use the Terracotta Job Store by setting the 
+following in your quartz.properties file (or set these properties 
+directly within the application)
+
+    org.quartz.jobStore.class = org.terracotta.quartz.TerracottaJobStore
+    org.quartz.jobStore.tcConfigUrl = localhost:9510
+
+This assumes that you are running the Terracotta server on the localhost 
+(which can be started using the bin/start-tc-server.[sh|bat] script). If 
+not, replace localhost as appropriate. The Terracotta Job Store requires 
+Terracotta 3.2.0 or greater.

Added: trunk/WEB-INF/lib/log4j-1.2.14.jar
===================================================================
(Binary files differ)


Property changes on: trunk/WEB-INF/lib/log4j-1.2.14.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Added: trunk/WEB-INF/lib/quartz-1.8.4.jar
===================================================================
(Binary files differ)


Property changes on: trunk/WEB-INF/lib/quartz-1.8.4.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Added: trunk/WEB-INF/lib/slf4j-api-1.6.0.jar
===================================================================
(Binary files differ)


Property changes on: trunk/WEB-INF/lib/slf4j-api-1.6.0.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Added: trunk/WEB-INF/lib/slf4j-log4j12-1.6.0.jar
===================================================================
(Binary files differ)


Property changes on: trunk/WEB-INF/lib/slf4j-log4j12-1.6.0.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Modified: trunk/config/default/web.xml
===================================================================
--- trunk/config/default/web.xml	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/config/default/web.xml	2011-02-09 11:26:16 UTC (rev 99)
@@ -2,7 +2,8 @@
 &lt;!DOCTYPE web-app PUBLIC &quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot; &quot;<A HREF="http://java.sun.com/dtd/web-app_2_3.dtd">http://java.sun.com/dtd/web-app_2_3.dtd</A>&quot;&gt;
 &lt;web-app&gt;
 
-    &lt;Listener className=&quot;de.kiezatlas.deepamehta.LifeCycleWatcher&quot;/&gt;
+  &lt;Listener className=&quot;de.kiezatlas.deepamehta.LifeCycleWatcher&quot;/&gt;
+  &lt;Listener classNAme=&quot;org.quartz.ee.servlet.QuartzInitializerListener&quot;/&gt;
 
 	&lt;!-- General description of the web application --&gt;
 
@@ -35,6 +36,25 @@
 		&lt;/description&gt;
 	&lt;/context-param&gt;
 
+  &lt;!-- Context-Information for starting up the Quartz Timing Framework
+
+   &lt;context-param&gt;
+     &lt;param-name&gt;quartz:shutdown-on-unload&lt;/param-name&gt;
+     &lt;param-value&gt;true&lt;/param-value&gt;
+   &lt;/context-param&gt;
+
+   &lt;context-param&gt;
+     &lt;param-name&gt;quartz:wait-on-shutdown&lt;/param-name&gt;
+     &lt;param-value&gt;false&lt;/param-value&gt;
+   &lt;/context-param&gt;
+
+   &lt;context-param&gt;
+     &lt;param-name&gt;quartz:start-scheduler-on-load&lt;/param-name&gt;
+     &lt;param-value&gt;true&lt;/param-value&gt;
+   &lt;/context-param&gt;
+
+    --&gt;
+
 	&lt;!-- Servlet definitions for the servlets that make up
 		 the web application.
 	--&gt;
@@ -87,12 +107,22 @@
 		&lt;servlet-class&gt;de.kiezatlas.deepamehta.MapServlet&lt;/servlet-class&gt;
 	&lt;/servlet&gt;
 
+	&lt;!-- &lt;servlet&gt;
+	  &lt;servlet-name&gt;SlimerServlet&lt;/servlet-name&gt;
+	  &lt;servlet-class&gt;de.kiezatlas.deepamehta.SlimerServlet&lt;/servlet-class&gt;
+    &lt;init-param&gt;
+	    &lt;param-name&gt;shutdown-on-unload&lt;/param-name&gt;
+	    &lt;param-value&gt;true&lt;/param-value&gt;
+	  &lt;/init-param&gt;
+	  &lt;load-on-startup&gt;0&lt;/load-on-startup&gt;
+	&lt;/servlet&gt;
+  --&gt;
+
 	&lt;!-- Define mappings that are used by the servlet container to
 		 translate a particular request URI (context-relative) to a
 		 particular servlet.
 	--&gt;
 
-    
 
   &lt;servlet-mapping&gt;
 		&lt;servlet-name&gt;Browse Servlet&lt;/servlet-name&gt;
@@ -137,10 +167,8 @@
 	&lt;!-- Define the default session timeout for your application,
 		 in minutes.
 	--&gt;
-
     
-
-    &lt;session-config&gt;
+  &lt;session-config&gt;
 		&lt;session-timeout&gt;120&lt;/session-timeout&gt;
 	&lt;/session-config&gt;
 

Modified: trunk/db/patches/ka-1.6.7.sql
===================================================================
--- trunk/db/patches/ka-1.6.7.sql	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/db/patches/ka-1.6.7.sql	2011-02-09 11:26:16 UTC (rev 99)
@@ -1,2 +1,2 @@
-INSERT INTO Association VALUES ('at-composition', 1, 1, 'a-ka-125', '', 'tt-ka-stadtplan', 1, 'pp-ka-password', 1);
-INSERT INTO AssociationProp VALUES ('a-ka-125', 1, 'Ordinal Number', '360');
+INSERT INTO Association VALUES ('at-composition', 1, 1, 'a-ka-126', '', 'tt-ka-stadtplan', 1, 'pp-ka-password', 1);
+INSERT INTO AssociationProp VALUES ('a-ka-126', 1, 'Ordinal Number', '360');

Added: trunk/db/patches/ka-1.6.8.sql
===================================================================
--- trunk/db/patches/ka-1.6.8.sql	                        (rev 0)
+++ trunk/db/patches/ka-1.6.8.sql	2011-02-09 11:26:16 UTC (rev 99)
@@ -0,0 +1,57 @@
+
+-------------------------------
+--- Intro Importer Config Topic
+-------------------------------
+
+--- Fixing patch Assocation ID from ka-1.6.7.sql
+
+-- ALTER Association VALUE ('at-composition', 1, 1, 'a-ka-125', '', 'tt-ka-stadtplan', 1, 'pp-ka-password', 1);
+
+--- create topic type &quot;Importer Settings&quot; ---
+
+INSERT INTO Topic VALUES ('tt-topictype', 1, 1, 'tt-ka-importersettings', 'Importer Settings');
+INSERT INTO TopicProp VALUES ('tt-ka-importersettings', 1, 'Name', 'Importer Settings');
+INSERT INTO TopicProp VALUES ('tt-ka-importersettings', 1, 'Plural Name', 'Importer Settings');
+INSERT INTO TopicProp VALUES ('tt-ka-importersettings', 1, 'Description', '&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;A &lt;i&gt;Importer Setting&lt;/i&gt; is connected to a Kiezatlas Workspace, and provides additional information for the TimedImporter-Implementations&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;');
+INSERT INTO TopicProp VALUES ('tt-ka-importersettings', 1, 'Description Query', 'What are &quot;Importer Settings&quot;?');
+INSERT INTO TopicProp VALUES ('tt-ka-importersettings', 1, 'Icon', 'gear.gif');
+
+-- super type
+INSERT INTO Association VALUES ('at-derivation', 1, 1, 'a-ka-127', '', 'tt-generic', 1, 'tt-ka-importersettings', 1);
+
+-- search type
+INSERT INTO Topic VALUES ('tt-topictype', 1, 1, 'tt-ka-importersettings-search', 'Importer Settings Search');
+INSERT INTO TopicProp VALUES ('tt-ka-importersettings-search', 1, 'Name', 'Importer Settings Search');
+
+-- derive search type
+INSERT INTO Association VALUES ('at-derivation', 1, 1, 'a-ka-128', '', 'tt-topiccontainer', 1, 'tt-ka-importersettings-search', 1);
+
+-- assign search type to type
+INSERT INTO Association VALUES ('at-aggregation', 1, 1, 'a-ka-129', '', 'tt-ka-importersettings-search', 1, 'tt-ka-importersettings', 1);
+
+--- create property &quot;Icons / Categories&quot; ---
+INSERT INTO Topic VALUES ('tt-property', 1, 1, 'pp-ka-importersetting-icons', 'Icons / Kategorien');
+INSERT INTO TopicProp VALUES ('pp-ka-importersetting-icons', 1, 'Name', 'Icons / Kategorien');
+INSERT INTO TopicProp VALUES ('pp-ka-importersetting-icons', 1, 'Visualization', 'Multiline Input Field');
+
+--- create property &quot;Content Report Mailbox&quot; ---
+INSERT INTO Topic VALUES ('tt-property', 1, 1, 'pp-ka-importersetting-contentbox', 'Content Report Mailbox');
+INSERT INTO TopicProp VALUES ('pp-ka-importersetting-contentbox', 1, 'Name', 'Content Report Mailbox');
+INSERT INTO TopicProp VALUES ('pp-ka-importersetting-contentbox', 1, 'Visualization', 'Input Field');
+
+--- create property &quot;Service Report Mailbox&quot; ---
+INSERT INTO Topic VALUES ('tt-property', 1, 1, 'pp-ka-importersetting-servicebox', 'Service Report Mailbox');
+INSERT INTO TopicProp VALUES ('pp-ka-importersetting-servicebox', 1, 'Name', 'Service Report Mailbox');
+INSERT INTO TopicProp VALUES ('pp-ka-importersetting-servicebox', 1, 'Visualization', 'Input Field');
+
+--- assign properties&quot; to &quot;Import Settings&quot;
+INSERT INTO Association VALUES ('at-composition', 1, 1, 'a-ka-130', '', 'tt-ka-importersettings', 1, 'pp-ka-importersetting-icons', 1);
+INSERT INTO AssociationProp VALUES ('a-ka-130', 1, 'Ordinal Number', '133');
+INSERT INTO Association VALUES ('at-composition', 1, 1, 'a-ka-131', '', 'tt-ka-importersettings', 1, 'pp-ka-importersetting-contentbox', 1);
+INSERT INTO AssociationProp VALUES ('a-ka-131', 1, 'Ordinal Number', '131');
+INSERT INTO Association VALUES ('at-composition', 1, 1, 'a-ka-132', '', 'tt-ka-importersettings', 1, 'pp-ka-importersetting-servicebox', 1);
+INSERT INTO AssociationProp VALUES ('a-ka-132', 1, 'Ordinal Number', '132');
+
+--- assign &quot;Importer Settings&quot; Topic to Adminstration Workgroup
+INSERT INTO Association VALUES ('at-uses', 1, 1, 'a-ka-133', '', 't-administrationgroup', 1, 'tt-ka-importersettings', 1);
+INSERT INTO AssociationProp VALUES ('a-ka-133', 1, 'Access Permission', 'create');
\ No newline at end of file

Modified: trunk/pages/be.de/AlternativeAtlas.jsp
===================================================================
--- trunk/pages/be.de/AlternativeAtlas.jsp	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/pages/be.de/AlternativeAtlas.jsp	2011-02-09 11:26:16 UTC (rev 99)
@@ -75,14 +75,14 @@
       if (debug) log(&quot;mapTopics:&quot; + mapTopics.result.topics.length);
       if (debug) log(&quot;workspaceCrits:&quot; + workspaceCriterias.result.length);
       if (debug) log(&quot;districtNames:&quot; + workspaceCriterias.result[4].categories[0].catName);
-      if (workspaceCriterias.result.length &gt;= 4) districtNames = workspaceCriterias.result[4].categories;
+      if (onBerlinDe &amp;&amp; workspaceCriterias.result.length &gt; 4) districtNames = workspaceCriterias.result[4].categories;
       setWorkspaceInfos();
       setCityMapName('&lt;%= map.getName() %&gt;'); // fetch and set CityMapName
-      handleResize(); // do the layout
       // check if a special criteria was set through an entry url
       if (crtCritIndex &gt;= workspaceCriterias.result.length) {
         crtCritIndex = 0;// workspaceCriterias.result.length;
       }
+      handleResize(); // do the layout
       // cityMap setup
       bounds = calculateInitialBounds();
       // after the dom is loaded we can init our parts of the app

Modified: trunk/pages/be.de/BerlinAtlas.jsp
===================================================================
--- trunk/pages/be.de/BerlinAtlas.jsp	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/pages/be.de/BerlinAtlas.jsp	2011-02-09 11:26:16 UTC (rev 99)
@@ -77,7 +77,7 @@
       if (debug) log(&quot;mapTopics:&quot; + mapTopics.result.topics.length);
       if (debug) log(&quot;workspaceCrits:&quot; + workspaceCriterias.result.length);
       if (debug) log(&quot;districtNames:&quot; + workspaceCriterias.result[4].categories[0].catName);
-      if (workspaceCriterias.result.length &gt;= 4) districtNames = workspaceCriterias.result[4].categories;
+      if (onBerlinDe &amp;&amp; workspaceCriterias.result.length &gt; 4) districtNames = workspaceCriterias.result[4].categories;
       setWorkspaceInfos();
       setCityMapName(mapTitle);
       handleResize(); // do the layout

Modified: trunk/pages/be.de/CustomLayerSwitcher.js
===================================================================
--- trunk/pages/be.de/CustomLayerSwitcher.js	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/pages/be.de/CustomLayerSwitcher.js	2011-02-09 11:26:16 UTC (rev 99)
@@ -502,7 +502,6 @@
         this.layersDiv.id = this.id + &quot;_layersDiv&quot;;
         // this.layersDiv.setAttribute(&quot;right&quot;, &quot;25px&quot;);
         // this.layersDiv.style.border = &quot;thin solid red&quot;;
-        // this.layersDiv.style.position = &quot;relative right: 100px top: 200px; !important&quot;;
         // mright: 100px&quot;;
         OpenLayers.Element.addClass(this.layersDiv, &quot;layersDiv&quot;);
         // base layer div
@@ -521,7 +520,13 @@
         OpenLayers.Element.addClass(this.dataLayersDiv, &quot;dataLayersDiv&quot;);
 
         if (this.ascending) {
-            this.P = document.createElement(&quot;p&quot;);
+            this.P = document.createElement(&quot;br&quot;);
+            if (navigator.appName == &quot;Microsoft Internet Explorer&quot;) {
+              this.P = document.createElement(&quot;p&quot;);
+              this.P.innerHTML = &quot;&nbsp;&quot;
+              this.layersDiv.style.left = &quot;-65px&quot;;
+              // this.layersDiv.style.top = &quot;15px&quot;;
+            }
             this.BR = document.createElement(&quot;br&quot;);
             this.layersDiv.appendChild(this.P);
             this.layersDiv.appendChild(this.baseLbl);
@@ -530,7 +535,13 @@
             this.layersDiv.appendChild(this.dataLbl);
             this.layersDiv.appendChild(this.dataLayersDiv);
         } else {
-            this.P = document.createElement(&quot;p&quot;);
+            this.P = document.createElement(&quot;br&quot;);
+            if (navigator.appName == &quot;Microsoft Internet Explorer&quot;) {
+              this.P = document.createElement(&quot;p&quot;);
+              this.P.innerHTML = &quot;&nbsp;&quot;
+              this.layersDiv.style.left = &quot;-65px&quot;;
+              // this.layersDiv.style.top = &quot;15px&quot;;
+            }
             this.BR = document.createElement(&quot;br&quot;);
             this.layersDiv.appendChild(this.P);
             this.layersDiv.appendChild(this.dataLbl);

Modified: trunk/pages/be.de/app.html
===================================================================
--- trunk/pages/be.de/app.html	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/pages/be.de/app.html	2011-02-09 11:26:16 UTC (rev 99)
@@ -24,7 +24,7 @@
 	    var hotspots = [];
 	    var footerMessage = '&lt;b&gt;&lt;a href=&quot;<A HREF="http://www.kiezatlas.de">http://www.kiezatlas.de</A>&quot;&gt;Kiezatlas&lt;/a&gt;&lt;/b&gt; is powered by &lt;a href=&quot;<A HREF="http://www.deepamehta.de">http://www.deepamehta.de</A>&quot;&gt;DeepaMehta&lt;/a&gt;';
 	    var slimWidth = true; // if set to true totalWidth, the following totalidth is used
-    	  var helpVisible = false;
+      var helpVisible = false;
 	    var totalWidth = 1000; // 953
 	    var headerGap = 63;
 	    var map = &quot;&quot;;

Modified: trunk/pages/be.de/bmap.php
===================================================================
--- trunk/pages/be.de/bmap.php	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/pages/be.de/bmap.php	2011-02-09 11:26:16 UTC (rev 99)
@@ -1,11 +1,11 @@
 &lt;?php
     require_once &quot;HTTP/Request.php&quot;;
-	// getMapTopics
+	  // getMapTopics
     $workspaceId = $_GET['workspaceId'];
     $topicId = $_GET['topicId'];
     $originId = $_GET['linkTo'];
     $body = '{&quot;method&quot;: &quot;getMapTopics&quot;, &quot;params&quot;: [&quot;'.$topicId.'&quot; , &quot;'.$workspaceId.'&quot;]}';
-    $req1 =&amp; new HTTP_Request(&quot;<A HREF="http://www.kiezatlas.de:8080/rpc/">http://www.kiezatlas.de:8080/rpc/</A>&quot;);
+    $req1 =&amp; new HTTP_Request(&quot;<A HREF="http://localhost:8080/kiezatlas/rpc/">http://localhost:8080/kiezatlas/rpc/</A>&quot;);
     // <A HREF="http://localhost:8080/kiezatlas/rpc/">http://localhost:8080/kiezatlas/rpc/</A> -- <A HREF="http://www.kiezatlas.de:8080/rpc/">http://www.kiezatlas.de:8080/rpc/</A>
     $req1-&gt;addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);
     // $req2-&gt;addHeader(&quot;Charset&quot;, &quot;utf-8&quot;);
@@ -19,8 +19,8 @@
     $mapTopics = utf8_encode($resp1);
 
     // getWorkspaceCriterias
-    $body = '{&quot;method&quot;: &quot;getWorkspaceCriterias&quot;, &quot;params&quot;: [&quot;'.$workspaceId.'&quot;, &quot;'.$topicId.'&quot;]}';
-    $req2 =&amp; new HTTP_Request(&quot;<A HREF="http://www.kiezatlas.de:8080/rpc/">http://www.kiezatlas.de:8080/rpc/</A>&quot;);
+    $body = '{&quot;method&quot;: &quot;getWorkspaceCriterias&quot;, &quot;params&quot;: [&quot;'.$topicId.'&quot;]}';
+    $req2 =&amp; new HTTP_Request(&quot;<A HREF="http://localhost:8080/kiezatlas/rpc/">http://localhost:8080/kiezatlas/rpc/</A>&quot;);
     $req2-&gt;addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;); 
     // $req2-&gt;addHeader(&quot;Charset&quot;, &quot;utf-8&quot;);
     $req2-&gt;setBody($body);
@@ -92,6 +92,8 @@
 	      var debug_window = window.open('','','width=400,height=600,scrollbars=1');
 	    }
 	    var gKey = 'ABQIAAAADev2ctFkze28KEcta5b4WBSQDgFJvORzMhuwLQZ9zEDMQLdVUhTWXHB2vS0W0TdlEbDiH_qzhBEZ5A';
+      // kiezatlas.js deployment switch
+      onBerlinDe = true;
 	    //
 	    jQuery(document).ready(function(){
 	    	// register resize
@@ -157,8 +159,8 @@
 		    &lt;/div&gt;
 		    &lt;div id=&quot;searchInput&quot;&gt;
 		      &lt;form id=&quot;searchForm&quot; action=&quot;javascript:searchRequest()&quot;&gt;
-			    &lt;label for=&quot;searchInputField&quot;&gt;Suchen&lt;/label&gt;
-			    &lt;input id=&quot;searchInputField&quot; type=&quot;text&quot; value=&quot;Name&quot; size=&quot;15&quot;/&gt;
+			    &lt;label for=&quot;searchInputField&quot;&gt;Suche&lt;/label&gt;
+			    &lt;input id=&quot;searchInputField&quot; type=&quot;text&quot; value=&quot;Einsatzm&#246;glichkeit&quot; size=&quot;15&quot;/&gt;
 			    &lt;ul&gt;
 			    &lt;/ul&gt;
 		      &lt;/form&gt;
@@ -177,7 +179,7 @@
         &lt;/a&gt;
         &lt;!-- &lt;img border=&quot;0&quot; id=&quot;divider&quot; src=&quot;img/division.png&quot; title=&quot;&quot; width=&quot;1&quot; height=&quot;10&quot;&gt; --&gt;
 		      &lt;!-- &lt;a href=&quot;javascript:removeAllMarker();&quot; style=&quot;text-decoration: none;&quot;&gt;&gt; Alle ausblenden&lt;/a&gt; &lt;br/&gt;--&gt;
-		    &lt;a href=&quot;javascript:updateVisibleBounds(null, true);&quot; id=&quot;resetMarkerHref&quot;&gt;
+		    &lt;a href=&quot;javascript:updateVisibleBounds(null, true, null, true);&quot; id=&quot;resetMarkerHref&quot;&gt;
 		      &lt;img border=&quot;0&quot; src=&quot;img/Stop.png&quot; title=&quot;zur&#252;cksetzen der Kartenansicht und Informationsebenen&quot; width=&quot;15&quot; height=&quot;15&quot;&gt;
         &lt;/a&gt;
         &lt;!-- &lt;img border=&quot;0&quot; id=&quot;divider&quot; src=&quot;img/division.png&quot; title=&quot;&quot; width=&quot;1&quot; height=&quot;10&quot;&gt; --&gt;

Modified: trunk/pages/be.de/kiezatlas.js
===================================================================
--- trunk/pages/be.de/kiezatlas.js	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/pages/be.de/kiezatlas.js	2011-02-09 11:26:16 UTC (rev 99)
@@ -1,26 +1,27 @@
   
   /** 
-   * This is a JavaScript Kiezatlas Citymap Service Client
-   * and it is composed of other components which are:
-   * - houdy.html (the html skeleton)
-   * - maps.css (the style definition)
-   * - OpenLayers.js (Version 2.8)
+   * This is the JavaScript Kiezatlas Citymap Client
    * 
    * @author Malte Rei&szlig;ig (<A HREF="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">malte at deepamehta.org</A>)
    * @license GPL v3
    * 
-   * Latest Modifications: 22nd of November 2010
+   * Latest Modifications: 03rd of Feburary 2011
+   *
    * 
+   * TODO: code cleanup, improving some wording on method signatures, some error handling
+   * INFO: getters/checkers return &quot;null&quot; as a negative result/ error
    */
 
-  //
-  // --- Constants help you to setup this script
-  //
-  
+
+
+  // --
+  // --- Settings helping you to configure this script
+  // --
+
   var SERVICE_URL = &quot;<A HREF="http://www.kiezatlas.de/rpc/">http://www.kiezatlas.de/rpc/</A>&quot;; // to be used by the jquery ajax methods
   var TESTING_SERVICE_URL = &quot;<A HREF="http://localhost:8080/kiezatlas/rpc/">http://localhost:8080/kiezatlas/rpc/</A>&quot;; // to be used by the jquery ajax methods
   var ICONS_URL = &quot;<A HREF="http://www.kiezatlas.de/client/icons/">http://www.kiezatlas.de/client/icons/</A>&quot;; // to be used by all icons if not relative to this folder
-  var IMAGES_URL = &quot;<A HREF="http://www.kiezatlas.de/client/images/">http://www.kiezatlas.de/client/images/</A>&quot;; // bo be used by all images in the sidebar
+  var IMAGES_URL = &quot;<A HREF="http://www.kiezatlas.de/images/">http://www.kiezatlas.de/images/</A>&quot;; // bo be used by all images in the sidebar
   var LEVEL_OF_DETAIL_ZOOM = 15; // the map focus when a mapinternal infoWindow is rendered
   var LEVEL_OF_DISTRICT_ZOOM = 12;
   var LEVEL_OF_CITY_ZOOM = 11;
@@ -39,70 +40,57 @@
   var propFooterMessage = &quot;&quot;;
   var helpLink = &quot;&quot;;
 
+
+
   //
   // --- Init &amp; Layout
-  // 
-  
+  //   
     
   function openLayersInit(openBounds){
     // Map Options
     var options = {
       projection: new OpenLayers.Projection(&quot;EPSG:900913&quot;),
-      displayProjection: new OpenLayers.Projection(&quot;EPSG:4326&quot;),
-      units: &quot;m&quot;,
-      maxResolution: 156543.0339,
-      // maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34)
-      maxExtent: openBounds
+      displayProjection: new OpenLayers.Projection(&quot;EPSG:4326&quot;), units: &quot;m&quot;,
+      maxResolution: 156543.0339, numZoomLevels: 25
+      // maxExtent: openBounds // an internal error occurs when using OpenStreetMap BaseLayer togegher with maxExtent
     };
     map = new OpenLayers.Map('map', options);
+    //
     // BaseLayer
-    var mapnik = new OpenLayers.Layer.TMS(&quot;OpenStreetMap&quot;, &quot;<A HREF="http://tile.openstreetmap.org/">http://tile.openstreetmap.org/</A>&quot;, {type: 'png', 
-      getURL: osm_getTileURL, displayOutsideMaxExtent: true, 
-      attribution: '&lt;a href=&quot;<A HREF="http://www.openstreetmap.org/">http://www.openstreetmap.org/</A>&quot;&gt;OpenStreetMap&lt;/a&gt;', 
-      numZoomLevels: 25}
-    );
-    mapnik.restrictExtent = bounds;
-    var googleBaseLayer = new OpenLayers.Layer.Google(&quot;Google Maps&quot;, {sphericalMercator:true, numZoomLevels: 25} );
+    var mapnik = new OpenLayers.Layer.TMS(&quot;OpenStreetMap&quot;, &quot;<A HREF="http://tile.openstreetmap.org/">http://tile.openstreetmap.org/</A>&quot;, {
+      type: 'png', getURL: osm_getTileURL, displayOutsideMaxExtent: false,
+      attribution: '&lt;a href=&quot;<A HREF="http://www.openstreetmap.org/">http://www.openstreetmap.org/</A>&quot;&gt;OpenStreetMap&lt;/a&gt;',
+      maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34)
+      // note: maxExtent bug, this bounds cannot be smaller than the whole world, otherwise projection error occurs
+    });
+    var googleBaseLayer = new OpenLayers.Layer.Google(&quot;Google Maps&quot;, { 
+      sphericalMercator:true, maxExtent: openBounds
+    });
     if (onBerlinDe) map.addLayers([googleBaseLayer, mapnik]); // , markerLayer
     else map.addLayers([googleBaseLayer, mapnik]);
-    //
+    // 
     // MapControl Setup
     nav = new OpenLayers.Control.NavigationHistory();
     myLayerSwitcher = OpenLayers.Control.CustomLayerSwitcher = 
     OpenLayers.Class(OpenLayers.Control.LayerSwitcher, {
       CLASS_NAME: &quot;OpenLayers.Control.CustomLayerSwitcher&quot;
     });
-    // myLayerSwitcher.moveTo(new OpenLayers.Pixel(50, 300));
-    // myLayerSwitcher.moveTo(new OpenLayers.Pixel(150, 400));
-    // parent control must be added to the map
+    // a parental control must be added to the map
     map.addControl(nav);
-    map.events.register(&quot;movestart&quot;, map, function (evnt) {
-      // log(&quot;baseLayerBounds&quot;+map.getBoundFromBaseLayer());
-      if (map.getExtent()!= null &amp;&amp; debug) log(&quot;evt: &quot; + map.getExtent().getCenterLonLat());
-    });
     //
-    //
-    panel = new OpenLayers.Control.Panel(
-	    {div: document.getElementById(&quot;navPanel&quot;)}
-    );
-    // jQuery(&quot;#OpenLayers.Control.PanZoom_5_zoomworld&quot;).unbind();
-    // jQuery(&quot;#OpenLayers.Control.PanZoom_5_zoomworld&quot;).click( function () {
-    //    updateVisibleBounds(null, true, null, true);
-    // });
+    panel = new OpenLayers.Control.Panel( { div: document.getElementById(&quot;navPanel&quot;) });
     myLayerSwitcher = new OpenLayers.Control.LayerSwitcher({
-      'div':OpenLayers.Util.getElement('mapSwitcher'), 
-      activeColor: &quot;white&quot;
+      'div':OpenLayers.Util.getElement('mapSwitcher'), activeColor: &quot;white&quot;
     });
     map.addControl(myLayerSwitcher);
     // event binding for the new hover controlMenu ### ToDo: find a better place for this
     jQuery(&quot;#mapControl&quot;).bind(&quot;mouseover&quot;, overMapControl);
     jQuery(&quot;#mapControl&quot;).bind(&quot;mouseout&quot;, outMapControl);
-    // 
+    //  special: left sided forth / back navigation menu on kiezatlas.de/map/*
     if (!onBerlinDe) panel.addControls([nav.next, nav.previous]);
     map.addControl(panel);
     // layerSwitcher, NavigationHistory, Panel
-    // setBounds
-    if (debug) log('[Info] mapBounds will be set to: ' + openBounds);
+    if (debug) log('mapBounds will be set to: ' + openBounds);
     map.zoomToExtent(openBounds.transform(map.displayProjection, map.projection));
     if (onBerlinDe) map.zoomTo(LEVEL_OF_CITY_ZOOM);
   }
@@ -122,7 +110,7 @@
   	if (onBerlinDe) jQuery(&quot;#bohead&quot;).css(&quot;width&quot;, fullW + 1);
     if (onBerlinDe) jQuery(&quot;#kiezatlas&quot;).css(&quot;width&quot;, fullW);
 	  jQuery(&quot;#kiezatlas&quot;).css(&quot;visibility&quot;, &quot;visible&quot;); // make the wrapping container visible
-    //jQuery(&quot;#kiezatlas&quot;).css(&quot;height&quot;, fullH - startHeight);
+    // jQuery(&quot;#kiezatlas&quot;).css(&quot;height&quot;, fullH - startHeight);
     jQuery(&quot;#kaheader&quot;).css(&quot;width&quot;, fullW);
     // jQuery(&quot;#map&quot;).css(&quot;top&quot;, topHeight);
     jQuery(&quot;#map&quot;).css(&quot;width&quot;, mapW);
@@ -158,7 +146,7 @@
     // jQuery(&quot;#sideBar&quot;).show('fast'); // showSideBar
     // jQuery(&quot;#sideBarControl&quot;).css(&quot;right&quot;, sideW);
     jQuery(&quot;#sideBarCriterias&quot;).css(&quot;width&quot;, sideW - 5);
-    jQuery(&quot;#sideBarCategories&quot;).css(&quot;width&quot;, sideW - 5);
+    jQuery(&quot;#sideBarCategories&quot;).css(&quot;width&quot;, sideW - 7);
     var critHeight = jQuery(&quot;#sideBarCriterias&quot;).css(&quot;height&quot;);
     critHeight = parseInt(critHeight.substr(0, critHeight.length-2));
     if (critHeight == 0 || isNaN(critHeight)) {
@@ -177,6 +165,7 @@
     jQuery(&quot;#kafooter&quot;).css(&quot;width&quot;, fWidth - 15);
     jQuery(&quot;#kafooter&quot;).css(&quot;left&quot;, fOrientation + 10);
     jQuery(&quot;#helpFont&quot;).css(&quot;left&quot;, fOrientation + 22);
+    jQuery(&quot;#layersDiv&quot;).css(&quot;left&quot;, -25);
     // ugly but convenient for dealing with ie7/8 layout fixes now
     if (jQuery.browser.msie) {
     	jQuery(&quot;input, textarea&quot;).css(&quot;height&quot;, 18);
@@ -185,9 +174,10 @@
   }
   
   function handleSideBar() { // e
+    var breitSeite; // complete content-window-width
     if(sideBarToggle) {
       // jQuery(&quot;#sideBarControl&quot;).css(&quot;cursor&quot;, &quot;w-resize&quot;);
-      var breitSeite = windowWidth() - 5; // 1317;//
+      breitSeite = windowWidth() - 5; // 1317;//
       jQuery(&quot;#sideBarControl&quot;).css(&quot;left&quot;, breitSeite);
       jQuery(&quot;#map&quot;).css(&quot;width&quot;, breitSeite);
       jQuery(&quot;#sideBar&quot;).hide(&quot;fast&quot;);
@@ -203,7 +193,7 @@
     } else {
       // jQuery(&quot;#kafooter&quot;).css(&quot;opacity&quot;, &quot;1.0&quot;);
       jQuery(&quot;#kafooter&quot;).css(&quot;background&quot;, &quot;#fff&quot;);
-      var breitSeite = windowWidth(); // 1339;//
+      breitSeite = windowWidth(); // 1339;//
       // jQuery(&quot;#sideBar&quot;).show(&quot;fast&quot;);
       // jQuery(&quot;#sideBarControl&quot;).attr(&quot;onclick&quot;, &quot;javascript:handleSideBar();&quot;);
       sideBarToggle = true;
@@ -221,17 +211,21 @@
     if (debug) log('[DEBUG] handleSidebar got: ' + e.type + ' at '+ posx+':'+posy + '');
   }
 
+
+
   // 
   // --- Client Side Requests (to proxy scripts)
   // 
 
-  function getGeoObjectInfo(topicId, resultHandler) {
+  /** a get and show method implemented as
+   *  an asynchronous call which renders the html directly into the sidebar when the result has arrived **/
+  function getGeoObjectInfo(itemId, resultHandler) {
     // log('requesting info for: ' + topicId);
     if (resultHandler == 'abc') {
       resultHandler = jQuery(&quot;#sideBarCategories&quot;);
     }
-    var url = SERVICE_URL; // + 'getGeoObjectInfo.php?topicId=' + topicId;
-    var body = '{&quot;method&quot;: &quot;getGeoObjectInfo&quot;, &quot;params&quot;: [&quot;' + topicId + '&quot;]}';// '{' + urlencode(streetFocus) + '}';
+    var url = TESTING_SERVICE_URL;
+    var body = '{&quot;method&quot;: &quot;getGeoObjectInfo&quot;, &quot;params&quot;: [&quot;' + itemId + '&quot;]}';// '{' + urlencode(streetFocus) + '}';
     jQuery.ajax({
 	    type: &quot;POST&quot;,
 	    url: url,
@@ -249,11 +243,29 @@
   	      resultHandler.append('&lt;img src=&quot;'+imgSrc+'&quot;&gt;&lt;br/&gt;');
 	      }
 	      resultHandler.append('&lt;b&gt;'+topic.name+'&lt;/b&gt;&lt;br/&gt;');
-	      // resultHandler.append('&lt;table width=&quot;100%&quot; cellpadding=&quot;2&quot; cellspacing=&quot;0&quot; id=&quot;sideBarCategoriesTable&quot;&gt;&lt;/table&gt;');
-	      if (onBerlinDe) resultHandler.append(''+getTopicPostalCode(topic) + ' Berlin &lt;br/&gt;');
-        else resultHandler.append(''+getTopicPostalCode(topic) + ' ' + getTopicCity(topic) + '&lt;br/&gt;');
-        resultHandler.append(''+getTopicAddress(topic)+'&lt;p/&gt;');
-	      // resultHandler.append(&quot;Loaded Topic&quot; + topic.name);
+        // address related stuff follows
+        var cityName = getTopicCity(topic);
+        var street = getTopicAddress(topic);
+	      if (cityName == &quot; Berlin&quot; || cityName == &quot;Berlin&quot; || onBerlinDe) { // TODO: sloppy condition for maps berlin.de
+          var publicTransportURL = '<A HREF="http://www.fahrinfo-berlin.de/Stadtplan/index?query=">http://www.fahrinfo-berlin.de/Stadtplan/index?query=</A>' + street +
+            '&amp;search=Suchen&amp;formquery=&amp;address=true';
+          var imageLink = '&lt;a href=&quot;'+ publicTransportURL + '&quot; target=&quot;_blank&quot;&gt;'
+            + '&lt;img src=\&quot;'+IMAGES_URL+'fahrinfo.gif&quot; border=&quot;0&quot; hspace=&quot;20&quot;&gt;&lt;/a&gt;';
+          if (onBerlinDe || topicId == &quot;t-331302&quot;) { // ehrenamt map datasets have no city property
+            resultHandler.append(''+getTopicPostalCode(topic) + ' Berlin&lt;br/&gt;'); 
+          } else { 
+            resultHandler.append(''+getTopicPostalCode(topic) + ' ' + cityName + '&lt;br/&gt;');
+          }
+          resultHandler.append('' + street + '&nbsp;' + imageLink + '&lt;p/&gt;');
+        } else {
+          if (topicId == &quot;t-331302&quot;) { // ehrenamt map on datasets have no city property
+            resultHandler.append(''+getTopicPostalCode(topic) + ' Berlin&lt;br/&gt;');
+          } else {
+            resultHandler.append(''+getTopicPostalCode(topic) + ' ' + cityName + '&lt;br/&gt;');
+          }
+          resultHandler.append('' + street + '&lt;p/&gt;');
+        }
+	      // stripping unwanted fields of the data container
 	      topic = stripFieldsContaining(topic, &quot;LAT&quot;);
 	      topic = stripFieldsContaining(topic, &quot;LONG&quot;);
 	      topic = stripFieldsContaining(topic, &quot;Locked Geometry&quot;);
@@ -272,10 +284,10 @@
 	        // propertyList += '&lt;tr&gt;';
 	        propertyList += '&lt;p&gt;&lt;span class=&quot;propertyLabel&quot;&gt;'+topic.properties[i].label+':&nbsp;&lt;/span&gt;';
 	        if (topic.properties[i].type == 0) {
-	          // Type Single
+	          // DM Property Type Single
 	          propertyList += '&lt;span class=&quot;propertyField&quot;&gt;'+topic.properties[i].value+'&lt;/span&gt;&lt;/p&gt;';
 	        } else {
-	          // Type Multi
+	          // DM Property Type Multi
             propertyList += '&lt;span class=&quot;propertyField&quot;&gt;';
 		        for (var k=0; k &lt; topic.properties[i].values.length; k++) {
 	            stringValue = topic.properties[i].values[k].name;
@@ -292,7 +304,6 @@
 	          }
             propertyList += '&lt;/span&gt;&lt;/p&gt;';
 	        }
-	        // propertyList += '&lt;/tr&gt;';
 	        propertyList += '&lt;/p&gt;';
 	      }
 	      resultHandler.append(propertyList);
@@ -317,7 +328,7 @@
   /** toload all topics with javascript, not with php, is currently #unused but possible */ 
   function loadCityMapTopics(mapId, workspaceId) {
     // log('requesting mapTopics for: ' + mapId);
-    var url = TESTING_SERVICE_URL; // + 'getMapTopics.php?topicId=' + mapId + '&amp;workspaceId=' + workspaceId;
+    var url = SERVICE_URL; // + 'getMapTopics.php?topicId=' + mapId + '&amp;workspaceId=' + workspaceId;
     var body = '{&quot;method&quot;: &quot;getMapTopics&quot;, &quot;params&quot;: [&quot;' + mapId+ '&quot; , &quot;' + workspaceId + '&quot;]}';
     jQuery.ajax({
       type: &quot;POST&quot;,
@@ -338,8 +349,7 @@
   }
 
   function loadWorkspaceCriterias(workspaceId) {
-    // log('requesting workspaceCriterias for: ' + workspaceId);
-    var url = SERVICE_URL; // + 'getWorkspaceCriterias.php?workspaceId=' + workspaceId + '&amp;topicId=' + topicId;
+    var url = SERVICE_URL;
     var body = '{&quot;method&quot;: &quot;getWorkspaceCriterias&quot;, &quot;params&quot;: [&quot;' + topicId + '&quot;]}';
     jQuery.ajax({
 	    type: &quot;POST&quot;,
@@ -396,7 +406,7 @@
   /** sends an ajax request to the google geocoder through a proxy script 
     * and moves the center / focuse of the mapTiles to the first result of coordinates
     * 
-    * ###: localized to DE and BERLIN throug &amp;q=... Berlin&quot;
+    * ### TODO: improve the dynamic localization of the viewPortBias, try again to make use of mapBounds
     */
   function focusRequest() {
     if (debug) log('focusRqeust for ' + streetFocus);
@@ -458,8 +468,6 @@
   //
   // --- Handling of alternatives after a focusRequest() 
   //
-
-
   
   /**
    *  Alternatives List for focusRequest and mapNavigation
@@ -520,7 +528,7 @@
       // autocomplete_item = atPos;
   }
 
-  /** changed on 23.Agusta --- ### to test with berlin.de */
+  /** changed on 23.Augusta --- */
   function focus_current_item(itemNumber)  {
       var item;
       if (alternative_items != null) {
@@ -530,8 +538,8 @@
           select_next_item(itemNumber);
         }
       }
-      // check if inputField.action with jQuery (line 293) was later changed 
-      // than inputField.keyUp is received (line 314)
+      // TODO: check if inputField.action with jQuery (line 293)
+      // was later changed than inputField.keyUp is received (line 314)
       if (item != undefined) { 
         var toLonLat= new OpenLayers.LonLat(item.Point.coordinates[0], item.Point.coordinates[1]);
         map.setCenter(toLonLat.transform(map.displayProjection, map.projection), 15);
@@ -557,8 +565,10 @@
       log(&quot;selectingPrevItem:&quot; + autocomplete_item);
   }
 
+
+
   // 
-  // --- Sidebar Specific Code
+  // --- Sidebar Specific GUI Code
   // 
   
   function initResultList(resultObjects) {
@@ -658,23 +668,22 @@
     }
   }
   
-  /** always initalizes the correct critCatList, to */
+  /** renders the current criteria and category list*/
   function updateCategoryList(criteria) {
     if (debug) log('.updateCategoryList(' + criteria+ ')'); // and updating gl currentIndex');
     crtCritIndex = criteria; // update
      // clear`s catList and hides all visible marker
     reSetMarkers();
     removeAllPopUps();
-    initCriteriaList(); // init CriteriaList
+    initCriteriaList(); // initializes the upper list of criterias
     var sideBarCategories = jQuery(&quot;#sideBarCategories&quot;);
     sideBarCategories.empty();
-    sideBarCategories.append('&nbsp;&nbsp;&lt;b class=&quot;redTitle&quot;&gt;Informationsebenen sind: &lt;/b&gt;&lt;p/&gt;');
+    sideBarCategories.append('&lt;p/&gt;'); // formerly: &nbsp;&nbsp;&lt;b class=&quot;redTitle&quot;&gt;Informationsebenen sind: &lt;/b&gt;&lt;/p&gt;
     sideBarCategories.append('&lt;table width=&quot;97%&quot; cellpadding=&quot;2&quot; cellspacing=&quot;0&quot; id=&quot;sideBarCategoriesTable&quot;&gt;&lt;/table&gt;');
-    // Auslesen der Legendenelemente.
     // sideBarCategories.html('&lt;table width=&quot;95%&quot;&gt;');
     // var contentWidth = jQuery(&quot;#sideBar&quot;).css(&quot;width&quot;).substr(0,jQuery(&quot;#sideBar&quot;).css(&quot;width&quot;).length-2);
     if (workspaceCriterias.result.length &lt;= 0) {
-      // ### ToDo: Exception Handling
+      // ### TODO: Exception Handling
       alert(&quot;Sorry for that inconvenience. Probably an error occured while loading the criterias.&quot;);
     } else {
       for (var i = 0; i &lt; workspaceCriterias.result[criteria].categories.length; i++) {
@@ -683,7 +692,8 @@
         var catName = [workspaceCriterias.result['' + criteria + ''].categories[i].catName];
         var catId = new String([workspaceCriterias.result['' + criteria + ''].categories[i].catId]);
         var catCSS = &quot;catRowDeselected&quot;;
-        /*if (isCategoryVisible(catId)) {
+        /** deactivated category row selection effect
+        if (isCategoryVisible(catId)) {
           if (debug) log(&quot;..updateCategeryList.isVisibleCat - reSelect in GUI! &quot;);
           catCSS = &quot;catRowSelected&quot;;
         }*/
@@ -693,18 +703,17 @@
             + '&lt;img src=&quot;'+ICONS_URL+''+catIcon+'&quot; border=&quot;0&quot; id=&quot;catIconRow-'+catId+'&quot; alt=&quot;'+catName+'-Icon&quot; '
             + 'text=&quot;Klicken zum Ein- und Ausblenden&quot;&gt;&lt;/a&gt;&lt;/td&gt;'
           + '&lt;td valign=&quot;center&quot;&gt;&lt;a href=&quot;&quot; id=&quot;catHref-'+catId+'&quot;&gt;'+catName+'&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;');
-        // javaScript sucks up when &quot;t-12312321&quot; is a stringId and NAN !
         // mozilla alows onclick on a tableRow while webkit and others do neither allow onmouseclick nor onclick
         jQuery(&quot;#toggleHref-&quot;+catId).attr('href', 'javascript:toggleMarkerGroups(&quot;' + catId + '&quot;);');
-        // jQuery(&quot;#catIconRow-&quot;+catId).attr('onclick', 'javascript:toggleMarkerGroups(&quot;' + catId + '&quot;)');
         jQuery(&quot;#catHref-&quot;+catId).attr('href', 'javascript:showCatInSideBar(&quot;' + catId + '&quot;, &quot;'+catName+'&quot;);');
+        // registering ui effects
         // jQuery(&quot;#catRow-&quot;+catId).attr('onmouseover', 'hoverCatButton(&quot;' + catId + '&quot;)');
         // jQuery(&quot;#catRow-&quot;+catId).attr('onmouseout', 'outCatButton(&quot;' + catId + '&quot;)');
       }
     }
   }
 
-  /** sets imprint, homepage and logo link associated with the current workspaceInfos*/
+  /** sets imprint, homepage and logo link associated with the current workspaceInfos */
   function setWorkspaceInfos() {
     var footerMessage = &quot;&quot;;
     if (onBerlinDe) {
@@ -718,14 +727,68 @@
     footer += '&lt;span id=&quot;footerPoweredBy&quot;&gt;'+footerMessage+'&lt;/span&gt;';
     jQuery(&quot;#kafooter&quot;).html(footer);
     jQuery(&quot;#sideBarLogo&quot;).attr('src', '' + IMAGES_URL + workspaceLogo);
-    jQuery(&quot;#sideBarLogo&quot;).attr('title', 'A KiezAtlas 1.7 Logo');
+    jQuery(&quot;#sideBarLogo&quot;).attr('title', 'The KiezAtlas 1.7 Logo');
     jQuery(&quot;#sideBarLogo&quot;).attr('alt', mapTitle + ' Logo');
     jQuery(&quot;#sideBarLogoLink&quot;).attr('href', workspaceHomepage);
     if (debug) log(&quot;set sideBar to: &quot; + jQuery(&quot;#sideBarLogo&quot;).attr('src') + &quot; and logo is: &quot; + jQuery(&quot;#sideBarLogo&quot;).attr('title'));
   }
-  
-  /** put numerous marker in the layer and draw them
-    * called by initResultList, showCatInSidebar
+
+  function isCurrentlyVisibleCat(categoryId) {
+    for (var j = 0; j &lt; markerGroupIds.length; j++) {
+      if(markerGroupIds[j] == categoryId) {
+        if (debug) log(&quot;...helper.isCurrentlyVisibleCat &quot; + catId + &quot; YEAH..&quot;);
+        return true;
+      }
+    }
+    return false;
+  }
+
+  function showCritCatList() {
+    // Automatisierte, workspaceabh&#228;ngig Erstellung der Seitenleisteninhalte.
+    updateCategoryList(crtCritIndex);
+  }
+
+  /** produces a very clear markerGroupIds situation*/
+  function selectAllCategories() {
+    markerGroupIds = []; // clear all, then put every catId inside
+    //for (var i = 0; i &lt; workspaceCriterias.result.length; i++) {
+    for (var j = 0; j &lt; workspaceCriterias.result[crtCritIndex].categories.length; j++) {
+      var catId = workspaceCriterias.result[crtCritIndex].categories[j].catId;
+      markerGroupIds.push(catId);
+      jQuery(&quot;#catRow-&quot;+catId).attr(&quot;class&quot;, &quot;catRowSelected&quot;);
+    }
+    log(&quot;selected All markerGroups: &quot; + markerGroupIds);
+  }
+
+  function checkIfAllCategoriesSelected() {
+    if (markerGroupIds.length == workspaceCriterias.result[crtCritIndex].categories.length) return true; else return false;
+  }
+
+  /** produces a very clear markerGroupIds state */
+  function deSelectAllCategories() {
+    markerGroupIds = [];
+    if (workspaceCriterias.result.length &lt;= 0) {
+      // ### ToDo: Exception Handling
+      alert(&quot;Sorry for that inconvenience. Probably an error occured while loading the criterias.&quot;);
+    } else {
+      for (var j = 0; j &lt; workspaceCriterias.result[crtCritIndex].categories.length; j++) {
+        var catId = workspaceCriterias.result[crtCritIndex].categories[j].catId;
+        // remove catId from groups
+        jQuery(&quot;#catRow-&quot;+catId).attr(&quot;class&quot;, &quot;catRowDeselected&quot;);
+      }
+    }
+    if(debug) log(&quot;deSelected All markerGroups to: &quot; + markerGroupIds);
+  }
+
+
+
+  // --
+  // --- Map specific GUI Code
+  // --
+
+  /**
+    * put numerous marker in the layer and draw them
+    * @see initResultList, showCatInSidebar
     * info: is used to display search or catSearch results _ontop/independent of already visible categories_
     */
   function showTopicsInMap(topicsToShow) {
@@ -738,7 +801,7 @@
         log(&quot;[ERROR] no feature found for &quot; + topic.id );
       }
     }
-    // render new state
+    // rerender
     myNewLayer.redraw();
   }
 
@@ -776,6 +839,34 @@
       showInfoWindowForMarker(featureToToggle.data);
     }
   }
+  
+  function selectAndShowInMap(originId, isTopicId) {
+    var feature = null;
+    if (isTopicId) {
+      feature = checkFeatureByTopicId(originId);
+    } else {
+      feature = checkFeatureByOriginId(originId);
+    }
+    if (feature == null) {
+      // project could not be assoiciated with a correct address, though is not published
+      // ### TODO: showInfo in SideBar
+        var helpHtmlOne = '&lt;br/&gt;&lt;b class=&quot;redTitle&quot;&gt;Entschuldigen sie bitte, die Projektadresse ist unbekannt.&lt;/b&gt;&lt;p/&gt; '
+          + 'F&uuml;r diese &lt;i&gt;Einsatzm&ouml;glichkeit&lt;/i&gt; ist die Adresse des Einsatzortes nicht bekannt bzw. '
+          + 'fehlerhaft und daher k&ouml;nnen wir ihnen an dieser Stelle keine zus&auml;tzlichen Informationen anzeigen. &lt;p/&gt;'
+          + ' Die Kontaktinformationen zu dieser &lt;i&gt;Einsatzm&ouml;glichkeit&lt;/i&gt; erhalten sie auf der '
+          + ' &lt;a href=&quot;<A HREF="http://www.berlin.de/buergeraktiv/ehrenamtsnetz/angebote/">http://www.berlin.de/buergeraktiv/ehrenamtsnetz/angebote/</A>'
+          + 'index.cfm?dateiname=ea_projekt_beschreibung.cfm&amp;cfide=0.304475484697&amp;&amp;anwender_id=5&amp;id=0&amp;ehrenamt_id=0&amp;projekt_id='
+          + originId +'&amp;seite=1&amp;organisation_id=0&quot;&gt;vorherigen Seite.&lt;/a&gt;&lt;br/&gt;';
+          helpHtmlOne += '&lt;br/&gt; Sie k&ouml;nnen nat&uuml;rlich auch in dieser Ansicht weiter nach &lt;a href=&quot;javascript:updateCategoryList(1);&quot;&gt;Einsatzm&ouml;glichkeiten&lt;/a&gt; in ihrer Umgebung navigieren.';
+        jQuery(&quot;#sideBarCategories&quot;).html(helpHtmlOne);
+    } else {
+      // log(&quot;linking in and showing &quot; + feature.data.topicName);
+      var catId = getTopicById(feature.data.topicId).criterias[1].categories[0]; // NOTE: just works for the herewith fixed default 2 TODO: createSlimGeoObject(has to assemble the crtierias with the help of CityMpa.getSeachCriteria() to mach always to the first criteria);criteria (zielgruppe)
+      toggleMarkerGroups(catId);
+      //
+      showTopicInMap(feature.data.topicId);
+    }
+  }
 
   /** focus topic inMap, show infoWindow in Map and load the corresponding data container */
   function showTopicInSideBar(topicId) {
@@ -1009,19 +1100,6 @@
     log('showingMarkerGroup and catIdRow is now: ' + jQuery(&quot;#catRow-&quot;+category).attr(&quot;class&quot;));
     return topicsToShow;
   }
-
-  function isCategoryVisible(myCatId) {
-    // log('howManyCatsVisible: ' + markerGroupIds.length);
-    for (var i = 0; i &lt; markerGroupIds.length; i++) {
-      // log('&gt;&gt; check if ' + myCatId + ' is..' + markerGroupIds[i]);
-      if (markerGroupIds[i] == myCatId) {
-        //printOut(' is currently visible, to hide, checked ' +markerGroupIds.toString());
-        return true;
-      } else {
-        //return false;
-      }
-    }
-  }
   
   /** toggles a OpenLayersMarker for a given topicId 
     * toggles a OpenLayersFeature on myNewLayer for a given topicId (it`s definitely already on the layer, just hide or show it)
@@ -1078,14 +1156,13 @@
     }
     return cats;
   }
-  
+
+  /** TODO: cleanup... **/
   function initBerlinDistrictsLayer() {
     var dStyle = new OpenLayers.Style( { 
       strokeColor: &quot;#4170D4&quot;, strokeWidth: 1.5, fill: 0
-      //fontWeight: &quot;bold&quot;,
-      //labelAlign: &quot;${align}&quot;,
-      //labelXOffset: &quot;${xOffset}&quot;,
-      //labelYOffset: &quot;${yOffset}&quot;
+      // fontWeight: &quot;bold&quot;, labelAlign: &quot;${align}&quot;,
+      // labelXOffset: &quot;${xOffset}&quot;, labelYOffset: &quot;${yOffset}&quot;
     });
     var defaultStyle = OpenLayers.Util.applyDefaults( dStyle, OpenLayers.Feature.Vector.style[&quot;default&quot;]);
     var dStyleMap = new OpenLayers.StyleMap({
@@ -1139,16 +1216,10 @@
     //
   }
 
-  function showCritCatList() {
-    // Automatisierte, workspaceabh&#228;ngig Erstellung der Seitenleisteninhalte.
-    updateCategoryList(crtCritIndex);
-  }
-
-  // 
-  // --- Layer, Map and &quot;Feature to Topic&quot; Related Code  (setup, getters, infoWindows, kiezatlas-citymap-logic)
-  //
-  
-  /** initializes myNewLayer and allFeatures*/
+  /**
+   * initializes myNewLayer and allFeatures
+   * TOOD: cleanup..
+   **/
   function initLayerAllFeatures(points, mainMap) {
       // create a lookup table with different symbolizers for the different
       // state values
@@ -1486,7 +1557,6 @@
     return null;
   }
 
-
   /** create and show popuop and render marker as selected */
   function showInfoWindowForMarker(featureData, clusteredId) {
     var idString = &quot;&quot;+ featureData.topicId + &quot;&quot;;
@@ -1594,9 +1664,20 @@
   }
   
   //
-  // --- Style Methods
-  // 
+  // --- Utility Methods for Style and Layout
+  //
 
+  function getCatIconURL(categoryId) {
+    for (var j = 0; j &lt; workspaceCriterias.result[crtCritIndex].categories.length; j++) {
+      if(workspaceCriterias.result[crtCritIndex].categories[j].catId == categoryId) {
+        log(&quot;&lt;b&gt;catIcon is: &lt;/b&gt;&quot; + workspaceCriterias.result[crtCritIndex].categories[j].catIcon);
+        return workspaceCriterias.result[crtCritIndex].categories[j].catIcon;
+      }
+      // var catToShow = mapTopics.result.topics[i].criterias[j].categories
+    }
+    return null;
+  }
+
   /** TODO: fix **/
   function inputFieldBehaviour() {
     // focusInputFinputield
@@ -1614,10 +1695,6 @@
       jQuery(this).animate({width: 115}, 500);
     });
   }
-
-  //
-  // --- Layout Methods
-  //
    
   function toggleWidth(e) {
       if (slimWidth) {
@@ -1680,7 +1757,7 @@
   /** TODO: to show progress always in center and with a label .. */
   function showProgressInSideBar(progressVal) {
     // sideBarControl
-    /*showSideBar*/(305);
+    /* showSideBar (305); */
     // jQuery(&quot;#sideBarCategoriesTable&quot;).empty(); // '&lt;a href=&quot;javascript:clearCriteriaSelection();&quot;&gt;Auswahl aufheben&lt;/a&gt;');
     // sideContent
     jQuery(&quot;#progContainer&quot;).html('&lt;b&gt;' + progressVal + '&lt;/b&gt;&lt;br/&gt;&lt;img src=&quot;../pages/be.de/img/aLoading.gif&quot; alt=&quot;Loading&quot;&gt;');
@@ -1690,6 +1767,8 @@
   function hideProgressFromSideBar() {
     jQuery(&quot;#progContainer&quot;).hide(&quot;fast&quot;);
   }
+
+
   
   //
   // --- Topic Data Container Utilities
@@ -1754,15 +1833,15 @@
         return topic.properties[at].value;
       }
     }
-    return &quot;&quot;;
+    return null;
   }
 
 
+
   // 
   // --- High Level CiyMap Functions 
   // 
   
-  
   function calculateInitialBounds() {
     var bounds = new OpenLayers.Bounds();
     for (var i = 0; i &lt; mapTopics.result.topics.length; i++) {
@@ -1845,7 +1924,7 @@
   }
   
   function overMapControl() {
-    jQuery(&quot;#mapControl&quot;).css(&quot;height&quot;, 138);
+    jQuery(&quot;#mapControl&quot;).css(&quot;height&quot;, 145);
     toggleMapControl();
   }
   
@@ -1862,38 +1941,6 @@
     }
   }
   
-  /** produces a very clear markerGroupIds situation*/
-  function selectAllCategories() {
-    markerGroupIds = []; // clear all, then put every catId inside
-    //for (var i = 0; i &lt; workspaceCriterias.result.length; i++) {  
-    for (var j = 0; j &lt; workspaceCriterias.result[crtCritIndex].categories.length; j++) {
-      var catId = workspaceCriterias.result[crtCritIndex].categories[j].catId;
-      markerGroupIds.push(catId);
-      jQuery(&quot;#catRow-&quot;+catId).attr(&quot;class&quot;, &quot;catRowSelected&quot;);    
-    }
-    log(&quot;selected All markerGroups: &quot; + markerGroupIds);
-  }
-  
-  function checkIfAllCategoriesSelected() {
-    if (markerGroupIds.length == workspaceCriterias.result[crtCritIndex].categories.length) return true; else return false;
-  }
-  
-  /** produces a very clear markerGroupIds state */
-  function deSelectAllCategories() {
-    markerGroupIds = [];
-    if (workspaceCriterias.result.length &lt;= 0) {
-      // ### ToDo: Exception Handling
-      alert(&quot;Sorry for that inconvenience. Probably an error occured while loading the criterias.&quot;);
-    } else {
-      for (var j = 0; j &lt; workspaceCriterias.result[crtCritIndex].categories.length; j++) {
-        var catId = workspaceCriterias.result[crtCritIndex].categories[j].catId;
-        // remove catId from groups
-        jQuery(&quot;#catRow-&quot;+catId).attr(&quot;class&quot;, &quot;catRowDeselected&quot;);
-      }
-    }
-    if(debug) log(&quot;deSelected All markerGroups to: &quot; + markerGroupIds);
-  }
-  
   /** show all topics as Features in myNewLayer and select all Categories in Sidebar */
   function showAllMarker() {
     if (!checkIfAllCategoriesSelected()) {
@@ -1933,39 +1980,12 @@
     removeAllPopUps();
   }
 
+
   
   //
-  // --- Little Helpers
+  // --- Other Little Helpers
   //
   
-  function selectAndShowInMap(originId, isTopicId) {
-    var feature = null;
-    if (isTopicId) {
-      feature = checkFeatureByTopicId(originId);
-    } else {
-      feature = checkFeatureByOriginId(originId);
-    }
-    if (feature == null) {
-      // project could not be assoiciated with a correct address, though is not published
-      // ### TODO: showInfo in SideBar
-        var helpHtmlOne = '&lt;br/&gt;&lt;b class=&quot;redTitle&quot;&gt;Entschuldigen sie bitte, die Projektadresse ist unbekannt.&lt;/b&gt;&lt;p/&gt; ' 
-          + 'F&uuml;r diese &lt;i&gt;Einsatzm&ouml;glichkeit&lt;/i&gt; ist die Adresse des Einsatzortes nicht bekannt bzw. ' 
-          + 'fehlerhaft und daher k&ouml;nnen wir ihnen an dieser Stelle keine zus&auml;tzlichen Informationen anzeigen. &lt;p/&gt;' 
-          + ' Die Kontaktinformationen zu dieser &lt;i&gt;Einsatzm&ouml;glichkeit&lt;/i&gt; erhalten sie auf der ' 
-          + ' &lt;a href=&quot;<A HREF="http://www.berlin.de/buergeraktiv/ehrenamtsnetz/angebote/">http://www.berlin.de/buergeraktiv/ehrenamtsnetz/angebote/</A>' 
-          + 'index.cfm?dateiname=ea_projekt_beschreibung.cfm&amp;cfide=0.304475484697&amp;&amp;anwender_id=5&amp;id=0&amp;ehrenamt_id=0&amp;projekt_id=' 
-          + originId +'&amp;seite=1&amp;organisation_id=0&quot;&gt;vorherigen Seite.&lt;/a&gt;&lt;br/&gt;';
-          helpHtmlOne += '&lt;br/&gt; Sie k&ouml;nnen nat&uuml;rlich auch in dieser Ansicht weiter nach &lt;a href=&quot;javascript:updateCategoryList(1);&quot;&gt;Einsatzm&ouml;glichkeiten&lt;/a&gt; in ihrer Umgebung navigieren.';
-        jQuery(&quot;#sideBarCategories&quot;).html(helpHtmlOne);
-    } else {
-      // log(&quot;linking in and showing &quot; + feature.data.topicName);
-      var catId = getTopicById(feature.data.topicId).criterias[1].categories[0]; // NOTE: just works for the herewith fixed default 2 TODO: createSlimGeoObject(has to assemble the crtierias with the help of CityMpa.getSeachCriteria() to mach always to the first criteria);criteria (zielgruppe)
-      toggleMarkerGroups(catId);
-      // 
-      showTopicInMap(feature.data.topicId);
-    }
-  }
-  
   /** mapTile Function, not exactly clear what it does */
   function osm_getTileURL(bounds) {
     var res = this.map.getResolution();
@@ -1982,26 +2002,6 @@
     }
   }
   
-  function isCurrentlyVisibleCat(categoryId) {
-    for (var j = 0; j &lt; markerGroupIds.length; j++) {
-      if(markerGroupIds[j] == categoryId) {
-        if (debug) log(&quot;...helper.isCurrentlyVisibleCat &quot; + catId + &quot; YEAH..&quot;);
-        return true;
-      }
-    }
-    return false;
-  }
-  
-  function getCatIconURL(categoryId) {
-    for (var j = 0; j &lt; workspaceCriterias.result[crtCritIndex].categories.length; j++) {
-      if(workspaceCriterias.result[crtCritIndex].categories[j].catId == categoryId) {
-        log(&quot;&lt;b&gt;catIcon is: &lt;/b&gt;&quot; + workspaceCriterias.result[crtCritIndex].categories[j].catIcon);
-        return workspaceCriterias.result[crtCritIndex].categories[j].catIcon;
-      }
-      // var catToShow = mapTopics.result.topics[i].criterias[j].categories
-    }
-  }
-  
   function redrawAfterZoomOperation () {
     // markerLayer.setVisibility(true);
     myNewLayer.setVisibility(true);

Modified: trunk/pages/be.de/landmaps.css
===================================================================
--- trunk/pages/be.de/landmaps.css	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/pages/be.de/landmaps.css	2011-02-09 11:26:16 UTC (rev 99)
@@ -61,8 +61,8 @@
 .topicRowSelected { background: #e6edff; }
 .olControlAttribution { position:absolute; bottom: 3px !important; }
 .redTitle { color: #b60033; }
-.layersDiv { position:relative; left: 5px;}
+.layersDiv { position:relative; left: 5px; max-width: 110px; text-align: right; }
 .dataLbl { color: #4170D4; }
 .baseLbl { color: #4170D4; }
-.dataLayersDiv { border: 1px solid #e6edff; padding: 2px; }
-.baseLayersDiv { border: 1px solid #e6edff; padding: 2px; }
+.dataLayersDiv { border: 1px solid #e6edff; padding: 2px; text-align: right;  }
+.baseLayersDiv { border: 1px solid #e6edff; padding: 2px; text-align: right; }

Modified: trunk/pages/be.de/maps.css
===================================================================
--- trunk/pages/be.de/maps.css	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/pages/be.de/maps.css	2011-02-09 11:26:16 UTC (rev 99)
@@ -45,7 +45,7 @@
 .topicRowSelected { background: #e6edff; }
 .olControlAttribution { position:absolute; bottom: 5px !important; right: 5px ! important; font-weight: bold;}
 .redTitle { color: #b60033; }
-.layersDiv { position:relative; left: 5px;}
+.layersDiv { position:relative; left: 5px }
 .dataLbl { color: #4170D4; }
 .baseLbl { color: #4170D4; }
 .dataLayersDiv { border: 1px solid #e6edff; padding: 2px; }

Modified: trunk/pages/be.de/proxies/getGeoObjectInfo.php
===================================================================
--- trunk/pages/be.de/proxies/getGeoObjectInfo.php	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/pages/be.de/proxies/getGeoObjectInfo.php	2011-02-09 11:26:16 UTC (rev 99)
@@ -1,8 +1,8 @@
 &lt;?php
   require_once(&quot;HTTP/Request.php&quot;);
     $topicId = $_GET['topicId'];
-    // $request = new HTTP_Request('<A HREF="http://localhost:8080/kiezatlas/rpc/">http://localhost:8080/kiezatlas/rpc/</A>');
-    $request = new HTTP_Request('<A HREF="http://www.kiezatlas.de:8080/rpc/">http://www.kiezatlas.de:8080/rpc/</A>');
+    $request = new HTTP_Request('<A HREF="http://localhost:8080/kiezatlas/rpc/">http://localhost:8080/kiezatlas/rpc/</A>');
+    // $request = new HTTP_Request('<A HREF="http://www.kiezatlas.de:8080/rpc/">http://www.kiezatlas.de:8080/rpc/</A>');
     $body = '{&quot;method&quot;: &quot;getGeoObjectInfo&quot;, &quot;params&quot;: [&quot;'.$topicId.'&quot;]}';
     $request-&gt;addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);
     $request-&gt;setBody($body);

Modified: trunk/pages/be.de/proxies/getMapTopics.php
===================================================================
--- trunk/pages/be.de/proxies/getMapTopics.php	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/pages/be.de/proxies/getMapTopics.php	2011-02-09 11:26:16 UTC (rev 99)
@@ -5,8 +5,8 @@
     $workspaceId = $_GET['workspaceId'];
     $topicId = $_GET['topicId'];
     $body = '{&quot;method&quot;: &quot;getMapTopics&quot;, &quot;params&quot;: [&quot;'.$topicId.'&quot; , &quot;'.$workspaceId.'&quot;]}';
-    $req1 =&amp; new HTTP_Request(&quot;<A HREF="http://www.kiezatlas.de:8080/rpc/">http://www.kiezatlas.de:8080/rpc/</A>&quot;);
-    // $req1 =&amp; new HTTP_Request(&quot;<A HREF="http://localhost:8080/kiezatlas/rpc/">http://localhost:8080/kiezatlas/rpc/</A>&quot;);
+    // $req1 =&amp; new HTTP_Request(&quot;<A HREF="http://www.kiezatlas.de:8080/rpc/">http://www.kiezatlas.de:8080/rpc/</A>&quot;);
+    $req1 =&amp; new HTTP_Request(&quot;<A HREF="http://localhost:8080/kiezatlas/rpc/">http://localhost:8080/kiezatlas/rpc/</A>&quot;);
     // <A HREF="http://www.kiezatlas.de:8080/rpc/">http://www.kiezatlas.de:8080/rpc/</A> --
     $req1-&gt;addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);
     // $req2-&gt;addHeader(&quot;Charset&quot;, &quot;utf-8&quot;);

Modified: trunk/pages/be.de/proxies/getWorkspaceCriterias.php
===================================================================
--- trunk/pages/be.de/proxies/getWorkspaceCriterias.php	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/pages/be.de/proxies/getWorkspaceCriterias.php	2011-02-09 11:26:16 UTC (rev 99)
@@ -4,8 +4,8 @@
     $workspaceId = $_GET['workspaceId'];
     $topicId = $_GET['topicId'];
     $body = '{&quot;method&quot;: &quot;getWorkspaceCriterias&quot;, &quot;params&quot;: [&quot;'.$workspaceId.'&quot;, &quot;'.$topicId.'&quot;]}';
-    // $req2 =&amp; new HTTP_Request(&quot;<A HREF="http://www.kiezatlas.de:8080/rpc/">http://www.kiezatlas.de:8080/rpc/</A> <A HREF="http://www.kiezatlas.de:8080/rpc/">http://www.kiezatlas.de:8080/rpc/</A>&quot;);
-    $req2 =&amp; new HTTP_Request(&quot;<A HREF="http://www.kiezatlas.de:8080/rpc/">http://www.kiezatlas.de:8080/rpc/</A>&quot;);
+    // $req2 =&amp; new HTTP_Request(&quot;<A HREF="http://www.kiezatlas.de:8080/rpc/">http://www.kiezatlas.de:8080/rpc/</A>&quot;);
+    $req2 =&amp; new HTTP_Request(&quot;<A HREF="http://localhost:8080/kiezatlas/rpc/">http://localhost:8080/kiezatlas/rpc/</A>&quot;);
     $req2-&gt;addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;); 
     // $req2-&gt;addHeader(&quot;Charset&quot;, &quot;utf-8&quot;);
     $req2-&gt;setBody($body);

Modified: trunk/pages/be.de/proxies/getWorkspaceInfos.php
===================================================================
--- trunk/pages/be.de/proxies/getWorkspaceInfos.php	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/pages/be.de/proxies/getWorkspaceInfos.php	2011-02-09 11:26:16 UTC (rev 99)
@@ -3,8 +3,8 @@
     // get workspaceCriterias
     $workspaceId = $_GET['workspaceId'];
     $body = '{&quot;method&quot;: &quot;getWorkspaceInfos&quot;, &quot;params&quot;: [&quot;'.$workspaceId.'&quot;]}';
-    $req2 =&amp; new HTTP_Request(&quot;<A HREF="http://www.kiezatlas.de:8080/rpc/">http://www.kiezatlas.de:8080/rpc/</A>&quot;);
-    // $req2 =&amp; new HTTP_Request(&quot;<A HREF="http://localhost:8080/kiezatlas/rpc/">http://localhost:8080/kiezatlas/rpc/</A>&quot;);
+    // $req2 =&amp; new HTTP_Request(&quot;<A HREF="http://www.kiezatlas.de:8080/rpc/">http://www.kiezatlas.de:8080/rpc/</A>&quot;);
+    $req2 =&amp; new HTTP_Request(&quot;<A HREF="http://localhost:8080/kiezatlas/rpc/">http://localhost:8080/kiezatlas/rpc/</A>&quot;);
     // 
     $req2-&gt;addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;); 
     // $req2-&gt;addHeader(&quot;Charset&quot;, &quot;utf-8&quot;);

Modified: trunk/pages/be.de/proxies/searchGeoObjects.php
===================================================================
--- trunk/pages/be.de/proxies/searchGeoObjects.php	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/pages/be.de/proxies/searchGeoObjects.php	2011-02-09 11:26:16 UTC (rev 99)
@@ -1,10 +1,10 @@
 &lt;?php
   require_once(&quot;HTTP/Request.php&quot;);
     $queryString = $_GET['query'];
-	$workspaceId = $_GET['workspaceId'];
-	$topicmapId = $_GET['topicmapId'];
-    // $request = new HTTP_Request('<A HREF="http://localhost:8080/kiezatlas/rpc/">http://localhost:8080/kiezatlas/rpc/</A>');
-    $request = new HTTP_Request('<A HREF="http://www.kiezatlas.de:8080/rpc/">http://www.kiezatlas.de:8080/rpc/</A>');
+    $workspaceId = $_GET['workspaceId'];
+    $topicmapId = $_GET['topicmapId'];
+    $request = new HTTP_Request('<A HREF="http://localhost:8080/kiezatlas/rpc/">http://localhost:8080/kiezatlas/rpc/</A>');
+    // $request = new HTTP_Request('<A HREF="http://www.kiezatlas.de:8080/rpc/">http://www.kiezatlas.de:8080/rpc/</A>');
     $body = '{&quot;method&quot;: &quot;searchGeoObjects&quot;, &quot;params&quot;: [&quot;'.$queryString.'&quot;, &quot;'.$topicmapId.'&quot;, &quot;'.$workspaceId.'&quot;]}';
     $request-&gt;addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);
     $request-&gt;setBody($body);

Modified: trunk/pages/util.js
===================================================================
--- trunk/pages/util.js	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/pages/util.js	2011-02-09 11:26:16 UTC (rev 99)
@@ -29,4 +29,12 @@
         jQuery(&quot;#numbers&quot;, window.parent.frames[&quot;right&quot;].document).css(&quot;visibility&quot;, &quot;visible&quot;);
     }*/
     //alert(&quot;changed-css attributes&quot;);
+}
+
+function deselectOptions (id){
+   var i;
+   var select = document.getElementById(id);
+   for (i=0; i&lt;select.options.length; i++) {
+     select.options[i].selected = false;
+   }
 }
\ No newline at end of file

Modified: trunk/src/de/kiezatlas/deepamehta/AtlasServlet.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/AtlasServlet.java	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/src/de/kiezatlas/deepamehta/AtlasServlet.java	2011-02-09 11:26:16 UTC (rev 99)
@@ -47,6 +47,7 @@
  */
 public class AtlasServlet extends DeepaMehtaServlet implements KiezAtlas {
 
+  
 
   // --
   // --- KiezAtlas Service Settings
@@ -320,6 +321,7 @@
     String logoURL = &quot;&quot;;
     BaseTopic logo = as.getRelatedTopic(workspaceId, ASSOCTYPE_ASSOCIATION, TOPICTYPE_IMAGE, 2, true);
     if (logo != null) logoURL = as.getTopicProperty(logo, PROPERTY_FILE);
+    System.out.println(&quot;AtlasServlet.getWorkspaceLogo =&gt; &quot; + logoURL);
     return logoURL;
   }
 

Modified: trunk/src/de/kiezatlas/deepamehta/ImportServlet.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/ImportServlet.java	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/src/de/kiezatlas/deepamehta/ImportServlet.java	2011-02-09 11:26:16 UTC (rev 99)
@@ -11,11 +11,9 @@
 import javax.servlet.ServletException;
 //
 import java.util.Enumeration;
-import java.util.Hashtable;
 import java.util.Vector;
 
 
-
 /**
  * Kiezatlas 1.6.5&lt;br&gt;
  * Requires DeepaMehta rev. 369
@@ -33,9 +31,7 @@
   public static final long UPDATE_INTERVAL_TESTING = 3600000; // approximately 60 mins
   //
   public static final String ENGAGEMENT_WORKSPACE = &quot;t-331306&quot;;
-  public static final String EVENTMENT_WORKSPACE = &quot;t-453282&quot;;
   public static final String CITYMAP_TO_PUBLISH = &quot;t-331302&quot;;
-  public static final String EVENTMAP_TO_PUBLISH = &quot;t-453286&quot;;
   //
   public static final String TOPICTYPE_ENG_PROJECT = &quot;t-331314&quot;;
   public static final String TOPICTYPE_ENG_ZIELGRUPPE = &quot;t-331319&quot;;
@@ -44,6 +40,9 @@
   public static final String TOPICTYPE_ENG_MERKMAL = &quot;t-331325&quot;;
   public static final String TOPICTYPE_ENG_BEZIRK = &quot;t-331327&quot;;
   //
+  public static final String EVENTMENT_WORKSPACE = &quot;t-453282&quot;;
+  public static final String EVENTMAP_TO_PUBLISH = &quot;t-453286&quot;;
+  //
   public static final String TOPICTYPE_EVT_EVENT = &quot;t-453276&quot;;
   public static final String TOPICTYPE_EVT_BEZIRK = &quot;t-453278&quot;;
   public static final String TOPICTYPE_EVT_KATEGORIE = &quot;t-453280&quot;;
@@ -222,26 +221,26 @@
         return cm.getTopics(geoType.getID());
     }
 	
-	private Vector getWorkspaces(String userID, Session session) {
-		Vector workspaces = new Vector();
-		//
-        session.setAttribute(&quot;membership&quot;, &quot;&quot;);
-        Vector ws = as.getRelatedTopics(userID, SEMANTIC_MEMBERSHIP, TOPICTYPE_WORKSPACE, 2);
-        Enumeration e = ws.elements();
-        if (!e.hasMoreElements()) {
-            Vector aws = as.getRelatedTopics(userID, SEMANTIC_AFFILIATED_MEMBERSHIP, TOPICTYPE_WORKSPACE, 2);
-            session.setAttribute(&quot;membership&quot;, &quot;Affiliated&quot;);
-            e = aws.elements();
-        }
-		while (e.hasMoreElements()) {
-			BaseTopic w = (BaseTopic) e.nextElement();
-			//if (isKiezatlasWorkspace(w.getID())) {
-			workspaces.addElement(w);
-			//}
-		}
-		//
-		return workspaces;
-	}
+    private Vector getWorkspaces(String userID, Session session) {
+      Vector workspaces = new Vector();
+      //
+          session.setAttribute(&quot;membership&quot;, &quot;&quot;);
+          Vector ws = as.getRelatedTopics(userID, SEMANTIC_MEMBERSHIP, TOPICTYPE_WORKSPACE, 2);
+          Enumeration e = ws.elements();
+          if (!e.hasMoreElements()) {
+              Vector aws = as.getRelatedTopics(userID, SEMANTIC_AFFILIATED_MEMBERSHIP, TOPICTYPE_WORKSPACE, 2);
+              session.setAttribute(&quot;membership&quot;, &quot;Affiliated&quot;);
+              e = aws.elements();
+          }
+      while (e.hasMoreElements()) {
+        BaseTopic w = (BaseTopic) e.nextElement();
+        //if (isKiezatlasWorkspace(w.getID())) {
+        workspaces.addElement(w);
+        //}
+      }
+      //
+      return workspaces;
+    }
 
     /**
      * returns null if no topictype whihc is assigned to the given workspace,

Modified: trunk/src/de/kiezatlas/deepamehta/ImportWorker.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/ImportWorker.java	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/src/de/kiezatlas/deepamehta/ImportWorker.java	2011-02-09 11:26:16 UTC (rev 99)
@@ -7,7 +7,6 @@
 import de.deepamehta.service.ApplicationService;
 import de.deepamehta.service.CorporateDirectives;
 import de.deepamehta.service.CorporateMemory;
-import de.deepamehta.service.Session;
 import de.deepamehta.topics.EmailTopic;
 import de.deepamehta.topics.LiveTopic;
 import de.deepamehta.topics.TypeTopic;
@@ -19,7 +18,6 @@
 import java.net.URL;
 import java.net.URLConnection;
 import java.net.UnknownHostException;
-import java.util.Enumeration;
 import java.util.Hashtable;
 import java.util.Vector;
 import javax.xml.parsers.DocumentBuilder;
@@ -185,7 +183,8 @@
         return workerStarted;
     }
 
-    /** completely remove all topics created by the last import
+    /**
+     *  completely remove all topics created by the last import
      *  e.g. delete from topicmap, delete related address topic, delete email topic,
      *  delete person topic, delete webpage topic, delete webpage topic if not used by any other topic ...
      */
@@ -193,8 +192,10 @@
         /** import data is, date of last import, complete or not complete, error objects */
         Vector allGeoObjects = cm.getTopics(getWorkspaceGeoType(workspaceId).getID());
         Vector allRelatedTopics = new Vector();
-        System.out.println(&quot;[ImportWorker] cleaning up (&quot;+getWorkspaceGeoType(workspaceId).getName()+&quot;). In number--- (&quot; +allGeoObjects.size()+ &quot;)&quot;);
+        System.out.println(&quot;[ImportWorker] cleaning up (&quot; + getWorkspaceGeoType(workspaceId).getName() +
+                &quot;). In number--- (&quot; + allGeoObjects.size() + &quot;)&quot;);
         for (int i = 0; i &lt; allGeoObjects.size(); i++) {
+            //
             BaseTopic baseTopic = (BaseTopic) allGeoObjects.get(i);
             Vector relatedTopics = as.getRelatedTopics(baseTopic.getID(), ASSOCTYPE_ASSOCIATION, 2);
             for (int j = 0; j &lt; relatedTopics.size(); j++) {
@@ -247,18 +248,18 @@
     
     /** performs a clear deletion of a topic with all it`s associations and it`s removal from all maps*/
     private void directiveDeletion(String topicID) {
-		// CorporateDirectives myDirective = as.deleteTopic(topicID, 1);	// ### version=1
+        // CorporateDirectives myDirective = as.deleteTopic(topicID, 1);	// ### version=1
         try {
             LiveTopic topic = as.getLiveTopic(topicID, 1);
             if (topic != null) {
-                // topic.del
+                // 
                 CorporateDirectives newDirectives = as.deleteTopic(topic.getID(), 1);	// ### version=1
                 newDirectives.updateCorporateMemory(as, null, null, null);
             }
         } catch (DeepaMehtaException dex) {
             // yeah, it`s not known to CM..
         }
-	}
+    }
 
     /**
      * just reads in THE xml String from ehrenamt.de and saves every single project into the kiezatlas cm
@@ -269,11 +270,9 @@
     private Vector parseAndStoreData(String xmlData) {
     Vector topicIds = new Vector();
     try {
-
         DocumentBuilderFactory docBuilderFactory = DocumentBuilderFactory.newInstance();
         DocumentBuilder docBuilder = docBuilderFactory.newDocumentBuilder();
         Document doc = docBuilder.parse(new InputSource(new StringReader(xmlData)));
-
         // normalize text representation..
         doc.getDocumentElement().normalize();
         //
@@ -401,9 +400,8 @@
            System.out.println (&quot;** Parsing error&quot; + &quot;, line &quot;
              + err.getLineNumber () + &quot;, column &quot; + err.getColumnNumber() + &quot;, message: &quot; + err.getMessage());
     } catch (SAXException e) {
-        Exception x = e.getException ();
+        Exception x = e.getException();
         ((x == null) ? e : x).printStackTrace ();
-
     } catch (Throwable t) {
         t.printStackTrace ();
     }
@@ -465,7 +463,7 @@
             as.setTopicProperty(geoObjectTopic, PROPERTY_CITY, &quot;Berlin&quot;);
         }
         // BaseTopic knownMailbox = cm.getTopic(TOPICTYPE_EMAIL_ADDRESS, orgaContact, 1);
-        // check for address in cm
+        // check for address in cm just by streetname and housenumber ### !not yet by Postal Code
         BaseTopic knownAddress = cm.getTopic(TOPICTYPE_ADDRESS, streetNr, 1);
         // check for street in Adress !!
         if (knownAddress != null) {
@@ -647,12 +645,18 @@
         // &quot;to&quot;
         String to = &quot;<A HREF="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">mre at newthinking.de</A>&quot;;
         // &quot;subject&quot;
-        String subject = &quot;Ehrenamtsatlas: \&quot;&quot; + unusableProjects.size() + &quot;\&quot; fehlerhafte Addresseintr&#228;ge in der Ehrenamtsdatenbank&quot;;
+        String subject = &quot;Ehrenamtsatlas: folgende Projekte haben einen fehlerhaften Addresseintrag&quot;;
         StringBuffer entries = new StringBuffer();
         entries.append(&quot;------------------------------\r&quot;);
         for (int i = 0; i &lt; unusableProjects.size(); i++) {
             GeoObjectTopic entry = (GeoObjectTopic) unusableProjects.get(i);
-            entries.append(&quot;Projekt: &quot;+ entry.getName()+ &quot; Adresseintrag: &quot; + entry.getAddress() + &quot;\r&quot;);
+            if (!entry.getAddress().getName().equals(&quot;&#252;ber Gute-Tat.de&quot;)) {
+              entries.append(&quot;Projekt: &quot;);
+              entries.append(entry.getName());
+              entries.append(&quot; mit Adresseintrag: &quot;);
+              entries.append(entry.getAddress().getName());
+              entries.append(&quot;\r&quot;);
+            }
         }
         entries.append(&quot;------------------------------\r&quot;);
         // &quot;body&quot;
@@ -674,55 +678,7 @@
       }
     }
 
-    private Vector getWorkspaces(String userID, Session session) {
-      Vector workspaces = new Vector();
-      //
-          session.setAttribute(&quot;membership&quot;, &quot;&quot;);
-          Vector ws = as.getRelatedTopics(userID, SEMANTIC_MEMBERSHIP, TOPICTYPE_WORKSPACE, 2);
-          Enumeration e = ws.elements();
-          if (!e.hasMoreElements()) {
-              Vector aws = as.getRelatedTopics(userID, SEMANTIC_AFFILIATED_MEMBERSHIP, TOPICTYPE_WORKSPACE, 2);
-              session.setAttribute(&quot;membership&quot;, &quot;Affiliated&quot;);
-              e = aws.elements();
-          }
-      while (e.hasMoreElements()) {
-        BaseTopic w = (BaseTopic) e.nextElement();
-        //if (isKiezatlasWorkspace(w.getID())) {
-        workspaces.addElement(w);
-        //}
-      }
-      //
-      return workspaces;
-    }
 
-    /**
-     * returns null if no topictype whihc is assigned to the given workspace,
-     * is a subtype of &quot;GeoObjectTopic&quot;
-     *
-     * @param workspaceId
-     * @return
-     */
-    private BaseTopic getWorkspaceSubType(String workspaceId, String superTypeId) {
-        //
-        TypeTopic geotype = as.type(superTypeId, 1);
-        Vector subtypes = geotype.getSubtypeIDs();
-        Vector workspacetypes = as.getRelatedTopics(workspaceId, ASSOCTYPE_USES, 2);
-        int i;
-        for (i = 0; i &lt; workspacetypes.size(); i++) {
-            BaseTopic topic = (BaseTopic) workspacetypes.get(i);
-            int a;
-            for (a = 0; a &lt; subtypes.size(); a++) {
-                // System.out.println(&quot; counter: &quot; + a);
-                String derivedOne = (String) subtypes.get(a);
-                // System.out.println(&quot;    &quot; + derivedOne.getID() + &quot;:&quot; + derivedOne.getName());
-                if (derivedOne.equals(topic.getID())) {
-                    // System.out.println(&quot; found geoType &quot; + topic.getID() + &quot;:&quot; + topic.getName());
-                    return topic;
-                }
-            }
-        }
-        return null;
-    }
 
     /**
      * returns null if no topictype whihc is assigned to the given workspace,
@@ -753,36 +709,4 @@
         return null;
     }
 
-
-    /**
-     * simply retrieves the BaseTopics assigned to a workspace which are used
-     * for navigation in web-frontends
-     *
-     * @param workspaceId
-     * @return
-     */
-    private Vector getKiezCriteriaTypes(String workspaceId)
-    {
-        Vector criterias = new Vector();
-        TypeTopic critType = as.type(TOPICTYPE_CRITERIA, 1);
-        Vector subtypes = critType.getSubtypeIDs();
-        Vector workspacetypes = as.getRelatedTopics(workspaceId, &quot;at-uses&quot;, 2);
-        for(int i = 0; i &lt; workspacetypes.size(); i++)
-        {
-            BaseTopic topic = (BaseTopic)workspacetypes.get(i);
-            for(int a = 0; a &lt; subtypes.size(); a++)
-            {
-                String derivedOne = (String)subtypes.get(a);
-                if(derivedOne.equals(topic.getID()))
-                {
-                    //System.out.println(&quot;&gt;&gt;&gt; use criteria (&quot; + derivedOne + &quot;) &quot; + topic.getName());
-                    criterias.add(topic);
-                }
-            }
-
-        }
-
-        return criterias;
-    }
-
 }
\ No newline at end of file

Modified: trunk/src/de/kiezatlas/deepamehta/ImportWorkerEvent.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/ImportWorkerEvent.java	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/src/de/kiezatlas/deepamehta/ImportWorkerEvent.java	2011-02-09 11:26:16 UTC (rev 99)
@@ -7,7 +7,7 @@
 import de.deepamehta.service.ApplicationService;
 import de.deepamehta.service.CorporateDirectives;
 import de.deepamehta.service.CorporateMemory;
-import de.deepamehta.service.Session;
+import de.deepamehta.topics.EmailTopic;
 import de.deepamehta.topics.LiveTopic;
 import de.deepamehta.topics.TypeTopic;
 import de.deepamehta.util.DeepaMehtaUtils;
@@ -18,7 +18,6 @@
 import java.net.URL;
 import java.net.URLConnection;
 import java.net.UnknownHostException;
-import java.util.Enumeration;
 import java.util.Hashtable;
 import java.util.Vector;
 import javax.xml.parsers.DocumentBuilder;
@@ -153,6 +152,7 @@
         //
         System.out.println(&quot;[ImportWorker] stored &quot; + validEntries + &quot; in public cityMap \&quot;&quot; +as.getTopicProperty(ImportServlet.EVENTMAP_TO_PUBLISH, 1, PROPERTY_WEB_ALIAS)+ &quot;\&quot;&quot;);
         System.out.println(&quot;[ImportWorker] didn`t published &quot; + unusable.size() + &quot; unlocatable \&quot;&quot;+getWorkspaceGeoType(workspaceId).getName()+&quot;e\&quot; &quot;);
+        sendNotificationEmail(unusable);
         //
     }
 
@@ -575,7 +575,51 @@
         return result;
     }
 
+    // --- copy of BrowseServlet
 
+    private void sendNotificationEmail(Vector unusableProjects) {
+      try {
+        // GeoObjectTopic inst = (GeoObjectTopic) as.getLiveTopic(instID, 1);
+        // &quot;from&quot;
+        String from = as.getEmailAddress(&quot;t-rootuser&quot;);		// ###
+        if (from == null || from.equals(&quot;&quot;)) {
+          throw new DeepaMehtaException(&quot;email address of root user is unknown&quot;);
+        }
+        // &quot;to&quot;
+        String to = &quot;<A HREF="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">mre at newthinking.de</A>&quot;;
+        // &quot;subject&quot;
+        String subject = &quot;Ehrenamtsatlas: folgende Veranstaltungen haben einen fehlerhaften Addresseintrag&quot;;
+        StringBuffer entries = new StringBuffer();
+        entries.append(&quot;------------------------------\r&quot;);
+        for (int i = 0; i &lt; unusableProjects.size(); i++) {
+            GeoObjectTopic entry = (GeoObjectTopic) unusableProjects.get(i);
+            entries.append(&quot;Veranstaltung: &quot;);
+            entries.append(entry.getName());
+            entries.append(&quot; mit Adresseintrag: &quot;);
+            entries.append(entry.getAddress().getName());
+            entries.append(&quot;\r&quot;);
+        }
+        entries.append(&quot;------------------------------\r&quot;);
+        // &quot;body&quot;
+        String body = &quot;Dies ist eine automatische Benachrichtigung erstellt von www.kiezatlas.de\r\r&quot; +
+          &quot;Folgende Veranstaltungen konnten aufgrund eines fehlerhaften Adresseintrags nicht korrekt verortet werden:\r\r&quot; +
+          &quot;&quot; + entries.toString() + &quot;\r&quot; +
+          &quot;www.berlin.de/buergeraktiv/atlas\r\r&quot; +
+          &quot;Mit freundlichen Gr&#252;&#223;en\r&quot; +
+          &quot;ihr Kiezatlas-Team&quot;;
+        //
+        System.out.println(&quot;&gt;&gt;&gt; send notification email&quot;);
+        System.out.println(&quot;  &gt; SMTP server: \&quot;&quot; + as.getSMTPServer() + &quot;\&quot;&quot;);	// as.getSMTPServer() throws DME
+        System.out.println(&quot;  &gt; from: \&quot;&quot; + from + &quot;\&quot;&quot;);
+        System.out.println(&quot;  &gt; to: \&quot;&quot; + to + &quot;\&quot;&quot;);
+        // send email
+        EmailTopic.sendMail(as.getSMTPServer(), from, to, subject, body);		// EmailTopic.sendMail() throws DME
+      } catch (Exception e) {
+        System.out.println(&quot;*** notification email not send (&quot; + e + &quot;)&quot;);
+      }
+    }
+
+
     /**
      * returns null if no topictype whihc is assigned to the given workspace,
      * is a subtype of &quot;GeoObjectTopic&quot;

Modified: trunk/src/de/kiezatlas/deepamehta/KiezAtlas.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/KiezAtlas.java	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/src/de/kiezatlas/deepamehta/KiezAtlas.java	2011-02-09 11:26:16 UTC (rev 99)
@@ -62,6 +62,7 @@
 	static final String TOPICTYPE_OUTLINE_POINT = &quot;tt-ka-outlinepoint&quot;;
 	static final String TOPICTYPE_SHAPE = &quot;tt-ka-shape&quot;;
 	static final String TOPICTYPE_STYLESHEET = &quot;tt-ka-stylesheet&quot;;
+	static final String TOPICTYPE_IMPORTER_SETTINGS = &quot;tt-ka-importersettings&quot;;
 
 
 
@@ -143,9 +144,21 @@
 	static final String PROPERTY_TARGET_WEBALIAS = &quot;Target Web Alias&quot;;
 	//
 	static final String PROPERTY_CSS = &quot;CSS&quot;;
+  //
+  // TOPICTYPE_IMPORTER_SETTINGS Properties
+  static final String PROPERTY_ICONS_MAP = &quot;Icons / Kategorien&quot;;
+  static final String PROPERTY_ICON_CAT_DIVIDER = &quot;:&quot;;
+  static final String PROPERTY_IMPORT_CONTENT_REPORT = &quot;Content Report Mailbox&quot;;
+  static final String PROPERTY_IMPORT_SERVICE_REPORT = &quot;Service Report Mailbox&quot;;
+  // Event imported Properties
+  static final String PROPERTY_EVENT_DESCRIPTION = &quot;Beschreibung&quot;;
+  static final String PROPERTY_EVENT_TIME = &quot;Datum / Zeit&quot;;
+  // Event and Engagment imported Properties
+  static final String PROPERTY_PROJECT_ORIGIN_ID = &quot;OriginId&quot;;
+  static final String PROPERTY_PROJECT_LAST_MODIFIED = &quot;Timestamp&quot;;
+  static final String PROPERTY_PROJECT_ORGANISATION = &quot;Organisation&quot;;
 
 
-
 	// -----------------------
 	// --- Property Values ---
 	// -----------------------

Added: trunk/src/de/kiezatlas/deepamehta/SlimerServlet.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/SlimerServlet.java	                        (rev 0)
+++ trunk/src/de/kiezatlas/deepamehta/SlimerServlet.java	2011-02-09 11:26:16 UTC (rev 99)
@@ -0,0 +1,147 @@
+package de.kiezatlas.deepamehta;
+
+import de.deepamehta.service.Session;
+import de.deepamehta.service.CorporateMemory;
+import de.deepamehta.service.ApplicationService;
+import de.deepamehta.service.ApplicationServiceHost;
+import de.deepamehta.service.CorporateDirectives;
+import de.deepamehta.service.PojoApplicationServiceProvider;
+
+import java.io.IOException;
+import javax.servlet.Servlet;
+import javax.servlet.ServletConfig;
+import javax.servlet.ServletContext;
+import javax.servlet.ServletException;
+import javax.servlet.ServletRequest;
+import javax.servlet.ServletResponse;
+
+import org.quartz.Scheduler;
+import org.quartz.JobDetail;
+import org.quartz.Trigger;
+import org.quartz.TriggerUtils;
+import org.quartz.SchedulerFactory;
+import org.quartz.impl.StdSchedulerFactory;
+import org.quartz.SchedulerException;
+
+/**
+ * Timer based Ehrenamt Schnittstelle 1.0
+ * is a thread based worker which imports single projects and all occuring criterias resp. categories
+ * from an xml interface into one kiezatlas workspace - it reuses topics (e.g. addresstopics) known to
+ * the cm (by name), triggers a geolocation on each project with nice address
+ *
+ * @author Malte Rei&#223;ig (<A HREF="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">mre at deepamehta.de</A>)
+ */
+public class SlimerServlet implements Servlet, ApplicationServiceHost {
+
+  Scheduler scheduler = null;
+  ServletContext sc = null;
+  ApplicationService as = null;
+  CorporateMemory cm = null;
+  //
+  PojoApplicationServiceProvider serviceProvider;
+  //
+  public static final long UPDATE_INTERVAL = 86000000; // approximately 24 hours
+  public static final long UPDATE_INTERVAL_TESTING = 3600000; // approximately 60 mins
+  //
+  public static final String ENGAGEMENT_SERVICE_URL = &quot;<A HREF="http://buerger-aktiv.index.de/kiezatlas/">http://buerger-aktiv.index.de/kiezatlas/</A>&quot;;
+  public static final String ENGAGEMENT_WORKSPACE = &quot;t-331306&quot;;
+  public static final String CITYMAP_TO_PUBLISH = &quot;t-331302&quot;;
+  //
+  public static final String EVENT_SERVICE_URL = &quot;<A HREF="http://www.berlin.de/land/kalender/export_kiezatlas.php">http://www.berlin.de/land/kalender/export_kiezatlas.php</A>&quot;;
+  public static final String EVENTMENT_WORKSPACE = &quot;t-453282&quot;;
+  public static final String EVENTMAP_TO_PUBLISH = &quot;t-453286&quot;;
+  
+  public void init(ServletConfig config) throws ServletException {
+    System.out.println(&quot;DEBUG: Starting to initialize the SlimerServlet...&quot;);
+    sc = config.getServletContext();
+    // --- create application service ---
+	  String service = sc.getInitParameter(&quot;service&quot;);
+    try {
+        // ApplicationServiceInstance instance = ApplicationServiceInstance.lookup(service, &quot;../config/dm.properties&quot;);
+        // as = ApplicationService.create(this, instance); // throws DME ### servlet is not properly inited
+        serviceProvider = new PojoApplicationServiceProvider();
+        serviceProvider.setServiceName(service);
+        serviceProvider.startup();
+        as = serviceProvider.getApplicationService();
+        cm = as.cm;
+        SchedulerFactory sf = new StdSchedulerFactory();
+        scheduler = sf.getScheduler();
+        // Scheduler will not execute jobs until it has been started (though they can be scheduled before start())
+        scheduler.start();
+        schedule();
+    } catch (Exception e){
+        System.out.println(&quot;ERROR: while initializing the TimerServlet and or Quartz Framework...&quot;);
+        e.printStackTrace();
+    }
+    // System.out.println(&quot;INFO: Quartz Framework initialized correctly.. for 2 Jobs for instance &quot; + service);
+  }
+
+  public void schedule() {
+      TimerJobParameterHolder.getInstance().getParameters().put(&quot;as&quot;, as);
+      TimerJobParameterHolder.getInstance().getParameters().put(&quot;cm&quot;, cm);
+      TimerJobParameterHolder.getInstance().getParameters().put(&quot;directives&quot;, new CorporateDirectives());
+      // both jobs use one jobParameterHolder
+      TimerJobParameterHolder.getInstance().getParameters().put(&quot;engagementWorkspaceId&quot;, ENGAGEMENT_WORKSPACE);
+      TimerJobParameterHolder.getInstance().getParameters().put(&quot;engagementCityMapId&quot;, CITYMAP_TO_PUBLISH);
+      TimerJobParameterHolder.getInstance().getParameters().put(&quot;engagementServiceUrl&quot;, ENGAGEMENT_SERVICE_URL);
+      TimerJobParameterHolder.getInstance().getParameters().put(&quot;eventWorkspaceId&quot;, EVENTMENT_WORKSPACE);
+      TimerJobParameterHolder.getInstance().getParameters().put(&quot;eventCityMapId&quot;, EVENTMAP_TO_PUBLISH);
+      TimerJobParameterHolder.getInstance().getParameters().put(&quot;eventServiceUrl&quot;, EVENT_SERVICE_URL);
+      //
+      JobDetail engagementJob = new JobDetail(&quot;engagement&quot;, &quot;importer&quot;, TimedEngagementImporter.class);
+      JobDetail eventJob = new JobDetail(&quot;event&quot;, &quot;importer&quot;, TimedEventImporter.class);
+      Trigger indexdeTrigger = TriggerUtils.makeDailyTrigger(1, 1);
+      // Trigger indexdeTrigger = TriggerUtils.makeMinutelyTrigger(1, 1);
+      Trigger eventTrigger = TriggerUtils.makeDailyTrigger(6, 0);
+      // Trigger eventTrigger = TriggerUtils.makeMinutelyTrigger(6, 0);
+      indexdeTrigger.setName(&quot;engagement&quot;);
+      indexdeTrigger.setGroup(&quot;importer&quot;);
+      eventTrigger.setName(&quot;event&quot;);
+      eventTrigger.setGroup(&quot;importer&quot;);
+      try {
+        scheduler.scheduleJob(engagementJob, indexdeTrigger);
+        scheduler.scheduleJob(eventJob, eventTrigger);
+        System.out.println(&quot;INFO: The Engagement and Event Importer Jobs are now scheduled for ... some time..&quot;);
+      } catch (SchedulerException ex) {
+        ex.printStackTrace();
+      }
+  }
+
+  public ServletConfig getServletConfig() {
+    throw new UnsupportedOperationException(&quot;Not supported yet.&quot;);
+  }
+
+  public void service(ServletRequest sr, ServletResponse sr1) throws ServletException, IOException {
+    throw new UnsupportedOperationException(&quot;Not supported yet.&quot;);
+  }
+
+  public String getServletInfo() {
+    throw new UnsupportedOperationException(&quot;Not supported yet.&quot;);
+  }
+
+  public void destroy() {
+    try {
+      if (scheduler != null) {
+        scheduler.shutdown(true);
+        // shutdown() does not return until executing Jobs complete execution..
+      }
+    } catch (Exception ex) {
+      System.out.println(&quot;ERROR: while stopping the Quartz Framework...&quot;);
+      ex.printStackTrace();
+    }
+    System.out.println(&quot;INFO: QuartzTimer stopped and destroyed..&quot;);
+  }
+
+  public String getCommInfo() {
+    return getCommInfo();
+  }
+
+  public void sendDirectives(Session sn, CorporateDirectives cd, ApplicationService as, String string, String string1) {
+    // do nothing
+  }
+
+  public void broadcastChangeNotification(String string) {
+    // do nothing
+  }
+
+}

Added: trunk/src/de/kiezatlas/deepamehta/TimedEngagementImporter.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/TimedEngagementImporter.java	                        (rev 0)
+++ trunk/src/de/kiezatlas/deepamehta/TimedEngagementImporter.java	2011-02-09 11:26:16 UTC (rev 99)
@@ -0,0 +1,683 @@
+package de.kiezatlas.deepamehta;
+
+import de.deepamehta.BaseTopic;
+import de.deepamehta.DeepaMehtaConstants;
+import de.deepamehta.DeepaMehtaException;
+import de.deepamehta.assocs.LiveAssociation;
+import de.deepamehta.service.ApplicationService;
+import de.deepamehta.service.CorporateDirectives;
+import de.deepamehta.service.CorporateMemory;
+import de.deepamehta.topics.EmailTopic;
+import de.deepamehta.topics.LiveTopic;
+import de.deepamehta.topics.TypeTopic;
+import de.deepamehta.util.DeepaMehtaUtils;
+import de.kiezatlas.deepamehta.topics.GeoObjectTopic;
+import java.io.BufferedReader;
+import java.io.InputStreamReader;
+import java.io.StringReader;
+import java.net.URL;
+import java.net.URLConnection;
+import java.net.UnknownHostException;
+import java.util.Hashtable;
+import java.util.Vector;
+import javax.xml.parsers.DocumentBuilder;
+import javax.xml.parsers.DocumentBuilderFactory;
+import org.w3c.dom.Document;
+import org.w3c.dom.Node;
+import org.w3c.dom.NodeList;
+import org.xml.sax.InputSource;
+import org.xml.sax.SAXException;
+import org.xml.sax.SAXParseException;
+
+import org.quartz.Job;
+import org.quartz.JobExecutionContext;
+import org.quartz.JobExecutionException;
+
+/**
+ * Ehrenamt Schnittstelle 1.0
+ * is a thread based worker which imports single projects and all occuring criterias resp. categories
+ * from an xml interface into one kiezatlas workspace - it reuses topics (e.g. addresstopics) known to
+ * the cm (by name), triggers a geolocation on each project with nice address
+ *
+ * @author Malte Rei&#223;ig (<A HREF="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">mre at deepamehta.de</A>)
+ */
+public class TimedEngagementImporter implements Job, DeepaMehtaConstants, KiezAtlas {
+
+    private ApplicationService as = null;
+    private CorporateMemory cm = null;
+    private CorporateDirectives directives = null;
+
+    private String workspaceId = &quot;&quot;;
+    private String cityMapId = &quot;&quot;;
+    private String serviceUrl = &quot;&quot;;
+    // settings
+    private String contentReportRecipient = &quot;&quot;;
+    private String serviceReportRecipient = &quot;&quot;;
+    private String iconCatMapString = &quot;&quot;;
+    private Object[] iconCatMap = null; // holds an array of String[catId,icon.gif]-Arrays
+    // 
+    // Imported Engagement Types
+    static final String TOPICTYPE_ENG_PROJECT = &quot;t-331314&quot;;
+    static final String TOPICTYPE_ENG_ZIELGRUPPE = &quot;t-331319&quot;;
+    static final String TOPICTYPE_ENG_TAETIGKEIT = &quot;t-331323&quot;;
+    static final String TOPICTYPE_ENG_EINSATZBEREICH = &quot;t-331321&quot;;
+    static final String TOPICTYPE_ENG_MERKMAL = &quot;t-331325&quot;;
+    static final String TOPICTYPE_ENG_BEZIRK = &quot;t-331327&quot;;
+
+    public TimedEngagementImporter () {
+      as = (ApplicationService) TimerJobParameterHolder.getInstance().getParameters().get(&quot;as&quot;);
+      cm = (CorporateMemory) TimerJobParameterHolder.getInstance().getParameters().get(&quot;cm&quot;);
+      directives = (CorporateDirectives) TimerJobParameterHolder.getInstance().getParameters().get(&quot;directives&quot;);
+      workspaceId = (String) TimerJobParameterHolder.getInstance().getParameters().get(&quot;engagementWorkspaceId&quot;);
+      cityMapId = (String) TimerJobParameterHolder.getInstance().getParameters().get(&quot;engagementCityMapId&quot;);
+      serviceUrl = (String) TimerJobParameterHolder.getInstance().getParameters().get(&quot;engagementServiceUrl&quot;);
+    }
+
+    public void execute(JobExecutionContext context) throws JobExecutionException {
+      BaseTopic settings = null; // getImporterSettingsTopic();
+      if (settings != null) {
+        contentReportRecipient = as.getTopicProperty(settings, PROPERTY_IMPORT_CONTENT_REPORT);
+        serviceReportRecipient = as.getTopicProperty(settings, PROPERTY_IMPORT_SERVICE_REPORT);
+        iconCatMapString = as.getTopicProperty(settings, PROPERTY_ICONS_MAP);
+        System.out.println(&quot;[EngagementJob] set to run for \&quot;&quot; + contentReportRecipient + &quot;\&quot; &quot; +
+                &quot;errors are reported to &quot; + serviceReportRecipient + &quot; iconsMap available ? &quot;
+                + (iconCatMapString.length() &gt; 0));
+      } else { System.out.println(&quot;[EngagementJob] ERROR while loading settings for workspace &quot; + workspaceId); }
+      //
+      if (iconCatMapString.length() &gt; 0) {
+        String[] lines = iconCatMapString.split(&quot;\n&quot;);
+        iconCatMap = new Object[lines.length];
+        for (int i = 0; i &lt; lines.length; i++) {
+          String[] pair = lines[i].split(&quot;:&quot;);
+          iconCatMap[i] = pair;
+        }
+        //
+        /* for (int i = 0; i &lt; iconCatMap.length; i++) {
+          String[] pair = (String[]) iconCatMap[i];
+          System.out.println(&quot;  catId: &quot; + pair[0] + &quot; iconSrc: &quot; + pair[1]);
+        } */
+        System.out.println(&quot;[EngagementJob] number of items configured in iconCatMap: &quot; + iconCatMap.length);
+      }
+      // work here
+      String ehrenamtXml = sendGetRequest(serviceUrl, &quot;&quot;);
+      if (ehrenamtXml != null) {
+        System.out.println(&quot;[EngagementJob] loaded data.. but is doing nothing for now....&quot; + cityMapId);
+        // delete former import
+        // clearCriterias();
+        // clears workspace if new topics are available
+        // clearImport();
+        // store and publish new topics
+        // Vector topicIds = parseAndStoreData(ehrenamtXml);
+        // publishData(topicIds);
+      }
+    }
+
+
+    
+    // --
+    // --- Utilities
+    // --
+
+
+    private BaseTopic getImporterSettingsTopic() {
+        Vector workspaces = as.getRelatedTopics(workspaceId, ASSOCTYPE_ASSOCIATION, TOPICTYPE_IMPORTER_SETTINGS, 1);
+        if (workspaces.size() &gt;= 1) {
+          BaseTopic settings = (BaseTopic) workspaces.get(0);
+          return settings;
+        }
+        return null;
+    }
+
+    private void publishData(Vector topicIds) {
+        System.out.println(&quot;[EngagementJob] is starting to gather coordinates and publish \&quot;&quot;+topicIds.size()+&quot;\&quot; topics into : &quot; + cm.getTopic(cityMapId, 1).getName());// + &quot; &quot; +
+        //
+        Vector unusable = new Vector(); // collection of GeoObjects without GPS Data
+        for (int i = 0; i &lt; topicIds.size(); i++) {
+            GeoObjectTopic baseTopic = (GeoObjectTopic) as.getLiveTopic(((String)topicIds.get(i)), 1);
+            // System.out.println(&quot;[GPSINFO] is LAT: &quot; + as.getTopicProperty(baseTopic, PROPERTY_GPS_LAT) + &quot; LON: &quot; + as.getTopicProperty(baseTopic, PROPERTY_GPS_LONG));
+            BaseTopic addressTopic = baseTopic.getAddress();
+            if (as.getTopicProperty(baseTopic.getID(), 1, PROPERTY_GPS_LAT).equals(&quot;&quot;)) {
+                System.out.println(&quot;[EngagementJob] WARNING ***  \&quot;&quot;+addressTopic.getName()+&quot;\&quot; is without GPS Data... dropping placement in CityMap&quot;);
+                unusable.add(baseTopic); //
+            } else if (as.getTopicProperty(addressTopic, PROPERTY_STREET).equals(&quot;&#252;ber Gute-Tat.de&quot;)) {
+                unusable.add(baseTopic);
+            } else {
+                // System.out.println(&quot;&gt;&gt;&gt;&gt; creating ViewTopic for &quot; + baseTopic.getName() + &quot; (&quot; + baseTopic.getID() + &quot;)&quot; );
+                as.createViewTopic(cityMapId, 1, null, baseTopic.getID(), 1, 0, 0, false);
+            }
+            // System.out.println(&quot;&gt;&gt;&gt; ready to publish geoObject &quot; +baseTopic.getName()+&quot; (&quot;+baseTopic.getID()+&quot;)&quot;);
+        }
+        int validEntries = topicIds.size() - unusable.size();
+        //
+        System.out.println(&quot;[EngagementJob] stored &quot; + validEntries + &quot; in public cityMap \&quot;&quot; +as.getTopicProperty(cityMapId, 1, PROPERTY_WEB_ALIAS)+ &quot;\&quot;&quot;);
+        System.out.println(&quot;[EngagementJob] didn`t published &quot; + unusable.size() + &quot; unlocatable \&quot;&quot;+getWorkspaceGeoType(workspaceId).getName()+&quot;e\&quot; &quot;);
+        sendNotificationEmail(unusable);
+    }
+
+    /** completely remove all topics created by the last import
+     *  e.g. delete from topicmap, delete related address topic, delete email topic,
+     *  delete person topic, delete webpage topic, delete webpage topic if not used by any other topic ...
+     */
+    private void clearImport() {
+        /** import data is, date of last import, complete or not complete, error objects */
+        Vector allGeoObjects = cm.getTopics(getWorkspaceGeoType(workspaceId).getID());
+        Vector allRelatedTopics = new Vector();
+        System.out.println(&quot;[EngagementJob] cleaning up (&quot;+getWorkspaceGeoType(workspaceId).getName()+&quot;). In number--- (&quot; +allGeoObjects.size()+ &quot;)&quot;);
+        for (int i = 0; i &lt; allGeoObjects.size(); i++) {
+            BaseTopic baseTopic = (BaseTopic) allGeoObjects.get(i);
+            Vector relatedTopics = as.getRelatedTopics(baseTopic.getID(), ASSOCTYPE_ASSOCIATION, 2);
+            for (int j = 0; j &lt; relatedTopics.size(); j++) {
+                BaseTopic relatedTopic = (BaseTopic) relatedTopics.get(j);
+                if (relatedTopic.getType().equals(TOPICTYPE_ENG_BEZIRK) ||
+                        relatedTopic.getType().equals(TOPICTYPE_ENG_ZIELGRUPPE) ||
+                        relatedTopic.getType().equals(TOPICTYPE_ENG_EINSATZBEREICH) ||
+                        relatedTopic.getType().equals(TOPICTYPE_ENG_TAETIGKEIT) ||
+                        relatedTopic.getType().equals(TOPICTYPE_ENG_MERKMAL)) {
+                    //
+                } else {
+                    // store topicID in Vector for later removal
+                    allRelatedTopics.add(relatedTopic);
+                }
+            }
+            directiveDeletion(baseTopic.getID());
+            //
+        }
+        //
+        System.out.println(&quot;[EngagementJob] is starting to delete &quot;+allRelatedTopics.size()+&quot; relatedTopics (just if one entry has no associations)---&quot;);
+        for (int k = 0; k &lt; allRelatedTopics.size(); k++) {
+            BaseTopic relTopic = (BaseTopic) allRelatedTopics.get(k);
+            //
+            if (cm.getAssociationIDs(relTopic.getID(), 1).size() &gt; 0) {
+               // System.out.println(&quot;&gt;&gt;&gt; relTopic (&quot;+relTopic.getID()+&quot;) \&quot;&quot;+relTopic.getName()+&quot;\&quot; not to delete, has &quot;+cm.getAssociationIDs(relTopic.getID(), 1).size()+&quot; other associations&quot;);
+            } else {
+               directiveDeletion(relTopic.getID());
+            }
+        }
+    }
+
+    /** remove criteria system from configured workspace */
+    private void clearCriterias() {
+        Vector taetigkeiten = cm.getTopics(TOPICTYPE_ENG_TAETIGKEIT);
+        Vector einsatzbereiche = cm.getTopics(TOPICTYPE_ENG_EINSATZBEREICH);
+        Vector merkmale = cm.getTopics(TOPICTYPE_ENG_MERKMAL);
+        Vector zielgruppen = cm.getTopics(TOPICTYPE_ENG_ZIELGRUPPE);
+        Vector bezirke = cm.getTopics(TOPICTYPE_ENG_BEZIRK);
+        bezirke.addAll(taetigkeiten);
+        bezirke.addAll(einsatzbereiche);
+        bezirke.addAll(merkmale);
+        bezirke.addAll(zielgruppen);
+        //
+        for (int i = 0; i &lt; bezirke.size(); i++) {
+            BaseTopic category = (BaseTopic) bezirke.get(i);
+            CorporateDirectives newDirectives = as.deleteTopic(category.getID(), 1);
+            newDirectives.updateCorporateMemory(as, null, null, null);
+        }
+    }
+    
+    /** performs a clear deletion of a topic with all it`s associations and it`s removal from all maps*/
+    private void directiveDeletion(String topicID) {
+		// CorporateDirectives myDirective = as.deleteTopic(topicID, 1);	// ### version=1
+        try {
+            LiveTopic topic = as.getLiveTopic(topicID, 1);
+            if (topic != null) {
+                // topic.del
+                CorporateDirectives newDirectives = as.deleteTopic(topic.getID(), 1);	// ### version=1
+                newDirectives.updateCorporateMemory(as, null, null, null);
+            }
+        } catch (DeepaMehtaException dex) {
+            // yeah, it`s not known to CM..
+        }
+    }
+
+    /**
+     * just reads in THE xml String from ehrenamt.de and saves every single project into the kiezatlas cm
+     *
+     * @param xmlData
+     * @return
+     */
+    private Vector parseAndStoreData(String xmlData) {
+    Vector topicIds = new Vector();
+    try {
+
+        DocumentBuilderFactory docBuilderFactory = DocumentBuilderFactory.newInstance();
+        DocumentBuilder docBuilder = docBuilderFactory.newDocumentBuilder();
+        Document doc = docBuilder.parse(new InputSource(new StringReader(xmlData)));
+
+        // normalize text representation..
+        doc.getDocumentElement().normalize();
+        //
+        NodeList listOfProjects = doc.getElementsByTagName(&quot;project&quot;);
+        int amountOfProjects = listOfProjects.getLength();
+        System.out.println(&quot;&quot;);
+        System.out.println(&quot; --- Import started at &quot; + DeepaMehtaUtils.getTime() +&quot; for a total no of &quot; + amountOfProjects + &quot; &quot; + getWorkspaceGeoType(workspaceId).getName());
+        // for(int s = 0; s &lt; listOfProjects.getLength(); s++){
+        System.out.println(&quot; -- &quot;);
+        System.out.println(&quot;&quot;);
+        Vector misspelledObjects = new Vector();
+        // iterate over projects
+        for(int p = 0; p &lt; amountOfProjects; p++) {
+            // fields of each project
+            String projectName = &quot;&quot;, originId = &quot;&quot;, contactPerson = &quot;&quot;, projectUrl = &quot;&quot;, postcode = &quot;&quot;, streetNr = &quot;&quot;, bezirk = &quot;&quot;, orgaName = &quot;&quot;,
+                    orgaWebsite = &quot;&quot;, orgaContact = &quot;&quot;, timeStamp = &quot;&quot;;
+            Vector merkmale = new Vector();
+            Vector taetigkeiten = new Vector();
+            Vector zielgruppen = new Vector();
+            Vector einsatzbereiche = new Vector();
+            NodeList projectDetail = listOfProjects.item(p).getChildNodes();
+            // System.out.println(&quot;&gt;&gt; projectDetail has childs in number : &quot; + projectDetail.getLength());
+            for (int i = 0; i &lt; projectDetail.getLength(); i++) {
+                Node node = projectDetail.item(i);
+                // System.out.println(&quot;&gt;&gt;&gt; node is &quot; + node.getNodeName() + &quot; : &quot; + node.getNodeValue() + &quot; (&quot; + node.getNodeType()+&quot;)&quot;);
+                if (node.hasChildNodes()) {
+                    NodeList details = node.getChildNodes();
+                    for (int j = 0; j &lt; details.getLength(); j++) {
+                        Node detailNode = details.item(j);
+                        if (detailNode.hasChildNodes()) {
+                            // System.out.println(&quot;&gt;&gt;&gt;&gt; &quot;+detailNode.getNodeName()+&quot; is &quot;);
+                            for(int k = 0; k &lt; detailNode.getChildNodes().getLength(); k++) {
+                                Node contentNode = detailNode.getChildNodes().item(k);
+                                if (contentNode.hasChildNodes()) {
+                                    // process deep project info, such as categories
+                                    for (int l = 0; l &lt; contentNode.getChildNodes().getLength(); l++) {
+                                        Node anotherNode = contentNode.getChildNodes().item(l);
+                                        if (contentNode.getNodeName().equals(&quot;contact&quot;)) {
+                                            // it`s THE contact person
+                                            contactPerson = anotherNode.getNodeValue();
+                                            // System.out.println(&quot;&gt; ansprechpartner: &quot; + anotherNode.getNodeValue());
+                                        } else if (contentNode.getNodeName().equals(&quot;adress&quot;)) {
+                                            // it`s THE point of interest
+                                            streetNr = anotherNode.getNodeValue();
+                                            // System.out.println(&quot;&gt; anlaufstelle: &quot; + anotherNode.getNodeValue());
+                                        } else if (contentNode.getNodeName().equals(&quot;postcode&quot;)) {
+                                            // it`s THE code of interest
+                                            postcode = anotherNode.getNodeValue();
+                                            // System.out.println(&quot;&gt; plz: &quot; + anotherNode.getNodeValue());
+                                        } else if (contentNode.getNodeName().equals(&quot;location&quot;)) {
+                                            // it`s THE category \&quot;Bezirk\&quot;
+                                            bezirk = anotherNode.getNodeValue();
+                                            // bezirk
+                                            // System.out.println(&quot;&gt; bezirk: &quot; + bezirk);
+                                        } else if (contentNode.getNodeName().equals(&quot;zielgruppen&quot;)) {
+                                            // these are target groups for this project
+                                            // System.out.println(&quot;&gt; zielgruppen: &quot;); // + anotherNode.getNodeValue());
+                                            zielgruppen = readInCategories(anotherNode.getNodeValue());
+                                        } else if (contentNode.getNodeName().equals(&quot;einsatzbereiche&quot;)) {
+                                            // these elements describe the fields of work
+                                            // System.out.println(&quot;&gt; einsatzbereiche: &quot;); // + anotherNode.getNodeValue());
+                                            einsatzbereiche = readInCategories(anotherNode.getNodeValue());
+                                        } else if (contentNode.getNodeName().equals(&quot;taetigkeit&quot;)) {
+                                            // these elements describe the type of work
+                                            // System.out.println(&quot;&gt; taetigkeiten: &quot;); //  + anotherNode.getNodeValue());
+                                            taetigkeiten = readInCategories(anotherNode.getNodeValue());
+                                        } else if (contentNode.getNodeName().equals(&quot;merkmale&quot;)) {
+                                            // these elements describe the attributes of work
+                                            // System.out.println(&quot;&gt; merkmale: &quot;); // + anotherNode.getNodeValue());
+                                            merkmale = readInCategories(anotherNode.getNodeValue());
+                                        } else {
+                                            System.out.println(&quot;*** TimedEngagementImporter found unknown category for a POI while importing from ehrenamt.&quot;);
+                                        }
+                                    }
+                                } else {
+                                    // check for other interesting data such as
+                                    //
+                                    if(detailNode.getNodeName().equals(&quot;created&quot;)) {
+                                        // System.out.println(&quot;&gt; timestamp is : &quot; + contentNode.getNodeValue());
+                                        timeStamp = contentNode.getNodeValue();
+                                    } else if (detailNode.getNodeName().equals(&quot;projectname&quot;)) {
+                                        // System.out.println(&quot;- Name is \&quot; &quot; + contentNode.getNodeValue() + &quot;\&quot;&quot;);
+                                        projectName = contentNode.getNodeValue();
+                                    } else if (detailNode.getNodeName().equals(&quot;projecturl&quot;)) {
+                                        // obsolete ? all needed infos should be right here..
+                                        projectUrl = contentNode.getNodeValue();
+                                        // System.out.println(&quot;&gt;website at : &quot; + contentNode.getNodeValue());
+                                    } else if (detailNode.getNodeName().equals(&quot;organisationname&quot;)) {
+                                        // System.out.println(&quot;&gt;organ. is : &quot; + contentNode.getNodeValue());
+                                        orgaName = contentNode.getNodeValue();
+                                    } else if (detailNode.getNodeName().equals(&quot;contact&quot;)) {
+                                        // System.out.println(&quot;&gt;contactperson is : &quot; + contentNode.getNodeValue());
+                                        orgaContact = contentNode.getNodeValue();
+                                    } else if (detailNode.getNodeName().equals(&quot;url&quot;)) {
+                                        // System.out.println(&quot;&gt;projectpage at : &quot; + contentNode.getNodeValue());
+                                        orgaWebsite = contentNode.getNodeValue();
+                                    } else if (detailNode.getNodeName().equals(&quot;id&quot;)) {
+                                        // System.out.println(&quot;&gt;projectpage at : &quot; + contentNode.getNodeValue());
+                                        originId = contentNode.getNodeValue();
+                                    }
+                                    //System.out.println(&quot;data is: &quot; + contentNode.getNodeValue());
+                                }
+                            }
+                        }
+                    }
+                }
+            }
+            // projectData was gathered
+            // store information per project now
+            String topicID = saveProjectData(originId, projectName, contactPerson, projectUrl, postcode, streetNr, bezirk,
+                        orgaName, orgaWebsite, orgaContact, timeStamp,
+                    merkmale, taetigkeiten, zielgruppen, einsatzbereiche);
+            //if (topicID == null) {
+                //ignore topic, failed to safe data
+              //  System.out.println(&quot;Missspelled Address Item: &quot; + projectName);
+                //misspelledObjects.add(projectName);
+            //} else {
+                // add topicID
+                topicIds.add(topicID);
+            //}
+            // ???
+        }//end of for loop with p for projects
+        System.out.println(&quot;[EngagementJob] stored data at &quot; + DeepaMehtaUtils.getTime() +&quot; for a total no of &quot; + amountOfProjects + &quot; &quot; + getWorkspaceGeoType(workspaceId).getName());
+        } catch (SAXParseException err) {
+               System.out.println (&quot;** Parsing error&quot; + &quot;, line &quot;
+                 + err.getLineNumber () + &quot;, column &quot; + err.getColumnNumber() + &quot;, message: &quot; + err.getMessage());
+        } catch (SAXException e) {
+            Exception x = e.getException ();
+            ((x == null) ? e : x).printStackTrace ();
+
+        } catch (Throwable t) {
+            t.printStackTrace ();
+        }
+        //System.exit (0);
+        return topicIds;
+    }
+
+    /**
+     *  save one item &quot;Project&quot; from ehrenamt.de into the corporate memory with
+     *  reusing existing addresses, webpages and persons
+     *  building up the categorySystem by each item which is in some categories
+     */
+    private String saveProjectData(String originId, String projectName, String contactPerson, String projectUrl, String postcode, String streetNr, String bezirk, String orgaName,
+            String orgaWebsite, String orgaContact, String timeStamp, Vector merkmale, Vector taetigkeiten, Vector zielgruppen, Vector einsatzbereiche) {
+        String topicId = &quot;&quot;;
+        String address = streetNr + &quot;, &quot; + postcode + &quot; &quot; + bezirk;
+        // storing data in corporate memory
+        String geoTypeId = getWorkspaceGeoType(workspaceId).getID();
+        LiveTopic geoObjectTopic = as.createLiveTopic(as.getNewTopicID(), geoTypeId, projectName, null);
+        //
+        as.setTopicProperty(geoObjectTopic, PROPERTY_NAME, projectName);
+        as.setTopicProperty(geoObjectTopic, PROPERTY_PROJECT_ORGANISATION, orgaName);
+        as.setTopicProperty(geoObjectTopic, PROPERTY_PROJECT_ORIGIN_ID, originId);
+        as.setTopicProperty(geoObjectTopic, PROPERTY_PROJECT_LAST_MODIFIED, timeStamp);
+        as.setTopicProperty(geoObjectTopic, PROPERTY_LOCKED_GEOMETRY, &quot;off&quot;);
+        //
+        LiveTopic webpageTopic;
+        LiveTopic contactPersonTopic;
+        LiveTopic addressTopic;
+        LiveTopic cityTopic;
+        // LiveTopic mailTopic;
+        // check for webpage in cm
+        Hashtable webProps = new Hashtable();
+        webProps.put(PROPERTY_URL, projectUrl);
+        Vector webpages = cm.getTopics(TOPICTYPE_WEBPAGE, webProps);
+        // check for URL !!!
+        if (webpages.size() &gt; 0) {
+            webpageTopic = as.getLiveTopic((BaseTopic)webpages.get(0));
+            //
+        } else {
+            webpageTopic = as.createLiveTopic(as.getNewTopicID(), TOPICTYPE_WEBPAGE, projectUrl, null);
+            as.setTopicProperty(webpageTopic.getID(), 1, PROPERTY_URL, projectUrl);
+            // as.setTopicProperty(webpageTopic.getID(), 1, PROPERTY_NAME, &quot;weitere Ehrenamt Projektinfos&quot;);
+        }
+        // check for person in cm
+        BaseTopic knownPerson = cm.getTopic(TOPICTYPE_PERSON, contactPerson, 1);
+        if (knownPerson != null) {
+            contactPersonTopic = as.getLiveTopic(knownPerson);
+        } else {
+            contactPersonTopic = as.createLiveTopic(as.getNewTopicID(), TOPICTYPE_PERSON, contactPerson, null);
+        }
+        // check for City Topic Berlin in cm
+        BaseTopic berlinTopic = cm.getTopic(TOPICTYPE_CITY, &quot;Berlin&quot;, 1);
+        if (berlinTopic != null) {
+            cityTopic = as.getLiveTopic(berlinTopic);
+        } else {
+            cityTopic = null;
+            System.out.println(&quot;[WARNING] EngagementJob is using Property \&quot;Stadt\&quot; at GeoObjectTopic instead of City Topic&quot;);
+            as.setTopicProperty(geoObjectTopic, PROPERTY_CITY, &quot;Berlin&quot;);
+        }
+        // BaseTopic knownMailbox = cm.getTopic(TOPICTYPE_EMAIL_ADDRESS, orgaContact, 1);
+        // check for address in cm just by streetname and housenumber ### !not yet by Postal Code
+        BaseTopic knownAddress = cm.getTopic(TOPICTYPE_ADDRESS, streetNr, 1);
+        // check for street in Adress !!
+        if (knownAddress != null) {
+            addressTopic = as.getLiveTopic(knownAddress);
+        } else {
+            addressTopic = as.createLiveTopic(as.getNewTopicID(), TOPICTYPE_ADDRESS, streetNr, null);
+        }
+        // add postalcode to address topic
+        as.setTopicProperty(addressTopic, PROPERTY_POSTAL_CODE, postcode);
+        as.setTopicProperty(addressTopic, PROPERTY_STREET, streetNr);
+        //
+        LiveAssociation toWebpage = as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), webpageTopic.getID(), null, null);
+        LiveAssociation toPerson = as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), contactPersonTopic.getID(), null, null);
+        LiveAssociation toAddress = as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), addressTopic.getID(), null, null);
+        if (as.getAssociation(addressTopic.getID(), ASSOCTYPE_ASSOCIATION, 2, TOPICTYPE_CITY, true, directives) == null) {
+            LiveAssociation toCity = as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, addressTopic.getID(), cityTopic.getID(), null, null);
+        }
+        // fetch GPS Data from GeoCoder
+        GeoObjectTopic geoObject = (GeoObjectTopic) geoObjectTopic;
+        geoObject.setGPSCoordinates(directives);
+        // bezirk label special move
+        if (bezirk.startsWith(&quot;Berlin-&quot;) || bezirk.startsWith(&quot;berlin-&quot;)) {
+            // slice a bit redundancy
+            bezirk = bezirk.substring(7);
+        }
+        // one to one
+        BaseTopic bezirkAlreadyKnown = cm.getTopic(TOPICTYPE_ENG_BEZIRK, bezirk, 1);
+        if (bezirkAlreadyKnown != null) {
+            // connect to known Bezirk
+            // System.out.println(&quot;&gt;&gt; reusing BezirkTopic \&quot;&quot;+bezirkAlreadyKnown.getName()+&quot;\&quot;&quot;);
+            as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), bezirkAlreadyKnown.getID(), null, null);
+        } else {
+            // new Bezirk and connect to
+            System.out.println(&quot;&gt;&gt; creating &quot;+as.getLiveTopic(TOPICTYPE_ENG_BEZIRK, 1).getName()+&quot;Topic \&quot;&quot;+bezirk+&quot;\&quot;&quot;);
+            LiveTopic bezirkTopic = as.createLiveTopic(as.getNewTopicID(), TOPICTYPE_ENG_BEZIRK, bezirk, null);
+            as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), bezirkTopic.getID(), null, null);
+        }
+        // one to many
+        for (int i = 0; i &lt; zielgruppen.size(); i++) {
+            String zielgruppenName = (String) zielgruppen.get(i);
+            BaseTopic knownZielgruppe = cm.getTopic(TOPICTYPE_ENG_ZIELGRUPPE, zielgruppenName, 1);
+            if (knownZielgruppe != null) {
+                // connect to known cat
+                // System.out.println(&quot;&gt;&gt; reusing ZielgruppenTopic \&quot;&quot;+catAlreadyKnown.getName()+&quot;\&quot;&quot;);
+                as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), knownZielgruppe.getID(), null, null);
+            } else {
+                System.out.println(&quot;&gt;&gt; creating &quot;+as.getLiveTopic(TOPICTYPE_ENG_ZIELGRUPPE, 1).getName()+&quot;Topic \&quot;&quot;+zielgruppenName+&quot;\&quot;&quot;);
+                LiveTopic newZielgruppe = as.createLiveTopic(as.getNewTopicID(), TOPICTYPE_ENG_ZIELGRUPPE, zielgruppenName, null);
+                as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), newZielgruppe.getID(), null, null);
+            }
+        }
+        // one to many
+        for (int i = 0; i &lt; taetigkeiten.size(); i++) {
+            String taetigkeitName = (String) taetigkeiten.get(i);
+            BaseTopic knownTaetigkeit = cm.getTopic(TOPICTYPE_ENG_TAETIGKEIT, taetigkeitName, 1);
+            if (knownTaetigkeit != null) {
+                // connect to known cat
+                // System.out.println(&quot;&gt;&gt; reusing ZielgruppenTopic \&quot;&quot;+catAlreadyKnown.getName()+&quot;\&quot;&quot;);
+                as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), knownTaetigkeit.getID(), null, null);
+            } else {
+                System.out.println(&quot;&gt;&gt; creating &quot;+as.getLiveTopic(TOPICTYPE_ENG_TAETIGKEIT, 1).getName()+&quot;Topic \&quot;&quot;+taetigkeitName+&quot;\&quot;&quot;);
+                LiveTopic newTaetigkeiten = as.createLiveTopic(as.getNewTopicID(), TOPICTYPE_ENG_TAETIGKEIT, taetigkeitName, null);
+                as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), newTaetigkeiten.getID(), null, null);
+            }
+        }
+        // one to many
+        for (int i = 0; i &lt; merkmale.size(); i++) {
+            String merkmalsName = (String) merkmale.get(i);
+            BaseTopic merkmalKnown = cm.getTopic(TOPICTYPE_ENG_MERKMAL, merkmalsName, 1);
+            if (merkmalKnown != null) {
+                // connect to known cat
+                // System.out.println(&quot;&gt;&gt; reusing ZielgruppenTopic \&quot;&quot;+catAlreadyKnown.getName()+&quot;\&quot;&quot;);
+                as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), merkmalKnown.getID(), null, null);
+            } else {
+                System.out.println(&quot;&gt;&gt; creating &quot;+as.getLiveTopic(TOPICTYPE_ENG_MERKMAL, 1).getName()+&quot;Topic \&quot;&quot;+merkmalsName+&quot;\&quot;&quot;);
+                LiveTopic newMerkmal = as.createLiveTopic(as.getNewTopicID(), TOPICTYPE_ENG_MERKMAL, merkmalsName, null);
+                as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), newMerkmal.getID(), null, null);
+            }
+        }
+        // one to many
+        for (int i = 0; i &lt; einsatzbereiche.size(); i++) {
+            String einsatzbereichsName = (String) einsatzbereiche.get(i);
+            BaseTopic knownEinsatzbereich = cm.getTopic(TOPICTYPE_ENG_EINSATZBEREICH, einsatzbereichsName, 1);
+            if (knownEinsatzbereich != null) {
+                // connect to known cat
+                // System.out.println(&quot;&gt;&gt; reusing ZielgruppenTopic \&quot;&quot;+catAlreadyKnown.getName()+&quot;\&quot;&quot;);
+                as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), knownEinsatzbereich.getID(), null, null);
+            } else {
+                System.out.println(&quot;&gt;&gt; creating &quot;+as.getLiveTopic(TOPICTYPE_ENG_EINSATZBEREICH, 1).getName()+&quot;Topic \&quot;&quot;+einsatzbereichsName+&quot;\&quot;&quot;);
+                LiveTopic newEinsatzbereich = as.createLiveTopic(as.getNewTopicID(), TOPICTYPE_ENG_EINSATZBEREICH, einsatzbereichsName, null);
+                as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), newEinsatzbereich.getID(), null, null);
+            }
+        }
+        return geoObjectTopic.getID();
+    }
+
+    private Vector readInCategories(String catSeperatedValue) {
+        Vector cats = new Vector();
+        while (catSeperatedValue.indexOf(&quot;;&quot;) != -1) {
+            int pointer = catSeperatedValue.indexOf(&quot;;&quot;);
+            String catName, restName = &quot;&quot;;
+            if (pointer != -1) {
+                catName = catSeperatedValue.substring(0, pointer);
+                restName = catSeperatedValue.substring(pointer + 1);
+                cats.add(catName);
+                //System.out.println(&quot;&gt;&gt; cat: &quot; + catName + &quot; rest: &quot; + restName);
+            }
+            catSeperatedValue = restName;
+        }
+        cats.add(catSeperatedValue);
+        // System.out.println(&quot;&gt;&gt; lastcat: &quot; + catSeperatedValue);
+        return cats;
+    }
+
+    private String sendGetRequest(String endpoint, String requestParameters) {
+        String result = null;
+        if (endpoint.startsWith(&quot;<A HREF="http://">http://</A>&quot;)) {
+            // Send a GET request to the servlet
+            try {
+                // Send data
+                String urlStr = endpoint;
+                if (requestParameters != null &amp;&amp; requestParameters.length() &gt; 0) {
+                    urlStr += &quot;?&quot; + requestParameters;
+                }
+                URL url = new URL(urlStr);
+                System.out.println(&quot;[EngagementJob] sending request to: &quot; + url.toURI().toURL().toString());
+                URLConnection conn = url.openConnection();
+                // Get the response
+                // BufferedReader rd = new BufferedReader(new InputStreamReader(conn.getInputStream(), &quot;ISO-8859-1&quot;));
+                BufferedReader rd = new BufferedReader(new InputStreamReader(conn.getInputStream(), &quot;UTF-8&quot;));
+                StringBuffer sb = new StringBuffer();
+                String line;
+                while ((line = rd.readLine()) != null) {
+                    sb.append(line);
+                }
+                rd.close();
+                result = sb.toString();
+                DocumentBuilderFactory docBuilderFactory = DocumentBuilderFactory.newInstance();
+                DocumentBuilder docBuilder = docBuilderFactory.newDocumentBuilder();
+                Document doc = docBuilder.parse(new InputSource(new StringReader(result)));
+                System.out.println(&quot;[EngagementJob] finished loading and parsing data from &quot; + url);
+            } catch(UnknownHostException uke) {
+                System.out.println(&quot;*** EngagementJob Thread could not load the xml data to import from &quot; + endpoint + &quot; message is: &quot; + uke.getMessage());
+                return null;
+                // done();
+            } catch (SAXParseException saxp) {
+                System.out.println (&quot;** Parsing error&quot; + &quot;, line &quot;
+                    + saxp.getLineNumber () + &quot;, column &quot; + saxp.getColumnNumber() + &quot;, message: &quot; + saxp.getMessage());
+                System.out.println(&quot;** dataValue: &quot; +result.substring(saxp.getColumnNumber()-100, saxp.getColumnNumber()+100));
+                System.out.println(&quot;*** EngagementJob is skipping the import for today!&quot;);
+                return null;
+            } catch (Exception ex) {
+                System.out.println(&quot;*** EngagementJob has encountered the following problem: &quot; + ex.getMessage());
+                return null;
+            }
+        }
+        return result;
+    }
+
+    private Vector getGeoObjectInformation(String workspaceId) {
+        BaseTopic geoType = getWorkspaceGeoType(workspaceId);
+        if (geoType == null) {
+            System.out.println(&quot;&gt;&gt; Workspace (&quot;+workspaceId+&quot;) is not configured properly&quot;);
+            return new Vector();
+        }
+        return cm.getTopics(geoType.getID());
+    }
+
+    // --- copy of BrowseServlet
+
+    private void sendNotificationEmail(Vector unusableProjects) {
+      try {
+        // GeoObjectTopic inst = (GeoObjectTopic) as.getLiveTopic(instID, 1);
+        // &quot;from&quot;
+        String from = as.getEmailAddress(&quot;t-rootuser&quot;);		// ###
+        if (from == null || from.equals(&quot;&quot;)) {
+          throw new DeepaMehtaException(&quot;email address of root user is unknown&quot;);
+        }
+        // &quot;to&quot;
+        String to = &quot;<A HREF="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">mre at newthinking.de</A>&quot;;
+        // &quot;subject&quot;
+        String subject = &quot;Ehrenamtsatlas: folgende Projekte haben einen fehlerhaften Addresseintrag&quot;;
+        StringBuffer entries = new StringBuffer();
+        entries.append(&quot;------------------------------\r&quot;);
+        for (int i = 0; i &lt; unusableProjects.size(); i++) {
+            GeoObjectTopic entry = (GeoObjectTopic) unusableProjects.get(i);
+            if (!entry.getAddress().getName().equals(&quot;&#252;ber Gute-Tat.de&quot;)) {
+              entries.append(&quot;Projekt: &quot;);
+              entries.append(entry.getName());
+              entries.append(&quot; mit Adresseintrag: &quot;);
+              entries.append(entry.getAddress().getName());
+              entries.append(&quot;\r&quot;);
+            }
+        }
+        entries.append(&quot;------------------------------\r&quot;);
+        // &quot;body&quot;
+        String body = &quot;Dies ist eine automatische Benachrichtigung erstellt von www.kiezatlas.de\r\r&quot; +
+          &quot;Folgende Ehrenamtsprojekte konnten aufgrund eines fehlerhaften Adresseintrags nicht korrekt verortet werden:\r\r&quot; +
+          &quot;&quot; + entries.toString() + &quot;\r&quot; +
+          &quot;www.berlin.de/buergeraktiv/atlas\r\r&quot; +
+          &quot;Mit freundlichen Gr&#252;&#223;en\r&quot; +
+          &quot;ihr Kiezatlas-Team&quot;;
+        //
+        System.out.println(&quot;&gt;&gt;&gt; send notification email&quot;);
+        System.out.println(&quot;  &gt; SMTP server: \&quot;&quot; + as.getSMTPServer() + &quot;\&quot;&quot;);	// as.getSMTPServer() throws DME
+        System.out.println(&quot;  &gt; from: \&quot;&quot; + from + &quot;\&quot;&quot;);
+        System.out.println(&quot;  &gt; to: \&quot;&quot; + to + &quot;\&quot;&quot;);
+        // send email
+        EmailTopic.sendMail(as.getSMTPServer(), from, to, subject, body);		// EmailTopic.sendMail() throws DME
+      } catch (Exception e) {
+        System.out.println(&quot;*** notification email not send (&quot; + e + &quot;)&quot;);
+      }
+    }
+
+
+
+    /**
+     * returns null if no topictype whihc is assigned to the given workspace,
+     * is a subtype of &quot;GeoObjectTopic&quot;
+     *
+     * @param workspaceId
+     * @return
+     */
+    private BaseTopic getWorkspaceGeoType(String workspaceId) {
+        //
+        TypeTopic geotype = as.type(TOPICTYPE_KIEZ_GEO, 1);
+        Vector subtypes = geotype.getSubtypeIDs();
+        Vector workspacetypes = as.getRelatedTopics(workspaceId, ASSOCTYPE_USES, 2);
+        int i;
+        for (i = 0; i &lt; workspacetypes.size(); i++) {
+            BaseTopic topic = (BaseTopic) workspacetypes.get(i);
+            int a;
+            for (a = 0; a &lt; subtypes.size(); a++) {
+                // System.out.println(&quot; counter: &quot; + a);
+                String derivedOne = (String) subtypes.get(a);
+                // System.out.println(&quot;    &quot; + derivedOne.getID() + &quot;:&quot; + derivedOne.getName());
+                if (derivedOne.equals(topic.getID())) {
+                    // System.out.println(&quot; found geoType &quot; + topic.getID() + &quot;:&quot; + topic.getName());
+                    return topic;
+                }
+            }
+        }
+        return null;
+    }
+
+}
\ No newline at end of file

Added: trunk/src/de/kiezatlas/deepamehta/TimedEventImporter.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/TimedEventImporter.java	                        (rev 0)
+++ trunk/src/de/kiezatlas/deepamehta/TimedEventImporter.java	2011-02-09 11:26:16 UTC (rev 99)
@@ -0,0 +1,588 @@
+package de.kiezatlas.deepamehta;
+
+import de.deepamehta.BaseTopic;
+import de.deepamehta.DeepaMehtaConstants;
+import de.deepamehta.DeepaMehtaException;
+import de.deepamehta.assocs.LiveAssociation;
+import de.deepamehta.service.ApplicationService;
+import de.deepamehta.service.CorporateDirectives;
+import de.deepamehta.service.CorporateMemory;
+import de.deepamehta.topics.EmailTopic;
+import de.deepamehta.topics.LiveTopic;
+import de.deepamehta.topics.TypeTopic;
+import de.deepamehta.util.DeepaMehtaUtils;
+import de.kiezatlas.deepamehta.topics.GeoObjectTopic;
+import java.io.BufferedReader;
+import java.io.InputStreamReader;
+import java.io.StringReader;
+import java.net.URL;
+import java.net.URLConnection;
+import java.net.UnknownHostException;
+import java.util.Hashtable;
+import java.util.Vector;
+import javax.xml.parsers.DocumentBuilder;
+import javax.xml.parsers.DocumentBuilderFactory;
+import org.w3c.dom.Document;
+import org.w3c.dom.Node;
+import org.w3c.dom.NodeList;
+import org.xml.sax.InputSource;
+import org.xml.sax.SAXException;
+import org.xml.sax.SAXParseException;
+
+import org.quartz.Job;
+import org.quartz.JobExecutionContext;
+import org.quartz.JobExecutionException;
+
+/**
+ * Event Calendar Schnittstelle 1.0
+ * is a thread based worker which imports single projects and all occuring criterias resp. categories
+ * from an xml interface into one kiezatlas workspace - it reuses topics (e.g. addresstopics) known to
+ * the cm (by name), triggers a geolocation on each project with nice address
+ *
+ * @author Malte Rei&#223;ig (<A HREF="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">mre at deepamehta.de</A>)
+ */
+public class TimedEventImporter implements Job, DeepaMehtaConstants, KiezAtlas {
+
+    private ApplicationService as = null;
+    private CorporateMemory cm = null;
+    private CorporateDirectives directives = null;
+
+    private String workspaceId = &quot;&quot;;
+    private String cityMapId = &quot;&quot;;
+    private String serviceUrl = &quot;&quot;;
+    // settings
+    private String contentReportRecipient = &quot;&quot;;
+    private String serviceReportRecipient = &quot;&quot;;
+    private String iconCatMap = &quot;&quot;; // remains empty for event importer
+    // 
+    // to be imported Event TopicTypes
+    static final String TOPICTYPE_EVT_EVENT = &quot;t-453276&quot;;
+    static final String TOPICTYPE_EVT_BEZIRK = &quot;t-453278&quot;;
+    static final String TOPICTYPE_EVT_KATEGORIE = &quot;t-453280&quot;;
+
+    public TimedEventImporter () {
+      as = (ApplicationService) TimerJobParameterHolder.getInstance().getParameters().get(&quot;as&quot;);
+      cm = (CorporateMemory) TimerJobParameterHolder.getInstance().getParameters().get(&quot;cm&quot;);
+      directives = (CorporateDirectives) TimerJobParameterHolder.getInstance().getParameters().get(&quot;directives&quot;);
+      workspaceId = (String) TimerJobParameterHolder.getInstance().getParameters().get(&quot;eventWorkspaceId&quot;);
+      cityMapId = (String) TimerJobParameterHolder.getInstance().getParameters().get(&quot;eventCityMapId&quot;);
+      serviceUrl = (String) TimerJobParameterHolder.getInstance().getParameters().get(&quot;eventServiceUrl&quot;);
+    }
+
+    public void execute(JobExecutionContext context) throws JobExecutionException {
+      System.out.println(&quot;[EventJob] was kicked off for workspace \&quot;&quot; + workspaceId + &quot;\&quot; at &quot;
+              + DeepaMehtaUtils.getTime().toString());
+      BaseTopic settings = null; //getImporterSettingsTopic();
+      if (settings != null) {
+        contentReportRecipient = as.getTopicProperty(settings, PROPERTY_IMPORT_CONTENT_REPORT);
+        serviceReportRecipient = as.getTopicProperty(settings, PROPERTY_IMPORT_SERVICE_REPORT);
+        iconCatMap = as.getTopicProperty(settings, PROPERTY_ICONS_MAP);
+        System.out.println(&quot;[EventJob] set to run for \&quot;&quot; + contentReportRecipient + &quot;\&quot; &quot; +
+                &quot;errors are reported to &quot; + serviceReportRecipient + &quot; iconsMap available ? &quot;
+                + (iconCatMap.length() &gt; 0));
+      } else { System.out.println(&quot;[EventJob] ERROR while loading settings for workspace &quot; + workspaceId); }
+      // work here
+      String ehrenamtXml = sendGetRequest(serviceUrl, &quot;&quot;);
+      if (ehrenamtXml != null) {
+        System.out.println(&quot;[EventJob] loaded data.. but is doing nothing for now.. &quot; + cityMapId);
+        // delete former import
+        // clearCriterias();
+        // clears workspace if new topics are available
+        // clearImport();
+        // store and publish new topics
+        // Vector topicIds = parseAndStoreData(ehrenamtXml);
+        //
+        // publishData(topicIds);
+      }
+    }
+
+    // --
+    // --- Utilities
+    // --
+
+
+    private BaseTopic getImporterSettingsTopic() {
+        Vector workspaces = as.getRelatedTopics(workspaceId, ASSOCTYPE_ASSOCIATION, TOPICTYPE_IMPORTER_SETTINGS, 1);
+        if (workspaces.size() &gt;= 1) {
+          BaseTopic settings = (BaseTopic) workspaces.get(0);
+          return settings;
+        }
+        return null;
+    }
+
+    private void publishData(Vector topicIds) {
+        System.out.println(&quot;[EventJob] is starting to gather coordinates and publish \&quot;&quot;+topicIds.size()+&quot;\&quot; topics into : &quot; + cm.getTopic(cityMapId, 1).getName());// + &quot; &quot; +
+        Vector unusable = new Vector(); // collection of GeoObjects with GPS Data
+        for (int i = 0; i &lt; topicIds.size(); i++) {
+            GeoObjectTopic baseTopic = (GeoObjectTopic) as.getLiveTopic(((String)topicIds.get(i)), 1);
+            // System.out.println(&quot;[GPSINFO] is LAT: &quot; + as.getTopicProperty(baseTopic, PROPERTY_GPS_LAT) + &quot; LON: &quot; + as.getTopicProperty(baseTopic, PROPERTY_GPS_LONG));
+            BaseTopic addressTopic = baseTopic.getAddress();
+            if (as.getTopicProperty(baseTopic.getID(), 1, PROPERTY_GPS_LAT).equals(&quot;&quot;)) {
+                System.out.println(&quot;[EventJob] WARNING ***  \&quot;&quot;+addressTopic.getName()+&quot;\&quot; is without GPS Data... dropping placement in CityMap&quot;);
+                // ###TODO: Report Functionality
+                unusable.add(baseTopic); //
+            } else if (as.getTopicProperty(addressTopic, PROPERTY_STREET).equals(&quot;&#252;ber Gute-Tat.de&quot;)) {
+                unusable.add(baseTopic);
+            } else {
+                // System.out.println(&quot;&gt;&gt;&gt;&gt; creating ViewTopic for &quot; + baseTopic.getName() + &quot; (&quot; + baseTopic.getID() + &quot;)&quot; );
+                as.createViewTopic(cityMapId, 1, null, baseTopic.getID(), 1, 0, 0, false);
+            }
+            // System.out.println(&quot;&gt;&gt;&gt; ready to publish geoObject &quot; +baseTopic.getName()+&quot; (&quot;+baseTopic.getID()+&quot;)&quot;);
+        }
+        int validEntries = topicIds.size() - unusable.size();
+        //
+        System.out.println(&quot;[EventJob] stored &quot; + validEntries + &quot; in public cityMap \&quot;&quot; +as.getTopicProperty(cityMapId, 1, PROPERTY_WEB_ALIAS)+ &quot;\&quot;&quot;);
+        System.out.println(&quot;[EventJob] didn`t stored &quot; + unusable.size() + &quot; in public cityMapId \&quot;&quot;+getWorkspaceGeoType(workspaceId).getName()+&quot;e\&quot; cause they were unlocatable&quot;);
+        sendNotificationEmail(unusable);
+        //
+    }
+
+    /** remove criteria system from configured workspace */
+    private void clearCriterias() {
+        Vector bezirke = cm.getTopics(TOPICTYPE_EVT_BEZIRK);
+        Vector einsatzbereiche = cm.getTopics(TOPICTYPE_EVT_KATEGORIE);
+        bezirke.addAll(einsatzbereiche);
+        //
+        for (int i = 0; i &lt; bezirke.size(); i++) {
+            BaseTopic category = (BaseTopic) bezirke.get(i);
+            CorporateDirectives newDirectives = as.deleteTopic(category.getID(), 1);
+            newDirectives.updateCorporateMemory(as, null, null, null);
+        }
+    }
+
+    /** completely remove all topics created by the last import
+     *  e.g. delete from topicmap, delete related address topic, delete email topic,
+     *  delete person topic, delete webpage topic, delete webpage topic if not used by any other topic ...
+     */
+    private void clearImport() {
+        /** import data is, date of last import, complete or not complete, error objects */
+        Vector allGeoObjects = cm.getTopics(getWorkspaceGeoType(workspaceId).getID());
+        Vector allRelatedTopics = new Vector();
+        System.out.println(&quot;[EventJob] cleaning up (&quot;+getWorkspaceGeoType(workspaceId).getName()+&quot;). In number--- (&quot; +allGeoObjects.size()+ &quot;)&quot;);
+        for (int i = 0; i &lt; allGeoObjects.size(); i++) {
+            BaseTopic baseTopic = (BaseTopic) allGeoObjects.get(i);
+            Vector relatedTopics = as.getRelatedTopics(baseTopic.getID(), ASSOCTYPE_ASSOCIATION, 2);
+            for (int j = 0; j &lt; relatedTopics.size(); j++) {
+                BaseTopic relatedTopic = (BaseTopic) relatedTopics.get(j);
+                if (relatedTopic.getType().equals(TOPICTYPE_EVT_BEZIRK) ||
+                        relatedTopic.getType().equals(TOPICTYPE_EVT_KATEGORIE)) {
+                    //
+                } else {
+                    // store topicID in Vector for later removal
+                    allRelatedTopics.add(relatedTopic);
+                }
+            }
+            directiveDeletion(baseTopic.getID());
+            //
+        }
+        //
+        System.out.println(&quot;[EventJob] is starting to delete &quot;+allRelatedTopics.size()+&quot; relatedTopics (just if one entry has no associations)---&quot;);
+        for (int k = 0; k &lt; allRelatedTopics.size(); k++) {
+            BaseTopic relTopic = (BaseTopic) allRelatedTopics.get(k);
+            //
+            if (cm.getAssociationIDs(relTopic.getID(), 1).size() &gt; 0) {
+               // System.out.println(&quot;&gt;&gt;&gt; relTopic (&quot;+relTopic.getID()+&quot;) \&quot;&quot;+relTopic.getName()+&quot;\&quot; not to delete, has &quot;+cm.getAssociationIDs(relTopic.getID(), 1).size()+&quot; other associations&quot;);
+            } else {
+               directiveDeletion(relTopic.getID());
+            }
+        }
+    }
+
+    /** performs a clear deletion of a topic with all it`s associations and it`s removal from all maps*/
+    private void directiveDeletion(String topicID) {
+		// CorporateDirectives myDirective = as.deleteTopic(topicID, 1);	// ### version=1
+        try {
+            LiveTopic topic = as.getLiveTopic(topicID, 1);
+            if (topic != null) {
+                // topic.del
+                CorporateDirectives newDirectives = as.deleteTopic(topic.getID(), 1);	// ### version=1
+                newDirectives.updateCorporateMemory(as, null, null, null);
+            }
+        } catch (DeepaMehtaException dex) {
+            // yeah, it`s not known to CM..
+        }
+	}
+
+    /**
+       * just reads in THE xml String from berlin.de and saves every single event into the kiezatlas cm
+     *
+     * @param xmlData
+     * @return
+     */
+    private Vector parseAndStoreData(String xmlData) {
+    Vector topicIds = new Vector();
+    try {
+
+        DocumentBuilderFactory docBuilderFactory = DocumentBuilderFactory.newInstance();
+        DocumentBuilder docBuilder = docBuilderFactory.newDocumentBuilder();
+        Document doc = docBuilder.parse(new InputSource(new StringReader(xmlData)));
+
+        // normalize text representation..
+        doc.getDocumentElement().normalize();
+        //
+        NodeList listOfProjects = doc.getElementsByTagName(&quot;project&quot;);
+        int amountOfProjects = listOfProjects.getLength();
+        System.out.println(&quot;&quot;);
+        System.out.println(&quot; --- Import started at &quot;+DeepaMehtaUtils.getTime() +&quot; for a total no of &quot; + amountOfProjects + &quot; &quot; + getWorkspaceGeoType(workspaceId).getName());
+        // for(int s = 0; s &lt; listOfProjects.getLength(); s++){
+        System.out.println(&quot; -- &quot;);
+        System.out.println(&quot;&quot;);
+        Vector misspelledObjects = new Vector();
+        // iterate over projects
+        for(int p = 0; p &lt; amountOfProjects; p++) {
+            // fields of each project
+            String projectName = &quot;&quot;, eventDescription = &quot;&quot;, originId = &quot;&quot;, contactPerson = &quot;&quot;, projectUrl = &quot;&quot;, postcode = &quot;&quot;, streetNr = &quot;&quot;, bezirk = &quot;&quot;, orgaName = &quot;&quot;,
+                    orgaWebsite = &quot;&quot;, orgaContact = &quot;&quot;, timeStamp = &quot;&quot;;
+            Vector zielgruppen = new Vector();
+            NodeList projectDetail = listOfProjects.item(p).getChildNodes();
+            // System.out.println(&quot;&gt;&gt; projectDetail has childs in number : &quot; + projectDetail.getLength());
+            for (int i = 0; i &lt; projectDetail.getLength(); i++) {
+                Node node = projectDetail.item(i);
+                // System.out.println(&quot;&gt;&gt;&gt; node is &quot; + node.getNodeName() + &quot; : &quot; + node.getNodeValue() + &quot; (&quot; + node.getNodeType()+&quot;)&quot;);
+                if (node.hasChildNodes()) {
+                    NodeList details = node.getChildNodes();
+                    for (int j = 0; j &lt; details.getLength(); j++) {
+                        Node detailNode = details.item(j);
+                        if (detailNode.hasChildNodes()) {
+                            // System.out.println(&quot;&gt;&gt;&gt;&gt; &quot;+detailNode.getNodeName()+&quot; is &quot;);
+                            for(int k = 0; k &lt; detailNode.getChildNodes().getLength(); k++) {
+                                Node contentNode = detailNode.getChildNodes().item(k);
+                                if (contentNode.hasChildNodes()) {
+                                    // process deep project info, such as categories
+                                    for (int l = 0; l &lt; contentNode.getChildNodes().getLength(); l++) {
+                                        Node anotherNode = contentNode.getChildNodes().item(l);
+                                        if (contentNode.getNodeName().equals(&quot;contact&quot;)) {
+                                            // it`s THE contact person
+                                            contactPerson = anotherNode.getNodeValue();
+                                            // System.out.println(&quot;&gt; ansprechpartner: &quot; + anotherNode.getNodeValue());
+                                        } else if (contentNode.getNodeName().equals(&quot;adress&quot;)) {
+                                            // it`s THE point of interest
+                                            streetNr = anotherNode.getNodeValue();
+                                            // System.out.println(&quot;&gt; anlaufstelle: &quot; + anotherNode.getNodeValue());
+                                        } else if (contentNode.getNodeName().equals(&quot;postcode&quot;)) {
+                                            // it`s THE code of interest
+                                            postcode = anotherNode.getNodeValue();
+                                            // System.out.println(&quot;&gt; plz: &quot; + anotherNode.getNodeValue());
+                                        } else if (contentNode.getNodeName().equals(&quot;location&quot;)) {
+                                            // it`s THE category \&quot;Bezirk\&quot;
+                                            bezirk = anotherNode.getNodeValue();
+                                            // bezirk
+                                            // System.out.println(&quot;&gt; bezirk: &quot; + bezirk);
+                                        } else if (contentNode.getNodeName().equals(&quot;zielgruppen&quot;)) {
+                                            // these are target groups for this project
+                                            // System.out.println(&quot;&gt; zielgruppen: &quot;); // + anotherNode.getNodeValue());
+                                            zielgruppen = readInCategories(anotherNode.getNodeValue());
+                                        } else {
+                                            System.out.println(&quot;*** EventJob found unknown category for a POI while importing from ehrenamt.&quot;);
+                                        }
+                                    }
+                                } else {
+                                    // check for other interesting data such as
+                                    //
+                                    if(detailNode.getNodeName().equals(&quot;created&quot;)) {
+                                        // System.out.println(&quot;&gt; timestamp is : &quot; + contentNode.getNodeValue());
+                                        timeStamp = contentNode.getNodeValue();
+                                    } else if (detailNode.getNodeName().equals(&quot;projectname&quot;)) {
+                                        // System.out.println(&quot;- Name is \&quot; &quot; + contentNode.getNodeValue() + &quot;\&quot;&quot;);
+                                        projectName = contentNode.getNodeValue();
+                                    } else if (detailNode.getNodeName().equals(&quot;projectdescr&quot;)) {
+                                        // System.out.println(&quot;- Name is \&quot; &quot; + contentNode.getNodeValue() + &quot;\&quot;&quot;);
+                                        eventDescription = contentNode.getNodeValue();
+                                    } else if (detailNode.getNodeName().equals(&quot;projecturl&quot;)) {
+                                        // obsolete ? all needed infos should be right here..
+                                        projectUrl = contentNode.getNodeValue();
+                                        // System.out.println(&quot;&gt;website at : &quot; + contentNode.getNodeValue());
+                                    } else if (detailNode.getNodeName().equals(&quot;organisationname&quot;)) {
+                                        // System.out.println(&quot;&gt;organ. is : &quot; + contentNode.getNodeValue());
+                                        orgaName = contentNode.getNodeValue();
+                                    } else if (detailNode.getNodeName().equals(&quot;contact&quot;)) {
+                                        // System.out.println(&quot;&gt;contactperson is : &quot; + contentNode.getNodeValue());
+                                        orgaContact = contentNode.getNodeValue();
+                                    } else if (detailNode.getNodeName().equals(&quot;url&quot;)) {
+                                        // System.out.println(&quot;&gt;projectpage at : &quot; + contentNode.getNodeValue());
+                                        orgaWebsite = contentNode.getNodeValue();
+                                    } else if (detailNode.getNodeName().equals(&quot;id&quot;)) {
+                                        // System.out.println(&quot;&gt;projectpage at : &quot; + contentNode.getNodeValue());
+                                        originId = contentNode.getNodeValue();
+                                    }
+                                    //System.out.println(&quot;data is: &quot; + contentNode.getNodeValue());
+                                }
+                            }
+                        }
+                    }
+                }
+            }
+            // projectData was gathered
+            // store information per project now
+            String topicID = saveProjectData(originId, projectName, eventDescription, contactPerson, projectUrl, postcode, streetNr, bezirk,
+                        orgaName, orgaWebsite, orgaContact, timeStamp, zielgruppen);
+            topicIds.add(topicID);
+        }//end of for loop with p for projects
+        System.out.println(&quot;[EventJob] stored data at &quot;+DeepaMehtaUtils.getTime() +&quot; for a total no of &quot; + amountOfProjects + &quot; &quot; + getWorkspaceGeoType(workspaceId).getName());
+    } catch (SAXParseException err) {
+           System.out.println (&quot;** Parsing error&quot; + &quot;, line &quot;
+             + err.getLineNumber () + &quot;, column &quot; + err.getColumnNumber() + &quot;, message: &quot; + err.getMessage());
+    } catch (SAXException e) {
+        Exception x = e.getException ();
+        ((x == null) ? e : x).printStackTrace ();
+
+    } catch (Throwable t) {
+        t.printStackTrace ();
+    }
+    //System.exit (0);
+    return topicIds;
+    }
+
+    /**
+     *  save one item &quot;Event&quot; into the corporate memory with
+     *  reusing existing addresses, webpages and persons
+     *  building up the categorySystem by each item which is in some categories
+     */
+    private String saveProjectData(String originId, String eventName, String eventDescr, String contactPerson, String projectUrl, String postcode, String streetNr, String bezirk, String orgaName,
+            String orgaWebsite, String orgaContact, String timeStamp, Vector zielgruppen) {
+        String topicId = &quot;&quot;;
+        String address = streetNr + &quot;, &quot; + postcode + &quot; &quot; + bezirk;
+        // storing data in corporate memory
+        String geoTypeId = getWorkspaceGeoType(workspaceId).getID();
+        LiveTopic geoObjectTopic = as.createLiveTopic(as.getNewTopicID(), geoTypeId, eventName, null);
+        //
+        as.setTopicProperty(geoObjectTopic, PROPERTY_NAME, eventName);
+        String descr = &quot;&quot;;
+        if (eventDescr.length() &gt; 256) { descr = eventDescr.substring(0, 256) + &quot; ...&quot;; } else { descr = eventDescr; }
+        as.setTopicProperty(geoObjectTopic, PROPERTY_EVENT_DESCRIPTION, descr);
+        as.setTopicProperty(geoObjectTopic, PROPERTY_PROJECT_ORGANISATION, orgaName);
+        as.setTopicProperty(geoObjectTopic, PROPERTY_PROJECT_ORIGIN_ID, originId);
+        as.setTopicProperty(geoObjectTopic, PROPERTY_EVENT_TIME, timeStamp);
+        as.setTopicProperty(geoObjectTopic, PROPERTY_LOCKED_GEOMETRY, &quot;off&quot;);
+        //
+        LiveTopic webpageTopic;
+        LiveTopic contactPersonTopic;
+        LiveTopic addressTopic;
+        LiveTopic cityTopic;
+        // LiveTopic mailTopic;
+        // check for webpage in cm
+        Hashtable webProps = new Hashtable();
+        webProps.put(PROPERTY_URL, projectUrl);
+        Vector webpages = cm.getTopics(TOPICTYPE_WEBPAGE, webProps);
+        // check for URL !!!
+        if (webpages.size() &gt; 0) {
+            webpageTopic = as.getLiveTopic((BaseTopic)webpages.get(0));
+            //
+        } else {
+            webpageTopic = as.createLiveTopic(as.getNewTopicID(), TOPICTYPE_WEBPAGE, projectUrl, null);
+            as.setTopicProperty(webpageTopic.getID(), 1, PROPERTY_URL, projectUrl);
+            // as.setTopicProperty(webpageTopic.getID(), 1, PROPERTY_NAME, &quot;weitere Ehrenamt Projektinfos&quot;);
+        }
+        // check for person in cm
+        BaseTopic knownPerson = cm.getTopic(TOPICTYPE_PERSON, contactPerson, 1);
+        if (knownPerson != null) {
+            contactPersonTopic = as.getLiveTopic(knownPerson);
+        } else {
+            contactPersonTopic = as.createLiveTopic(as.getNewTopicID(), TOPICTYPE_PERSON, contactPerson, null);
+        }
+        // check for City Topic Berlin in cm
+        BaseTopic berlinTopic = cm.getTopic(TOPICTYPE_CITY, &quot;Berlin&quot;, 1);
+        if (berlinTopic != null) {
+            cityTopic = as.getLiveTopic(berlinTopic);
+        } else {
+            cityTopic = null;
+            System.out.println(&quot;[WARNING] EventJob is using Property \&quot;Stadt\&quot; at GeoObjectTopic instead of City Topic&quot;);
+            as.setTopicProperty(geoObjectTopic, PROPERTY_CITY, &quot;Berlin&quot;);
+        }
+        // BaseTopic knownMailbox = cm.getTopic(TOPICTYPE_EMAIL_ADDRESS, orgaContact, 1);
+        // check for address in cm
+        BaseTopic knownAddress = cm.getTopic(TOPICTYPE_ADDRESS, streetNr, 1);
+        // check for street in Adress !!
+        if (knownAddress != null) {
+            addressTopic = as.getLiveTopic(knownAddress);
+        } else {
+            addressTopic = as.createLiveTopic(as.getNewTopicID(), TOPICTYPE_ADDRESS, streetNr, null);
+            System.out.println(&quot;&gt;&gt;&gt; created new Address for &quot; + streetNr);
+        }
+        // add postalcode to address topic
+        as.setTopicProperty(addressTopic, PROPERTY_POSTAL_CODE, postcode);
+        as.setTopicProperty(addressTopic, PROPERTY_STREET, streetNr);
+        //
+        LiveAssociation toWebpage = as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), webpageTopic.getID(), null, null);
+        LiveAssociation toPerson = as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), contactPersonTopic.getID(), null, null);
+        LiveAssociation toAddress = as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), addressTopic.getID(), null, null);
+        if (as.getAssociation(addressTopic.getID(), ASSOCTYPE_ASSOCIATION, 2, TOPICTYPE_CITY, true, directives) == null) {
+            LiveAssociation toCity = as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, addressTopic.getID(), cityTopic.getID(), null, null);
+        }
+        // fetch GPS Data from GeoCoder
+        GeoObjectTopic geoObject = (GeoObjectTopic) geoObjectTopic;
+        // ### fixme: if address is just &quot;Berlin&quot; which seems to be happening, then G. has a coordinate for that spot !!!
+        geoObject.setGPSCoordinates(directives);
+        // bezirk label special move
+        if (bezirk.startsWith(&quot;Berlin-&quot;) || bezirk.startsWith(&quot;berlin-&quot;)) {
+            // slice a bit redundancy
+            bezirk = bezirk.substring(7);
+        }
+        // one to one
+        BaseTopic bezirkAlreadyKnown = cm.getTopic(TOPICTYPE_EVT_BEZIRK, bezirk, 1);
+        if (bezirkAlreadyKnown != null) {
+            // connect to known Bezirk
+            // System.out.println(&quot;&gt;&gt; reusing BezirkTopic \&quot;&quot;+bezirkAlreadyKnown.getName()+&quot;\&quot;&quot;);
+            as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), bezirkAlreadyKnown.getID(), null, null);
+        } else {
+            // new Bezirk and connect to
+            System.out.println(&quot;&gt;&gt; creating &quot;+as.getLiveTopic(TOPICTYPE_EVT_BEZIRK, 1).getName()+&quot; Topic \&quot;&quot;+bezirk+&quot;\&quot;&quot;);
+            LiveTopic bezirkTopic = as.createLiveTopic(as.getNewTopicID(), TOPICTYPE_EVT_BEZIRK, bezirk, null);
+            as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), bezirkTopic.getID(), null, null);
+        }
+        // one to many
+        for (int i = 0; i &lt; zielgruppen.size(); i++) {
+            String zielgruppenName = (String) zielgruppen.get(i);
+            BaseTopic knownZielgruppe = cm.getTopic(TOPICTYPE_EVT_KATEGORIE, zielgruppenName, 1);
+            if (knownZielgruppe != null) {
+                // connect to known cat
+                // System.out.println(&quot;&gt;&gt; reusing ZielgruppenTopic \&quot;&quot;+knownZielgruppe.getName()+&quot;\&quot;&quot;);
+                as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), knownZielgruppe.getID(), null, null);
+            } else {
+                System.out.println(&quot;&gt;&gt; creating &quot;+as.getLiveTopic(TOPICTYPE_EVT_KATEGORIE, 1).getName()+&quot;Topic \&quot;&quot;+zielgruppenName+&quot;\&quot;&quot;);
+                LiveTopic newZielgruppe = as.createLiveTopic(as.getNewTopicID(), TOPICTYPE_EVT_KATEGORIE, zielgruppenName, null);
+                as.createLiveAssociation(as.getNewAssociationID(), ASSOCTYPE_ASSOCIATION, geoObjectTopic.getID(), newZielgruppe.getID(), null, null);
+            }
+        }
+        return geoObjectTopic.getID();
+    }
+
+    private Vector readInCategories(String catSeperatedValue) {
+        Vector cats = new Vector();
+        while (catSeperatedValue.indexOf(&quot;;&quot;) != -1) {
+            int pointer = catSeperatedValue.indexOf(&quot;;&quot;);
+            String catName, restName = &quot;&quot;;
+            if (pointer != -1) {
+                catName = catSeperatedValue.substring(0, pointer);
+                restName = catSeperatedValue.substring(pointer + 1);
+                cats.add(catName);
+                //System.out.println(&quot;&gt;&gt; cat: &quot; + catName + &quot; rest: &quot; + restName);
+            }
+            catSeperatedValue = restName;
+        }
+        cats.add(catSeperatedValue);
+        // System.out.println(&quot;&gt;&gt; lastcat: &quot; + catSeperatedValue);
+        return cats;
+    }
+
+    private String sendGetRequest(String endpoint, String requestParameters) {
+        String result = null;
+        if (endpoint.startsWith(&quot;<A HREF="http://">http://</A>&quot;)) {
+            // Send a GET request to the servlet
+            try {
+                // Send data
+                String urlStr = endpoint;
+                if (requestParameters != null &amp;&amp; requestParameters.length() &gt; 0) {
+                    urlStr += &quot;?&quot; + requestParameters;
+                }
+                URL url = new URL(urlStr);
+                System.out.println(&quot;[EventJob] sending request to: &quot; + url.toURI().toURL().toString());
+                URLConnection conn = url.openConnection();
+                // Get the response
+                // BufferedReader rd = new BufferedReader(new InputStreamReader(conn.getInputStream(), &quot;ISO-8859-1&quot;));
+                BufferedReader rd = new BufferedReader(new InputStreamReader(conn.getInputStream(), &quot;UTF-8&quot;));
+                StringBuffer sb = new StringBuffer();
+                String line;
+                while ((line = rd.readLine()) != null) {
+                    sb.append(line);
+                }
+                rd.close();
+                result = sb.toString();
+                System.out.println(&quot;[EventJob] finished loading data from &quot; + url);
+                DocumentBuilderFactory docBuilderFactory = DocumentBuilderFactory.newInstance();
+                DocumentBuilder docBuilder = docBuilderFactory.newDocumentBuilder();
+                Document doc = docBuilder.parse(new InputSource(new StringReader(result)));
+            } catch(UnknownHostException uke) {
+                System.out.println(&quot;*** TimedEventJob could not load the xml data to import from &quot; + endpoint + &quot; message is: &quot; + uke.getMessage());
+                return null;
+                // done();
+            } catch (SAXParseException saxp) {
+                System.out.println (&quot;** Parsing error&quot; + &quot;, line &quot;
+                    + saxp.getLineNumber () + &quot;, column &quot; + saxp.getColumnNumber() + &quot;, message: &quot; + saxp.getMessage());
+                System.out.println(&quot;dataValue: &quot; +result.substring(saxp.getColumnNumber()-15, saxp.getColumnNumber()+50));
+                System.out.println(&quot;*** TimedEventJob is skipping the import for today !&quot;);
+                return null;
+            } catch (Exception ex) {
+                System.out.println(&quot;*** TimedEventJob encountered problem: &quot; + ex.getMessage());
+                return null;
+            }
+        }
+        return result;
+    }
+
+    // --- copy of BrowseServlet
+
+    private void sendNotificationEmail(Vector unusableProjects) {
+      if (unusableProjects.isEmpty()) return;
+      try {
+        // GeoObjectTopic inst = (GeoObjectTopic) as.getLiveTopic(instID, 1);
+        // &quot;from&quot;
+        String from = as.getEmailAddress(&quot;t-rootuser&quot;);		// ###
+        if (from == null || from.equals(&quot;&quot;)) {
+          throw new DeepaMehtaException(&quot;email address of root user is unknown&quot;);
+        }
+        // &quot;to&quot;
+        String to = &quot;<A HREF="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">mre at newthinking.de</A>&quot;;
+        // &quot;subject&quot;
+        String subject = &quot;Ehrenamtsatlas: folgende Veranstaltungen haben einen fehlerhaften Addresseintrag&quot;;
+        StringBuffer entries = new StringBuffer();
+        entries.append(&quot;------------------------------\r&quot;);
+        for (int i = 0; i &lt; unusableProjects.size(); i++) {
+            GeoObjectTopic entry = (GeoObjectTopic) unusableProjects.get(i);
+            entries.append(&quot;Veranstaltung: &quot;);
+            entries.append(entry.getName());
+            entries.append(&quot; mit Adresseintrag: &quot;);
+            entries.append(entry.getAddress().getName());
+            entries.append(&quot;\r&quot;);
+        }
+        entries.append(&quot;------------------------------\r&quot;);
+        // &quot;body&quot;
+        String body = &quot;Dies ist eine automatische Benachrichtigung erstellt von www.kiezatlas.de\r\r&quot; +
+          &quot;Folgende Veranstaltungen konnten aufgrund eines fehlerhaften Adresseintrags nicht korrekt verortet werden:\r\r&quot; +
+          &quot;&quot; + entries.toString() + &quot;\r&quot; +
+          &quot;www.berlin.de/buergeraktiv/atlas\r\r&quot; +
+          &quot;Mit freundlichen Gr&#252;&#223;en\r&quot; +
+          &quot;ihr Kiezatlas-Team&quot;;
+        //
+        System.out.println(&quot;&gt;&gt;&gt; send notification email&quot;);
+        System.out.println(&quot;  &gt; SMTP server: \&quot;&quot; + as.getSMTPServer() + &quot;\&quot;&quot;);	// as.getSMTPServer() throws DME
+        System.out.println(&quot;  &gt; from: \&quot;&quot; + from + &quot;\&quot;&quot;);
+        System.out.println(&quot;  &gt; to: \&quot;&quot; + to + &quot;\&quot;&quot;);
+        // send email
+        EmailTopic.sendMail(as.getSMTPServer(), from, to, subject, body);		// EmailTopic.sendMail() throws DME
+      } catch (Exception e) {
+        System.out.println(&quot;*** notification email not send (&quot; + e + &quot;)&quot;);
+      }
+    }
+
+
+    /**
+     * returns null if no topictype whihc is assigned to the given workspace,
+     * is a subtype of &quot;GeoObjectTopic&quot;
+     *
+     * @param workspaceId
+     * @return
+     */
+    private BaseTopic getWorkspaceGeoType(String workspaceId) {
+        //
+        TypeTopic geotype = as.type(TOPICTYPE_KIEZ_GEO, 1);
+        Vector subtypes = geotype.getSubtypeIDs();
+        Vector workspacetypes = as.getRelatedTopics(workspaceId, ASSOCTYPE_USES, 2);
+        int i;
+        for (i = 0; i &lt; workspacetypes.size(); i++) {
+            BaseTopic topic = (BaseTopic) workspacetypes.get(i);
+            int a;
+            for (a = 0; a &lt; subtypes.size(); a++) {
+                // System.out.println(&quot; counter: &quot; + a);
+                String derivedOne = (String) subtypes.get(a);
+                // System.out.println(&quot;    &quot; + derivedOne.getID() + &quot;:&quot; + derivedOne.getName());
+                if (derivedOne.equals(topic.getID())) {
+                    // System.out.println(&quot; found geoType &quot; + topic.getID() + &quot;:&quot; + topic.getName());
+                    return topic;
+                }
+            }
+        }
+        return null;
+    }
+
+}

Added: trunk/src/de/kiezatlas/deepamehta/TimerJobParameterHolder.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/TimerJobParameterHolder.java	                        (rev 0)
+++ trunk/src/de/kiezatlas/deepamehta/TimerJobParameterHolder.java	2011-02-09 11:26:16 UTC (rev 99)
@@ -0,0 +1,26 @@
+package de.kiezatlas.deepamehta;
+
+import java.util.HashMap;
+import java.util.Map;
+
+public class TimerJobParameterHolder {
+
+	private static TimerJobParameterHolder instance;
+	
+	private Map&lt;String, Object&gt; parameters;
+	
+	private TimerJobParameterHolder() {
+		parameters = new HashMap&lt;String, Object&gt;();
+	}
+	
+	public static TimerJobParameterHolder getInstance() {
+		if (instance == null) {
+			instance = new TimerJobParameterHolder();
+		}
+		return instance;
+	}
+	
+	public Map&lt;String, Object&gt; getParameters() {
+		return parameters;
+	}
+}

Modified: trunk/src/de/kiezatlas/deepamehta/topics/CityMapTopic.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/topics/CityMapTopic.java	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/src/de/kiezatlas/deepamehta/topics/CityMapTopic.java	2011-02-09 11:26:16 UTC (rev 99)
@@ -348,7 +348,7 @@
 	}
 
   public static boolean passwordCorrect(BaseTopic map, ApplicationService as, String password) {
-    if (as.getTopicProperty(map, PROPERTY_PASSWORD).equals(password)) return false; else return true;
+    if (as.getTopicProperty(map, PROPERTY_PASSWORD).equals(password)) return true; else return false;
 	}
 
 	// --- lookupCityMap (3 forms) ---

Modified: trunk/src/de/kiezatlas/deepamehta/topics/GPSConverterTopic.java
===================================================================
--- trunk/src/de/kiezatlas/deepamehta/topics/GPSConverterTopic.java	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/src/de/kiezatlas/deepamehta/topics/GPSConverterTopic.java	2011-02-09 11:26:16 UTC (rev 99)
@@ -245,18 +245,18 @@
 
 
 
-    private Vector getAssignedWorkspaces() {
-        Vector workspaces = as.getRelatedTopics(this.getID(), ASSOCTYPE_ASSOCIATION, TOPICTYPE_WORKSPACE, 2);
-        // System.out.println(&quot;    workspaces found count: &quot; + workspaces.size());
-        return workspaces;
-    }
+  private Vector getAssignedWorkspaces() {
+      Vector workspaces = as.getRelatedTopics(this.getID(), ASSOCTYPE_ASSOCIATION, TOPICTYPE_WORKSPACE, 2);
+      // System.out.println(&quot;    workspaces found count: &quot; + workspaces.size());
+      return workspaces;
+  }
 
-    public Vector disabledProperties(Session session) {
-		Vector disabledProps = new Vector();
-		//
-        disabledProps.addElement(PROPERTY_DESCRIPTION);
-		//
-		return disabledProps;
+  public Vector disabledProperties(Session session) {
+      Vector disabledProps = new Vector();
+      //
+          disabledProps.addElement(PROPERTY_DESCRIPTION);
+      //
+      return disabledProps;
 	}
 
     /**

Modified: trunk/src/de/swers/kiezatlas/tools/UploadDataServlet.java
===================================================================
--- trunk/src/de/swers/kiezatlas/tools/UploadDataServlet.java	2010-12-14 18:20:30 UTC (rev 98)
+++ trunk/src/de/swers/kiezatlas/tools/UploadDataServlet.java	2011-02-09 11:26:16 UTC (rev 99)
@@ -37,22 +37,22 @@
  *
  * @author Ramazan Sarikaya
  */
-public class UploadDataServlet extends DeepaMehtaServlet implements de.kiezatlas.deepamehta.KiezAtlas{
+public class UploadDataServlet extends DeepaMehtaServlet implements de.kiezatlas.deepamehta.KiezAtlas {
     
-        static final String PAGE_LOGIN = &quot;UploadDataLogin&quot;;
-        static final String PAGE_HOME = &quot;UploadDataHome&quot;;
-        static final String PAGE_LOGIN_TRY_AGAIN = &quot;UploadDataLoginTryAgain&quot;;
+  static final String PAGE_LOGIN = &quot;UploadDataLogin&quot;;
+  static final String PAGE_HOME = &quot;UploadDataHome&quot;;
+  static final String PAGE_LOGIN_TRY_AGAIN = &quot;UploadDataLoginTryAgain&quot;;
 
-        static final String ACTION_UPLOAD_DATA = &quot;UploadDataAction&quot;;
-        static final String ACTION_UPLOAD_DONE = &quot;UploadDataDone&quot;;
+  static final String ACTION_UPLOAD_DATA = &quot;UploadDataAction&quot;;
+  static final String ACTION_UPLOAD_DONE = &quot;UploadDataDone&quot;;
+
+  static final String PREFIX_NEUKOELLN =  &quot;t-NKLSTI-&quot;;
+
+  public void doPost(HttpServletRequest request, HttpServletResponse response)
+                          throws IOException, ServletException {
+      super.doPost(request, response);	// ###
+  }
         
-        static final String PREFIX_NEUKOELLN =  &quot;t-NKLSTI-&quot;;
-        
-        public void doPost(HttpServletRequest request, HttpServletResponse response)
-    														throws IOException, ServletException {
-            super.doPost(request, response);	// ###
-        }
-        
 	protected String performAction(String action, RequestParameter params, Session session, CorporateDirectives directives) throws ServletException {
 		if (action == null) {
 			System.out.println(&quot;Hello from the external UploadServlet&quot;);
@@ -91,7 +91,7 @@
 	// **********************
 
 
-       	private String writeData(Vector fileItems) {
+    private String writeData(Vector fileItems) {
 		System.out.println(&quot;&gt;&gt;&gt; UploadDataServlet.writeData(): &quot; + fileItems.size() + &quot; files uploaded&quot;);
 		try {
 			Enumeration e = fileItems.elements();


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#86">[ date ]</a>
              <a href="thread.html#86">[ thread ]</a>
              <a href="subject.html#86">[ subject ]</a>
              <a href="author.html#86">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/kiezatlas-svn">More information about the Kiezatlas-svn
mailing list</a><br>
</body></html>
